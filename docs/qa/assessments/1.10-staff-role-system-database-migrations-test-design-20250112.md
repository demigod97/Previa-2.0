# Test Design: Story 1.10

Date: 2025-01-12
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 18
- Unit tests: 6 (33%)
- Integration tests: 8 (44%)
- E2E tests: 4 (22%)
- Priority distribution: P0: 8, P1: 6, P2: 4

## Test Scenarios by Acceptance Criteria

### AC1: Staff Roles Table Structure

#### Scenarios

| ID              | Level       | Priority | Test                                    | Justification                    |
| --------------- | ----------- | -------- | --------------------------------------- | --------------------------------- |
| 1.10-UNIT-001   | Unit        | P0       | Table schema validation                 | Pure schema logic validation      |
| 1.10-INT-001    | Integration | P0       | Migration applies successfully          | Database migration integration    |
| 1.10-INT-002    | Integration | P0       | Constraints prevent invalid roles       | Data integrity validation         |
| 1.10-E2E-001    | E2E         | P1       | Table accessible via Supabase client   | End-to-end database connectivity  |

### AC2: Make Specific User Super Admin

#### Scenarios

| ID              | Level       | Priority | Test                                    | Justification                    |
| --------------- | ----------- | -------- | --------------------------------------- | --------------------------------- |
| 1.10-UNIT-002   | Unit        | P0       | Migration script logic validation       | Pure migration logic              |
| 1.10-INT-003    | Integration | P0       | Super admin assignment succeeds         | Critical user setup              |
| 1.10-INT-004    | Integration | P1       | UPSERT handles existing role            | Edge case handling               |
| 1.10-E2E-002    | E2E         | P0       | Verification query returns correct data | End-to-end verification          |

### AC3: RLS Policies for Staff Tables

#### Scenarios

| ID              | Level       | Priority | Test                                    | Justification                    |
| --------------- | ----------- | -------- | --------------------------------------- | --------------------------------- |
| 1.10-UNIT-003   | Unit        | P0       | RLS policy syntax validation            | Policy logic validation          |
| 1.10-INT-005    | Integration | P0       | Super admin can read staff_roles        | Security policy enforcement       |
| 1.10-INT-006    | Integration | P0       | Regular user cannot read staff_roles    | Security policy enforcement       |
| 1.10-INT-007    | Integration | P1       | User can read own staff role            | Self-access policy                |
| 1.10-INT-008    | Integration | P1       | Team member can read but not modify     | Role-based access control         |
| 1.10-E2E-003    | E2E         | P1       | RLS policies work in production        | Production security validation   |

### AC4: Helper Functions for Role Checks

#### Scenarios

| ID              | Level       | Priority | Test                                    | Justification                    |
| --------------- | ----------- | -------- | --------------------------------------- | --------------------------------- |
| 1.10-UNIT-004   | Unit        | P0       | is_super_admin function accuracy        | Pure function logic               |
| 1.10-UNIT-005   | Unit        | P0       | is_staff_member function accuracy       | Pure function logic               |
| 1.10-UNIT-006   | Unit        | P1       | get_user_staff_role function accuracy  | Pure function logic               |
| 1.10-INT-009    | Integration | P1       | Functions work with RLS policies        | Function-policy integration       |
| 1.10-INT-010    | Integration | P2       | Functions handle non-existent users     | Edge case handling               |

### AC5: Frontend Should Not Show Staff Features (Yet)

#### Scenarios

| ID              | Level       | Priority | Test                                    | Justification                    |
| --------------- | ----------- | -------- | --------------------------------------- | --------------------------------- |
| 1.10-INT-011    | Integration | P2       | useStaffRole hook works correctly       | Hook integration testing          |
| 1.10-E2E-004    | E2E         | P2       | No UI changes visible to regular users | UI behavior validation           |

## Risk Coverage

### Security Risks
- **SEC-001**: Privilege escalation prevention
  - Covered by: 1.10-INT-005, 1.10-INT-006, 1.10-E2E-003
- **SEC-002**: RLS policy bypass attempts
  - Covered by: 1.10-INT-005, 1.10-INT-006, 1.10-INT-007

### Data Integrity Risks
- **DATA-001**: Invalid role assignments
  - Covered by: 1.10-INT-002, 1.10-UNIT-001
- **DATA-002**: Migration failures
  - Covered by: 1.10-INT-001, 1.10-INT-003

### Functional Risks
- **FUNC-001**: Helper function inaccuracy
  - Covered by: 1.10-UNIT-004, 1.10-UNIT-005, 1.10-UNIT-006
- **FUNC-002**: Circular dependency in RLS
  - Covered by: 1.10-INT-003, 1.10-E2E-002

## Recommended Execution Order

1. **P0 Unit tests** (fail fast)
   - 1.10-UNIT-001: Table schema validation
   - 1.10-UNIT-002: Migration script logic
   - 1.10-UNIT-003: RLS policy syntax
   - 1.10-UNIT-004: is_super_admin function
   - 1.10-UNIT-005: is_staff_member function

2. **P0 Integration tests**
   - 1.10-INT-001: Migration applies successfully
   - 1.10-INT-002: Constraints prevent invalid roles
   - 1.10-INT-003: Super admin assignment succeeds
   - 1.10-INT-005: Super admin can read staff_roles
   - 1.10-INT-006: Regular user cannot read staff_roles

3. **P0 E2E tests**
   - 1.10-E2E-001: Table accessible via Supabase client
   - 1.10-E2E-002: Verification query returns correct data

4. **P1 tests**
   - 1.10-UNIT-006: get_user_staff_role function
   - 1.10-INT-004: UPSERT handles existing role
   - 1.10-INT-007: User can read own staff role
   - 1.10-INT-008: Team member can read but not modify
   - 1.10-INT-009: Functions work with RLS policies
   - 1.10-E2E-003: RLS policies work in production

5. **P2 tests** (as time permits)
   - 1.10-INT-010: Functions handle non-existent users
   - 1.10-INT-011: useStaffRole hook works correctly
   - 1.10-E2E-004: No UI changes visible to regular users

## Test Implementation Notes

### Database Test Setup
- Use Supabase test database for integration tests
- Create test users with different role assignments
- Test both local and cloud environments

### Security Test Considerations
- Test with different user contexts (super_admin, team, regular user)
- Verify RLS policies prevent unauthorized access
- Test edge cases like non-existent users

### Migration Test Strategy
- Test migrations in isolation
- Test rollback scenarios
- Verify data integrity after migrations

### Hook Testing
- Test useStaffRole hook with different user states
- Verify loading states and error handling
- Test with no user (logged out state)

## Coverage Validation

- ✅ Every AC has test coverage
- ✅ Test levels are appropriate (not over-testing)
- ✅ No duplicate coverage across levels
- ✅ Priorities align with business risk
- ✅ Test IDs follow naming convention
- ✅ Scenarios are atomic and independent

## Critical Test Scenarios

**Must Pass Before Production:**
1. Super admin can access staff_roles table (1.10-INT-005)
2. Regular users cannot access staff_roles table (1.10-INT-006)
3. Helper functions return correct values (1.10-UNIT-004, 1.10-UNIT-005)
4. Migration assigns super admin successfully (1.10-INT-003)
5. RLS policies prevent privilege escalation (1.10-E2E-003)

**High Priority for Quality:**
1. UPSERT handles existing roles (1.10-INT-004)
2. Functions work with RLS policies (1.10-INT-009)
3. User can read own staff role (1.10-INT-007)

**Nice to Have:**
1. Edge case handling for non-existent users (1.10-INT-010)
2. Hook integration testing (1.10-INT-011)
3. UI behavior validation (1.10-E2E-004)
