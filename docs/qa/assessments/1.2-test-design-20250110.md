# Test Design: Story 1.2 - Audit and Update Dependencies

**Date:** 2025-01-10
**Designer:** Quinn (Test Architect)
**Story:** 1.2 - Audit and Update Dependencies

---

## Test Strategy Overview

- **Total Test Scenarios:** 23
- **Unit Tests:** 8 (35%)
- **Integration Tests:** 10 (43%)
- **E2E Tests:** 5 (22%)
- **Priority Distribution:**
  - **P0:** 7 scenarios (30%) - Critical security and compatibility
  - **P1:** 9 scenarios (39%) - Core functionality validation
  - **P2:** 5 scenarios (22%) - Secondary validation
  - **P3:** 2 scenarios (9%) - Nice-to-have checks

### Test Philosophy for Dependency Story

This story is unique because it's **infrastructure-focused** rather than feature-focused. The testing strategy emphasizes:

1. **Security validation** (critical for financial platform)
2. **Backward compatibility** (ensure nothing breaks)
3. **Build pipeline integrity** (verify tooling works)
4. **Runtime stability** (no new errors introduced)

---

## Test Scenarios by Acceptance Criteria

### AC1: Package.json name updated from "policyai" to "previa"

**Risk Alignment:** TECH-001 (Breaking changes), OPS-001 (Deployment)

#### Scenarios

| ID | Level | Priority | Test Scenario | Justification | Mitigates |
|----|-------|----------|---------------|---------------|-----------|
| 1.2-UNIT-001 | Unit | P1 | Verify package.json name field equals "previa" | Direct metadata validation | TECH-001 |
| 1.2-UNIT-002 | Unit | P1 | Verify package.json version equals "0.1.0" | Version tracking validation | TECH-001 |
| 1.2-UNIT-003 | Unit | P2 | Verify package.json description contains "financial intelligence" | Metadata accuracy | - |
| 1.2-INT-001 | Integration | P1 | Clean npm install succeeds | Verifies package structure valid | OPS-001 |
| 1.2-INT-002 | Integration | P2 | Application startup displays "Previa" branding | End-to-end branding validation | - |

**Given-When-Then Mapping:**
```gherkin
Given package.json exists
When I read the "name" field
Then it should equal "previa"

Given package.json has been updated
When I run npm ci from clean state
Then installation should succeed without errors
```

---

### AC2: All dependencies are compatible with Previa financial use cases

**Risk Alignment:** TECH-002 (Incompatible dependencies), TECH-001 (Breaking changes)

#### Scenarios

| ID | Level | Priority | Test Scenario | Justification | Mitigates |
|----|-------|----------|---------------|---------------|-----------|
| 1.2-INT-003 | Integration | P0 | No peer dependency warnings during npm install | Dependency compatibility | TECH-002 |
| 1.2-INT-004 | Integration | P0 | TypeScript compilation succeeds without errors | Type compatibility | TECH-002 |
| 1.2-INT-005 | Integration | P1 | Vite dev server starts successfully | Build tool compatibility | TECH-001 |
| 1.2-INT-006 | Integration | P1 | Production build completes without errors | Build pipeline integrity | TECH-001 |
| 1.2-E2E-001 | E2E | P1 | Application loads in browser without console errors | Runtime compatibility | TECH-001 |

**Given-When-Then Mapping:**
```gherkin
Given dependencies have been updated
When I run npm install
Then no peer dependency warnings should appear

Given all dependencies are installed
When I run npm run build
Then build should complete successfully with exit code 0
```

---

### AC3: Financial-specific libraries added where needed

**Risk Alignment:** DATA-001 (Currency calculation errors), TECH-002 (Incompatibility)

#### Scenarios

| ID | Level | Priority | Test Scenario | Justification | Mitigates |
|----|-------|----------|---------------|---------------|-----------|
| 1.2-UNIT-004 | Unit | P0 | Currency library performs precise calculations (no floating-point errors) | Financial accuracy critical | DATA-001 |
| 1.2-UNIT-005 | Unit | P0 | Currency formatting outputs correct AUD format ($10.50) | Display accuracy | DATA-001 |
| 1.2-UNIT-006 | Unit | P1 | File upload library (react-dropzone) accepts multiple file types | File processing capability | - |
| 1.2-UNIT-007 | Unit | P2 | XLSX library reads test bank statement correctly | Excel processing | - |
| 1.2-UNIT-008 | Unit | P2 | CSV parser handles test transaction data | CSV processing | - |
| 1.2-INT-007 | Integration | P1 | All new financial libraries import successfully | Module resolution | TECH-002 |

**Given-When-Then Mapping:**
```gherkin
Given currency.js/dinero.js is installed
When I calculate 10.50 + 0.03
Then result should equal exactly 10.53 (no floating-point error)

Given react-dropzone is installed
When I import the library in a component
Then import should succeed without errors
```

**Specific Test Cases for Currency Library (P0):**

| Test Case | Input | Expected Output | Notes |
|-----------|-------|-----------------|-------|
| Addition | 10.50 + 0.03 | 10.53 | No floating-point drift |
| Multiplication | 10.50 × 0.1 (10% tax) | 1.05 | Proper rounding |
| Division | 100.00 ÷ 3 | 33.33, 33.33, 33.34 | Remainder distribution |
| Formatting | 1050 cents | "$10.50" | AUD currency format |
| Parsing | "$10.50" | 1050 cents | Round-trip accuracy |
| Large numbers | 999999999.99 | No overflow | Max transaction size |
| Negative | -10.50 | "-$10.50" | Refunds/credits |
| Zero | 0 | "$0.00" | Edge case |

---

### AC4: Security vulnerabilities resolved in existing dependencies

**Risk Alignment:** SEC-001 (Security vulnerabilities) - **CRITICAL**

#### Scenarios

| ID | Level | Priority | Test Scenario | Justification | Mitigates |
|----|-------|----------|---------------|---------------|-----------|
| 1.2-INT-008 | Integration | P0 | npm audit shows 0 high/critical vulnerabilities | Security validation | SEC-001 |
| 1.2-INT-009 | Integration | P0 | Vite version >= 6.1.6 | Specific vulnerability fix | SEC-001 |
| 1.2-INT-010 | Integration | P0 | @babel/runtime version >= 7.26.10 | Specific vulnerability fix | SEC-001 |
| 1.2-INT-011 | Integration | P0 | nanoid version >= 3.3.8 | Specific vulnerability fix | SEC-001 |
| 1.2-E2E-002 | E2E | P0 | Development server access controls work correctly | Security validation | SEC-001 |

**Given-When-Then Mapping:**
```gherkin
Given all dependencies have been updated
When I run npm audit
Then output should show 0 high vulnerabilities
And output should show 0 critical vulnerabilities

Given Vite has been updated
When I check package.json
Then Vite version should be >= 6.1.6
```

**Security Validation Checklist (P0):**
- [ ] `npm audit` returns 0 high/critical issues
- [ ] Vite updated to address CVE-2024-XXXXX (file system bypass)
- [ ] @babel/runtime updated to fix RegExp complexity
- [ ] nanoid updated to fix predictable generation
- [ ] esbuild updated (transitive dependency)
- [ ] No new vulnerabilities introduced by new packages
- [ ] All vulnerable packages documented in risk profile

---

### AC5: No unused dependencies from PolicyAi domain remain

**Risk Alignment:** TECH-001 (Breaking changes), OPS-001 (Deployment size)

#### Scenarios

| ID | Level | Priority | Test Scenario | Justification | Mitigates |
|----|-------|----------|---------------|---------------|-----------|
| 1.2-INT-012 | Integration | P2 | Dependency analysis shows no unused packages | Clean dependency tree | - |
| 1.2-INT-013 | Integration | P2 | No PolicyAi-specific packages remain | Domain cleanup | - |
| 1.2-E2E-003 | E2E | P3 | Bundle size has not increased significantly (< 20%) | Performance validation | OPS-001 |

**Given-When-Then Mapping:**
```gherkin
Given dependencies have been cleaned up
When I run dependency analyzer (e.g., depcheck)
Then no unused packages should be listed

Given PolicyAi references have been removed
When I search package.json for "policy"
Then no PolicyAi-specific packages should exist
```

---

### AC6: All package versions are up-to-date and compatible

**Risk Alignment:** TECH-001 (Breaking changes), TECH-002 (Incompatibility)

#### Scenarios

| ID | Level | Priority | Test Scenario | Justification | Mitigates |
|----|-------|----------|---------------|---------------|-----------|
| 1.2-INT-014 | Integration | P1 | All packages use latest stable versions | Dependency freshness | TECH-001 |
| 1.2-INT-015 | Integration | P1 | package-lock.json is consistent with package.json | Lock file integrity | TECH-002 |
| 1.2-E2E-004 | E2E | P1 | Full regression test suite passes | No breaking changes | TECH-001 |
| 1.2-E2E-005 | E2E | P2 | Hot module replacement (HMR) works in dev mode | Dev experience validation | - |

**Given-When-Then Mapping:**
```gherkin
Given all dependencies have been updated
When I run npm outdated
Then no critical packages should show as outdated

Given package.json and lock file have been updated
When I run npm ci
Then installation should use exact lock file versions
And no version mismatches should occur
```

---

## Risk-Based Test Coverage Matrix

Mapping test scenarios to identified risks from [risk profile](1.2-risk-20250110.md):

| Risk ID | Risk Title | Score | Test Scenarios Covering | Coverage Status |
|---------|------------|-------|-------------------------|-----------------|
| SEC-001 | Unresolved security vulnerabilities | 9 (Critical) | 1.2-INT-008, 009, 010, 011, E2E-002 | ✅ 5 scenarios (P0) |
| TECH-001 | Breaking changes from updates | 6 (High) | 1.2-INT-004, 005, 006, E2E-001, E2E-004 | ✅ 5 scenarios |
| TECH-002 | Incompatible dependency versions | 4 (Medium) | 1.2-INT-003, 007, 015 | ✅ 3 scenarios |
| DATA-001 | Currency calculation errors | 3 (Low) | 1.2-UNIT-004, 005 | ✅ 2 scenarios (P0) |
| OPS-001 | Deployment pipeline disruption | 2 (Low) | 1.2-INT-001, E2E-003 | ✅ 2 scenarios |

**Risk Coverage Assessment:** ✅ All risks have dedicated test coverage

---

## Test Level Justification

### Why Unit Tests? (8 scenarios, 35%)

**Pure validation and logic testing:**
- Package.json metadata validation (fields are data)
- Currency calculation precision (pure math functions)
- File format handling (library capabilities)

**Advantages:**
- Fast execution (< 1 second total)
- No dependencies needed
- Easy to debug failures
- Comprehensive edge case coverage

**What NOT to test at unit level:**
- Dependency compatibility (needs actual npm install)
- Build system integration (needs Vite/TypeScript)
- Runtime behavior (needs browser environment)

---

### Why Integration Tests? (10 scenarios, 43%)

**Multi-component interactions:**
- npm install process (package manager + file system)
- TypeScript compilation (compiler + type definitions)
- Build pipeline (Vite + plugins + dependencies)
- Security auditing (npm audit + vulnerability database)

**Advantages:**
- Tests real dependency interactions
- Validates build toolchain
- Catches configuration issues
- Verifies security posture

**What NOT to test at integration level:**
- Simple metadata (use unit tests)
- Complete user journeys (use E2E tests)

---

### Why E2E Tests? (5 scenarios, 22%)

**Critical validation paths:**
- Application actually loads in browser
- No runtime errors in console
- Full regression suite passes
- Bundle size within limits

**Advantages:**
- Validates complete system
- Catches runtime-only issues
- Confirms user-facing functionality

**Why limited E2E?**
- Dependency story doesn't add user features
- Most validation happens at build time
- Expensive to run and maintain
- Focus on smoke testing

---

## Recommended Test Execution Order

### Phase 1: Pre-Commit Validation (Fast Fail)
**Duration: ~2 minutes**

1. **P0 Unit Tests** (1.2-UNIT-001 through 008)
   - Metadata validation
   - Currency calculation precision
   - File library capabilities

2. **P0 Integration Tests** (1.2-INT-003, 008-011)
   - Security audit
   - Peer dependencies
   - TypeScript compilation

**Exit Criteria:** All P0 tests pass before proceeding

---

### Phase 2: Build Validation (Medium Duration)
**Duration: ~5 minutes**

3. **P1 Integration Tests** (1.2-INT-001, 004-007, 014-015)
   - npm install
   - Vite dev server
   - Production build
   - New library imports

4. **P1 E2E Tests** (1.2-E2E-001, 004)
   - Application loads
   - Regression suite passes

**Exit Criteria:** All P1 tests pass before merge

---

### Phase 3: Comprehensive Validation (Optional)
**Duration: ~3 minutes**

5. **P2 Tests** (All P2 scenarios)
   - Bundle size analysis
   - Unused dependency check
   - HMR validation

6. **P3 Tests** (All P3 scenarios)
   - Nice-to-have validations

**Exit Criteria:** No blocking issues found

---

## Test Implementation Guidance

### For Unit Tests

**Framework:** Vitest
**Location:** `src/lib/__tests__/` or alongside implementation

**Example: Currency Calculation Test**
```typescript
// src/lib/__tests__/currency.test.ts
import { describe, it, expect } from 'vitest';
import { add, format, parse } from '@/lib/currency';

describe('Currency Calculations', () => {
  it('should add amounts without floating-point errors', () => {
    const result = add(1050, 3); // 10.50 + 0.03
    expect(result).toBe(1053); // 10.53
  });

  it('should format cents to AUD currency string', () => {
    const formatted = format(1050);
    expect(formatted).toBe('$10.50');
  });

  it('should parse currency string to cents', () => {
    const cents = parse('$10.50');
    expect(cents).toBe(1050);
  });

  it('should handle large amounts without overflow', () => {
    const result = format(99999999999); // 999,999,999.99
    expect(result).toBe('$999,999,999.99');
  });
});
```

---

### For Integration Tests

**Framework:** Vitest with Node.js APIs
**Location:** `src/test/integration/`

**Example: Dependency Security Test**
```typescript
// src/test/integration/dependencies.test.ts
import { describe, it, expect } from 'vitest';
import { execSync } from 'child_process';
import packageJson from '../../../package.json';

describe('Dependency Security', () => {
  it('should have no high or critical vulnerabilities', () => {
    const audit = execSync('npm audit --json', { encoding: 'utf-8' });
    const result = JSON.parse(audit);

    expect(result.metadata.vulnerabilities.high).toBe(0);
    expect(result.metadata.vulnerabilities.critical).toBe(0);
  });

  it('should have Vite >= 6.1.6', () => {
    const viteVersion = packageJson.devDependencies.vite;
    const version = viteVersion.replace(/[^\d.]/g, '');
    expect(parseFloat(version)).toBeGreaterThanOrEqual(6.1);
  });
});
```

---

### For E2E Tests

**Framework:** Playwright (via MCP tool)
**Location:** `tests/e2e/`

**Example: Application Load Test**
```typescript
// tests/e2e/app-load.spec.ts
import { test, expect } from '@playwright/test';

test('application loads without errors', async ({ page }) => {
  const errors: string[] = [];

  page.on('console', msg => {
    if (msg.type() === 'error') {
      errors.push(msg.text());
    }
  });

  await page.goto('http://localhost:5173');

  // Wait for app to fully load
  await expect(page.locator('body')).toBeVisible();

  // Verify no console errors
  expect(errors).toHaveLength(0);

  // Verify Previa branding
  await expect(page).toHaveTitle(/Previa/);
});
```

---

## Test Data Requirements

### For Currency Tests
```typescript
// src/test/fixtures/currency-test-data.ts
export const currencyTestCases = [
  { cents: 0, formatted: '$0.00', description: 'Zero amount' },
  { cents: 1, formatted: '$0.01', description: 'Minimum amount' },
  { cents: 1050, formatted: '$10.50', description: 'Typical amount' },
  { cents: -1050, formatted: '-$10.50', description: 'Negative (refund)' },
  { cents: 99999999999, formatted: '$999,999,999.99', description: 'Maximum' },
];

export const calculationTestCases = [
  { a: 1050, b: 3, operation: 'add', expected: 1053 },
  { a: 1050, b: 10, operation: 'multiply', expected: 10500 }, // 10% tax
  { a: 10000, b: 3, operation: 'divide', expected: [3333, 3333, 3334] },
];
```

### For Security Tests
```typescript
// src/test/fixtures/security-test-data.ts
export const requiredVersions = {
  vite: '6.1.6',
  '@babel/runtime': '7.26.10',
  nanoid: '3.3.8',
};

export const acceptableVulnerabilityCounts = {
  critical: 0,
  high: 0,
  moderate: 10, // Allow up to 10 moderate with justification
  low: Infinity, // Low severity acceptable
};
```

---

## Coverage Gaps Analysis

### Acceptance Criteria Coverage

| AC | Description | Test Count | Coverage Status |
|----|-------------|------------|-----------------|
| AC1 | Package name updated | 5 | ✅ Complete |
| AC2 | Dependencies compatible | 5 | ✅ Complete |
| AC3 | Financial libraries added | 6 | ✅ Complete |
| AC4 | Security vulnerabilities resolved | 5 | ✅ Complete |
| AC5 | No unused dependencies | 3 | ✅ Complete |
| AC6 | Package versions up-to-date | 4 | ✅ Complete |

**Result:** ✅ **No coverage gaps** - All ACs have appropriate test coverage

---

## Test Maintenance Considerations

### What Makes These Tests Fragile?

1. **Version-specific assertions** (e.g., Vite >= 6.1.6)
   - **Risk:** Future updates may require test updates
   - **Mitigation:** Use range checks, not exact versions

2. **npm audit thresholds**
   - **Risk:** New vulnerabilities may appear over time
   - **Mitigation:** Accept moderate/low with justification

3. **Bundle size assertions**
   - **Risk:** Natural growth as features added
   - **Mitigation:** Use percentage increase, not absolute size

### Maintenance Strategy

- **Review quarterly:** Update version requirements
- **Update fixtures:** Keep test data current
- **Refactor shared logic:** Extract common assertions
- **Document exceptions:** Note why certain vulnerabilities acceptable

---

## Definition of Done for Testing

Before marking story as complete, verify:

- [ ] All P0 tests implemented and passing
- [ ] All P1 tests implemented and passing
- [ ] Security audit returns 0 high/critical
- [ ] Currency calculation tests pass all edge cases
- [ ] Regression suite passes completely
- [ ] No new console errors in browser
- [ ] Bundle size increase < 20%
- [ ] CI/CD pipeline passes all checks
- [ ] Test coverage documented in story

---

## Integration with Quality Gate

### Gate Criteria Based on Test Results

**For PASS Gate:**
- ✅ All P0 tests passing
- ✅ All P1 tests passing
- ✅ Security audit clean (0 high/critical)
- ✅ Regression suite passes

**For CONCERNS Gate:**
- ⚠️ Some P2 tests failing (non-critical)
- ⚠️ Moderate security vulnerabilities with justification
- ⚠️ Minor bundle size increase (20-30%)

**For FAIL Gate:**
- ❌ Any P0 test failing
- ❌ Security audit shows high/critical vulnerabilities
- ❌ Regression suite has failures
- ❌ Application won't start

---

## Test Execution Metrics

### Expected Test Duration

| Phase | Test Count | Duration | Cumulative |
|-------|------------|----------|------------|
| P0 Unit | 8 | 10s | 10s |
| P0 Integration | 5 | 60s | 70s |
| P1 Integration | 6 | 120s | 190s |
| P1 E2E | 2 | 30s | 220s |
| P2 All Levels | 5 | 45s | 265s |
| P3 All Levels | 2 | 15s | 280s |

**Total Test Suite Duration:** ~4.5 minutes

**Fast Feedback Loop:** P0 tests complete in 70 seconds

---

## Conclusion

This test design provides **comprehensive, risk-based coverage** for Story 1.2 with:

- ✅ All 6 acceptance criteria covered
- ✅ All 5 identified risks mitigated
- ✅ Efficient test level distribution (35% unit, 43% integration, 22% E2E)
- ✅ Clear priorities (30% P0, 39% P1, 31% P2-P3)
- ✅ Fast feedback loop (P0 tests in 70 seconds)

**Critical Focus Areas:**
1. **Security validation** (SEC-001) - 5 P0 tests
2. **Currency accuracy** (DATA-001) - 2 P0 tests
3. **Compatibility** (TECH-001/002) - 8 P0-P1 tests

The test strategy ensures financial platform security while maintaining efficient test execution and clear priorities for development.

---

**Test design document location:**
```
docs/qa/assessments/1.2-test-design-20250110.md
```

**P0 tests identified:** 12 (must pass for gate approval)
