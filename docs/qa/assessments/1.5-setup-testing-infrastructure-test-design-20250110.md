# Test Design: Story 1.5 - Setup Testing Infrastructure

**Date**: 2025-01-10
**Designer**: Quinn (Test Architect)
**Story ID**: 1.5
**Story Title**: Setup Testing Infrastructure

---

## Test Strategy Overview

- **Total test scenarios**: 32
- **Unit tests**: 15 (47%)
- **Integration tests**: 14 (44%)
- **E2E tests**: 3 (9%)
- **Priority distribution**: P0: 12, P1: 14, P2: 6

**Strategic Approach**: Since this story establishes testing infrastructure rather than implementing features, the test design focuses on **validation tests** that ensure the infrastructure itself works correctly. This creates a "meta-testing" approach where we test the testing tools.

**Risk-Informed Design**: Incorporates critical risk mitigations from [1.5-setup-testing-infrastructure-risk-20250110.md](1.5-setup-testing-infrastructure-risk-20250110.md), particularly:
- SEC-001: RLS Policy Testing Gaps (9 scenarios)
- TECH-003: Supabase Mocking Complexity (7 scenarios)
- DATA-001: Test Data Financial Accuracy (5 scenarios)
- TECH-001: Incomplete Mock Data Coverage (4 scenarios)

---

## Test Scenarios by Acceptance Criteria

### AC1: Vitest Configuration Properly Set Up

**Goal**: Verify testing framework operates correctly with React and TypeScript

#### Scenarios

| ID           | Level       | Priority | Test Scenario                                  | Justification                                       | Mitigates Risk |
|--------------|-------------|----------|------------------------------------------------|-----------------------------------------------------|----------------|
| 1.5-UNIT-001 | Unit        | P0       | Verify vitest.config.ts loads without errors   | Configuration validation - blocks all testing       | TECH-002       |
| 1.5-UNIT-002 | Unit        | P0       | Validate jsdom environment configured          | DOM testing requirement - critical for React        | TECH-002       |
| 1.5-UNIT-003 | Unit        | P0       | Test @/ path alias resolution                  | Import resolution - affects all test files          | TECH-002       |
| 1.5-INT-001  | Integration | P1       | Run sample React component test                | Validates React + TypeScript + Vitest integration   | TECH-002       |
| 1.5-INT-002  | Integration | P1       | Verify test-setup.ts executes before tests     | Setup file critical for global test configuration   | TECH-002       |

**Coverage Summary**: 5 scenarios ensuring test framework baseline functionality

---

### AC2: Financial Mock Data Fixtures Available

**Goal**: Comprehensive, type-safe mock data for all financial entities with edge cases

#### Scenarios

| ID           | Level       | Priority | Test Scenario                                        | Justification                                              | Mitigates Risk |
|--------------|-------------|----------|------------------------------------------------------|------------------------------------------------------------|----------------|
| 1.5-UNIT-004 | Unit        | P0       | Load all mock fixtures without TypeScript errors     | Type safety validation - prevents runtime errors           | TECH-001       |
| 1.5-UNIT-005 | Unit        | P0       | Validate mock data matches database schema types     | Schema alignment critical for accurate testing             | TECH-001       |
| 1.5-UNIT-006 | Unit        | P0       | Test currency values use integer cents (not floats)  | Financial accuracy requirement                             | DATA-001       |
| 1.5-UNIT-007 | Unit        | P1       | Verify mock data helper functions generate valid data| Data generation utilities must produce schema-compliant data| TECH-001       |
| 1.5-UNIT-008 | Unit        | P1       | Test edge case fixtures: failed OCR scenarios        | Error scenario coverage                                    | TECH-001       |
| 1.5-UNIT-009 | Unit        | P1       | Test edge case fixtures: reconciliation timeouts     | Error scenario coverage                                    | TECH-001       |
| 1.5-UNIT-010 | Unit        | P2       | Validate realistic Australian bank data (CBA, ANZ)   | Data realism improves test quality                         | -              |

**Coverage Summary**: 7 scenarios ensuring mock data quality, type safety, and financial accuracy

---

### AC3: Supabase and Authentication Mocking Utilities

**Goal**: Reliable mocking utilities that accurately represent Supabase behavior

#### Scenarios

| ID           | Level       | Priority | Test Scenario                                               | Justification                                                 | Mitigates Risk |
|--------------|-------------|----------|-------------------------------------------------------------|---------------------------------------------------------------|----------------|
| 1.5-UNIT-011 | Unit        | P0       | Mock Supabase client matches actual API signatures (TypeScript)| Type safety prevents mock/real divergence                     | TECH-003       |
| 1.5-INT-003  | Integration | P0       | Test RLS policy enforcement with real Supabase dev branch   | Security-critical - mocks insufficient for RLS testing        | SEC-001        |
| 1.5-INT-004  | Integration | P0       | Verify authentication state transitions in mock             | Auth flow accuracy critical for protected routes              | TECH-003       |
| 1.5-INT-005  | Integration | P0       | Test multi-role user access with real database              | Role-based access core security requirement                   | SEC-001        |
| 1.5-INT-006  | Integration | P1       | Mock file upload with progress tracking                     | File upload critical for bank statement processing            | TECH-003       |
| 1.5-INT-007  | Integration | P1       | Test file storage mocking utilities                         | Storage operations needed for receipt/statement uploads       | TECH-003       |
| 1.5-INT-008  | Integration | P1       | Mock real-time subscription connection states               | Real-time features (reconciliation updates) require accuracy  | TECH-003       |
| 1.5-INT-009  | Integration | P1       | Test cross-role data access denial (Administrator vs Executive)| Security validation - no cross-role data leakage              | SEC-001        |
| 1.5-INT-010  | Integration | P1       | Verify unauthenticated access denial                        | Security baseline - auth required for all operations          | SEC-001        |
| 1.5-INT-011  | Integration | P2       | Test database query mocking patterns                        | Query mocking utilities for unit testing database operations  | TECH-003       |

**Coverage Summary**: 10 scenarios with strong emphasis on security (RLS) and mock accuracy

**Critical Note**: Per risk mitigation strategy, RLS testing MUST use real Supabase dev branch, not pure mocks.

---

### AC4: Sample Test Files Demonstrating Patterns

**Goal**: Provide developers with executable examples of testing patterns

#### Scenarios

| ID           | Level       | Priority | Test Scenario                                          | Justification                                            | Mitigates Risk |
|--------------|-------------|----------|--------------------------------------------------------|----------------------------------------------------------|----------------|
| 1.5-UNIT-012 | Unit        | P0       | Sample: Financial calculation test (currency precision)| Demonstrates integer cents pattern for accuracy          | DATA-001       |
| 1.5-UNIT-013 | Unit        | P1       | Sample: Component rendering test (transaction display) | Shows React Testing Library usage patterns               | -              |
| 1.5-INT-012  | Integration | P0       | Sample: Reconciliation matching workflow test          | Demonstrates complex business logic integration testing  | DATA-001       |
| 1.5-INT-013  | Integration | P1       | Sample: Authentication flow test                       | Shows auth mocking and protected route testing           | TECH-003       |
| 1.5-INT-014  | Integration | P1       | Sample: File upload component test                     | Demonstrates file upload mocking with progress tracking  | TECH-003       |

**Coverage Summary**: 5 sample tests serving as templates for developers

---

### AC5: Coverage Reporting Configured

**Goal**: Accurate coverage metrics with appropriate exclusions and thresholds

#### Scenarios

| ID           | Level       | Priority | Test Scenario                                      | Justification                                       | Mitigates Risk |
|--------------|-------------|----------|----------------------------------------------------|----------------------------------------------------|----------------|
| 1.5-UNIT-014 | Unit        | P0       | Verify coverage thresholds set to 80% (lines/funcs)| Enforces minimum quality bar                        | TECH-004       |
| 1.5-UNIT-015 | Unit        | P1       | Test coverage reporters generate all formats       | Multiple formats needed (text, json, html)          | TECH-004       |
| 1.5-INT-015  | Integration | P1       | Run coverage on sample financial code              | Validates coverage works on TypeScript + React      | TECH-004       |

**Coverage Summary**: 3 scenarios ensuring coverage tooling operational

---

### AC6: Test Scripts Available for Different Scenarios

**Goal**: npm scripts for unit, integration, watch mode, and coverage reporting

#### Scenarios

| ID           | Level       | Priority | Test Scenario                        | Justification                               | Mitigates Risk |
|--------------|-------------|----------|--------------------------------------|---------------------------------------------|----------------|
| 1.5-E2E-001  | E2E         | P1       | Execute `npm test` and verify success| Validates default test command works        | -              |
| 1.5-E2E-002  | E2E         | P1       | Execute `npm run test:watch` mode    | Developer workflow validation               | PERF-001       |
| 1.5-E2E-003  | E2E         | P1       | Execute `npm run test:coverage`      | CI/CD coverage reporting validation         | TECH-004       |

**Coverage Summary**: 3 E2E scenarios validating complete test execution workflows

---

### AC7: Testing Documentation Available

**Goal**: Comprehensive guide for developers writing tests

#### Scenarios

| ID          | Level | Priority | Test Scenario                                          | Justification                                | Mitigates Risk |
|-------------|-------|----------|--------------------------------------------------------|----------------------------------------------|----------------|
| 1.5-DOC-001 | Doc   | P1       | Verify documentation covers financial calculation testing | Critical for DATA-001 mitigation             | OPS-001        |
| 1.5-DOC-002 | Doc   | P1       | Verify documentation covers Supabase mocking strategies   | Critical for TECH-003 mitigation             | OPS-001        |
| 1.5-DOC-003 | Doc   | P2       | Verify documentation includes troubleshooting guide       | Reduces developer friction                   | OPS-001        |
| 1.5-DOC-004 | Doc   | P2       | Verify documentation covers RLS testing with dev branch   | Critical for SEC-001 mitigation              | OPS-001        |

**Coverage Summary**: 4 documentation validation items (manual review)

---

## Risk Coverage Mapping

### Critical Risks (Score 9)

**SEC-001: RLS Policy Testing Gaps**
- ✅ **1.5-INT-003**: RLS policy enforcement with real Supabase dev branch (P0)
- ✅ **1.5-INT-005**: Multi-role user access testing (P0)
- ✅ **1.5-INT-009**: Cross-role data access denial (P1)
- ✅ **1.5-INT-010**: Unauthenticated access denial (P1)
- ✅ **1.5-DOC-004**: RLS testing documentation (P2)

**Coverage Assessment**: 5 scenarios directly address RLS testing. The P0 scenarios use **real Supabase dev branch** per mitigation strategy, avoiding pure mocking for security-critical tests.

---

**TECH-003: Supabase Mocking Complexity**
- ✅ **1.5-UNIT-011**: Mock API signature validation (P0)
- ✅ **1.5-INT-004**: Authentication state transition testing (P0)
- ✅ **1.5-INT-006**: File upload mocking with progress (P1)
- ✅ **1.5-INT-007**: File storage mocking utilities (P1)
- ✅ **1.5-INT-008**: Real-time subscription mocking (P1)
- ✅ **1.5-INT-013**: Sample authentication flow test (P1)
- ✅ **1.5-INT-014**: Sample file upload component test (P1)

**Coverage Assessment**: 7 scenarios ensure Supabase mocks are accurate and validated. Includes mock validation tests and integration tests with real client.

---

### High Risks (Score 6)

**TECH-001: Incomplete Mock Data Coverage**
- ✅ **1.5-UNIT-004**: Load all mock fixtures (P0)
- ✅ **1.5-UNIT-005**: Validate schema alignment (P0)
- ✅ **1.5-UNIT-007**: Data helper function validation (P1)
- ✅ **1.5-UNIT-008**: Failed OCR edge cases (P1)
- ✅ **1.5-UNIT-009**: Reconciliation timeout edge cases (P1)

**Coverage Assessment**: 5 scenarios ensure comprehensive mock data coverage including edge cases and error scenarios.

---

**DATA-001: Test Data Financial Accuracy**
- ✅ **1.5-UNIT-006**: Integer cents validation (P0)
- ✅ **1.5-UNIT-012**: Sample financial calculation test (P0)
- ✅ **1.5-INT-012**: Sample reconciliation workflow test (P0)

**Coverage Assessment**: 3 scenarios establish financial accuracy standards with integer currency representation.

---

### Medium Risks (Score 4)

**TECH-002: Test Setup Configuration Errors**
- ✅ **1.5-UNIT-001**: Vitest config loads (P0)
- ✅ **1.5-UNIT-002**: jsdom environment configured (P0)
- ✅ **1.5-UNIT-003**: Path alias resolution (P0)
- ✅ **1.5-INT-001**: React component test (P1)
- ✅ **1.5-INT-002**: test-setup.ts execution (P1)

**Coverage Assessment**: 5 scenarios validate test framework configuration.

---

**OPS-001: Missing Test Documentation**
- ✅ **1.5-DOC-001**: Financial calculation testing docs (P1)
- ✅ **1.5-DOC-002**: Supabase mocking strategies docs (P1)
- ✅ **1.5-DOC-003**: Troubleshooting guide (P2)
- ✅ **1.5-DOC-004**: RLS testing documentation (P2)

**Coverage Assessment**: 4 documentation items ensure developer guidance available.

---

### Low Risks (Score 2)

**TECH-004: Coverage Threshold Configuration**
- ✅ **1.5-UNIT-014**: Verify 80% thresholds (P0)
- ✅ **1.5-UNIT-015**: Coverage reporters (P1)
- ✅ **1.5-INT-015**: Coverage on sample code (P1)
- ✅ **1.5-E2E-003**: npm run test:coverage (P1)

**Coverage Assessment**: 4 scenarios validate coverage tooling.

---

**PERF-001: Slow Test Execution**
- ✅ **1.5-E2E-002**: Test watch mode (P1)

**Coverage Assessment**: 1 scenario validates developer workflow performance.

---

## Test Scenario Details

### P0 Critical Tests (Must Pass Before Story Acceptance)

#### Infrastructure Validation

**1.5-UNIT-001: Verify vitest.config.ts loads without errors**
```yaml
level: unit
priority: P0
risk: TECH-002
description: Import vitest.config.ts and verify it loads without syntax/config errors
test_steps:
  - Import vitest configuration
  - Verify config object structure
  - Check for required fields (test, coverage, environment)
expected_result: Configuration loads successfully
acceptance: Zero errors on config import
```

**1.5-UNIT-002: Validate jsdom environment configured**
```yaml
level: unit
priority: P0
risk: TECH-002
description: Verify jsdom environment set for DOM testing
test_steps:
  - Check vitest.config.ts environment setting
  - Verify document/window globals available in test context
expected_result: jsdom environment active
acceptance: DOM APIs accessible in tests
```

**1.5-UNIT-003: Test @/ path alias resolution**
```yaml
level: unit
priority: P0
risk: TECH-002
description: Validate path alias resolves correctly for imports
test_steps:
  - Import component using @/ alias (e.g., @/components/ui/button)
  - Verify import resolves without errors
expected_result: @/ alias resolves to src/ directory
acceptance: No module resolution errors
```

---

#### Mock Data Validation

**1.5-UNIT-004: Load all mock fixtures without TypeScript errors**
```yaml
level: unit
priority: P0
risk: TECH-001
description: Import all fixtures from financial-data.ts and verify type safety
test_steps:
  - Import mockUserTiers, mockBankAccounts, mockTransactions, etc.
  - Verify no TypeScript compilation errors
  - Check all exports are present
expected_result: All fixtures load without errors
acceptance: TypeScript compilation succeeds with strict mode
```

**1.5-UNIT-005: Validate mock data matches database schema types**
```yaml
level: unit
priority: P0
risk: TECH-001
description: Ensure mock data conforms to Supabase generated types
test_steps:
  - Compare mock fixture types to Database types from supabase/types.ts
  - Verify field names and types match exactly
  - Check for missing required fields
expected_result: Mock data compatible with database schema
acceptance: No type mismatches between mocks and schema
```

**1.5-UNIT-006: Test currency values use integer cents (not floats)**
```yaml
level: unit
priority: P0
risk: DATA-001
description: Verify all monetary amounts stored as integer cents
test_steps:
  - Inspect mockTransactions for amount fields
  - Verify amounts are integers (e.g., 1050 for $10.50)
  - Check no floating-point currency values exist
expected_result: All currency as integer cents
acceptance: Zero floating-point currency values found
justification: Prevents floating-point precision errors in financial calculations
```

---

#### Security Testing (RLS)

**1.5-INT-003: Test RLS policy enforcement with real Supabase dev branch**
```yaml
level: integration
priority: P0
risk: SEC-001
description: Validate RLS policies using real Supabase development branch
prerequisites:
  - Supabase dev branch created (mcp__supabase__create_branch)
  - Test users with Administrator and Executive roles created
test_steps:
  - Connect to Supabase dev branch database
  - Create test policy documents with role assignments
  - Attempt queries as different role users
  - Verify RLS policies filter results correctly
expected_result: RLS policies enforce role-based access
acceptance: Administrator sees only admin documents; Executive sees only exec documents
critical_note: MUST use real database, NOT mocks
```

**1.5-INT-005: Test multi-role user access with real database**
```yaml
level: integration
priority: P0
risk: SEC-001
description: Validate data segregation between Administrator and Executive roles
prerequisites:
  - Supabase dev branch with RLS policies
  - Test users: admin@test.com (Administrator), exec@test.com (Executive)
test_steps:
  - Authenticate as admin@test.com
  - Query policy_documents table
  - Verify only Administrator-assigned documents returned
  - Authenticate as exec@test.com
  - Query policy_documents table
  - Verify only Executive-assigned documents returned
expected_result: Zero cross-role data leakage
acceptance: Each role sees only assigned documents
```

---

#### Supabase Mocking Validation

**1.5-UNIT-011: Mock Supabase client matches actual API signatures (TypeScript)**
```yaml
level: unit
priority: P0
risk: TECH-003
description: Ensure mock Supabase client has identical TypeScript API to real client
test_steps:
  - Import real SupabaseClient type from @supabase/supabase-js
  - Create mock Supabase client type
  - Use TypeScript to verify mock implements SupabaseClient interface
  - Check key methods: auth.signIn, from().select(), storage.upload()
expected_result: Mock client type-compatible with real client
acceptance: TypeScript compilation with strict mode succeeds
justification: Type safety prevents mock API drift
```

**1.5-INT-004: Verify authentication state transitions in mock**
```yaml
level: integration
priority: P0
risk: TECH-003
description: Test auth state machine in mock matches real behavior
test_steps:
  - Start with unauthenticated state
  - Call mock auth.signIn()
  - Verify session state changes to authenticated
  - Call mock auth.signOut()
  - Verify session state returns to unauthenticated
  - Test error states (invalid credentials)
expected_result: Mock auth state machine matches real Supabase behavior
acceptance: State transitions identical to real client
```

---

#### Financial Calculation Samples

**1.5-UNIT-012: Sample: Financial calculation test (currency precision)**
```yaml
level: unit
priority: P0
risk: DATA-001
description: Demonstrate correct financial calculation testing pattern
test_steps:
  - Create sample function: calculateTransactionTotal(transactions: Transaction[])
  - Use integer cents for all amounts
  - Test addition: [1050, 2099, 500] → 3649 cents ($36.49)
  - Test subtraction (refunds): 1050 - 200 → 850 cents ($8.50)
  - Test edge case: zero amount
  - Test edge case: negative amount (refund)
expected_result: All calculations exact to the cent
acceptance: No floating-point errors; all assertions pass
educational_value: Serves as template for developers writing financial tests
```

**1.5-INT-012: Sample: Reconciliation matching workflow test**
```yaml
level: integration
priority: P0
risk: DATA-001
description: Demonstrate complex financial workflow testing
test_steps:
  - Load mock bank transactions and receipts
  - Run reconciliation matching algorithm
  - Verify matches above 95% confidence auto-approved
  - Test date tolerance (±3 days)
  - Test amount tolerance (exact match required)
  - Verify OCR confidence threshold (90%)
expected_result: Reconciliation logic produces correct matches
acceptance: Expected matches found with correct confidence scores
educational_value: Shows integration testing for multi-component financial workflows
```

---

### P1 High Priority Tests (Should Complete)

**1.5-INT-001: Run sample React component test**
```yaml
level: integration
priority: P1
risk: TECH-002
description: Validate React Testing Library + Vitest integration
test_steps:
  - Create simple React component (e.g., TransactionListItem)
  - Write test using React Testing Library render()
  - Test component renders with mock transaction data
  - Test user interaction (click event)
expected_result: React component test passes
acceptance: Component renders and events fire correctly
```

**1.5-INT-009: Test cross-role data access denial (Administrator vs Executive)**
```yaml
level: integration
priority: P1
risk: SEC-001
description: Verify security boundaries prevent cross-role access
test_steps:
  - Create policy document assigned to Administrator role only
  - Authenticate as Executive user
  - Attempt to query that specific document by ID
  - Verify query returns empty result (RLS denial)
  - Repeat reverse scenario (Executive document, Administrator query)
expected_result: Cross-role queries return no data
acceptance: RLS policies prevent unauthorized access attempts
```

**1.5-INT-010: Verify unauthenticated access denial**
```yaml
level: integration
priority: P1
risk: SEC-001
description: Baseline security - no data access without authentication
test_steps:
  - Create Supabase client without authentication session
  - Attempt to query policy_documents, sources, documents tables
  - Verify all queries return empty results or auth errors
expected_result: Unauthenticated requests denied
acceptance: Zero data leakage to unauthenticated users
```

**1.5-INT-006: Mock file upload with progress tracking**
```yaml
level: integration
priority: P1
risk: TECH-003
description: Test file upload mocking with progress callbacks
test_steps:
  - Create mock file object (bank statement PDF)
  - Call mock storage.upload() with progress callback
  - Verify progress events fire (0%, 25%, 50%, 75%, 100%)
  - Verify upload completion returns file path
  - Test error scenario (file too large)
expected_result: Upload mock accurately simulates progress tracking
acceptance: Progress callbacks fire with expected percentages
```

**1.5-INT-013: Sample: Authentication flow test**
```yaml
level: integration
priority: P1
risk: TECH-003
description: Demonstrate testing protected routes with auth mocking
test_steps:
  - Mock Supabase auth to return unauthenticated state
  - Render component requiring authentication
  - Verify redirect to login page
  - Mock successful authentication
  - Re-render component
  - Verify protected content displays
expected_result: Auth-dependent behavior testable via mocking
acceptance: Protected route logic verified
educational_value: Template for testing auth-gated features
```

---

### P2 Medium Priority Tests (Nice to Have)

**1.5-UNIT-010: Validate realistic Australian bank data (CBA, ANZ)**
```yaml
level: unit
priority: P2
risk: -
description: Verify mock data uses realistic Australian bank details
test_steps:
  - Check mockBankAccounts for realistic BSB numbers
  - Verify institution names (Commonwealth Bank, ANZ, Westpac)
  - Check account number formats
expected_result: Mock data reflects Australian banking standards
acceptance: Data passes realism checks
```

**1.5-INT-011: Test database query mocking patterns**
```yaml
level: integration
priority: P2
risk: TECH-003
description: Create utilities for mocking database queries in unit tests
test_steps:
  - Create mock supabase.from().select() response
  - Test chaining: .eq(), .order(), .limit()
  - Verify mock returns expected data structure
expected_result: Query mocking utilities functional
acceptance: Developers can mock DB queries in unit tests
```

---

## Test Execution Strategy

### Phase 1: Infrastructure Validation (P0 - Must Pass First)
**Goal**: Ensure test framework operational before building on it

**Order**:
1. **Configuration Tests** (1.5-UNIT-001, 002, 003)
   - Validates Vitest + TypeScript + React setup
   - **Blocks**: All subsequent tests if fails

2. **Mock Data Foundation** (1.5-UNIT-004, 005, 006)
   - Validates mock data quality and financial accuracy
   - **Blocks**: Any test using mock data

3. **Security Infrastructure** (1.5-INT-003, 005)
   - Validates RLS testing capability with real database
   - **Blocks**: All security-related feature testing

4. **Mocking Utilities** (1.5-UNIT-011, 1.5-INT-004)
   - Validates Supabase mocking accuracy
   - **Blocks**: Unit tests requiring Supabase mocks

5. **Financial Calculation Samples** (1.5-UNIT-012, 1.5-INT-012)
   - Establishes financial testing patterns
   - **Blocks**: Financial feature testing in Epic 2+

**Total P0 Tests**: 12 scenarios
**Estimated Execution Time**: 15-20 minutes (including real database tests)

---

### Phase 2: Developer Experience Validation (P1 - Should Complete)
**Goal**: Ensure developers can effectively use the testing infrastructure

**Order**:
1. **Sample Tests** (1.5-INT-001, 013, 014)
   - Provides templates for common test patterns
   - **Impact**: Developer productivity

2. **Security Edge Cases** (1.5-INT-009, 010)
   - Validates security boundaries
   - **Impact**: Security confidence

3. **Advanced Mocking** (1.5-INT-006, 007, 008)
   - File uploads, storage, real-time subscriptions
   - **Impact**: Feature test capability

4. **Documentation Validation** (1.5-DOC-001, 002)
   - Ensures critical docs present
   - **Impact**: Developer onboarding

5. **Workflow Tests** (1.5-E2E-001, 002, 003)
   - Validates npm scripts work end-to-end
   - **Impact**: CI/CD integration

**Total P1 Tests**: 14 scenarios
**Estimated Execution Time**: 20-25 minutes

---

### Phase 3: Quality of Life (P2 - Time Permitting)
**Goal**: Nice-to-have validations

**Tests**: 1.5-UNIT-010, 1.5-INT-011, 1.5-DOC-003, 1.5-DOC-004

**Total P2 Tests**: 6 scenarios
**Estimated Execution Time**: 10 minutes

---

## Recommended Test Execution Order

### CI/CD Pipeline Order
```bash
# Phase 1: Fail Fast - Infrastructure P0 (parallel)
npm test 1.5-UNIT-001 1.5-UNIT-002 1.5-UNIT-003
npm test 1.5-UNIT-004 1.5-UNIT-005 1.5-UNIT-006
npm test 1.5-UNIT-011

# Phase 2: Critical Integration P0 (sequential - needs DB)
npm test 1.5-INT-003 1.5-INT-004 1.5-INT-005

# Phase 3: Sample Tests P0 (parallel)
npm test 1.5-UNIT-012 1.5-INT-012

# Phase 4: P1 Tests (parallel where possible)
npm test 1.5-INT-001 1.5-INT-006 1.5-INT-007 1.5-INT-008
npm test 1.5-INT-009 1.5-INT-010 1.5-INT-013 1.5-INT-014

# Phase 5: E2E Workflow Tests (sequential)
npm test
npm run test:watch --run # Non-interactive
npm run test:coverage

# Phase 6: P2 Tests (if time permits)
npm test 1.5-UNIT-010 1.5-INT-011
```

---

## Coverage Gaps Analysis

### No Coverage Gaps Detected
All 7 acceptance criteria have comprehensive test coverage:

- ✅ **AC1**: 5 scenarios (infrastructure validation)
- ✅ **AC2**: 7 scenarios (mock data quality)
- ✅ **AC3**: 10 scenarios (Supabase/auth mocking)
- ✅ **AC4**: 5 scenarios (sample test files)
- ✅ **AC5**: 3 scenarios (coverage reporting)
- ✅ **AC6**: 3 scenarios (test scripts)
- ✅ **AC7**: 4 scenarios (documentation)

### Risk Coverage Validation

All identified risks have dedicated test scenarios:

- ✅ **SEC-001** (Critical): 5 scenarios
- ✅ **TECH-003** (Critical): 7 scenarios
- ✅ **TECH-001** (High): 5 scenarios
- ✅ **DATA-001** (High): 3 scenarios
- ✅ **TECH-002** (Medium): 5 scenarios
- ✅ **OPS-001** (Medium): 4 scenarios
- ✅ **TECH-004** (Low): 4 scenarios
- ✅ **PERF-001** (Low): 1 scenario

**Total Risk-Mitigating Scenarios**: 34 (some scenarios address multiple risks)

---

## Test Anti-Patterns Avoided

### ✅ No E2E Overuse
Only 3 E2E tests (9%), used exclusively for npm script workflow validation. All business logic tested at unit/integration levels.

### ✅ No Duplicate Coverage
Each scenario tests a distinct aspect. Where overlap exists (e.g., mock data), tests validate different properties:
- 1.5-UNIT-004: Type safety
- 1.5-UNIT-005: Schema alignment
- 1.5-UNIT-006: Financial accuracy

### ✅ Security Tests Use Real Database
Per risk mitigation, RLS tests (1.5-INT-003, 005, 009, 010) use real Supabase dev branch, not pure mocks.

### ✅ Right Test at Right Level
- **Unit**: Pure validation, type checking, fixture loading
- **Integration**: Component interaction, database operations, auth flows
- **E2E**: Complete workflows via npm scripts

---

## Special Considerations

### Supabase Dev Branch Requirement

**Critical Tests Requiring Real Database**:
- 1.5-INT-003: RLS policy enforcement
- 1.5-INT-005: Multi-role access validation
- 1.5-INT-009: Cross-role access denial
- 1.5-INT-010: Unauthenticated access denial

**Setup Steps**:
1. Create Supabase development branch via MCP tools
2. Apply all migrations to branch database
3. Create test users with Administrator and Executive roles
4. Seed test policy documents with role assignments
5. Configure test environment to use branch database connection

**Estimated Setup Time**: 10-15 minutes

---

### Financial Accuracy Standards

All tests involving currency MUST:
- Use integer cents (not floating-point dollars)
- Validate calculations to exact cent precision
- Test edge cases: zero, negative (refunds), very large amounts
- Document currency handling in test comments

**Example**:
```typescript
// ✅ CORRECT: Integer cents
const amount = 1050; // $10.50

// ❌ WRONG: Floating-point dollars
const amount = 10.50;
```

---

### Mock Validation Strategy

**Layered Testing Approach**:
1. **Unit Tests**: Use mocks for isolation
2. **Integration Tests**: Use real Supabase client (dev branch)
3. **Mock Validation Tests**: Compare mock behavior to real client

This prevents false confidence from inaccurate mocks while maintaining unit test speed.

---

## Test Data Requirements

### Mock Data Fixtures Needed
- ✅ User tiers (free and premium)
- ✅ Bank accounts (CBA, ANZ, Westpac)
- ✅ Bank statements (PDF and CSV)
- ✅ Transactions (10+ varied examples)
- ✅ Receipts (with OCR data)
- ✅ Reconciliation matches (various confidence levels)
- ➕ **New**: Failed OCR scenarios
- ➕ **New**: Reconciliation timeouts
- ➕ **New**: File upload errors
- ➕ **New**: Invalid file formats

### Test User Accounts (Dev Branch)
- admin@test.com (Administrator role)
- exec@test.com (Executive role)
- noRole@test.com (No role assigned)
- Unauthenticated session (no user)

---

## Success Metrics

### Story Acceptance Criteria
- ✅ All P0 tests pass (12 scenarios)
- ✅ At least 80% of P1 tests pass (11/14 scenarios)
- ✅ Zero critical bugs in test infrastructure
- ✅ Documentation covers critical risk mitigations (SEC-001, TECH-003, DATA-001)

### Infrastructure Health Indicators
- Test execution time < 5 minutes (unit + integration)
- Zero test flakiness (consistent pass/fail)
- 100% TypeScript compilation success
- All mock fixtures load without errors

---

## Maintenance and Evolution

### Test Review Triggers
Re-evaluate test design when:
- Supabase client library updates (mock validation may need refresh)
- Database schema changes (mock fixtures need updates)
- New RLS policies added (new security tests required)
- Financial calculation logic changes (new test vectors needed)
- Vitest framework updates (configuration tests may need adjustment)

### Ongoing Test Quality
- Run mock validation tests weekly to catch API drift
- Monitor test execution times (alert if >10 min)
- Track test flakiness metrics
- Review failed test patterns monthly

---

## Integration with Quality Gate

### Gate Decision Inputs from Test Design

```yaml
test_design_summary:
  scenarios_total: 32
  by_level:
    unit: 15
    integration: 14
    e2e: 3
  by_priority:
    p0: 12
    p1: 14
    p2: 6
  coverage_gaps: []
  critical_risks_addressed:
    - SEC-001: 5 scenarios
    - TECH-003: 7 scenarios
    - DATA-001: 3 scenarios
    - TECH-001: 5 scenarios
```

### Gate Determination Logic
- **All P0 tests pass** → Gate moves toward PASS
- **Any P0 test fails** → Gate = CONCERNS or FAIL
- **<80% P1 tests pass** → Gate = CONCERNS
- **Documentation incomplete** (1.5-DOC-001, 002) → Gate = CONCERNS

---

## Appendix: Test Scenario Summary Table

| ID           | AC  | Level       | Priority | Test Scenario                                             | Risk Mitigated |
|--------------|-----|-------------|----------|-----------------------------------------------------------|----------------|
| 1.5-UNIT-001 | AC1 | Unit        | P0       | Verify vitest.config.ts loads without errors              | TECH-002       |
| 1.5-UNIT-002 | AC1 | Unit        | P0       | Validate jsdom environment configured                     | TECH-002       |
| 1.5-UNIT-003 | AC1 | Unit        | P0       | Test @/ path alias resolution                             | TECH-002       |
| 1.5-INT-001  | AC1 | Integration | P1       | Run sample React component test                           | TECH-002       |
| 1.5-INT-002  | AC1 | Integration | P1       | Verify test-setup.ts executes before tests                | TECH-002       |
| 1.5-UNIT-004 | AC2 | Unit        | P0       | Load all mock fixtures without TypeScript errors          | TECH-001       |
| 1.5-UNIT-005 | AC2 | Unit        | P0       | Validate mock data matches database schema types          | TECH-001       |
| 1.5-UNIT-006 | AC2 | Unit        | P0       | Test currency values use integer cents (not floats)       | DATA-001       |
| 1.5-UNIT-007 | AC2 | Unit        | P1       | Verify mock data helper functions generate valid data     | TECH-001       |
| 1.5-UNIT-008 | AC2 | Unit        | P1       | Test edge case fixtures: failed OCR scenarios             | TECH-001       |
| 1.5-UNIT-009 | AC2 | Unit        | P1       | Test edge case fixtures: reconciliation timeouts          | TECH-001       |
| 1.5-UNIT-010 | AC2 | Unit        | P2       | Validate realistic Australian bank data (CBA, ANZ)        | -              |
| 1.5-UNIT-011 | AC3 | Unit        | P0       | Mock Supabase client matches actual API signatures        | TECH-003       |
| 1.5-INT-003  | AC3 | Integration | P0       | Test RLS policy enforcement with real Supabase dev branch | SEC-001        |
| 1.5-INT-004  | AC3 | Integration | P0       | Verify authentication state transitions in mock           | TECH-003       |
| 1.5-INT-005  | AC3 | Integration | P0       | Test multi-role user access with real database            | SEC-001        |
| 1.5-INT-006  | AC3 | Integration | P1       | Mock file upload with progress tracking                   | TECH-003       |
| 1.5-INT-007  | AC3 | Integration | P1       | Test file storage mocking utilities                       | TECH-003       |
| 1.5-INT-008  | AC3 | Integration | P1       | Mock real-time subscription connection states             | TECH-003       |
| 1.5-INT-009  | AC3 | Integration | P1       | Test cross-role data access denial                        | SEC-001        |
| 1.5-INT-010  | AC3 | Integration | P1       | Verify unauthenticated access denial                      | SEC-001        |
| 1.5-INT-011  | AC3 | Integration | P2       | Test database query mocking patterns                      | TECH-003       |
| 1.5-UNIT-012 | AC4 | Unit        | P0       | Sample: Financial calculation test (currency precision)   | DATA-001       |
| 1.5-UNIT-013 | AC4 | Unit        | P1       | Sample: Component rendering test (transaction display)    | -              |
| 1.5-INT-012  | AC4 | Integration | P0       | Sample: Reconciliation matching workflow test             | DATA-001       |
| 1.5-INT-013  | AC4 | Integration | P1       | Sample: Authentication flow test                          | TECH-003       |
| 1.5-INT-014  | AC4 | Integration | P1       | Sample: File upload component test                        | TECH-003       |
| 1.5-UNIT-014 | AC5 | Unit        | P0       | Verify coverage thresholds set to 80% (lines/funcs)       | TECH-004       |
| 1.5-UNIT-015 | AC5 | Unit        | P1       | Test coverage reporters generate all formats              | TECH-004       |
| 1.5-INT-015  | AC5 | Integration | P1       | Run coverage on sample financial code                     | TECH-004       |
| 1.5-E2E-001  | AC6 | E2E         | P1       | Execute `npm test` and verify success                     | -              |
| 1.5-E2E-002  | AC6 | E2E         | P1       | Execute `npm run test:watch` mode                         | PERF-001       |
| 1.5-E2E-003  | AC6 | E2E         | P1       | Execute `npm run test:coverage`                           | TECH-004       |
| 1.5-DOC-001  | AC7 | Doc         | P1       | Verify docs cover financial calculation testing           | OPS-001        |
| 1.5-DOC-002  | AC7 | Doc         | P1       | Verify docs cover Supabase mocking strategies             | OPS-001        |
| 1.5-DOC-003  | AC7 | Doc         | P2       | Verify docs include troubleshooting guide                 | OPS-001        |
| 1.5-DOC-004  | AC7 | Doc         | P2       | Verify docs cover RLS testing with dev branch             | OPS-001        |

---

**Generated by**: Quinn (Test Architect)
**Framework**: BMAD™ Test Design
**Date**: 2025-01-10
**Total Test Scenarios**: 32 (15 unit, 14 integration, 3 E2E)
