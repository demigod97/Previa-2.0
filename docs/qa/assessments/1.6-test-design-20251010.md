# Test Design: Story 1.6 - Build Previa Design System

**Date:** 2025-10-10
**Designer:** Quinn (Test Architect)
**Story:** 1.6 - Build Previa Design System
**Story File:** [docs/stories/1.6.build-design-system.md](../../stories/1.6.build-design-system.md)

---

## Test Strategy Overview

- **Total test scenarios:** 31
- **Unit tests:** 12 (38.7%)
- **Integration tests:** 14 (45.2%)
- **E2E tests:** 5 (16.1%)
- **Priority distribution:** P0: 16, P1: 11, P2: 4

### Rationale

This story focuses on **design system implementation** - a foundational layer affecting all future UI work. The test strategy emphasizes:

1. **Configuration validation** (unit) - Ensure Tailwind/CSS configs compile correctly
2. **Component rendering** (integration) - Verify design tokens apply correctly to components
3. **Accessibility compliance** (integration/e2e) - Validate WCAG AA standards
4. **Visual regression** (e2e) - Ensure consistent rendering across browsers

**Risk:** Design system bugs affect **all Epic 2+ features**. Heavy P0 weighting reflects this foundational criticality.

---

## Test Scenarios by Acceptance Criteria

### AC1: Previa color palette implemented in Tailwind CSS configuration

**Risk:** Incorrect colors break brand identity and accessibility. **Priority: P0**

| ID | Level | Priority | Test Scenario | Justification |
|---|---|---|---|---|
| 1.6-UNIT-001 | Unit | P0 | Tailwind config exports previa color palette | Validate config structure before runtime |
| 1.6-UNIT-002 | Unit | P0 | All previa colors match specification hex values | Prevent color drift from design spec |
| 1.6-UNIT-003 | Unit | P0 | PolicyAi color references removed from safelist | Ensure clean migration from PolicyAi |
| 1.6-INT-001 | Integration | P0 | Previa colors accessible via Tailwind classes | Verify classes compile correctly |
| 1.6-INT-002 | Integration | P1 | Color classes apply correctly to DOM elements | Runtime rendering validation |

**Coverage:** 5 tests, 4 P0, 1 P1

---

### AC2: CSS custom properties defined for semantic color usage

**Risk:** Semantic mapping errors break shadcn/ui components. **Priority: P0**

| ID | Level | Priority | Test Scenario | Justification |
|---|---|---|---|---|
| 1.6-UNIT-004 | Unit | P0 | CSS custom properties defined in globals.css | Validate CSS syntax and structure |
| 1.6-UNIT-005 | Unit | P0 | Semantic colors map to correct previa values | Prevent mapping errors |
| 1.6-INT-003 | Integration | P0 | Custom properties resolve in browser runtime | Verify browser CSS variable support |
| 1.6-INT-004 | Integration | P0 | Financial status colors (success/warning/error) render correctly | Critical for transaction UI |
| 1.6-E2E-001 | E2E | P1 | Status colors display consistently across components | Visual regression check |

**Coverage:** 5 tests, 4 P0, 1 P1

---

### AC3: Typography system configured with Inter and JetBrains Mono fonts

**Risk:** Font loading failures or incorrect weights break readability. **Priority: P1**

| ID | Level | Priority | Test Scenario | Justification |
|---|---|---|---|---|
| 1.6-UNIT-006 | Unit | P1 | Font families defined in Tailwind config | Validate config structure |
| 1.6-INT-005 | Integration | P1 | Inter font loads successfully | Runtime font loading check |
| 1.6-INT-006 | Integration | P1 | JetBrains Mono font loads successfully | Runtime font loading check |
| 1.6-INT-007 | Integration | P1 | Font scale (h1-h4, body, small) renders correctly | Typography hierarchy validation |
| 1.6-E2E-002 | E2E | P2 | Financial amounts display in JetBrains Mono | User-facing typography check |

**Coverage:** 5 tests, 0 P0, 4 P1, 1 P2

---

### AC4: shadcn/ui components customized with Previa theme

**Risk:** Component theming errors affect all UI screens. **Priority: P0**

| ID | Level | Priority | Test Scenario | Justification |
|---|---|---|---|---|
| 1.6-INT-008 | Integration | P0 | Button component renders with Previa colors | Core interactive component |
| 1.6-INT-009 | Integration | P0 | Card component renders with cream background | Primary container component |
| 1.6-INT-010 | Integration | P1 | Form components apply Previa focus states | User input validation |
| 1.6-INT-011 | Integration | P1 | Table component renders with correct styling | Transaction display foundation |
| 1.6-E2E-003 | E2E | P1 | All shadcn components display consistently | Visual regression across component library |

**Coverage:** 5 tests, 2 P0, 3 P1

---

### AC5: Financial-specific color coding implemented

**Risk:** Incorrect status colors mislead users on transaction states. **Priority: P0**

| ID | Level | Priority | Test Scenario | Justification |
|---|---|---|---|---|
| 1.6-UNIT-007 | Unit | P0 | Transaction status color mapping defined | Validate statusâ†’color logic |
| 1.6-INT-012 | Integration | P0 | Success status renders green (#10B981) | Critical for approved transactions |
| 1.6-INT-013 | Integration | P0 | Warning status renders amber (#F59E0B) | Critical for matched transactions |
| 1.6-INT-014 | Integration | P0 | Error status renders red (#EF4444) | Critical for rejected transactions |
| 1.6-INT-015 | Integration | P0 | Processing status renders blue (#3B82F6) | Critical for pending transactions |

**Coverage:** 5 tests, 5 P0

---

### AC6: Component documentation created with examples

**Risk:** Missing documentation slows Epic 2+ development. **Priority: P2**

| ID | Level | Priority | Test Scenario | Justification |
|---|---|---|---|---|
| 1.6-UNIT-008 | Unit | P2 | Documentation markdown files exist | File existence check |
| 1.6-UNIT-009 | Unit | P2 | Color usage guidelines documented | Content validation |
| 1.6-UNIT-010 | Unit | P2 | Component variants documented with code examples | Developer reference validation |

**Coverage:** 3 tests, 0 P0, 0 P1, 3 P2

---

### AC7: Accessibility standards met (WCAG AA contrast ratios)

**Risk:** Accessibility failures block deployment and violate compliance. **Priority: P0**

| ID | Level | Priority | Test Scenario | Justification |
|---|---|---|---|---|
| 1.6-UNIT-011 | Unit | P0 | Charcoal on Cream contrast ratio â‰¥ 4.5:1 (AA) | Accessibility compliance |
| 1.6-UNIT-012 | Unit | P0 | DarkStone on Cream contrast ratio â‰¥ 4.5:1 (AA) | Accessibility compliance |
| 1.6-INT-016 | Integration | P0 | Focus indicators visible (sand, 2px outline) | Keyboard navigation requirement |
| 1.6-INT-017 | Integration | P0 | Screen reader labels present on interactive elements | Assistive technology support |
| 1.6-E2E-004 | E2E | P0 | Keyboard navigation works across all components | Full accessibility validation |

**Coverage:** 5 tests, 5 P0

---

### AC8: Design tokens work across all planned components

**Risk:** Token failures break component consistency. **Priority: P0**

| ID | Level | Priority | Test Scenario | Justification |
|---|---|---|---|---|
| 1.6-INT-018 | Integration | P0 | Design tokens compile without errors | Build validation |
| 1.6-INT-019 | Integration | P0 | Tokens apply consistently across Button, Card, Input, Table | Component consistency check |
| 1.6-E2E-005 | E2E | P1 | Responsive behavior works across breakpoints | Mobile/tablet/desktop validation |

**Coverage:** 3 tests, 2 P0, 1 P1

---

## Test Level Distribution Rationale

### Unit Tests (38.7%, n=12)
Focus on **configuration validation** and **pure logic** (color mappings, contrast calculations):
- Tailwind config structure
- CSS custom property definitions
- Color hex value validation
- Contrast ratio calculations
- Documentation existence checks

**Why unit?** Fast feedback on config errors before runtime. No DOM/browser dependencies needed.

---

### Integration Tests (45.2%, n=14)
Focus on **component rendering** and **browser runtime behavior**:
- Tailwind class application
- Font loading
- Component theming
- Status color rendering
- Focus indicators
- Design token compilation

**Why integration?** Validates interaction between Tailwind, CSS custom properties, and React components. Requires DOM but not full user workflows.

---

### E2E Tests (16.1%, n=5)
Focus on **visual consistency** and **accessibility validation**:
- Cross-component visual regression
- Keyboard navigation flows
- Responsive breakpoint behavior
- Financial number rendering in context

**Why E2E?** Validates complete user experience with real browser interactions. Reserved for critical paths and visual validation.

---

## Risk Coverage

**Identified Risks from Story:**

| Risk ID | Description | Mitigated By |
|---|---|---|
| RISK-DS-001 | Color drift from Previa specification | 1.6-UNIT-002, 1.6-INT-001 |
| RISK-DS-002 | Accessibility compliance failure | 1.6-UNIT-011, 1.6-UNIT-012, 1.6-INT-016, 1.6-INT-017, 1.6-E2E-004 |
| RISK-DS-003 | shadcn/ui theming breaks components | 1.6-INT-008, 1.6-INT-009, 1.6-E2E-003 |
| RISK-DS-004 | Financial status colors mislead users | 1.6-UNIT-007, 1.6-INT-012, 1.6-INT-013, 1.6-INT-014, 1.6-INT-015 |
| RISK-DS-005 | Design tokens fail across components | 1.6-INT-018, 1.6-INT-019, 1.6-E2E-005 |
| RISK-DS-006 | Font loading failures | 1.6-INT-005, 1.6-INT-006 |

**Coverage Assessment:** All identified risks have dedicated test coverage with appropriate priority levels.

---

## Recommended Execution Order

### Phase 1: Configuration Validation (Fast Fail)
**Run before any component work:**
1. 1.6-UNIT-001 to 1.6-UNIT-006 (Tailwind config, CSS properties, fonts)
2. 1.6-UNIT-011, 1.6-UNIT-012 (Contrast ratios)

**Goal:** Catch config errors immediately. ~30 seconds execution.

---

### Phase 2: Component Integration (P0 Coverage)
**Run after config passes:**
1. 1.6-INT-001 to 1.6-INT-004 (Color application)
2. 1.6-INT-008, 1.6-INT-009 (Button/Card theming)
3. 1.6-INT-012 to 1.6-INT-015 (Financial status colors)
4. 1.6-INT-016, 1.6-INT-017 (Accessibility)
5. 1.6-INT-018, 1.6-INT-019 (Design token compilation)

**Goal:** Validate all P0 component behavior. ~2-3 minutes execution.

---

### Phase 3: Typography & Polish (P1 Coverage)
**Run after P0 tests pass:**
1. 1.6-INT-005 to 1.6-INT-007 (Font loading)
2. 1.6-INT-010, 1.6-INT-011 (Form/Table components)

**Goal:** Complete P1 coverage. ~1-2 minutes execution.

---

### Phase 4: End-to-End Validation (Visual & Accessibility)
**Run before merge:**
1. 1.6-E2E-001 (Status color consistency)
2. 1.6-E2E-003 (shadcn component consistency)
3. 1.6-E2E-004 (Keyboard navigation - **CRITICAL**)
4. 1.6-E2E-005 (Responsive behavior)
5. 1.6-E2E-002 (Financial typography)

**Goal:** Final visual and accessibility validation. ~5-7 minutes execution.

---

### Phase 5: Documentation (P2, Optional)
**Run as time permits:**
1. 1.6-UNIT-008 to 1.6-UNIT-010 (Documentation checks)

**Goal:** Validate developer documentation. ~10 seconds execution.

---

## Coverage Gaps & Notes

### âœ… Full Coverage
All 8 acceptance criteria have dedicated test scenarios.

### âš ï¸ Potential Gaps

1. **Dark mode compatibility** (AC2 mentions "future-proofing"):
   - **Gap:** No tests for dark mode CSS variables
   - **Recommendation:** Add when dark mode is prioritized (Epic 6+)
   - **Risk:** Low (not in current scope)

2. **Browser compatibility testing**:
   - **Gap:** No explicit cross-browser E2E tests
   - **Recommendation:** Run E2E suite on Chrome, Firefox, Safari
   - **Risk:** Medium (modern browsers should support CSS custom properties)

3. **Animation specifications** (mentioned in frontend-spec):
   - **Gap:** No animation testing in this story
   - **Recommendation:** Defer to component-specific stories
   - **Risk:** Low (animations are polish, not functionality)

### ðŸ“‹ Test Data Requirements

- **Color hex values:** From frontend-spec-new.md (Previa palette)
- **Contrast ratios:** Calculated from spec (7.2:1, 5.1:1, 3.2:1)
- **Component list:** Button, Card, Form, Input, Table, Dialog, Modal (from AC4)
- **Status colors:** Green (#10B981), Amber (#F59E0B), Red (#EF4444), Blue (#3B82F6)

---

## Implementation Guidance

### Test File Locations
Per story requirements: `src/test/design-system/`

**Recommended structure:**
```
src/test/design-system/
â”œâ”€â”€ unit/
â”‚   â”œâ”€â”€ tailwind-config.test.ts          # 1.6-UNIT-001 to 1.6-UNIT-003
â”‚   â”œâ”€â”€ css-custom-properties.test.ts    # 1.6-UNIT-004, 1.6-UNIT-005
â”‚   â”œâ”€â”€ typography-config.test.ts        # 1.6-UNIT-006
â”‚   â”œâ”€â”€ financial-colors.test.ts         # 1.6-UNIT-007
â”‚   â”œâ”€â”€ contrast-ratios.test.ts          # 1.6-UNIT-011, 1.6-UNIT-012
â”‚   â””â”€â”€ documentation.test.ts            # 1.6-UNIT-008 to 1.6-UNIT-010
â”œâ”€â”€ integration/
â”‚   â”œâ”€â”€ color-application.test.tsx       # 1.6-INT-001 to 1.6-INT-004
â”‚   â”œâ”€â”€ font-loading.test.tsx            # 1.6-INT-005 to 1.6-INT-007
â”‚   â”œâ”€â”€ shadcn-theming.test.tsx          # 1.6-INT-008 to 1.6-INT-011
â”‚   â”œâ”€â”€ financial-status-colors.test.tsx # 1.6-INT-012 to 1.6-INT-015
â”‚   â”œâ”€â”€ accessibility.test.tsx           # 1.6-INT-016, 1.6-INT-017
â”‚   â””â”€â”€ design-tokens.test.tsx           # 1.6-INT-018, 1.6-INT-019
â””â”€â”€ e2e/
    â”œâ”€â”€ visual-consistency.spec.ts       # 1.6-E2E-001, 1.6-E2E-003
    â”œâ”€â”€ accessibility-flow.spec.ts       # 1.6-E2E-004
    â”œâ”€â”€ responsive-behavior.spec.ts      # 1.6-E2E-005
    â””â”€â”€ financial-typography.spec.ts     # 1.6-E2E-002
```

### Testing Frameworks
- **Unit/Integration:** Vitest (already configured)
- **E2E:** Playwright (recommended) or Cypress
- **Accessibility:** axe-core or @testing-library/jest-dom

### Sample Test Implementation

**Example: 1.6-UNIT-002 (Color hex validation)**
```typescript
// src/test/design-system/unit/tailwind-config.test.ts
import { describe, it, expect } from 'vitest';
import tailwindConfig from '../../../tailwind.config';

describe('1.6-UNIT-002: Previa color hex values', () => {
  it('should match frontend specification exactly', () => {
    const previaColors = tailwindConfig.theme.extend.colors.previa;

    expect(previaColors.cream).toBe('#F2E9D8');
    expect(previaColors.stone).toBe('#8C877D');
    expect(previaColors.sand).toBe('#D9C8B4');
    expect(previaColors.charcoal).toBe('#403B31');
    expect(previaColors.darkStone).toBe('#595347');
  });
});
```

**Example: 1.6-INT-016 (Focus indicators)**
```typescript
// src/test/design-system/integration/accessibility.test.tsx
import { describe, it, expect } from 'vitest';
import { render, screen } from '@testing-library/react';
import { Button } from '@/components/ui/button';

describe('1.6-INT-016: Focus indicators', () => {
  it('should display visible focus outline with sand color', () => {
    render(<Button>Test Button</Button>);
    const button = screen.getByRole('button');

    button.focus();

    const styles = window.getComputedStyle(button);
    expect(styles.outlineWidth).toBe('2px');
    expect(styles.outlineColor).toContain('sand'); // Match sand color
  });
});
```

**Example: 1.6-E2E-004 (Keyboard navigation)**
```typescript
// src/test/design-system/e2e/accessibility-flow.spec.ts
import { test, expect } from '@playwright/test';

test('1.6-E2E-004: Keyboard navigation across components', async ({ page }) => {
  await page.goto('/design-system-showcase');

  // Tab through interactive elements
  await page.keyboard.press('Tab');
  await expect(page.locator('button:focus')).toBeVisible();

  // Verify focus indicator visible
  const focusedButton = page.locator('button:focus');
  const outline = await focusedButton.evaluate(el =>
    window.getComputedStyle(el).outlineWidth
  );
  expect(outline).toBe('2px');

  // Continue tabbing through all components
  for (let i = 0; i < 10; i++) {
    await page.keyboard.press('Tab');
    await expect(page.locator(':focus')).toBeVisible();
  }
});
```

---

## Quality Checklist

âœ… **Coverage:**
- [x] Every AC has test coverage (8/8 covered)
- [x] Test levels are appropriate (unit for config, integration for components, E2E for workflows)
- [x] No duplicate coverage across levels (unit validates config, integration validates runtime, E2E validates UX)
- [x] Priorities align with business risk (P0 for foundational colors/accessibility, P1 for polish, P2 for docs)

âœ… **Test Design:**
- [x] Test IDs follow naming convention (1.6-LEVEL-SEQ)
- [x] Scenarios are atomic and independent
- [x] Justifications explain level selection
- [x] Risk mitigations documented

âœ… **Execution:**
- [x] Clear execution order defined (config â†’ integration â†’ E2E)
- [x] P0 tests run first (fail fast)
- [x] Fast feedback loop (<5 min for all P0/P1 tests)

---

## Gate YAML Block

```yaml
test_design:
  scenarios_total: 31
  by_level:
    unit: 12
    integration: 14
    e2e: 5
  by_priority:
    p0: 16
    p1: 11
    p2: 4
  coverage_gaps: []
  estimated_execution_time:
    unit: "30 seconds"
    integration: "3-4 minutes"
    e2e: "5-7 minutes"
    total: "8-12 minutes"
  critical_tests:
    - "1.6-UNIT-002: Color hex validation"
    - "1.6-UNIT-011/012: Contrast ratios"
    - "1.6-INT-012-015: Financial status colors"
    - "1.6-E2E-004: Keyboard navigation"
  blockers:
    - "Design system bugs affect ALL Epic 2+ UI work"
    - "Accessibility failures block deployment"
```

---

## Summary for Trace Requirements

**Test design matrix:** `docs/qa/assessments/1.6-test-design-20251010.md`
**P0 tests identified:** 16
**P1 tests identified:** 11
**Critical coverage:** Color palette, accessibility, financial status colors, shadcn theming
**Estimated total execution time:** 8-12 minutes (fast feedback)

**Next Step:** Run `*trace` command to create Given-When-Then requirements mapping.

---

**End of Test Design Document**
