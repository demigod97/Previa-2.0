# Risk Profile: Story 1.8 – Transform PolicyAI to Previa Financial Dashboard

Date: 2025-10-11
Reviewer: Quinn (Test Architect)

## Executive Summary

- Total Risks Identified: 11
- Critical Risks: 1
- High Risks: 3
- Medium Risks: 6
- Low Risks: 1
- Overall Risk Score: 65/100 (calculated by deductions)

Key drivers: AI chat markdown rendering (XSS), webhook/auth boundaries with N8N, transactional consistency for reconciliation writes, and observability gaps. Performance risks are moderate and manageable with lazy loading and virtualization.

## Critical Risks Requiring Immediate Attention

### 1) SEC-001: XSS via Markdown rendering in Chat responses

- Score: 9 (High probability × High impact)
- Probability: High — AI responses may include untrusted markdown/HTML content; common risk without strict sanitization
- Impact: High — Stored/Reflected XSS could compromise sessions and data
- Mitigation:
  - Sanitize markdown with a strict allowlist (e.g., DOMPurify with sanitize + disallow inline event handlers and iframes)
  - Render code blocks safely; disable raw HTML in markdown parser
  - Escape all dynamic fields in message UI components
  - Add Content Security Policy (CSP) where feasible
- Testing Focus: Unit tests on renderer sanitization; integration tests rendering hostile payloads; e2e attempt basic XSS vectors

## Risk Distribution

### By Category

- Security (SEC): 4
- Technical (TECH): 1
- Performance (PERF): 2
- Data (DATA): 2
- Business (BUS): 1
- Operational (OPS): 1

### By Component/Area

- Chat & N8N Integration: SEC-001, SEC-002, OPS-001
- Reconciliation Engine: DATA-001, TECH-001
- Transactions Table & Dashboard: PERF-001, PERF-002, DATA-002
- Uploads/Files: SEC-003
- Tiering/Access: SEC-004
- Delivery/Scope: BUS-001

## Detailed Risk Register

| ID | Category | Title | Probability | Impact | Score | Priority |
| --- | --- | --- | --- | --- | --- | --- |
| SEC-001 | security | XSS via Markdown in Chat | High (3) | High (3) | 9 | Critical |
| SEC-002 | security | Unauthenticated/weakly-authenticated N8N webhook | Medium (2) | High (3) | 6 | High |
| DATA-001 | data | Non-atomic reconciliation update (partial writes) | Medium (2) | High (3) | 6 | High |
| OPS-001 | operational | Missing monitoring/alerting for chat/recon flows | High (3) | Medium (2) | 6 | High |
| PERF-001 | performance | Initial load > 3.5s due to chart libs/assets | Medium (2) | Medium (2) | 4 | Medium |
| TECH-001 | technical | Drag-and-drop race conditions/state loss | Medium (2) | Medium (2) | 4 | Medium |
| DATA-002 | data | Chart aggregation timezone/rounding errors | Medium (2) | Medium (2) | 4 | Medium |
| PERF-002 | performance | Transactions table jank without virtualization | Medium (2) | Medium (2) | 4 | Medium |
| SEC-003 | security | Receipt upload file validation (type/size) | Low (1) | High (3) | 3 | Low |
| BUS-001 | business | Scope creep impacting 1.8 delivery window | Medium (2) | Medium (2) | 4 | Medium |
| SEC-004 | security | Tier enforcement client-only (no server checks) | Medium (2) | Medium (2) | 4 | Medium |

### Mitigations, Testing Requirements, and Owners

- SEC-001 (XSS via Markdown)
  - Strategy: Preventive
  - Actions: Strict markdown sanitization; disable raw HTML; CSP; escape outputs
  - Testing: Unit sanitization tests; hostile markdown integration tests; e2e smoke
  - Owner: dev (frontend)
  - Timeline: Before enabling chat in Phase 3

- SEC-002 (N8N webhook auth)
  - Strategy: Preventive
  - Actions: Require signed requests or JWT; secret rotation; IP allowlists if possible
  - Testing: Integration tests for 401/403; negative tests for missing/invalid signature
  - Owner: dev/integration
  - Timeline: Prior to shipping chat messaging

- DATA-001 (Non-atomic reconciliation)
  - Strategy: Preventive/Corrective
  - Actions: Use RPC or serverless edge function to wrap insert+update in a single transaction; verify RLS behaviors
  - Testing: Integration tests asserting both records and status change; rollback on failure
  - Owner: dev/backend
  - Timeline: With Phase 4 implementation

- OPS-001 (No monitoring/alerting)
  - Strategy: Detective
  - Actions: Add Sentry/console error forwarding, HTTP error logging, and basic uptime checks for N8N
  - Testing: Simulate API failures and verify alerts/logs present
  - Owner: dev/ops
  - Timeline: Before wider testing; no later than end of Phase 3

- PERF-001 (Initial load)
  - Strategy: Preventive
  - Actions: Lazy-load chart libs; code-split routes; compress assets; cache policies
  - Testing: E2E TTI measurement; bundle analyzer targets
  - Owner: dev/frontend
  - Timeline: Phase 2

- TECH-001 (DnD state loss)
  - Strategy: Preventive
  - Actions: Centralize state; debounce operations; idempotent UI updates; optimistic updates with rollback
  - Testing: Integration tests for drag/drop under rapid events
  - Owner: dev/frontend
  - Timeline: Phase 4

- DATA-002 (Chart aggregation)
  - Strategy: Preventive
  - Actions: Normalize to UTC; explicit rounding; unit tests for boundaries
  - Testing: Unit tests with tz cases; snapshot diffs
  - Owner: dev/frontend
  - Timeline: Phase 2

- PERF-002 (Table performance)
  - Strategy: Preventive
  - Actions: Virtualize long lists; pagination server-side; memoize selectors
  - Testing: Integration test for 1k rows; FPS sampling in dev
  - Owner: dev/frontend
  - Timeline: Phase 5

- SEC-003 (Upload validation)
  - Strategy: Preventive
  - Actions: Accept-list mime/size checks; scan in backend (if available); block executable payloads
  - Testing: Negative tests for invalid files; e2e upload failure path
  - Owner: dev/backend
  - Timeline: Phase 4 (upload entry point)

- BUS-001 (Scope creep)
  - Strategy: Process
  - Actions: Guard rail with acceptance criteria; defer non-MVP; use sprint change proposal when needed
  - Testing: N/A
  - Owner: sm/po
  - Timeline: Continuous through 1.8

- SEC-004 (Tier enforcement)
  - Strategy: Preventive
  - Actions: Enforce server-side via RLS/policies; client UI reflects, not enforces
  - Testing: Integration tests for unauthorized access blocked
  - Owner: dev/backend
  - Timeline: Before enabling premium-only UI pathways

## Risk-Based Testing Strategy

Prioritize P0 scenarios from the Test Design:

1. Security: Sanitization tests (SEC-001), webhook auth negative tests (SEC-002)
2. Data Integrity: Reconciliation atomicity tests (DATA-001)
3. Observability: Induce failures and assert logs/alerts (OPS-001)
4. Performance: TTI checks and list virtualization thresholds (PERF-001/002)

Coordinate with existing scenarios in `1.8-test-design-20251011.md` and elevate any gaps to P0 where risks are high.

## Risk Acceptance Criteria

- Must fix before production: All Critical (score 9) and High (score 6) risks
- Can proceed with mitigation: Medium risks with compensating controls
- Documented acceptance: Any Low risks kept for later with owner and timeline

---

Risk profile: docs/qa/assessments/1.8-risk-20251011.md

---

## Gate YAML (paste under risk_summary)

```yaml
risk_summary:
  totals:
    critical: 1
    high: 3
    medium: 6
    low: 1
  highest:
    id: SEC-001
    score: 9
    title: 'XSS via Markdown in Chat'
  recommendations:
    must_fix:
      - 'Sanitize markdown & disable raw HTML (SEC-001)'
      - 'Authenticate/sign N8N webhook requests (SEC-002)'
      - 'Make reconciliation writes atomic (DATA-001)'
    monitor:
      - 'Add monitoring/alerting for failures (OPS-001)'
      - 'Watch initial load size and lazy-load charts (PERF-001)'
```
