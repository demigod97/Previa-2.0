# Test Design: Story 1.8 – Transform PolicyAI to Previa Financial Dashboard

Date: 2025-10-11
Designer: Quinn (Test Architect)
Story: 1.8 – docs/stories/1.8.transform-policyai-to-previa-dashboard.md
Sources: Frontend Spec (docs/frontend-spec-new.md), Project Brief (docs/Project Brief.md)

## Strategy Overview

Goal: Validate Phases 1–5 for a cohesive, shadcn/ui-based financial dashboard that aligns with the Project Brief and the Frontend Spec. We will prioritize functional coverage for navigation, widgets, chat, reconciliation, and the transactions table, plus essential NFRs: accessibility, responsiveness, and performance.

- Test levels: unit for logic, integration for component–store–API wiring, e2e for user journeys.
- Data: Use seeded demo user and financial fixtures noted in the story (accounts, transactions, receipts, matches).
- UI Conventions: Verify use of shadcn/ui components and Previa design tokens (cream/sand/charcoal/darkStone), emoji icons in nav (🏠 🔄 📊 💬 ⚙️), and layout structure per spec.
- Environments: Headless browser for e2e (Playwright), component tests with React Testing Library, unit with Vitest.

Totals (initial plan):
- Total scenarios: 30
- By level: unit 12, integration 11, e2e 7
- By priority: P0 12, P1 12, P2 6

Recommended execution order:
1) P0 Unit ⇒ 2) P0 Integration ⇒ 3) P0 E2E ⇒ 4) P1 set ⇒ 5) P2 set.

## Mapping to Acceptance Criteria (by Phase)

### Phase 1 – Dashboard Layout & Navigation
AC: sidebar renders; routes accessible; layout accommodates sidebar; mobile bottom bar; build succeeds.

Scenarios
| ID | Level | Priority | Test | Justification |
| --- | --- | --- | --- | --- |
| 1.8-UNIT-001 | unit | P0 | Sidebar config exports 5 items with emojis (🏠 🔄 📊 💬 ⚙️) and paths | Prevents routing drift and icon omissions |
| 1.8-UNIT-002 | unit | P1 | TopBar renders user avatar/notifications given mock user | Basic header resilience |
| 1.8-UNIT-003 | unit | P1 | Responsive helpers toggle classes at 768px/1024px breakpoints | Enforces spec breakpoints |
| 1.8-INT-001 | integration | P0 | Clicking each sidebar item updates route and active state style (sand background, darkStone left border) | Functional navigation |
| 1.8-INT-002 | integration | P0 | Mobile viewport (<768px): bottom nav visible; sidebar hidden; routes remain accessible | Mobile-first compliance |
| 1.8-E2E-001 | e2e | P0 | Smoke: Load app → navigate across 🏠/🔄/📊/💬/⚙️ without errors; layout persists | Primary user journey |

### Phase 2 – Dashboard Widgets
AC: 4 widgets render with real data; charts correct; unreconciled alert accurate; responsive.

Scenarios
| ID | Level | Priority | Test | Justification |
| --- | --- | --- | --- | --- |
| 1.8-UNIT-004 | unit | P0 | Aggregation util computes daily totals for Monthly Spending from seeded transactions | Chart correctness |
| 1.8-UNIT-005 | unit | P0 | Unreconciled count selector filters status = 'unreconciled' | Alert accuracy |
| 1.8-INT-003 | integration | P1 | Monthly Spending Card renders line chart with darkStone line; hover tooltip shows amount+date | Spec conformance |
| 1.8-INT-004 | integration | P1 | Income vs Expenses renders grouped bars (green/red) for current vs previous month | Visual accuracy |
| 1.8-INT-005 | integration | P1 | Widget grid collapses to 1-column on mobile | Responsive layout |
| 1.8-E2E-002 | e2e | P0 | Dashboard shows 4 widgets and Recent Transactions list reflects latest 5 entries | End-user validation |

### Phase 3 – Chat Assistant
AC: panel opens/closes; send/receive; history persists; prompts relevant; citations link to data.

Scenarios
| ID | Level | Priority | Test | Justification |
| --- | --- | --- | --- | --- |
| 1.8-UNIT-006 | unit | P0 | useFinancialChat manages message state, pending flag, and retries with backoff on 429/5xx | Robust client behavior |
| 1.8-UNIT-007 | unit | P1 | Starter prompts list renders when history empty | UX readiness |
| 1.8-INT-006 | integration | P0 | Open shadcn Sheet from 💬; send message; mock N8N returns JSON with citations; messages render (markdown) | Core flow |
| 1.8-INT-007 | integration | P1 | HoverCard shows citation details (transaction/receipt preview) | Traceability |
| 1.8-E2E-003 | e2e | P0 | User asks “What did I spend on groceries this month?” → assistant replies; session reload shows persisted history | Value and persistence |

### Phase 4 – Reconciliation Engine
AC: list unmatched; drag/drop to preview; approve/reject; DB+UI update; confidence score shown.

Scenarios
| ID | Level | Priority | Test | Justification |
| --- | --- | --- | --- | --- |
| 1.8-UNIT-008 | unit | P0 | useReconciliation: fetchUnmatched, createMatch, updateStatus transitions | Business logic |
| 1.8-UNIT-009 | unit | P1 | Confidence score formatter (0–100%) and label High/Medium/Low | UI correctness |
| 1.8-INT-008 | integration | P0 | Drag TransactionCard onto ReceiptCard triggers preview with Progress circle and AI explanation | UX + wiring |
| 1.8-INT-009 | integration | P0 | Approve creates record in reconciliation_matches and sets transaction status 'matched' | Data integrity |
| 1.8-INT-010 | integration | P1 | Reject returns items to lists; toast shows “Match rejected” | Negative path |
| 1.8-E2E-004 | e2e | P0 | End-to-end: select unmatched → match with receipt → approve → item disappears from unmatched; success toast | Critical journey |

### Phase 5 – Transactions Table
AC: show all transactions; sorting/filter/search; batch actions; pagination; edit modal.

Scenarios
| ID | Level | Priority | Test | Justification |
| --- | --- | --- | --- | --- |
| 1.8-UNIT-010 | unit | P0 | Comparator for amount/date sorting; stable sort | Deterministic ordering |
| 1.8-UNIT-011 | unit | P1 | Filter predicate for status/category/date range | Query logic |
| 1.8-UNIT-012 | unit | P2 | CSV export utility produces correct headers and row count | Data export |
| 1.8-INT-011 | integration | P0 | Data Table renders with pagination (10/25/50/100), column visibility toggles, selection | Feature parity |
| 1.8-INT-012 | integration | P1 | Batch categorize updates selected rows; undo on failure | Batch operations |
| 1.8-INT-013 | integration | P1 | Edit modal validates and updates transaction | Edit flow |
| 1.8-E2E-005 | e2e | P0 | Search “Uber” + status=Unreconciled + last 30 days → results filtered; paginate; export CSV | Realistic task |

## Cross-Cutting NFR Scenarios

| ID | Level | Priority | Test | Justification |
| --- | --- | --- | --- | --- |
| 1.8-INT-014 | integration | P0 | Accessibility smoke with axe: no critical violations on key views (🏠, 🔄, 📊, 💬) | WCAG AA baseline |
| 1.8-INT-015 | integration | P1 | Keyboard-only nav: focus ring (sand) visible; Esc closes dialogs; Enter activates primary | A11y interactions |
| 1.8-INT-016 | integration | P1 | Responsive snapshots at 360×780, 768×1024, 1440×900 | Breakpoint assurance |
| 1.8-E2E-006 | e2e | P1 | Cold load TTI < 3.5s on desktop sample, charts lazy-load | Perf user impact |
| 1.8-E2E-007 | e2e | P2 | Error handling: failed N8N call shows retry; failed upload shows red badge | Resilience UX |

## Tooling & Fixtures

- Unit/Integration: Vitest + React Testing Library + MSW for API mocks.
- E2E: Playwright with storage state for seeded demo user.
- a11y: axe-core/Playwright.
- Data: use existing seed scripts/migrations referenced in the story; create MSW fixtures for chat and reconciliation endpoints.

## Success Criteria & Risks

- PASS if all P0 scenarios green and no critical a11y/perf issues.
- Risks: chart library flakiness, drag/drop timing, citation hover rendering in virtualized lists.
- Mitigations: deterministic seeds, retryable assertions, mock time for animations, MSW for API stability.

## Scenario Index (Counts)

- Scenarios total: 30
- By level: unit 12, integration 11, e2e 7
- By priority: P0 12, P1 12, P2 6

## Notes on Spec & Layout Conformance

- Sidebar uses shadcn Sheet/Sidebar; emoji icons per spec; active item styled with sand background + darkStone left border.
- Widgets are shadcn Cards with charts (darkStone line/bars), amounts in JetBrains Mono.
- Chat uses shadcn Sheet, ScrollArea, Textarea; citations via HoverCard.
- Reconciliation uses ResizablePanelGroup; Transaction/Receipt cards are shadcn Cards; Matching uses Progress circle and Button group (✅/❌/✏️).
- Transactions view uses shadcn Data Table with Popover/Calendar/DropdownMenu.

---

### Gate Block (paste into gate file)

test_design:
  scenarios_total: 30
  by_level:
    unit: 12
    integration: 11
    e2e: 7
  by_priority:
    p0: 12
    p1: 12
    p2: 6
  coverage_gaps: []

---

Test design matrix: docs/qa/assessments/1.8-test-design-20251011.md
