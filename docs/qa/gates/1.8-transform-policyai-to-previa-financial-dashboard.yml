schema: 1
story: '1.8'
story_title: 'Transform PolicyAI to Previa Financial Dashboard'
gate: FAIL
status_reason: 'Critical XSS risk in chat markdown (SEC-001) and other high-risk gaps present.'
reviewer: 'Quinn (Test Architect)'
updated: '2025-10-11T00:00:00Z'

top_issues:
  - id: 'SEC-001'
    severity: high
    finding: 'Chat markdown renderer allows potential XSS without strict sanitization'
    suggested_action: 'Sanitize markdown, disable raw HTML, escape outputs, consider CSP'
  - id: 'SEC-002'
    severity: high
    finding: 'N8N webhook lacks strong authentication/signature enforcement'
    suggested_action: 'Require JWT/signature validation and rotate secrets; IP allowlists if possible'
  - id: 'DATA-001'
    severity: high
    finding: 'Reconciliation write path may be non-atomic, risking partial updates'
    suggested_action: 'Wrap insert+update in a single transaction via RPC/function; verify RLS'
  - id: 'OPS-001'
    severity: medium
    finding: 'Missing monitoring/alerting for failures in chat/reconciliation flows'
    suggested_action: 'Add Sentry/logging/alerts and uptime checks for N8N endpoints'
  - id: 'PERF-001'
    severity: medium
    finding: 'Initial load may exceed target due to chart libs/assets'
    suggested_action: 'Lazy-load charts, code-split routes, compress assets'

waiver: { active: false }

# Extended fields
quality_score: 50

evidence:
  tests_reviewed: 30
  risks_identified: 11
  trace:
    ac_covered: []
    ac_gaps: []

test_design:
  scenarios_total: 30
  by_level:
    unit: 12
    integration: 11
    e2e: 7
  by_priority:
    p0: 12
    p1: 12
    p2: 6
  coverage_gaps: []

risk_summary:
  totals:
    critical: 1
    high: 3
    medium: 6
    low: 1
  highest:
    id: SEC-001
    score: 9
    title: 'XSS via Markdown in Chat'
  recommendations:
    must_fix:
      - 'Sanitize markdown & disable raw HTML (SEC-001)'
      - 'Authenticate/sign N8N webhook requests (SEC-002)'
      - 'Make reconciliation writes atomic (DATA-001)'
    monitor:
      - 'Add monitoring/alerting for failures (OPS-001)'
      - 'Watch initial load size and lazy-load charts (PERF-001)'

nfr_validation:
  security:
    status: FAIL
    notes: 'Critical XSS risk in chat markdown (SEC-001); webhook auth gaps (SEC-002)'
  performance:
    status: CONCERNS
    notes: 'Chart libs may affect TTI; ensure lazy-loading/code-splitting'
  reliability:
    status: CONCERNS
    notes: 'Reconciliation atomicity/rollback patterns not yet verified'
  maintainability:
    status: CONCERNS
    notes: 'Test coverage for P0 scenarios pending; monitoring/observability gaps'

recommendations:
  immediate:
    - action: 'Implement markdown sanitization and disable raw HTML in renderer'
      refs: ['src/components/chat/*']
    - action: 'Add request signing/JWT for N8N webhook and enforce verification'
      refs: ['src/hooks/useFinancialChat.ts', 'n8n']
    - action: 'Make reconciliation writes atomic and verify RLS'
      refs: ['src/hooks/useReconciliation.ts', 'supabase/functions']
  future:
    - action: 'Virtualize large tables and profile list rendering'
      refs: ['src/pages/TransactionsView.tsx']
    - action: 'Establish monitoring and alerting for core flows'
      refs: ['src/*']
