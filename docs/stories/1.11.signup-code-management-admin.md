# Story 1.11: Sign-up Code Management (Admin Interface)

## Status
Draft

## Epic
Epic 1: Foundation & Core Services

## Story
**As a** super admin,
**I want** to manage sign-up codes with CRUD operations, expiry dates, and usage limits,
**so that** I can control platform access and track code usage.

## Context Source
- Source Document: User request + Staff role system (Story 1.10)
- Enhancement Type: New feature (admin management interface)
- Existing System Impact: Adds admin UI for signup_codes table created in Story 1.9

## Acceptance Criteria

### AC1: Admin Access Control
- [ ] Admin interface is only accessible to users with 'super_admin' role
- [ ] Redirect non-admin users to dashboard if they try to access admin pages
- [ ] Admin navigation item only visible to super_admin users
- [ ] Team members (role='team') can view codes but cannot create/edit/delete

### AC2: Sign-up Code List View
- [ ] Display table of all signup codes with columns:
  - Code (masked partially for security, e.g., "PREVI******25")
  - Status (Active/Inactive badge)
  - Usage (X / Y uses, or "Unlimited")
  - Expiry (Date or "No expiry")
  - Created date
  - Last used (Date or "Never")
  - Actions (View, Edit, Deactivate/Activate, Delete)
- [ ] Sortable columns (click header to sort)
- [ ] Filter by status (Active, Inactive, Expired, All)
- [ ] Search by code
- [ ] Pagination (25 codes per page)

### AC3: Create Sign-up Code
- [ ] "Create Code" button opens modal/form
- [ ] Form fields:
  - Code (text input, auto-generate button option)
  - Usage Limit (number input, checkbox for "Unlimited")
  - Expiry Date (date picker, checkbox for "No expiry")
  - Notes (textarea, optional)
- [ ] Code validation:
  - Must be unique
  - Minimum 6 characters
  - Alphanumeric only (no spaces or special chars)
- [ ] Success toast on creation
- [ ] Refresh list after creation

### AC4: Edit Sign-up Code
- [ ] Click "Edit" opens modal with current code details
- [ ] Can modify:
  - Usage limit (can increase but not decrease below used_count)
  - Expiry date (can extend but not shorten to past)
  - Notes
  - Active status (toggle)
- [ ] Cannot modify:
  - Code itself (security - would break existing links)
  - Used count (read-only)
- [ ] Validation prevents invalid changes
- [ ] Success toast on update

### AC5: Deactivate/Activate Code
- [ ] Quick toggle button to activate/deactivate without opening edit modal
- [ ] Confirmation dialog: "Are you sure you want to deactivate [CODE]?"
- [ ] Deactivated codes cannot be used for sign-ups
- [ ] Deactivated codes remain in database for audit trail
- [ ] Success toast on status change

### AC6: Delete Sign-up Code
- [ ] Delete button with confirmation dialog
- [ ] Warning: "Permanently delete code [CODE]? This cannot be undone."
- [ ] Soft delete or hard delete decision:
  - If never used: Hard delete (remove from DB)
  - If used: Soft delete (mark as deleted but keep for audit)
- [ ] Success toast on deletion
- [ ] Refresh list after deletion

### AC7: View Code Details & Usage Stats
- [ ] Click code to view detail modal
- [ ] Show full code (unmasked)
- [ ] Show complete metadata:
  - Creation date and creator (if tracked)
  - Total uses / limit
  - Last used date and time
  - Expiry date
  - Notes
- [ ] Usage history (future enhancement placeholder)
- [ ] Copy code button (with "Copied!" feedback)

### AC8: Code Generation Helper
- [ ] "Generate Code" button creates random secure code
- [ ] Generated format: "PREVIA-XXXX-XXXX" (where X is alphanumeric)
- [ ] User can modify generated code before saving
- [ ] Check uniqueness on generation

## Dev Technical Guidance

### Existing System Context
**Database Schema (from Stories 1.9 & 1.10):**
```sql
-- Already exists
public.signup_codes (
  id UUID,
  code TEXT UNIQUE,
  is_active BOOLEAN,
  use_limit INTEGER,
  used_count INTEGER,
  expiry_date TIMESTAMPTZ,
  created_by UUID REFERENCES auth.users,
  created_at TIMESTAMPTZ,
  last_used_at TIMESTAMPTZ,
  notes TEXT
)

public.staff_roles (
  user_id UUID,
  role TEXT ('team' | 'super_admin')
)

-- Helper functions
public.is_super_admin(user_id UUID) RETURNS BOOLEAN
public.is_staff_member(user_id UUID) RETURNS BOOLEAN
```

**Current User Tier System:**
- User tiers: 'user', 'premium_user' (payment tiers)
- Staff roles: 'team', 'super_admin' (platform admin)
- Completely separate systems

### Integration Approach
**Admin Route Structure:**
```typescript
/admin                          # Admin dashboard (future)
/admin/signup-codes             # Sign-up code management (this story)
/admin/signup-codes/:id         # Code detail view
```

**Component Architecture:**
```
src/
  pages/
    admin/
      SignUpCodeManagement.tsx        # Main admin page
  components/
    admin/
      SignUpCodeList.tsx              # Table of codes
      SignUpCodeForm.tsx              # Create/Edit modal
      SignUpCodeDetails.tsx           # Detail view modal
      CodeGeneratorButton.tsx         # Generate code button
      ProtectedAdminRoute.tsx         # Route guard component
    ui/
      DataTable.tsx                   # Reusable table component
```

### Technical Constraints
- **Security:**
  - All mutations must check user is super_admin via RLS
  - Team members: read-only access (SELECT only)
  - Regular users: no access (RLS blocks)
  - Never expose full code in list view (mask it)

- **Data Validation:**
  - Usage limit cannot be decreased below used_count
  - Expiry date cannot be set to past
  - Code uniqueness must be enforced
  - Code format: alphanumeric, 6-32 characters

- **UX Requirements:**
  - Fast list rendering (virtual scrolling for 100+ codes)
  - Optimistic UI updates (update UI immediately, rollback on error)
  - Loading states for all async operations
  - Error handling with retry options

### File Locations
```
src/
  pages/
    admin/
      SignUpCodeManagement.tsx        # Main page
  components/
    admin/
      SignUpCodeList.tsx
      SignUpCodeForm.tsx
      SignUpCodeDetails.tsx
      CodeGeneratorButton.tsx
      ProtectedAdminRoute.tsx
  hooks/
    admin/
      useSignUpCodes.ts               # CRUD operations hook
      useCodeGenerator.ts             # Code generation logic
  lib/
    admin/
      codeValidation.ts               # Validation utilities
  types/
    admin.ts                          # Admin-specific types
```

### Testing Requirements
**Unit Tests:**
- Code generator uniqueness
- Code validation rules
- Usage limit validation
- Expiry date validation

**Integration Tests:**
- Admin access control (super_admin, team, regular user)
- CRUD operations with RLS
- Optimistic UI updates
- Error handling and rollback

**E2E Tests:**
- Complete code management flow
- Access control enforcement
- Form validation

## Tasks / Subtasks

### Task 1: Create Admin Route Protection (AC1)
- [ ] Create `src/components/admin/ProtectedAdminRoute.tsx`:
  ```typescript
  import { useStaffRole } from '@/hooks/staff/useStaffRole';
  import { Navigate } from 'react-router-dom';

  export const ProtectedAdminRoute = ({ 
    children, 
    requireSuperAdmin = false 
  }: { 
    children: React.ReactNode; 
    requireSuperAdmin?: boolean 
  }) => {
    const { isSuperAdmin, isStaffMember, loading } = useStaffRole();

    if (loading) return <div>Loading...</div>;
    
    if (requireSuperAdmin && !isSuperAdmin) {
      return <Navigate to="/" replace />;
    }
    
    if (!requireSuperAdmin && !isStaffMember) {
      return <Navigate to="/" replace />;
    }

    return <>{children}</>;
  };
  ```
- [ ] Add route in `src/App.tsx`:
  ```typescript
  <Route 
    path="/admin/signup-codes" 
    element={
      <ProtectedAdminRoute requireSuperAdmin={true}>
        <SignUpCodeManagement />
      </ProtectedAdminRoute>
    } 
  />
  ```
- [ ] Test: Super admin can access
- [ ] Test: Team member redirected
- [ ] Test: Regular user redirected

### Task 2: Add Admin Navigation (AC1)
- [ ] Update `src/components/layout/Sidebar.tsx`:
  - Add "Admin" section (conditionally rendered)
  - Show only if `isSuperAdmin` or `isStaffMember`
  - Add "Sign-up Codes" link
- [ ] Style admin section differently (e.g., border, icon)
- [ ] Add admin icon (e.g., Shield, Settings)
- [ ] Test visibility with different user roles

### Task 3: Create useSignUpCodes Hook (AC2-AC7)
- [ ] Create `src/hooks/admin/useSignUpCodes.ts`:
  ```typescript
  import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
  import { supabase } from '@/integrations/supabase/client';

  export const useSignUpCodes = () => {
    const queryClient = useQueryClient();

    // Fetch all codes
    const { data: codes, isLoading } = useQuery({
      queryKey: ['signup-codes'],
      queryFn: async () => {
        const { data, error } = await supabase
          .from('signup_codes')
          .select('*')
          .order('created_at', { ascending: false });
        
        if (error) throw error;
        return data;
      }
    });

    // Create code
    const createCode = useMutation({
      mutationFn: async (codeData: SignUpCodeCreate) => {
        const { data, error } = await supabase
          .from('signup_codes')
          .insert(codeData)
          .select()
          .single();
        
        if (error) throw error;
        return data;
      },
      onSuccess: () => {
        queryClient.invalidateQueries({ queryKey: ['signup-codes'] });
      }
    });

    // Update code
    const updateCode = useMutation({
      mutationFn: async ({ id, updates }: { id: string; updates: SignUpCodeUpdate }) => {
        const { data, error } = await supabase
          .from('signup_codes')
          .update(updates)
          .eq('id', id)
          .select()
          .single();
        
        if (error) throw error;
        return data;
      },
      onSuccess: () => {
        queryClient.invalidateQueries({ queryKey: ['signup-codes'] });
      }
    });

    // Toggle active status
    const toggleActive = useMutation({
      mutationFn: async ({ id, isActive }: { id: string; isActive: boolean }) => {
        const { error } = await supabase
          .from('signup_codes')
          .update({ is_active: isActive })
          .eq('id', id);
        
        if (error) throw error;
      },
      onSuccess: () => {
        queryClient.invalidateQueries({ queryKey: ['signup-codes'] });
      }
    });

    // Delete code
    const deleteCode = useMutation({
      mutationFn: async (id: string) => {
        const { error } = await supabase
          .from('signup_codes')
          .delete()
          .eq('id', id);
        
        if (error) throw error;
      },
      onSuccess: () => {
        queryClient.invalidateQueries({ queryKey: ['signup-codes'] });
      }
    });

    return {
      codes,
      isLoading,
      createCode,
      updateCode,
      toggleActive,
      deleteCode
    };
  };
  ```
- [ ] Add TypeScript types for mutations
- [ ] Test each operation

### Task 4: Create Code Generator Utility (AC8)
- [ ] Create `src/hooks/admin/useCodeGenerator.ts`:
  ```typescript
  import { useState } from 'react';
  import { supabase } from '@/integrations/supabase/client';

  export const useCodeGenerator = () => {
    const [isGenerating, setIsGenerating] = useState(false);

    const generateCode = async (): Promise<string> => {
      setIsGenerating(true);
      
      try {
        // Generate format: PREVIA-XXXX-XXXX
        const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; // Exclude ambiguous chars
        const generateSegment = (length: number) => {
          let result = '';
          for (let i = 0; i < length; i++) {
            result += chars[Math.floor(Math.random() * chars.length)];
          }
          return result;
        };

        let code = '';
        let isUnique = false;
        let attempts = 0;

        // Retry until unique code generated
        while (!isUnique && attempts < 10) {
          code = `PREVIA-${generateSegment(4)}-${generateSegment(4)}`;
          
          // Check uniqueness
          const { data } = await supabase
            .from('signup_codes')
            .select('code')
            .eq('code', code)
            .maybeSingle();
          
          isUnique = !data;
          attempts++;
        }

        if (!isUnique) {
          throw new Error('Failed to generate unique code');
        }

        return code;
      } finally {
        setIsGenerating(false);
      }
    };

    return { generateCode, isGenerating };
  };
  ```
- [ ] Test code generation uniqueness
- [ ] Test format consistency

### Task 5: Create SignUpCodeList Component (AC2, AC5)
- [ ] Create `src/components/admin/SignUpCodeList.tsx`:
  - Use shadcn/ui Table component
  - Implement sortable columns
  - Implement filters (Active, Inactive, Expired, All)
  - Implement search input
  - Mask codes in list view (show first 6 chars + "***")
  - Add action buttons (View, Edit, Toggle Active, Delete)
  - Show status badges (Active=green, Inactive=gray, Expired=red)
  - Show usage with progress bar
  - Implement pagination
- [ ] Style with Previa design system
- [ ] Add loading skeleton
- [ ] Add empty state ("No codes yet")
- [ ] Test sorting, filtering, search

### Task 6: Create SignUpCodeForm Component (AC3, AC4)
- [ ] Create `src/components/admin/SignUpCodeForm.tsx`:
  - Create/Edit modal form using shadcn/ui Dialog
  - Form fields:
    - Code input (with generate button)
    - Usage limit input (with "Unlimited" checkbox)
    - Expiry date picker (with "No expiry" checkbox)
    - Notes textarea
    - Active status toggle (edit mode only)
  - Integrate useCodeGenerator for auto-generation
  - Form validation:
    - Code uniqueness check
    - Minimum 6 characters
    - Alphanumeric only
    - Usage limit > 0
    - Expiry date in future
  - Disable fields appropriately in edit mode
  - Show used_count in edit mode (read-only)
- [ ] Implement optimistic UI updates
- [ ] Add loading states
- [ ] Test validation rules
- [ ] Test create and edit modes

### Task 7: Create SignUpCodeDetails Component (AC7)
- [ ] Create `src/components/admin/SignUpCodeDetails.tsx`:
  - Detail view modal using shadcn/ui Dialog
  - Display all code metadata:
    - Full code (unmasked) with copy button
    - Status badge
    - Created date and by (if tracked)
    - Usage stats (X / Y or "Unlimited")
    - Last used date/time
    - Expiry date
    - Notes
  - Copy code functionality with toast feedback
  - Usage history placeholder (future)
- [ ] Style as read-only view
- [ ] Test copy functionality

### Task 8: Create Main SignUpCodeManagement Page (AC2-AC8)
- [ ] Create `src/pages/admin/SignUpCodeManagement.tsx`:
  - Page layout with header
  - "Create Code" button (top-right)
  - Integrate SignUpCodeList component
  - Handle modal states for create/edit/details
  - Integrate useSignUpCodes hook
  - Handle toast notifications for all actions
  - Add page-level loading state
  - Add error boundary
- [ ] Implement confirmation dialogs for destructive actions
- [ ] Test complete user flow

### Task 9: Implement Validation Utilities (AC3, AC4)
- [ ] Create `src/lib/admin/codeValidation.ts`:
  ```typescript
  export const validateCode = (code: string): { valid: boolean; error?: string } => {
    if (code.length < 6) {
      return { valid: false, error: 'Code must be at least 6 characters' };
    }
    if (code.length > 32) {
      return { valid: false, error: 'Code cannot exceed 32 characters' };
    }
    if (!/^[A-Za-z0-9-]+$/.test(code)) {
      return { valid: false, error: 'Code can only contain letters, numbers, and hyphens' };
    }
    return { valid: true };
  };

  export const validateUsageLimit = (
    limit: number | null, 
    usedCount: number
  ): { valid: boolean; error?: string } => {
    if (limit === null) return { valid: true }; // Unlimited
    if (limit < usedCount) {
      return { 
        valid: false, 
        error: `Usage limit cannot be less than current usage (${usedCount})` 
      };
    }
    if (limit <= 0) {
      return { valid: false, error: 'Usage limit must be greater than 0' };
    }
    return { valid: true };
  };

  export const validateExpiryDate = (
    date: Date | null
  ): { valid: boolean; error?: string } => {
    if (date === null) return { valid: true }; // No expiry
    if (date < new Date()) {
      return { valid: false, error: 'Expiry date cannot be in the past' };
    }
    return { valid: true };
  };

  export const maskCode = (code: string): string => {
    if (code.length <= 6) return code;
    return code.substring(0, 6) + '******';
  };
  ```
- [ ] Test all validation functions
- [ ] Test edge cases

### Task 10: Add TypeScript Type Definitions (AC2-AC8)
- [ ] Update `src/types/admin.ts`:
  ```typescript
  export interface SignUpCode {
    id: string;
    code: string;
    is_active: boolean;
    use_limit: number | null;
    used_count: number;
    expiry_date: string | null;
    created_by: string | null;
    created_at: string;
    last_used_at: string | null;
    notes: string | null;
  }

  export interface SignUpCodeCreate {
    code: string;
    is_active?: boolean;
    use_limit?: number | null;
    expiry_date?: string | null;
    notes?: string | null;
  }

  export interface SignUpCodeUpdate {
    use_limit?: number | null;
    expiry_date?: string | null;
    notes?: string | null;
    is_active?: boolean;
  }

  export interface SignUpCodeFilters {
    status: 'all' | 'active' | 'inactive' | 'expired';
    search: string;
  }
  ```

### Task 11: Integration Testing (AC1-AC8)
- [ ] Test: Admin access control (super_admin only)
- [ ] Test: Team member can view but not modify
- [ ] Test: Create code with all options
- [ ] Test: Edit code with validation
- [ ] Test: Toggle active/inactive status
- [ ] Test: Delete code (used vs unused)
- [ ] Test: Code generator uniqueness
- [ ] Test: Sorting and filtering
- [ ] Test: Search functionality
- [ ] Test: Pagination
- [ ] Test: Optimistic updates and rollback on error
- [ ] Test: Copy code functionality
- [ ] Test: All validation rules
- [ ] Write automated tests for:
  - Component rendering
  - CRUD operations
  - Access control
  - Validation

### Task 12: UI/UX Polish (AC2-AC8)
- [ ] Responsive design (mobile, tablet, desktop)
- [ ] Loading skeletons for table
- [ ] Empty states ("No codes", "No results")
- [ ] Error states (retry buttons)
- [ ] Success/error toast notifications
- [ ] Confirmation dialogs for destructive actions
- [ ] Keyboard shortcuts (ESC to close modals, etc.)
- [ ] Accessibility (ARIA labels, keyboard navigation)
- [ ] Test on multiple screen sizes
- [ ] Test keyboard-only navigation

## Risk Assessment

### Implementation Risks
- **Primary Risk**: Accidentally exposing all codes to non-admin users
- **Mitigation**: RLS policies strictly enforce super_admin access, test with different user roles
- **Verification**: Penetration testing of admin endpoints

- **Secondary Risk**: Race condition in code generation (duplicate codes)
- **Mitigation**: Database UNIQUE constraint + retry logic in generator
- **Verification**: Load test code generation

### Rollback Plan
- Remove admin routes
- Remove admin components
- Keep database schema (from Stories 1.9 & 1.10)
- Admin can still use SQL editor to manage codes

### Safety Checks
- [ ] RLS policies tested with non-admin users
- [ ] Validation prevents data corruption
- [ ] Optimistic updates have rollback logic
- [ ] Delete confirmation prevents accidents

## Definition of Done
- [ ] All acceptance criteria met and tested
- [ ] Admin interface accessible only to super_admin users
- [ ] CRUD operations work correctly
- [ ] Code generator produces unique codes
- [ ] All validation rules enforced
- [ ] Responsive design works on all screen sizes
- [ ] Accessibility standards met (WCAG 2.1 AA)
- [ ] Integration tests pass
- [ ] Code review completed
- [ ] Security review of admin access control
- [ ] User acceptance testing with actual admin user

## Notes
- **Admin Dashboard**: This is the first admin feature - future admin features will follow similar patterns
- **Usage History**: Detailed usage history (who used which code when) is a future enhancement
- **Bulk Operations**: Bulk create/deactivate codes is a future enhancement
- **Analytics**: Usage analytics dashboard is a future enhancement
- **Team Role**: Story specifies team members can view but not modify - this is enforced via RLS policies

