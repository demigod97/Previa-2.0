# Story 1.3: Deploy Database Migrations

## Status
Draft

## Story
**As a** developer,
**I want** to deploy the financial database schema with RLS policies and triggers,
**so that** Previa has a secure, production-ready database foundation for financial data.

## Acceptance Criteria
1. All 3 financial database migrations successfully applied
2. Financial tables exist with proper structure (user_tiers, bank_accounts, bank_statements, transactions, receipts, reconciliation_matches)
3. Row Level Security (RLS) policies active on all financial tables
4. User tier creation trigger functional (auto-creates free tier on signup)
5. Database indexes created for optimal query performance
6. TypeScript types generated and updated for new schema
7. No migration errors or rollback required

## Tasks / Subtasks
- [ ] Verify Supabase CLI configuration (AC: 1)
  - [ ] Check Supabase project connection with `supabase status`
  - [ ] Verify CLI is authenticated and pointing to correct project
  - [ ] Confirm no pending migrations that could conflict
- [ ] Apply Migration 1: Financial Schema (AC: 2, 5)
  - [ ] Run migration `20250109000001_create_financial_schema.sql`
  - [ ] Verify 6 tables created: user_tiers, bank_accounts, bank_statements, transactions, receipts, reconciliation_matches
  - [ ] Confirm UUID primary keys and foreign key relationships
  - [ ] Validate indexes created for performance optimization
  - [ ] Test table constraints and data types
- [ ] Apply Migration 2: RLS Policies (AC: 3)
  - [ ] Run migration `20250109000002_create_financial_rls_policies.sql`
  - [ ] Verify RLS enabled on all 6 financial tables
  - [ ] Test user data isolation (users can only access their own data)
  - [ ] Confirm security policies prevent cross-user data access
- [ ] Apply Migration 3: User Tier Trigger (AC: 4)
  - [ ] Run migration `20250109000003_create_default_tier_trigger.sql`
  - [ ] Test trigger creates free tier on new user signup
  - [ ] Verify default limits: 3 accounts, 50 transactions/month, 10 receipts/month
  - [ ] Confirm updated_at triggers work for timestamp management
- [ ] Validate complete schema deployment (AC: 1, 2, 7)
  - [ ] Run validation queries to confirm all tables and relationships
  - [ ] Test basic CRUD operations on each table
  - [ ] Verify no foreign key constraint violations
  - [ ] Confirm no migration rollback warnings
- [ ] Generate and update TypeScript types (AC: 6)
  - [ ] Run `supabase gen types typescript` to generate new types
  - [ ] Update TypeScript definitions in src/integrations/supabase/
  - [ ] Verify type safety for financial data structures
  - [ ] Test compilation with new types
- [ ] Post-deployment verification (AC: 3, 4, 5)
  - [ ] Test RLS policies with sample queries
  - [ ] Verify trigger functionality with test user creation
  - [ ] Run performance tests on indexed queries
  - [ ] Confirm database connection from application

## Dev Notes

### Previous Story Insights
Story 1.1 preserved Supabase infrastructure. Story 1.2 updated dependencies. This story establishes the core database foundation that all future stories depend on.

### Architecture Context
- **Database:** PostgreSQL with Row Level Security for financial data isolation [Source: architecture/5-backend-architecture-rls-edge-functions-n8n.md]
- **Security Model:** RLS policies ensure users only access their own financial data [Source: architecture/7-security-rls-deterministic-rules.md]
- **Data Model:** 6 core tables for comprehensive financial tracking [Source: architecture/6-data-model-financial-domain.md]

### Migration Files Analysis
**Migration 1: Financial Schema** (`20250109000001_create_financial_schema.sql`) [Source: migration file analysis]
- **Tables:** 6 tables with UUID primary keys and proper relationships
- **user_tiers:** Freemium model with tier limits (free: 3 accounts, 50 trans/month, 10 receipts/month)
- **bank_accounts:** Institution, account details, masked account numbers
- **bank_statements:** PDF/CSV uploads with processing status
- **transactions:** Individual transaction records with categorization
- **receipts:** OCR-processed receipt data with confidence scores
- **reconciliation_matches:** AI-matched transaction-receipt pairs

**Migration 2: RLS Policies** (`20250109000002_create_financial_rls_policies.sql`) [Source: migration file]
- **Security:** Row Level Security on all 6 financial tables
- **Isolation:** Users can only access their own financial data
- **Defense in Depth:** Database-level security preventing data leakage

**Migration 3: Triggers** (`20250109000003_create_default_tier_trigger.sql`) [Source: migration file]
- **Auto-tier Creation:** Trigger creates free tier on user signup
- **Default Limits:** 3 accounts, 50 transactions/month, 10 receipts/month
- **Timestamp Management:** Auto-update timestamps on record changes

### Database Schema Structure
**Core Financial Tables:** [Source: architecture/6-data-model-financial-domain.md]
```sql
user_tiers: User tier management (free/premium limits)
bank_accounts: User's bank account details
bank_statements: Uploaded statement files
transactions: Individual transaction records
receipts: Uploaded receipt files with OCR data
reconciliation_matches: AI-matched transaction-receipt pairs
```

**Key Relationships:**
- All tables reference auth.users(id) with CASCADE delete
- bank_statements → bank_accounts (foreign key)
- transactions → bank_accounts (foreign key)
- reconciliation_matches → transactions + receipts (foreign keys)

### Supabase CLI Commands
**Migration Deployment:**
```bash
# Check current status
supabase status

# Apply all pending migrations
supabase db push

# Generate TypeScript types
supabase gen types typescript --local > src/integrations/supabase/types.ts
```

**Validation Queries:** [Source: handoff document validation steps]
```sql
-- Verify tables created
SELECT table_name FROM information_schema.tables WHERE table_schema = 'public' AND table_name LIKE '%financial%';

-- Check RLS policies
SELECT schemaname, tablename, policyname FROM pg_policies WHERE schemaname = 'public';

-- Test tier trigger
INSERT INTO auth.users (id, email) VALUES (gen_random_uuid(), 'test@example.com');
```

### Technical Constraints
- **Production-ready migrations** - Must work without rollback [Source: TECHNICAL-DECISIONS.md#5]
- **RLS enforcement** - All financial data must be user-isolated [Source: architecture/7-security-rls-deterministic-rules.md]
- **Performance optimization** - Indexes required for query performance [Source: architecture/6-data-model-financial-domain.md]
- **Type safety** - TypeScript types must match database schema [Source: architecture/1-goals-scope-constraints.md]

### Error Handling and Rollback
**Common Issues:**
- Supabase CLI not authenticated
- Conflicting migrations from PolicyAi schema
- RLS policy conflicts
- Type generation failures

**Rollback Strategy:**
- Migration files are designed to be rerunnable
- Each migration includes IF NOT EXISTS checks
- Manual rollback available via Supabase dashboard if needed

### Testing
**Validation Testing:**
- SQL queries to verify table creation and relationships
- RLS policy testing with multiple user contexts
- Trigger testing with new user creation simulation
- Performance testing on indexed queries

**Integration Testing:**
- Application startup with new database schema
- TypeScript compilation with generated types
- Basic CRUD operations through Supabase client

Test file location: Database validation queries and manual testing
Testing frameworks: SQL queries, Supabase CLI validation, manual verification
Specific testing requirements: RLS isolation, trigger functionality, type safety

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-09 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results
*Results from QA Agent review will be added here*