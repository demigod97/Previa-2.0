# Story 1.5: Setup Testing Infrastructure

## Status
Draft

## Story
**As a** developer,
**I want** to establish comprehensive testing infrastructure for Previa,
**so that** financial features can be tested reliably with proper mock data and coverage reporting.

## Acceptance Criteria
1. Vitest testing framework properly configured for React and TypeScript
2. Financial mock data fixtures available for all major entities
3. Test utilities created for Supabase and authentication mocking
4. Sample test files demonstrate testing patterns for financial components
5. Coverage reporting configured with appropriate exclusions
6. Test scripts available for different testing scenarios (unit, integration, watch)
7. Testing documentation available for developers

## Tasks / Subtasks
- [ ] Verify Vitest configuration (AC: 1)
  - [ ] Review vitest.config.ts for proper React and TypeScript support
  - [ ] Ensure jsdom environment for DOM testing
  - [ ] Verify path aliases work correctly (@/ imports)
  - [ ] Check test setup file configuration
- [ ] Enhance financial mock data fixtures (AC: 2)
  - [ ] Review existing src/test/fixtures/financial-data.ts
  - [ ] Ensure all 6 database entities have comprehensive mock data
  - [ ] Add edge cases: failed processing, reconciliation mismatches
  - [ ] Create helper functions for generating test data variations
  - [ ] Add type safety for all mock data structures
- [ ] Create Supabase testing utilities (AC: 3)
  - [ ] Create mock Supabase client for testing
  - [ ] Add authentication mocking utilities
  - [ ] Create RLS policy testing helpers
  - [ ] Add database query mocking patterns
  - [ ] Create file upload mocking utilities
- [ ] Write sample test files (AC: 4)
  - [ ] Create unit test example for financial calculations
  - [ ] Add component test example for transaction display
  - [ ] Write integration test for reconciliation matching
  - [ ] Create authentication flow test
  - [ ] Add file upload component test
- [ ] Configure coverage reporting (AC: 5)
  - [ ] Verify coverage reporters (text, json, html)
  - [ ] Review exclusions for test files and configuration
  - [ ] Set coverage thresholds for financial domain code
  - [ ] Ensure coverage includes TypeScript and React components
- [ ] Setup test scripts and utilities (AC: 6)
  - [ ] Verify npm test scripts in package.json
  - [ ] Add test:watch for development workflow
  - [ ] Create test:coverage for CI/CD reporting
  - [ ] Add test database reset utilities if needed
- [ ] Create testing documentation (AC: 7)
  - [ ] Document testing patterns for financial components
  - [ ] Create guide for using mock data fixtures
  - [ ] Document Supabase mocking strategies
  - [ ] Add examples of different test types
  - [ ] Create troubleshooting guide for common test issues

## Dev Notes

### Previous Story Insights
Stories 1.1-1.4 established foundation. This story ensures quality through testing infrastructure before building financial features in Epic 2+.

### Architecture Context
- **Testing Strategy:** Unit, integration, and E2E testing for financial accuracy [Source: architecture/9-observability-testing.md]
- **Mock Data Approach:** Comprehensive fixtures over real data for privacy and determinism [Source: TECHNICAL-DECISIONS.md#4]
- **Type Safety:** All tests must be TypeScript compatible [Source: architecture/1-goals-scope-constraints.md]

### Current Testing Infrastructure Analysis
**Vitest Configuration:** [Source: vitest.config.ts analysis]
- ✅ **Framework:** Vite + React + TypeScript support configured
- ✅ **Environment:** jsdom for DOM testing
- ✅ **Path Aliases:** @/ imports configured for src/ directory
- ✅ **Coverage:** Multiple reporters (text, json, html) with exclusions
- ✅ **Setup:** Points to src/test-setup.ts (needs verification)

**Mock Data Fixtures:** [Source: src/test/fixtures/financial-data.ts analysis]
- ✅ **Comprehensive:** User tiers, bank accounts, transactions, receipts
- ✅ **Schema Aligned:** Matches database migration structure
- ✅ **Type Safe:** TypeScript types for all fixtures
- ✅ **Realistic Data:** Commonwealth Bank, ANZ, Westpac examples
- ✅ **Edge Cases:** Free vs Premium tiers, various transaction types

### Testing Requirements for Financial Domain
**Financial Accuracy Testing:** [Source: TECHNICAL-DECISIONS.md#2]
- Currency calculations (avoid floating-point errors)
- OCR threshold validation (90% confidence)
- Reconciliation matching algorithm (95% auto-approve)
- Date handling across timezones
- File processing validation

**Security Testing:** [Source: architecture/7-security-rls-deterministic-rules.md]
- RLS policy enforcement
- User data isolation
- Authentication flow protection
- File upload security validation

**Performance Testing:**
- Large transaction list rendering
- File upload progress tracking
- Database query optimization validation
- Real-time reconciliation updates

### Mock Data Enhancement Requirements
**Current Mock Data Coverage:** [Source: src/test/fixtures/financial-data.ts]
- ✅ User tiers (free and premium)
- ✅ Bank accounts (3 institutions)
- ✅ Bank statements (PDF and CSV)
- ✅ Transactions (10 varied examples)
- ✅ Receipts (5 with OCR data)
- ✅ Reconciliation matches (4 confidence levels)

**Additional Mock Data Needed:**
- Failed OCR processing scenarios
- Processing timeout situations
- File upload error cases
- Network failure simulations
- Invalid file format attempts

### Testing Utilities Requirements
**Supabase Mocking:** [Source: architecture/3-high-level-architecture.md]
- Mock supabase client for offline testing
- RLS policy testing without real database
- File storage mocking for uploads
- Real-time subscription mocking

**Authentication Mocking:** [Source: architecture/4-frontend-architecture-auth-roles-chat-uploads.md]
- User session simulation
- Role-based access testing
- Auth state transitions
- Protected route testing

### Sample Test Structure
**Unit Tests:**
```typescript
// Financial calculations
// Component rendering
// Utility functions
// Validation schemas
```

**Integration Tests:**
```typescript
// Reconciliation matching workflow
// File upload and processing
// Authentication flows
// Database operations
```

**E2E Tests:**
```typescript
// Complete user workflows
// Onboarding process
// Document processing pipeline
// Export functionality
```

### Testing Scripts Configuration
**Package.json Scripts:** [Source: package.json analysis]
- ✅ `npm test` - Run Vitest
- ✅ `npm run test:ui` - Vitest UI mode
- ✅ `npm run test:run` - Single run for CI

**Additional Scripts Needed:**
- `npm run test:watch` - Watch mode for development
- `npm run test:coverage` - Coverage report generation
- `npm run test:integration` - Integration tests only

### Coverage Configuration
**Current Coverage Setup:** [Source: vitest.config.ts]
- ✅ Reporters: text, json, html
- ✅ Exclusions: node_modules, test files, dist, configs

**Coverage Thresholds for Financial Code:**
- Statements: 80% minimum
- Branches: 75% minimum
- Functions: 80% minimum
- Lines: 80% minimum

### Technical Constraints
- **Financial Accuracy:** Tests must validate precise currency calculations [Source: TECHNICAL-DECISIONS.md]
- **Type Safety:** All test code must be TypeScript [Source: architecture/1-goals-scope-constraints.md]
- **Deterministic:** Tests must be repeatable and not flaky [Source: TECHNICAL-DECISIONS.md#4]
- **Fast:** Unit tests should run quickly for developer feedback [Source: architecture/9-observability-testing.md]

### Documentation Requirements
**Testing Guide Topics:**
- How to write tests for financial calculations
- Mocking Supabase in different scenarios
- Testing file upload components
- Testing authentication flows
- Using mock data fixtures effectively

### Testing
**Infrastructure Testing:**
- Verify test runner starts without errors
- Test mock data loads correctly
- Validate coverage reporting works
- Check TypeScript compilation in tests

**Sample Test Validation:**
- Run example tests to ensure patterns work
- Verify Supabase mocking functions
- Test authentication state simulation
- Validate file upload mocking

Test file location: `src/test/` directory structure
Testing frameworks: Vitest + React Testing Library + jsdom
Specific testing requirements: Financial accuracy, security isolation, type safety

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-09 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results
*Results from QA Agent review will be added here*