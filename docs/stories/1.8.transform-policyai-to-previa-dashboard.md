# Story 1.8: Transform PolicyAI to Previa Financial Dashboard

## Status
In Progress

## Story
**As a** Previa user,
**I want** a comprehensive financial intelligence dashboard with AI chat, reconciliation, and transaction management,
**so that** I can efficiently manage my finances, reconcile transactions with receipts, and get AI-powered insights.

## Overview

This story documents the transformation of the PolicyAI notebook/chat system into Previa's financial intelligence platform, aligning with the Project Brief requirements and Frontend Specification.

---

## ‚úÖ Completed Work (Story 1.7 & Prerequisites)

### Database Schema & Migration
- [x] Created `user_tiers` table in Supabase cloud
- [x] Created `bank_accounts` table
- [x] Created `bank_statements` table
- [x] Created `transactions` table
- [x] Created `receipts` table
- [x] Created `reconciliation_matches` table
- [x] Applied migration: `20251011001852_force_create_user_tiers.sql`
- [x] Applied migration: `20251011002746_seed_sample_financial_data.sql`

### Sample Data Seeding
- [x] Created user tier record for user `273fb674-b87b-4604-89d5-41ab0b46d356` (Free tier)
- [x] Added 2 bank accounts (Commonwealth Bank, Westpac)
- [x] Added 10 transactions (mix of income/expenses)
- [x] Added 4 receipts with OCR data
- [x] Added 4 reconciliation matches (AI-matched pairs)

### Type Definitions & Hooks
- [x] Created `src/types/financial.ts` (UserTier, UserTierData, TierLimits)
- [x] Created `src/hooks/financial/useUserTier.ts`
- [x] Created `src/hooks/financial/useBankAccounts.ts`
- [x] Created `src/hooks/financial/useTransactions.ts`
- [x] Created `src/hooks/financial/useReceipts.ts`
- [x] Updated `src/integrations/supabase/types.ts` with financial schema

### Components - Tier System
- [x] Created `src/components/auth/TierDisplay.tsx` (tier badge, limits, usage)
- [x] Created `src/components/auth/UpgradePrompt.tsx` (premium upgrade modal)
- [x] Created `src/lib/tierValidation.ts` (validation utilities)
- [x] Updated `src/contexts/AuthContext.tsx` (integrated tier data)

### Components - Dashboard
- [x] Updated `src/components/dashboard/UserGreetingCard.tsx`:
  - Removed PolicyAI role display (administrator/executive/board)
  - Added tier badge in header (‚ú® Free / üëë Premium)
  - Added 3-column tier limits display
  - Applied Previa design system colors
- [x] Updated `src/pages/Dashboard.tsx`:
  - Removed mock data and demo alerts
  - Connected to real database via hooks
  - Added Financial Overview Cards (accounts, transactions, receipts)
  - Added Recent Transactions list with formatting
  - Added Bank Accounts list with balances
  - Applied Previa design system

### Testing & Validation
- [x] Created unit tests for tier validation logic (29/29 passing)
- [x] Created integration tests for useUserTier hook (5/7 passing)
- [x] Frontend build successful (2.89s, no errors)
- [x] Verified data displays correctly for user `273fb674-b87b-4604-89d5-41ab0b46d356`

---

## üéØ Transformation Plan: PolicyAI ‚Üí Previa

### Phase 1: Dashboard Layout Restructure ‚úÖ COMPLETE
**Goal**: Transform basic dashboard into comprehensive financial hub with sidebar navigation

#### 1.1 Create Sidebar Navigation Component ‚úÖ
- [x] Create `src/components/layout/Sidebar.tsx`
  - [x] Add Previa logo at top
  - [x] Add navigation items:
    - [x] üè† Home
    - [x] üîÑ Reconciliation
    - [x] üìä Transactions
    - [x] üí¨ Chat
    - [x] ‚öôÔ∏è Settings
  - [x] Add user menu at bottom:
    - [x] Avatar/initials
    - [x] Email display
    - [x] Tier badge
    - [x] Sign out button
  - [x] Add active/hover/inactive states (sand/cream/transparent)
  - [x] Make responsive (collapsible on tablet, bottom nav on mobile)

#### 1.2 Create Top Bar Component ‚úÖ
- [x] Create `src/components/layout/TopBar.tsx`
  - [x] Add user avatar dropdown (right)
  - [x] Add notifications bell icon
  - [x] Add search bar (optional for MVP)
  - [x] Apply Previa colors

#### 1.3 Update Dashboard Layout ‚úÖ
- [x] Update `src/pages/Dashboard.tsx`:
  - [x] Integrate Sidebar component (persistent left, 240px)
  - [x] Integrate TopBar component
  - [x] Adjust main content area to accommodate sidebar
  - [x] Ensure responsive behavior
  - [x] Test layout on desktop/tablet/mobile

#### 1.4 Setup Routing for New Views ‚úÖ
- [x] Update `src/App.tsx` or router:
  - [x] Add route: `/` or `/dashboard` ‚Üí Dashboard (Home view)
  - [x] Add route: `/reconciliation` ‚Üí ReconciliationView (placeholder)
  - [x] Add route: `/transactions` ‚Üí TransactionsView (placeholder)
  - [x] Add route: `/chat` ‚Üí ChatView (placeholder)
  - [x] Add route: `/settings` ‚Üí Settings (updated with new layout)

#### 1.5 Create Placeholder Pages ‚úÖ
- [x] Create `src/pages/ReconciliationView.tsx` (basic placeholder)
- [x] Create `src/pages/TransactionsView.tsx` (basic placeholder)
- [x] Create `src/pages/ChatView.tsx` (basic placeholder)

---

### Phase 2: Dashboard Widgets ‚úÖ COMPLETE
**Goal**: Add financial insight widgets to home dashboard

#### 2.1 Monthly Spending Chart Widget ‚úÖ
- [x] Create `src/components/widgets/MonthlySpendingChart.tsx`
  - [x] Use shadcn Card component
  - [x] Integrate chart library (recharts)
  - [x] Add period selector (This Month / Last 3 Months / Year)
  - [x] Fetch transaction data and aggregate by day/week/month
  - [x] Line chart with Previa colors (darkStone line)
  - [x] Hover tooltips showing amount + date

#### 2.2 Income vs Expenses Chart Widget ‚úÖ
- [x] Create `src/components/widgets/IncomeVsExpensesChart.tsx`
  - [x] Use shadcn Card component
  - [x] Bar chart (grouped bars)
  - [x] Legend (Income: green, Expenses: red)
  - [x] Current month vs previous month comparison
  - [x] Use JetBrains Mono for amounts

#### 2.3 Unreconciled Items Alert Widget ‚úÖ
- [x] Create `src/components/widgets/UnreconciledAlert.tsx`
  - [x] Use shadcn Card with Alert styling
  - [x] Warning triangle icon (amber)
  - [x] Count of unmatched transactions
  - [x] "Review Now" button ‚Üí navigate to reconciliation view
  - [x] Fetch count from transactions where status = 'unreconciled'
  - [x] Success state when all reconciled

#### 2.4 Integrate Widgets into Dashboard ‚úÖ
- [x] Update `src/pages/Dashboard.tsx`:
  - [x] Add 2x2 widget grid (stacked on mobile)
  - [x] Position: Monthly Spending (top-left)
  - [x] Position: Income vs Expenses (top-right)
  - [x] Position: Unreconciled Alert (bottom-left)
  - [x] Position: Recent Transactions (bottom-right)
  - [x] Ensure responsive grid layout
  - [x] Added Transaction type and transformations

---

### Phase 3: Chat Interface Integration ‚úÖ COMPLETE
**Goal**: Bring PolicyAI chat functionality into Previa as AI financial assistant

#### 3.1 Port Chat Components from PolicyAI ‚úÖ
- [x] Review `docs/_archive/backup_src/src/components/notebook/ChatArea.tsx`
- [x] Create `src/components/chat/FinancialChatPanel.tsx`
  - [x] Copy chat message rendering logic
  - [x] Update styling to Previa colors (cream/sand/charcoal)
  - [x] Replace "notebook" context with "financial data"
  - [x] Update placeholder prompts:
    - [x] "What did I spend on groceries this month?"
    - [x] "Show me duplicate transactions"
    - [x] "Categorize my Uber transactions"
    - [x] "What's my biggest expense category?"

#### 3.2 Create Chat Message Components ‚úÖ
- [x] Create `src/components/chat/ChatMessage.tsx`
  - [x] User messages (right-aligned, sand background)
  - [x] AI responses (left-aligned, cream background)
  - [x] Timestamps (small, stone color)
  - [x] Citation hover cards (point to transactions/receipts)
  - [x] Markdown rendering for AI responses

#### 3.3 Create Chat Input Component ‚úÖ
- [x] Create `src/components/chat/ChatInput.tsx`
  - [x] shadcn Textarea (auto-resize)
  - [x] Send button (or Ctrl+Enter)
  - [x] Ctrl+Enter keyboard shortcut support
  - [x] Loading state during AI response

#### 3.4 Integrate Chat Panel ‚úÖ
**Option B: Full-Page View** (Implemented)
- [x] Create dedicated `/chat` route
- [x] Full-page chat interface
- [x] Navigate from sidebar
- [x] Citation detail dialog for transaction/receipt references

#### 3.5 Chat Data Integration ‚úÖ
- [x] Create `src/hooks/useFinancialChat.ts`
  - [x] Fetch chat history from `n8n_chat_histories`
  - [x] Send message to N8N webhook
  - [x] Handle AI responses with citations
  - [x] Maintain message state
  - [x] Real-time message updates via Supabase subscriptions
- [ ] Update N8N workflow for financial queries
  - [ ] Replace policy document RAG with transaction/receipt RAG
  - [ ] Update system prompt for financial context
  - [ ] Ensure citations point to financial data
  - **Note**: N8N workflow updates are backend work and will be handled separately

---

### Phase 4: Reconciliation View ‚úÖ COMPLETE
**Goal**: Create core reconciliation engine UI

#### 4.1 Create Reconciliation Layout ‚úÖ
- [x] Create `src/pages/ReconciliationView.tsx`
  - [x] Use shadcn ResizablePanelGroup (3 panels)
  - [x] Left panel (40%): Unmatched Transactions
  - [x] Right panel (40%): Receipts Library
  - [x] Center panel (20%): Matching Preview (conditional)

#### 4.2 Unmatched Transactions Panel (Left) ‚úÖ
- [x] Create `src/components/reconciliation/TransactionCard.tsx`
  - [x] Date (top-left)
  - [x] Description (main text)
  - [x] Amount (top-right, JetBrains Mono, red/green)
  - [x] Category badge (if auto-categorized)
  - [x] "Match" button
  - [x] Drag handle for drag-and-drop
- [x] Add filters to panel:
  - [x] Search input for description
  - [x] Category dropdown (shadcn Select)
- [x] Fetch unmatched transactions (status = 'unreconciled')
- [x] shadcn ScrollArea for list

#### 4.3 Receipts Library Panel (Right) ‚úÖ
- [x] Create `src/components/reconciliation/ReceiptCard.tsx`
  - [x] Icon placeholder (FileText icon)
  - [x] Merchant name
  - [x] Date
  - [x] Amount (JetBrains Mono)
  - [x] Confidence badge (High/Medium/Low based on OCR score)
  - [x] "Match" button
  - [x] Drop target for drag-and-drop
- [x] Add grid/list toggle (shadcn Tabs)
- [x] Upload receipt button (placeholder)
- [x] Fetch receipts from database

#### 4.4 Matching Interface (Center Panel) ‚úÖ
- [x] Create `src/components/reconciliation/MatchingPreview.tsx`
  - [x] Transaction details card
  - [x] Receipt details card
  - [x] Confidence score with progress bar (0-100%)
  - [x] Match analysis with reasons
  - [x] Action buttons:
    - [x] ‚úÖ Approve Match (green button)
    - [x] ‚ùå Reject Match (ghost button)
    - [x] ‚úèÔ∏è Edit Details (optional)
- [x] Handle match approval:
  - [x] Create record in `reconciliation_matches` table
  - [x] Update transaction status to 'matched'
  - [x] Toast notification: "Match approved!"
  - [x] Refresh data after approval

#### 4.5 Reconciliation Data Integration ‚úÖ
- [x] Create `src/hooks/financial/useReconciliation.ts`
  - [x] useUnmatchedTransactions - Fetch unmatched transactions
  - [x] useUnmatchedReceipts - Fetch unmatched receipts
  - [x] useCreateMatch - Create match and update transaction status
  - [x] useDeleteMatch - Delete match (undo)
  - [x] useMatchSuggestions - AI suggestions (placeholder for backend)
- [x] Create `src/types/reconciliation.ts`
  - [x] MatchSuggestion interface
  - [x] ReconciliationMatch interface
  - [x] MatchConfidence type
  - [x] ReconciliationFilters interface
- [x] Update `src/types/financial.ts`
  - [x] Added Receipt interface

#### 4.6 Drag-and-Drop Matching ‚úÖ
- [x] Install @dnd-kit/core, @dnd-kit/utilities, @dnd-kit/sortable
- [x] Make TransactionCard draggable (useDraggable)
- [x] Make ReceiptCard a drop target (useDroppable)
- [x] Visual feedback on hover (ring-2 ring-sand)
- [x] Trigger matching preview on drop

---

### Phase 5: Transactions Table View
**Goal**: Full transaction management with advanced filtering

#### 5.1 Create Transaction Table Component
- [ ] Create `src/pages/TransactionsView.tsx`
- [ ] Use shadcn Data Table pattern
- [ ] Define columns:
  - [ ] Checkbox (select for batch actions)
  - [ ] Date (sortable, format: DD/MM/YYYY)
  - [ ] Description (searchable)
  - [ ] Amount (sortable, right-aligned, JetBrains Mono, red/green)
  - [ ] Category (filterable, badge)
  - [ ] Status (filterable, color-coded badge):
    - [ ] Unreconciled (red badge)
    - [ ] Matched (yellow badge)
    - [ ] Approved (green badge)
    - [ ] Rejected (gray badge)
  - [ ] Actions (shadcn DropdownMenu):
    - [ ] View details
    - [ ] Edit transaction
    - [ ] Reconcile
    - [ ] Delete

#### 5.2 Add Table Toolbar
- [ ] Search input (shadcn Input) - search description
- [ ] Filters button (shadcn Popover):
  - [ ] Date range (shadcn Calendar)
  - [ ] Status checkboxes (Unreconciled/Matched/Approved/Rejected)
  - [ ] Category multi-select
  - [ ] Amount range slider
- [ ] Batch actions dropdown (shadcn DropdownMenu):
  - [ ] "Categorize selected" ‚Üí bulk category update
  - [ ] "Export selected" ‚Üí CSV download
  - [ ] "Delete selected" ‚Üí bulk delete with confirmation
- [ ] View options button:
  - [ ] Column visibility toggles
  - [ ] Density (compact/comfortable/spacious)

#### 5.3 Table Features
- [ ] Column sorting (asc/desc) - click header
- [ ] Column resizing (drag divider)
- [ ] Pagination (shadcn Pagination):
  - [ ] Rows per page selector: 10 / 25 / 50 / 100
  - [ ] Page navigation (Previous/Next)
  - [ ] Total count display
- [ ] Row selection:
  - [ ] Select all checkbox in header
  - [ ] Individual row checkboxes
  - [ ] Selected count badge
- [ ] Empty state:
  - [ ] "No transactions yet" message
  - [ ] Upload prompt button

#### 5.4 Transaction Actions
- [ ] Create `src/hooks/useTransactionActions.ts`
  - [ ] Bulk categorize function
  - [ ] Bulk delete function
  - [ ] Export to CSV function
  - [ ] Update transaction status
- [ ] Create edit transaction modal (shadcn Dialog):
  - [ ] Form fields: date, description, amount, category
  - [ ] Save/Cancel buttons
  - [ ] Validation

#### 5.5 Data Integration
- [ ] Extend `useTransactions` hook:
  - [ ] Add pagination support
  - [ ] Add filtering parameters
  - [ ] Add sorting parameters
- [ ] Fetch all transactions (not just 10 limit)
- [ ] Implement client-side or server-side pagination

---

### Phase 6: Enhanced Dashboard Features
**Goal**: Extract dashboard sections into reusable components

#### 6.1 Extract Financial Overview Cards
- [ ] Create `src/components/dashboard/FinancialOverviewCards.tsx`
  - [ ] Extract from current Dashboard.tsx
  - [ ] Bank Accounts card
  - [ ] Transactions card
  - [ ] Receipts card
  - [ ] Make reusable component

#### 6.2 Extract Recent Transactions List
- [ ] Create `src/components/dashboard/RecentTransactionsList.tsx`
  - [ ] Extract from current Dashboard.tsx
  - [ ] Add "View All" link ‚Üí navigate to /transactions
  - [ ] Show 5 most recent by default

#### 6.3 Extract Bank Accounts List
- [ ] Create `src/components/dashboard/BankAccountsList.tsx`
  - [ ] Extract from current Dashboard.tsx
  - [ ] Add "Add Account" button (placeholder for future)
  - [ ] Add total balance summary

---

### Phase 7: Mobile Responsiveness
**Goal**: Ensure all views work seamlessly on mobile

#### 7.1 Sidebar Mobile Adaptation
- [ ] Tablet (768px - 1024px):
  - [ ] Collapsible sidebar (icons only)
  - [ ] Expand on hover
- [ ] Mobile (<768px):
  - [ ] Bottom navigation bar (5 icons)
  - [ ] Hamburger menu for additional options
  - [ ] User menu in top bar

#### 7.2 Dashboard Mobile Layout
- [ ] Stack widgets vertically on mobile
- [ ] Single column for all cards
- [ ] Touch-friendly tap targets
- [ ] Swipe gestures for widget navigation (optional)

#### 7.3 Reconciliation Mobile Adaptation
- [ ] Single-panel view with tab navigation:
  - [ ] Tab 1: Transactions
  - [ ] Tab 2: Receipts
  - [ ] Tab 3: Matches
- [ ] Full-screen matching preview (modal)
- [ ] Simplified filters (bottom sheet)

#### 7.4 Transactions Table Mobile
- [ ] Card-based layout (not table)
- [ ] Each transaction as a card
- [ ] Swipe actions (left: delete, right: edit)
- [ ] Filter button opens bottom sheet

---

### Phase 8: Polish & Testing
**Goal**: Final polish and comprehensive testing

#### 8.1 Design System Consistency
- [ ] Audit all components for Previa color usage
- [ ] Verify all amounts use JetBrains Mono font
- [ ] Check spacing/padding consistency
- [ ] Verify icon sizes (h-4 w-4 / h-5 w-5)
- [ ] Check button hover states

#### 8.2 Loading States
- [ ] Add skeleton loaders for all data fetches
- [ ] Animated placeholders with Previa colors
- [ ] Loading spinners for async actions
- [ ] Optimistic UI updates (where appropriate)

#### 8.3 Error Handling
- [ ] Error boundaries for each view
- [ ] Toast notifications for errors (Sonner)
- [ ] Retry buttons for failed fetches
- [ ] User-friendly error messages

#### 8.4 Accessibility
- [ ] Keyboard navigation for all interactive elements
- [ ] ARIA labels for icon buttons
- [ ] Focus indicators (ring-2 ring-sand)
- [ ] Screen reader announcements for status changes

#### 8.5 Performance Optimization
- [ ] Lazy load chart libraries
- [ ] Virtualize long transaction lists
- [ ] Debounce search inputs
- [ ] Optimize bundle size (code splitting)

#### 8.6 Testing
- [ ] Unit tests for new hooks
- [ ] Component tests for new UI components
- [ ] Integration tests for reconciliation flow
- [ ] E2E tests for critical user flows:
  - [ ] Upload receipt ‚Üí match ‚Üí approve
  - [ ] Chat query ‚Üí get insights
  - [ ] Filter transactions ‚Üí export
- [ ] Manual testing on:
  - [ ] Desktop (Chrome, Firefox, Safari)
  - [ ] Tablet (iPad, Android)
  - [ ] Mobile (iPhone, Android)

---

## Technical Requirements

### Dependencies to Add
- [ ] `recharts` or `chart.js` - For financial charts
- [ ] `@dnd-kit/core` - For drag-and-drop reconciliation
- [ ] `react-csv` or `papaparse` - For CSV export
- [ ] `date-fns` - For date formatting/manipulation

### Database Schema Validation
- [x] `user_tiers` table exists ‚úÖ
- [x] `bank_accounts` table exists ‚úÖ
- [x] `bank_statements` table exists ‚úÖ
- [x] `transactions` table exists ‚úÖ
- [x] `receipts` table exists ‚úÖ
- [x] `reconciliation_matches` table exists ‚úÖ
- [x] `n8n_chat_histories` table exists ‚úÖ

### N8N Workflow Updates
- [ ] Update chat workflow for financial queries
- [ ] Create reconciliation suggestion workflow
- [ ] Update RAG to use transactions/receipts instead of policies
- [ ] Test webhook endpoints

---

## Acceptance Criteria

### Phase 1 Complete When:
- [ ] Sidebar navigation renders and is functional
- [ ] All routes are accessible via sidebar
- [ ] Dashboard layout accommodates sidebar (no overlap)
- [ ] Mobile responsive navigation works (bottom bar)
- [ ] Build succeeds with no errors

### Phase 2 Complete When:
- [ ] All 4 dashboard widgets render with real data
- [ ] Charts display correct financial data
- [ ] Unreconciled alert shows accurate count
- [ ] Widgets are responsive on all screen sizes

### Phase 3 Complete When:
- [ ] Chat panel opens/closes smoothly
- [ ] Users can send messages and receive AI responses
- [ ] Chat history persists and loads correctly
- [ ] Financial prompts trigger relevant responses
- [ ] Citations link to correct transactions/receipts

### Phase 4 Complete When:
- [ ] Users can view unmatched transactions and receipts
- [ ] Users can drag-and-drop to create matches
- [ ] Matching preview shows confidence score
- [ ] Users can approve/reject matches
- [ ] Matched items update database and UI correctly

### Phase 5 Complete When:
- [ ] Transaction table displays all transactions
- [ ] Sorting, filtering, searching all work
- [ ] Batch actions (categorize, export, delete) work
- [ ] Pagination handles large datasets
- [ ] Edit transaction modal functions correctly

### MVP Complete When:
- [ ] All phases 1-5 are complete
- [ ] All tier limits enforced in UI
- [ ] Mobile responsive on all views
- [ ] Build passes with no errors/warnings
- [ ] Manual testing passes on desktop/tablet/mobile
- [ ] User can complete full reconciliation flow

---

## Design System Reference

### Previa Colors
```typescript
const colors = {
  cream: '#F2E9D8',      // Background, light surfaces
  stone: '#8C877D',      // Secondary text, borders
  sand: '#D9C8B4',       // Accent, hover states, active nav
  charcoal: '#403B31',   // Primary text, headings
  darkStone: '#595347',  // Secondary headings, icons
}
```

### Status Colors
```typescript
const statusColors = {
  success: '#10B981',    // Approved, positive
  warning: '#F59E0B',    // Matched, pending
  error: '#EF4444',      // Unreconciled, rejected
  info: '#3B82F6',       // Processing, in progress
}
```

### Typography
- **Headings**: Inter (Bold/Semibold)
- **Body**: Inter (Regular/Medium)
- **Financial Amounts**: JetBrains Mono

### Component Styling
- **Cards**: `bg-white border-sand`
- **Buttons Primary**: `bg-sand hover:bg-sand/90 text-charcoal`
- **Buttons Secondary**: `bg-cream hover:bg-sand text-charcoal`
- **Badges**: Variant based on status (success/warning/error)

---

## Timeline Estimate

- **Phase 1**: 3-4 days (Sidebar + Layout)
- **Phase 2**: 2-3 days (Dashboard Widgets)
- **Phase 3**: 4-5 days (Chat Integration)
- **Phase 4**: 5-7 days (Reconciliation View)
- **Phase 5**: 4-5 days (Transactions Table)
- **Phase 6**: 2-3 days (Component Extraction)
- **Phase 7**: 3-4 days (Mobile Responsiveness)
- **Phase 8**: 3-4 days (Polish & Testing)

**Total**: ~26-35 days (4-7 weeks)

---

## References

- **Project Brief**: `docs/Project Brief.md`
- **Frontend Spec**: `docs/frontend-spec-new.md`
- **PolicyAI ChatArea**: `docs/_archive/backup_src/src/components/notebook/ChatArea.tsx`
- **PolicyAI Notebook**: `docs/_archive/backup_src/src/pages/Notebook.tsx`
- **Architecture Doc**: `docs/architecure.md`

---

## Notes

### What We're Keeping from PolicyAI:
- ‚úÖ Chat message rendering logic
- ‚úÖ Citation hover cards (adapted for financial data)
- ‚úÖ Message input component
- ‚úÖ Scroll-to-bottom behavior
- ‚úÖ Loading states and animations

### What We're Removing:
- ‚ùå Notebook creation/deletion
- ‚ùå Policy document uploads
- ‚ùå Role-based access (administrator/executive)
- ‚ùå Studio sidebar (notes feature)
- ‚ùå Audio generation

### What We're Transforming:
- üîÑ "Sources" ‚Üí "Bank Accounts + Receipts"
- üîÑ "Notebooks" ‚Üí "Financial Data Context"
- üîÑ "Chat about policies" ‚Üí "Chat about finances"
- üîÑ Blue/gray theme ‚Üí Previa cream/sand/charcoal

---

## Dev Agent Record

**Agent**: Claude Sonnet 4.5 (James)
**Date Started**: 2025-10-11
**Phase 1 Completed**: 2025-10-11

### Agent Model Used
- Claude Sonnet 4.5

### Debug Log References

**Phase 1:**
```bash
npm run build
‚úì built in 2.78s
‚úì 1812 modules transformed
```

**Phase 2:**
```bash
# Install dependencies
npm install recharts date-fns --legacy-peer-deps
‚úì installed successfully

# Build with widgets
npm run build
‚úì built in 4.68s
‚úì 2739 modules transformed
dist/assets/index-CW_D0khI.js    970.06 kB ‚îÇ gzip: 281.33 kB

# Run widget tests
npm test -- src/test/widgets
‚úì 18 tests passing
‚úì MonthlySpendingChart.test.tsx (5 tests) 164ms
‚úì IncomeVsExpensesChart.test.tsx (6 tests) 54ms
‚úì UnreconciledAlert.test.tsx (7 tests) 136ms
```

**Phase 3:**
```bash
# Build with chat components
npm run build
‚úì built in 4.83s
‚úì 2753 modules transformed
dist/assets/index-D3guNgw0.js    1,023.39 kB ‚îÇ gzip: 299.20 kB

# Run chat component tests
npm test -- src/test/chat
‚úì 14 tests passing (2 files)
‚úì ChatMessage.test.tsx (5 tests) 187ms
‚úì ChatInput.test.tsx (9 tests) 270ms
```

**Phase 4:**
```bash
# Install @dnd-kit for drag-and-drop
npm install @dnd-kit/core @dnd-kit/utilities @dnd-kit/sortable --legacy-peer-deps
‚úì added 4 packages

# Build with reconciliation components
npm run build
‚úì built in 12.19s
‚úì 2764 modules transformed
dist/assets/index-BbofKWKx.js    1,104.55 kB ‚îÇ gzip: 325.33 kB
```

### Completion Notes List

**Phase 1: Dashboard Layout Restructure - COMPLETE**

1. **Created Sidebar Navigation Component** (`src/components/layout/Sidebar.tsx`)
   - Implemented responsive sidebar with Previa branding
   - Desktop: Full 240px sidebar with labels and user menu
   - Tablet: Collapsed 80px icon-only sidebar
   - Mobile: Bottom navigation bar
   - Active state highlighting with sand color
   - User avatar with tier badge (Free/Premium)
   - Sign out functionality integrated

2. **Created TopBar Component** (`src/components/layout/TopBar.tsx`)
   - User avatar dropdown menu with tier display
   - Notifications bell icon (ready for future implementation)
   - Dropdown menu with Settings, Billing, and Sign Out
   - Previa color scheme applied

3. **Updated Dashboard Layout** (`src/pages/Dashboard.tsx`)
   - Integrated Sidebar and TopBar components
   - Updated layout to flexbox with sidebar accommodation
   - Responsive margins: lg:ml-64 (desktop), md:ml-20 (tablet)
   - Updated all loading/error states with new layout
   - Maintained all existing financial data display functionality

4. **Added Routing** (`src/App.tsx`)
   - Added /reconciliation route ‚Üí ReconciliationView
   - Added /transactions route ‚Üí TransactionsView
   - Added /chat route ‚Üí ChatView
   - Updated /settings route with new layout
   - All routes protected with ProtectedRoute component

5. **Created Placeholder Pages**
   - `ReconciliationView.tsx`: Placeholder for matching interface
   - `TransactionsView.tsx`: Placeholder for transaction table
   - `ChatView.tsx`: Placeholder for AI assistant
   - All pages use consistent layout (Sidebar + TopBar)

6. **Updated Settings Page** (`src/pages/Settings.tsx`)
   - Integrated Sidebar and TopBar components
   - Maintained tier display and user profile functionality
   - Consistent layout with all other views

**Phase 2: Dashboard Widgets - COMPLETE**

1. **Created Monthly Spending Chart Widget** (`src/components/widgets/MonthlySpendingChart.tsx`)
   - Recharts LineChart implementation
   - Period selector dropdown (This Month / Last 3 Months / Last 12 Months)
   - Dynamic aggregation: daily for month view, weekly for 3 months, monthly for year
   - Total spending display with calculation
   - Filters for expense-type transactions only
   - Previa color scheme (darkStone line, sand grid)
   - Responsive chart with hover tooltips

2. **Created Income vs Expenses Chart Widget** (`src/components/widgets/IncomeVsExpensesChart.tsx`)
   - Recharts BarChart implementation
   - Grouped bars comparing current and previous month
   - Separate income (green) and expenses (red) bars
   - Net income calculation with positive/negative indicators
   - Legend for income vs expenses
   - JetBrains Mono font for amounts
   - Responsive chart layout

3. **Created Unreconciled Alert Widget** (`src/components/widgets/UnreconciledAlert.tsx`)
   - Conditional rendering based on unreconciled count
   - Success state when all transactions reconciled
   - Warning state (amber) when unreconciled items exist
   - Count and total amount display
   - "Review Now" button navigating to /reconciliation
   - Uses absolute values for amount calculation

4. **Extended Transaction Type System** (`src/types/financial.ts`)
   - Added TransactionType: 'income' | 'expense'
   - Created Transaction interface with computed type field
   - Added date alias for widget compatibility

5. **Updated Dashboard Integration** (`src/pages/Dashboard.tsx`)
   - Installed recharts and date-fns dependencies
   - Increased transaction fetch limit to 100 for chart data
   - Added useMemo to transform transactions with type field
   - Created 2x2 responsive widget grid (stacks on mobile)
   - Positioned widgets: Monthly Spending (top-left), Income vs Expenses (top-right), Unreconciled Alert (bottom-left), Recent Transactions (bottom-right)
   - Removed duplicate Recent Transactions and Bank Accounts sections
   - Added loading skeletons for all widgets

6. **Comprehensive Test Coverage**
   - Created `src/test/widgets/MonthlySpendingChart.test.tsx` (5 tests)
   - Created `src/test/widgets/IncomeVsExpensesChart.test.tsx` (6 tests)
   - Created `src/test/widgets/UnreconciledAlert.test.tsx` (7 tests)
   - All tests passing (18/18)
   - Tests cover: rendering, calculations, empty states, edge cases

**Phase 3: Chat Interface Integration - COMPLETE**

1. **Created Message Type Definitions** (`src/types/message.ts`)
   - Adapted from PolicyAI with financial context support
   - Citation interface supports transaction/receipt/bank_account types
   - Transaction-specific fields: transaction_id, transaction_date, transaction_amount
   - Receipt-specific fields: receipt_id, receipt_merchant
   - EnhancedChatMessage interface for full message structure

2. **Created Citation Button Component** (`src/components/chat/CitationButton.tsx`)
   - Previa design system colors (darkStone text, sand border/hover)
   - Circular button with citation index number
   - Hover states with sand background

3. **Created Markdown Renderer** (`src/components/chat/MarkdownRenderer.tsx`)
   - Processes message segments with citation support
   - Handles user messages (inline, no paragraph breaks)
   - Handles AI messages (paragraph formatting, bold text)
   - Citation buttons integrated inline with content
   - Supports both string and structured content formats

4. **Created Chat Message Component** (`src/components/chat/ChatMessage.tsx`)
   - User messages: right-aligned, sand background, charcoal text
   - AI messages: left-aligned, cream background Card, charcoal text
   - Timestamp display with stone color
   - Citation click handler integration
   - Previa design system applied throughout

5. **Created Chat Input Component** (`src/components/chat/ChatInput.tsx`)
   - Auto-resizing Textarea component
   - Send button with loading state (Loader2 spinner)
   - Ctrl+Enter / Cmd+Enter keyboard shortcut support
   - Example questions carousel (financial-specific prompts)
   - Disabled state during message sending
   - Helper text for keyboard shortcuts
   - Previa colors: white background, sand border/buttons

6. **Created Financial Chat Hook** (`src/hooks/useFinancialChat.ts`)
   - Fetches chat history from `n8n_chat_histories` table
   - Sends messages to N8N webhook via `send-chat-message` edge function
   - Transforms N8N message format to EnhancedChatMessage
   - Handles AI responses with JSON-parsed citations
   - Real-time message updates via Supabase Realtime subscriptions
   - Clear chat history functionality with optimistic updates
   - Toast notifications for success/error states

7. **Created Financial Chat Panel** (`src/components/chat/FinancialChatPanel.tsx`)
   - Full-height chat interface with cream background
   - Chat header with Sparkles icon and Clear Chat button
   - ScrollArea for message history
   - Welcome message card for first-time users
   - Pending user message display (optimistic UI)
   - AI loading indicator with bouncing dots (sand colored)
   - Auto-scroll to latest message
   - Financial-specific example questions
   - Footer with disclaimer text
   - Previa design system applied throughout

8. **Updated ChatView Page** (`src/pages/ChatView.tsx`)
   - Replaced placeholder with full FinancialChatPanel integration
   - Citation detail Dialog for showing transaction/receipt details
   - Displays transaction date, amount (formatted with formatCurrency)
   - Displays receipt merchant information
   - Dialog styling with Previa colors
   - Full-page layout with Sidebar and TopBar

9. **Added Currency Formatting Utility** (`src/lib/utils.ts`)
   - `formatCurrency()` function for consistent currency display
   - USD default, configurable currency parameter
   - 2 decimal places, locale-aware formatting

10. **Comprehensive Test Coverage**
    - Created `src/test/chat/ChatMessage.test.tsx` (5 tests)
    - Created `src/test/chat/ChatInput.test.tsx` (9 tests)
    - All tests passing (14/14)
    - Tests cover: user/AI messages, citations, input handling, example questions

### File List

**Created - Phase 1:**
- src/components/layout/Sidebar.tsx
- src/components/layout/TopBar.tsx
- src/components/layout/index.ts
- src/pages/ReconciliationView.tsx
- src/pages/TransactionsView.tsx
- src/pages/ChatView.tsx

**Created - Phase 2:**
- src/components/widgets/MonthlySpendingChart.tsx
- src/components/widgets/IncomeVsExpensesChart.tsx
- src/components/widgets/UnreconciledAlert.tsx
- src/components/widgets/index.ts
- src/test/widgets/MonthlySpendingChart.test.tsx
- src/test/widgets/IncomeVsExpensesChart.test.tsx
- src/test/widgets/UnreconciledAlert.test.tsx

**Created - Phase 3:**
- src/types/message.ts
- src/components/chat/CitationButton.tsx
- src/components/chat/MarkdownRenderer.tsx
- src/components/chat/ChatMessage.tsx
- src/components/chat/ChatInput.tsx
- src/components/chat/FinancialChatPanel.tsx
- src/components/chat/index.ts
- src/hooks/useFinancialChat.ts
- src/test/chat/ChatMessage.test.tsx
- src/test/chat/ChatInput.test.tsx

**Created - Phase 4:**
- src/types/reconciliation.ts
- src/hooks/financial/useReconciliation.ts
- src/components/reconciliation/TransactionCard.tsx
- src/components/reconciliation/ReceiptCard.tsx
- src/components/reconciliation/MatchingPreview.tsx
- src/components/reconciliation/index.ts

**Modified - Phase 1:**
- src/pages/Dashboard.tsx (integrated layout)
- src/pages/Settings.tsx (integrated layout)
- src/App.tsx (added routes)

**Modified - Phase 2:**
- src/types/financial.ts (added Transaction interface and types)
- src/pages/Dashboard.tsx (integrated widgets, updated transaction fetching)
- package.json (added recharts, date-fns dependencies)

**Modified - Phase 3:**
- src/pages/ChatView.tsx (replaced placeholder with FinancialChatPanel)
- src/lib/utils.ts (added formatCurrency function)

**Modified - Phase 4:**
- src/types/financial.ts (added Receipt interface)
- src/hooks/financial/index.ts (exported reconciliation hooks)
- src/pages/ReconciliationView.tsx (replaced placeholder with full implementation)
- package.json (added @dnd-kit dependencies)

### Change Log

**2025-10-11 - Phase 1 Implementation**
- Created Sidebar navigation component with responsive behavior
- Created TopBar with user menu and notifications bell
- Updated Dashboard to use new layout structure
- Added routing for Reconciliation, Transactions, and Chat views
- Created placeholder pages for all new views
- Updated Settings page with new layout
- Build successful: 526.73 kB bundle, no errors
- All components follow Previa design system (cream/sand/charcoal)

**2025-10-11 - Phase 2 Implementation**
- Installed recharts (charting library) and date-fns (date utilities)
- Created MonthlySpendingChart widget with period selector and line chart
- Created IncomeVsExpensesChart widget with bar chart comparison
- Created UnreconciledAlert widget with conditional success/warning states
- Extended Transaction type system in financial.ts
- Updated Dashboard to fetch 100 transactions and transform with type field
- Integrated 2x2 responsive widget grid into Dashboard
- Created comprehensive test suites for all widgets (18 tests passing)
- Build successful: 970.06 kB bundle (recharts adds ~440KB)
- All widgets follow Previa design system with proper color usage

**2025-10-11 - Phase 3 Implementation**
- Created complete chat interface adapted from PolicyAI ChatArea
- Implemented message type system with financial citation support
- Created ChatMessage, ChatInput, CitationButton, and MarkdownRenderer components
- Created FinancialChatPanel with welcome message, example questions, and real-time updates
- Implemented useFinancialChat hook with Supabase Realtime subscriptions
- Updated ChatView with full-page chat interface and citation detail dialog
- Added formatCurrency utility function for consistent currency display
- Created comprehensive test suites for chat components (14 tests passing)
- Build successful: 1,023.39 kB bundle (chat adds ~53KB)
- All chat components follow Previa design system (cream/sand/charcoal)
- N8N workflow updates for financial context deferred to backend work

**2025-10-11 - Phase 4 Implementation**
- Installed @dnd-kit libraries for drag-and-drop (core, utilities, sortable)
- Created reconciliation type definitions (src/types/reconciliation.ts)
- Added Receipt interface to financial types with correct database schema
- Created useReconciliation hook with 5 functions:
  - useUnmatchedTransactions (fetch status='unreconciled')
  - useUnmatchedReceipts (fetch non-matched receipts)
  - useCreateMatch (create match + update transaction status)
  - useDeleteMatch (undo match)
  - useMatchSuggestions (placeholder for AI backend)
- Created TransactionCard component with drag support (useDraggable)
- Created ReceiptCard component with drop target (useDroppable)
- Created MatchingPreview component:
  - Confidence score with progress bar
  - Transaction/receipt details cards
  - Match analysis with automatic reasoning
  - Approve/Reject actions
- Updated ReconciliationView with full 3-panel resizable layout:
  - Left panel: Transaction list with search and category filters
  - Center panel: Matching preview (conditional)
  - Right panel: Receipt library with grid/list toggle
  - Drag-and-drop matching with visual feedback
  - Confidence score calculation algorithm (amount + date + merchant)
- Build successful: 1,104.55 kB bundle (reconciliation adds ~81KB)
- All components follow Previa design system
- Zero linting errors

### Status
Phase 4 Complete - Ready for Phase 5 (Transactions Table View)

---

## QA Results

### Review Date: TBD
### Reviewed By: TBD
### Gate Status: TBD

(QA review will be conducted after each phase completion)

### Gate Status

Gate: FAIL ‚Üí docs/qa/gates/1.8-transform-policyai-to-previa-financial-dashboard.yml
