# Story 2.1: Build Welcome & Authentication Screens

## Status: Draft

## Story

As a **new user visiting Previa for the first time**,  
I want **to see a welcoming onboarding screen that explains the value proposition and allows me to sign up/log in with email**,  
So that **I understand what Previa offers and can securely create my account to begin managing my finances**.

## Acceptance Criteria

**AC1: Welcome Screen Display**
- Welcome screen displays Previa branding (logo, colors from design system)
- Value proposition clearly stated: "AI-driven financial intelligence for Australian freelancers"
- Three key benefits displayed with icons
- "Get Started" CTA button prominently placed
- Legal links (Privacy Policy, Terms of Service) in footer

**AC2: Authentication Flow**
- Clicking "Get Started" navigates to auth screen
- Email/password sign-up form with validation
- Email/password login form (toggleable)
- Form validation: valid email format, password min 8 chars
- Error messages display for invalid credentials
- Success message on account creation

**AC3: Supabase Auth Integration**
- Sign-up creates user in Supabase Auth
- Login authenticates against Supabase Auth
- User session persisted (JWT token)
- Redirect to onboarding step 2 after successful auth
- Logout functionality available

**AC4: Responsive Design**
- Welcome and auth screens work on mobile (320px+), tablet, desktop
- Touch-friendly buttons (min 44x44px)
- Readable text at all viewport sizes
- Previa design system colors and typography applied

**AC5: Gamification Hook**
- On successful account creation, trigger gamification profile creation
- Award "First Steps" badge (onboarding category)
- Award 10 points for account creation
- No UI display yet (backend setup only for this story)

## Tasks / Subtasks

- [ ] **Task 1: Create Welcome Screen Component** (AC: 1)
  - [ ] 1.1: Create `src/pages/Welcome.tsx` component
  - [ ] 1.2: Add Previa logo and headline using design system colors
  - [ ] 1.3: Display 3 key benefits with icons (Lucide React)
  - [ ] 1.4: Add "Get Started" button with onClick navigation
  - [ ] 1.5: Add legal links footer (Privacy Policy, Terms)
  - [ ] 1.6: Apply responsive layout (mobile-first, Tailwind CSS)

- [ ] **Task 2: Create Authentication Components** (AC: 2, 3)
  - [ ] 2.1: Create `src/pages/Auth.tsx` with tab switching (Sign Up / Log In)
  - [ ] 2.2: Build sign-up form (email, password, confirm password)
  - [ ] 2.3: Build login form (email, password)
  - [ ] 2.4: Add form validation using react-hook-form + zod
  - [ ] 2.5: Integrate Supabase Auth (signUp, signInWithPassword)
  - [ ] 2.6: Handle auth errors (user exists, invalid credentials, network)
  - [ ] 2.7: Display success/error messages using shadcn Toast
  - [ ] 2.8: Redirect to `/onboarding/upload` on success

- [ ] **Task 3: Implement Session Management** (AC: 3)
  - [ ] 3.1: Create `src/contexts/AuthContext.tsx` for user session state
  - [ ] 3.2: Persist session using Supabase `onAuthStateChange`
  - [ ] 3.3: Protect onboarding routes (redirect if not authenticated)
  - [ ] 3.4: Add logout functionality (clear session, redirect to welcome)

- [ ] **Task 4: Gamification Backend Setup** (AC: 5)
  - [ ] 4.1: Create `src/services/gamificationService.ts`
  - [ ] 4.2: On successful sign-up, insert row in `gamification_profiles` table
  - [ ] 4.3: Award "First Steps" badge → insert in `user_badges` table
  - [ ] 4.4: Award 10 points → insert in `point_transactions` table
  - [ ] 4.5: Handle errors gracefully (don't block auth flow)

- [ ] **Task 5: Responsive Design & Styling** (AC: 4)
  - [ ] 5.1: Apply Previa design system colors (cream, stone, sand, charcoal)
  - [ ] 5.2: Use Inter font for headings/body text
  - [ ] 5.3: Test on mobile (320px), tablet (768px), desktop (1024px+)
  - [ ] 5.4: Ensure touch targets are 44x44px minimum
  - [ ] 5.5: Verify color contrast meets WCAG AA standards

- [ ] **Task 6: Testing** (AC: 1, 2, 3, 4, 5)
  - [ ] 6.1: Unit test Welcome component renders correctly
  - [ ] 6.2: Unit test Auth component form validation
  - [ ] 6.3: Integration test sign-up creates Supabase user
  - [ ] 6.4: Integration test login authenticates user
  - [ ] 6.5: Integration test gamification profile created on sign-up
  - [ ] 6.6: E2E test: complete sign-up flow and verify redirect

## Dev Notes

### Previous Story Insights

**From Story 1.1 (Initialize Previa Project):**
- Supabase client initialized in `src/integrations/supabase/client.ts`
- Environment variables configured in `.env`
- Design system colors defined in `tailwind.config.ts`

**From Story 1.6 (Build Design System):**
- Previa colors available as Tailwind classes: `bg-cream`, `text-charcoal`, etc.
- Button components in `src/components/ui/button.tsx` (shadcn)
- Form components in `src/components/ui/` (Input, Label, Form from shadcn)

### Architecture Context

**Authentication (from architecture/backend-architecture.md):**
- Supabase Auth handles user management
- Email/password authentication enabled
- JWT tokens for session management
- RLS policies enforce user-level data access

**Frontend Structure (from architecture/unified-project-structure.md):**
- Pages: `src/pages/` (Welcome.tsx, Auth.tsx)
- Contexts: `src/contexts/AuthContext.tsx`
- Services: `src/services/gamificationService.ts`
- Components: `src/components/ui/` (shadcn components)

**Design System (from architecture/design-system.md):**
- Colors: cream (#F2E9D8), stone (#8C877D), sand (#D9C8B4), charcoal (#403B31), darkStone (#595347)
- Fonts: Inter (headings, body), JetBrains Mono (financial numbers)
- Spacing: 4px base grid (Tailwind spacing scale)

### Data Models

**Gamification Tables (from specifications/gamification-system.md):**

```sql
-- gamification_profiles
CREATE TABLE gamification_profiles (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  total_points INT DEFAULT 0,
  current_level INT DEFAULT 1,
  created_at TIMESTAMPTZ DEFAULT now(),
  UNIQUE(user_id)
);

-- user_badges
CREATE TABLE user_badges (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  badge_id VARCHAR(50) NOT NULL, -- e.g., 'first_steps'
  earned_at TIMESTAMPTZ DEFAULT now()
);

-- point_transactions
CREATE TABLE point_transactions (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  points INT NOT NULL,
  reason VARCHAR(255),
  created_at TIMESTAMPTZ DEFAULT now()
);
```

### Component Specifications

**Welcome Screen Layout:**
```tsx
// src/pages/Welcome.tsx
import { Button } from '@/components/ui/button';
import { useNavigate } from 'react-router-dom';

export default function Welcome() {
  const navigate = useNavigate();

  return (
    <div className="min-h-screen bg-cream flex flex-col items-center justify-center p-4">
      {/* Logo */}
      <img src="/logo.svg" alt="Previa" className="h-16 mb-8" />
      
      {/* Headline */}
      <h1 className="text-4xl font-bold text-charcoal mb-4 text-center">
        Welcome to Previa
      </h1>
      <p className="text-xl text-stone mb-12 text-center max-w-2xl">
        AI-driven financial intelligence for Australian freelancers
      </p>

      {/* Benefits */}
      <div className="grid md:grid-cols-3 gap-8 mb-12 max-w-4xl">
        <BenefitCard 
          icon={<FileText />}
          title="Smart Document Processing"
          description="Upload bank statements and receipts, AI extracts the data"
        />
        <BenefitCard 
          icon={<Zap />}
          title="Automated Reconciliation"
          description="AI matches transactions to receipts automatically"
        />
        <BenefitCard 
          icon={<BarChart />}
          title="Real-Time Insights"
          description="Dashboard shows spending, income, and trends"
        />
      </div>

      {/* CTA */}
      <Button 
        size="lg" 
        onClick={() => navigate('/auth')}
        className="bg-charcoal hover:bg-darkStone"
      >
        Get Started
      </Button>

      {/* Legal Footer */}
      <footer className="mt-16 text-sm text-stone">
        <a href="/privacy" className="hover:underline">Privacy Policy</a>
        {' · '}
        <a href="/terms" className="hover:underline">Terms of Service</a>
      </footer>
    </div>
  );
}
```

**Authentication Component:**
```tsx
// src/pages/Auth.tsx
import { useState } from 'react';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import * as z from 'zod';
import { supabase } from '@/integrations/supabase/client';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { useToast } from '@/hooks/use-toast';
import { useNavigate } from 'react-router-dom';
import { createGamificationProfile } from '@/services/gamificationService';

const signUpSchema = z.object({
  email: z.string().email('Invalid email address'),
  password: z.string().min(8, 'Password must be at least 8 characters'),
  confirmPassword: z.string(),
}).refine((data) => data.password === data.confirmPassword, {
  message: "Passwords don't match",
  path: ['confirmPassword'],
});

export default function Auth() {
  const [mode, setMode] = useState<'signup' | 'login'>('signup');
  const { toast } = useToast();
  const navigate = useNavigate();
  
  const form = useForm({
    resolver: zodResolver(mode === 'signup' ? signUpSchema : loginSchema),
  });

  const handleSignUp = async (data) => {
    try {
      const { data: authData, error } = await supabase.auth.signUp({
        email: data.email,
        password: data.password,
      });

      if (error) throw error;

      // Create gamification profile
      await createGamificationProfile(authData.user.id);

      toast({
        title: 'Account created!',
        description: 'Welcome to Previa. Let\'s get you set up.',
      });

      navigate('/onboarding/upload');
    } catch (error) {
      toast({
        title: 'Sign-up failed',
        description: error.message,
        variant: 'destructive',
      });
    }
  };

  // ... login handler, form render
}
```

**Gamification Service:**
```typescript
// src/services/gamificationService.ts
import { supabase } from '@/integrations/supabase/client';

export async function createGamificationProfile(userId: string) {
  try {
    // 1. Create gamification profile
    const { error: profileError } = await supabase
      .from('gamification_profiles')
      .insert({ user_id: userId, total_points: 10, current_level: 1 });

    if (profileError) throw profileError;

    // 2. Award "First Steps" badge
    const { error: badgeError } = await supabase
      .from('user_badges')
      .insert({ user_id: userId, badge_id: 'first_steps' });

    if (badgeError) throw badgeError;

    // 3. Record points transaction
    const { error: pointsError } = await supabase
      .from('point_transactions')
      .insert({
        user_id: userId,
        points: 10,
        reason: 'Account created',
      });

    if (pointsError) throw pointsError;

    return { success: true };
  } catch (error) {
    console.error('Gamification setup failed:', error);
    // Don't throw - allow auth to succeed even if gamification fails
    return { success: false, error };
  }
}
```

### File Locations

**New Files to Create:**
- `src/pages/Welcome.tsx` - Welcome screen component
- `src/pages/Auth.tsx` - Authentication (sign-up/login) component
- `src/contexts/AuthContext.tsx` - Auth state management
- `src/services/gamificationService.ts` - Gamification backend service
- `src/components/BenefitCard.tsx` - Reusable benefit card for welcome screen

**Existing Files to Reference:**
- `src/integrations/supabase/client.ts` - Supabase client instance
- `src/components/ui/button.tsx` - Button component (shadcn)
- `src/components/ui/input.tsx` - Input component (shadcn)
- `src/components/ui/form.tsx` - Form component (shadcn)
- `src/hooks/use-toast.ts` - Toast hook for notifications

### Technical Constraints

**Authentication Requirements:**
- Use Supabase Auth SDK methods: `signUp()`, `signInWithPassword()`
- JWT tokens automatically managed by Supabase client
- Session persisted in localStorage by default
- Use `onAuthStateChange` listener for session updates

**Form Validation:**
- Use react-hook-form for form state management
- Use zod for schema validation
- Minimum password length: 8 characters
- Email must be valid format (regex or zod email validator)

**Error Handling:**
- Display user-friendly error messages (no raw Supabase errors)
- Handle network failures gracefully
- Don't block auth flow if gamification setup fails
- Log errors to console for debugging

**Routing:**
- Redirect to `/onboarding/upload` after successful auth
- Protect onboarding routes (require authentication)
- Redirect to `/welcome` if user tries to access protected route without auth

### Testing Requirements

**Unit Tests:**
- Welcome component renders correctly (logo, headline, benefits, CTA)
- Auth component validates email format
- Auth component validates password length
- Auth component checks password confirmation match
- gamificationService creates profile, badges, points

**Integration Tests:**
- Sign-up creates user in Supabase Auth (use test database)
- Login authenticates user successfully
- Gamification profile created on sign-up
- Session persisted after page refresh

**E2E Tests (Playwright/Cypress):**
- Complete sign-up flow: fill form → submit → verify redirect to onboarding
- Complete login flow: fill form → submit → verify dashboard access
- Error handling: invalid email → error message displays

### Security Considerations

- Passwords never logged or displayed in plain text
- Use HTTPS for all Supabase requests (production)
- JWT tokens stored in httpOnly cookies (if configured)
- RLS policies prevent users from accessing other users' gamification data

## Change Log

| Date       | Version | Description                    | Author |
|------------|---------|--------------------------------|--------|
| 2025-10-10 | 1.0     | Initial story draft (from PO) | Sarah  |

## Dev Agent Record

### Agent Model Used
<!-- Dev agent will update this section -->

### Debug Log References
<!-- Dev agent will log commands, test results, lint fixes here -->

### Completion Notes
<!-- Dev agent will document what was implemented, challenges, deviations -->

### File List
<!-- Dev agent will list all files created/modified/deleted -->

## QA Results
<!-- QA agent will append review results here -->
