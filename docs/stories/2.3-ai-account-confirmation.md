# Story 2.3: AI Processing & Account Confirmation

## Status: Approved

## Story

As a **new user who has uploaded their bank statement**,  
I want **to see the AI-extracted account details and confirm or correct them before they're saved**,  
So that **my bank account is created accurately and I have control over my financial data**.

## Acceptance Criteria

**AC1: Display Extracted Account Details**
- Show extracted data from bank statement:
  - Institution name (e.g., "Commonwealth Bank")
  - Account name (e.g., "Everyday Account")
  - Account number (masked, last 4 digits visible)
  - BSB number (format: XXX-XXX)
  - Current balance with currency symbol
- Display confidence scores for each field (high/medium/low indicators)
- Show statement period (from date - to date)
- Card-based layout with clear visual hierarchy

**AC2: Edit Functionality**
- Each field is editable (click to edit inline or via form)
- Validation rules:
  - BSB format: XXX-XXX (6 digits with hyphen)
  - Account number: 6-10 digits
  - Balance: valid decimal number
  - Institution name: required, max 100 chars
- Display validation errors inline
- "Undo" option to revert to AI-extracted values

**AC3: Confidence Score Indicators**
- Visual indicators for confidence levels:
  - High (0.90+): Green checkmark icon
  - Medium (0.70-0.89): Yellow warning icon
  - Low (<0.70): Red alert icon, field highlighted for review
- Tooltip explaining confidence score on hover
- Low confidence fields automatically focused for user review

**AC4: Account Creation**
- "Confirm & Continue" button creates bank account in database
- Insert row in `bank_accounts` table with confirmed values
- Link bank_statements.id to bank_accounts.id (if schema supports)
- Handle duplicate account detection (same user + account number)
- Success message on account creation

**AC5: Transaction Preview**
- Display summary of extracted transactions:
  - Count: "X transactions found"
  - Date range: "From DD/MM/YYYY to DD/MM/YYYY"
  - Total debits and credits
- "View all transactions" link to expand list
- Note: Full transaction review in next step (Story 2.4)

**AC6: Gamification Reward**
- Award "Account Creator" badge (onboarding category)
- Award 10 points for confirming first account
- Record in `user_badges` and `point_transactions` tables
- Display badge earned notification (toast or modal)
- Redirect to transaction preview (Story 2.4) after confirmation

## Tasks / Subtasks

- [ ] **Task 1: Fetch Extracted Data** (AC: 1)
  - [ ] 1.1: Create `src/pages/onboarding/ConfirmAccount.tsx`
  - [ ] 1.2: Fetch bank_statement by ID from database
  - [ ] 1.3: Parse OCR extraction data (JSON stored in bank_statements table or related table)
  - [ ] 1.4: Extract account details: institution, account name, number, BSB, balance
  - [ ] 1.5: Extract confidence scores for each field
  - [ ] 1.6: Handle missing or incomplete extraction data

- [ ] **Task 2: Display Account Details UI** (AC: 1, 3)
  - [ ] 2.1: Create card layout displaying all account fields
  - [ ] 2.2: Add confidence score indicators (icons with colors)
  - [ ] 2.3: Implement tooltips for confidence explanation
  - [ ] 2.4: Highlight low confidence fields (red border or background)
  - [ ] 2.5: Display statement period and document metadata
  - [ ] 2.6: Style with Previa design system

- [ ] **Task 3: Implement Edit Functionality** (AC: 2)
  - [ ] 3.1: Make fields editable (inline editing or edit button)
  - [ ] 3.2: Add form validation:
    - BSB format (XXX-XXX regex)
    - Account number (6-10 digits)
    - Balance (positive decimal)
  - [ ] 3.3: Display validation errors inline
  - [ ] 3.4: Add "Undo" button to revert to original AI values
  - [ ] 3.5: Track which fields were manually edited

- [ ] **Task 4: Transaction Summary Display** (AC: 5)
  - [ ] 4.1: Calculate transaction count from extracted data
  - [ ] 4.2: Display date range (earliest to latest transaction)
  - [ ] 4.3: Calculate total debits and credits
  - [ ] 4.4: Add "View all transactions" expandable section
  - [ ] 4.5: Display transaction list preview (first 5 transactions)

- [ ] **Task 5: Account Creation Logic** (AC: 4)
  - [ ] 5.1: Create `src/services/accountService.ts`
  - [ ] 5.2: Implement `createBankAccount(accountData)` function
  - [ ] 5.3: Check for duplicate accounts (same user + account number)
  - [ ] 5.4: Insert row in `bank_accounts` table with confirmed values
  - [ ] 5.5: Update bank_statement record with `account_confirmed: true`
  - [ ] 5.6: Handle database errors (constraints, network)

- [ ] **Task 6: Gamification Badge Award** (AC: 6)
  - [ ] 6.1: Update `src/services/gamificationService.ts`
  - [ ] 6.2: Add `awardBadge(userId, badgeId)` function
  - [ ] 6.3: On account confirmation, award "Account Creator" badge
  - [ ] 6.4: Award 10 points for account confirmation
  - [ ] 6.5: Display badge notification (toast or modal with badge image)
  - [ ] 6.6: Redirect to `/onboarding/transactions` after notification

- [ ] **Task 7: Testing** (AC: 1, 2, 3, 4, 5, 6)
  - [ ] 7.1: Unit test extraction data parsing
  - [ ] 7.2: Unit test form validation (BSB, account number, balance)
  - [ ] 7.3: Unit test confidence score calculation
  - [ ] 7.4: Integration test account creation
  - [ ] 7.5: Integration test duplicate account detection
  - [ ] 7.6: Integration test badge award
  - [ ] 7.7: E2E test: review → edit → confirm → badge notification → redirect

## Dev Notes

### Previous Story Insights

**From Story 2.2 (Bank Statement Upload):**
- bank_statement record created with `processing_status: 'completed'`
- bank_statement.id available from URL params or context
- Extraction data stored in database (exact schema TBD - check architecture)

**From Story 1.6 (Build Design System):**
- Card, Input, Label, Button components from shadcn/ui
- Badge component for displaying confidence levels
- Toast notifications for success/error messages

### Architecture Context

**OCR Extraction Data (from specifications/ocr-test-data-schema.md):**
- BankStatementExtraction interface defines schema
- Confidence scores: 0.90-1.00 (high), 0.70-0.89 (medium), 0.50-0.69 (low)
- Australian-specific: BSB format XXX-XXX, currency AUD, date DD/MM/YYYY

**Database Schema (from architecture/database-schema.md):**
- bank_accounts table stores confirmed account details
- bank_statements table may store OCR data as JSONB column
- Relationship: bank_accounts ← bank_statements (via user_id, not direct FK)

**Frontend Structure (from architecture/unified-project-structure.md):**
- Pages: `src/pages/onboarding/ConfirmAccount.tsx`
- Services: `src/services/accountService.ts`
- Components: Reuse Card, Input, Badge, Button from shadcn/ui

### Data Models

**BankStatementExtraction (from specifications/ocr-test-data-schema.md):**

```typescript
interface BankStatementExtraction {
  document_type: 'bank_statement';
  institution: {
    name: string;
    code?: string; // Bank code if available
  };
  account: {
    name: string; // "Everyday Account", "Savings Account"
    number_masked: string; // "XXXX1234"
    bsb: string; // "123-456"
  };
  balance: {
    opening: number;
    closing: number;
    currency: string; // "AUD"
  };
  statement_period: {
    from: string; // "2024-07-01"
    to: string; // "2024-07-31"
  };
  transactions: Array<{
    date: string; // "2024-07-05"
    description: string;
    amount: number; // Negative for debit, positive for credit
    balance: number; // Running balance
  }>;
  confidence_scores: {
    institution_name: number; // 0.0-1.0
    account_number: number;
    bsb: number;
    balance: number;
    overall: number;
  };
  metadata: {
    pages: number;
    extracted_at: string; // ISO timestamp
  };
}
```

**bank_accounts Table (from architecture/database-schema.md):**

```sql
CREATE TABLE bank_accounts (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  institution VARCHAR(100) NOT NULL,
  account_name VARCHAR(100) NOT NULL,
  account_number_masked VARCHAR(20) NOT NULL,
  bsb VARCHAR(7), -- Format: XXX-XXX
  balance DECIMAL(12, 2),
  currency VARCHAR(3) DEFAULT 'AUD',
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now(),
  UNIQUE(user_id, account_number_masked) -- Prevent duplicate accounts
);
```

**user_badges Table (from specifications/gamification-system.md):**

```sql
CREATE TABLE user_badges (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  badge_id VARCHAR(50) NOT NULL, -- 'account_creator'
  earned_at TIMESTAMPTZ DEFAULT now()
);
```

### Component Specifications

**Confirm Account Component:**

```tsx
// src/pages/onboarding/ConfirmAccount.tsx
import { useState, useEffect } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import { Card, CardHeader, CardTitle, CardContent } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Badge } from '@/components/ui/badge';
import { CheckCircle, AlertTriangle, XCircle, Edit2, Undo } from 'lucide-react';
import { useToast } from '@/hooks/use-toast';
import { supabase } from '@/integrations/supabase/client';
import { createBankAccount } from '@/services/accountService';
import { awardBadge, awardPoints } from '@/services/gamificationService';
import { useAuth } from '@/contexts/AuthContext';

export default function ConfirmAccount() {
  const { statementId } = useParams();
  const { user } = useAuth();
  const { toast } = useToast();
  const navigate = useNavigate();

  const [extraction, setExtraction] = useState(null);
  const [editedData, setEditedData] = useState({});
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    fetchExtractionData();
  }, [statementId]);

  const fetchExtractionData = async () => {
    try {
      const { data, error } = await supabase
        .from('bank_statements')
        .select('id, ocr_data') // Assuming ocr_data stores extraction JSON
        .eq('id', statementId)
        .single();

      if (error) throw error;

      setExtraction(data.ocr_data);
      setEditedData(data.ocr_data); // Initialize with AI values
    } catch (error) {
      toast({
        title: 'Failed to load data',
        description: error.message,
        variant: 'destructive',
      });
    } finally {
      setLoading(false);
    }
  };

  const getConfidenceIndicator = (score: number) => {
    if (score >= 0.9) {
      return <CheckCircle className="w-5 h-5 text-green-600" />;
    } else if (score >= 0.7) {
      return <AlertTriangle className="w-5 h-5 text-yellow-600" />;
    } else {
      return <XCircle className="w-5 h-5 text-red-600" />;
    }
  };

  const handleConfirm = async () => {
    try {
      // 1. Create bank account
      const accountId = await createBankAccount({
        user_id: user.id,
        institution: editedData.institution.name,
        account_name: editedData.account.name,
        account_number_masked: editedData.account.number_masked,
        bsb: editedData.account.bsb,
        balance: editedData.balance.closing,
        currency: editedData.balance.currency,
      });

      // 2. Award badge and points
      await awardBadge(user.id, 'account_creator');
      await awardPoints(user.id, 10, 'First account confirmed');

      // 3. Show badge notification
      toast({
        title: '🎉 Badge Earned!',
        description: 'You earned the "Account Creator" badge',
      });

      // 4. Redirect to transaction preview
      navigate('/onboarding/transactions');
    } catch (error) {
      toast({
        title: 'Failed to create account',
        description: error.message,
        variant: 'destructive',
      });
    }
  };

  if (loading) return <div>Loading...</div>;

  return (
    <div className="min-h-screen bg-cream flex flex-col items-center justify-center p-4">
      <div className="max-w-2xl w-full">
        <h1 className="text-3xl font-bold text-charcoal mb-2">
          Confirm Your Account Details
        </h1>
        <p className="text-stone mb-8">
          Review the details extracted from your bank statement. Edit any incorrect information.
        </p>

        <Card className="mb-6">
          <CardHeader>
            <CardTitle>Account Information</CardTitle>
          </CardHeader>
          <CardContent className="space-y-4">
            {/* Institution Name */}
            <div className="flex items-start justify-between">
              <div className="flex-1">
                <Label>Institution</Label>
                <Input
                  value={editedData.institution?.name || ''}
                  onChange={(e) => setEditedData({
                    ...editedData,
                    institution: { ...editedData.institution, name: e.target.value }
                  })}
                />
              </div>
              <div className="ml-2 mt-7">
                {getConfidenceIndicator(extraction?.confidence_scores?.institution_name)}
              </div>
            </div>

            {/* Account Name */}
            <div className="flex items-start justify-between">
              <div className="flex-1">
                <Label>Account Name</Label>
                <Input
                  value={editedData.account?.name || ''}
                  onChange={(e) => setEditedData({
                    ...editedData,
                    account: { ...editedData.account, name: e.target.value }
                  })}
                />
              </div>
            </div>

            {/* BSB */}
            <div className="flex items-start justify-between">
              <div className="flex-1">
                <Label>BSB</Label>
                <Input
                  value={editedData.account?.bsb || ''}
                  onChange={(e) => setEditedData({
                    ...editedData,
                    account: { ...editedData.account, bsb: e.target.value }
                  })}
                  pattern="\d{3}-\d{3}"
                  placeholder="123-456"
                />
              </div>
              <div className="ml-2 mt-7">
                {getConfidenceIndicator(extraction?.confidence_scores?.bsb)}
              </div>
            </div>

            {/* Account Number (masked) */}
            <div className="flex items-start justify-between">
              <div className="flex-1">
                <Label>Account Number</Label>
                <Input
                  value={editedData.account?.number_masked || ''}
                  disabled
                  className="bg-gray-50"
                />
                <p className="text-xs text-stone mt-1">
                  Masked for security (last 4 digits visible)
                </p>
              </div>
              <div className="ml-2 mt-7">
                {getConfidenceIndicator(extraction?.confidence_scores?.account_number)}
              </div>
            </div>

            {/* Balance */}
            <div className="flex items-start justify-between">
              <div className="flex-1">
                <Label>Current Balance</Label>
                <div className="flex items-center">
                  <span className="mr-2 text-stone">$</span>
                  <Input
                    type="number"
                    step="0.01"
                    value={editedData.balance?.closing || ''}
                    onChange={(e) => setEditedData({
                      ...editedData,
                      balance: { ...editedData.balance, closing: parseFloat(e.target.value) }
                    })}
                  />
                </div>
              </div>
              <div className="ml-2 mt-7">
                {getConfidenceIndicator(extraction?.confidence_scores?.balance)}
              </div>
            </div>
          </CardContent>
        </Card>

        {/* Transaction Summary */}
        <Card className="mb-6">
          <CardHeader>
            <CardTitle>Transaction Summary</CardTitle>
          </CardHeader>
          <CardContent>
            <p className="text-stone">
              <strong>{extraction?.transactions?.length || 0}</strong> transactions found
            </p>
            <p className="text-stone text-sm">
              From {extraction?.statement_period?.from} to {extraction?.statement_period?.to}
            </p>
            <Button variant="link" className="p-0 mt-2">
              View all transactions →
            </Button>
          </CardContent>
        </Card>

        <Button
          size="lg"
          className="w-full"
          onClick={handleConfirm}
        >
          Confirm & Continue
        </Button>
      </div>
    </div>
  );
}
```

**Account Service:**

```typescript
// src/services/accountService.ts
import { supabase } from '@/integrations/supabase/client';

export async function createBankAccount(accountData: {
  user_id: string;
  institution: string;
  account_name: string;
  account_number_masked: string;
  bsb: string;
  balance: number;
  currency: string;
}): Promise<string> {
  // Check for duplicates
  const { data: existing, error: checkError } = await supabase
    .from('bank_accounts')
    .select('id')
    .eq('user_id', accountData.user_id)
    .eq('account_number_masked', accountData.account_number_masked)
    .single();

  if (existing) {
    throw new Error('This account already exists. Please upload a different statement.');
  }

  // Create account
  const { data, error } = await supabase
    .from('bank_accounts')
    .insert(accountData)
    .select('id')
    .single();

  if (error) {
    throw new Error(`Failed to create account: ${error.message}`);
  }

  return data.id;
}
```

### File Locations

**New Files to Create:**
- `src/pages/onboarding/ConfirmAccount.tsx` - Account confirmation UI
- `src/services/accountService.ts` - Account creation logic
- `src/components/ConfidenceIndicator.tsx` - Reusable confidence score display (optional)

**Existing Files to Modify:**
- `src/services/gamificationService.ts` - Add `awardBadge()` function

**Existing Files to Reference:**
- `src/contexts/AuthContext.tsx` - User session
- `src/integrations/supabase/client.ts` - Database client

### Technical Constraints

**Data Validation:**
- BSB format: XXX-XXX (regex: `^\d{3}-\d{3}$`)
- Account number: 6-10 digits (extracted, masked display)
- Balance: positive decimal, max 2 decimal places
- Institution name: required, max 100 characters

**Confidence Score Thresholds:**
- High: >= 0.90 (green checkmark)
- Medium: 0.70-0.89 (yellow warning)
- Low: < 0.70 (red alert, highlight field)

**Database Operations:**
- Use Supabase client for all DB operations
- Check for duplicate accounts before insert
- Handle unique constraint violations gracefully
- RLS policies ensure user can only create accounts for themselves

**Error Handling:**
- Display user-friendly error messages
- Don't block flow if gamification fails
- Provide retry option for account creation failures
- Log detailed errors for debugging

### Testing Requirements

**Unit Tests:**
- Parse extraction data correctly
- Validate BSB format (valid/invalid cases)
- Validate account number format
- Calculate confidence scores
- Handle missing extraction data

**Integration Tests:**
- Fetch bank statement extraction from database
- Create bank account with valid data
- Detect duplicate accounts
- Award badge and points on confirmation
- Update bank_statement record with confirmation flag

**E2E Tests:**
- Review account details → edit BSB → confirm → badge notification displays
- Low confidence field highlighted → user edits → confirm succeeds
- Duplicate account detected → error message displays

### Security Considerations

- RLS policies prevent users from viewing other users' bank statements
- Account numbers always masked (last 4 digits visible)
- BSB and other sensitive data validated server-side
- JWT token required for all database operations

## Change Log

| Date       | Version | Description                    | Author |
|------------|---------|--------------------------------|--------|
| 2025-10-10 | 1.0     | Initial story draft (from PO) | Sarah  |

## Dev Agent Record

### Agent Model Used
<!-- Dev agent will update this section -->

### Debug Log References
<!-- Dev agent will log commands, test results, lint fixes here -->

### Completion Notes
<!-- Dev agent will document what was implemented, challenges, deviations -->

### File List
<!-- Dev agent will list all files created/modified/deleted -->

## QA Results
<!-- QA agent will append review results here -->
