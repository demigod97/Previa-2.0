# Story 2.4: Transaction Preview & Onboarding Complete

## Status: Draft

## Story

As a **new user who has confirmed their bank account**,  
I want **to preview the extracted transactions and complete the onboarding process**,  
So that **I understand what data was imported and can start using Previa's full features**.

## Acceptance Criteria

**AC1: Transaction List Display**
- Display all extracted transactions in a table/list:
  - Date (DD/MM/YYYY format)
  - Description
  - Amount (formatted as currency, negative for debits, positive for credits)
  - Running balance
- Sort by date (newest first by default)
- Show transaction count at top
- Pagination or infinite scroll if > 50 transactions
- Mobile-responsive (card view on small screens)

**AC2: Transaction Categorization Preview**
- Show placeholder categories for transactions (if available from OCR)
- If no categories: display "Uncategorized" tag
- Note: "You can categorize transactions later in the dashboard"
- Visual distinction between debits (red) and credits (green)

**AC3: Summary Statistics**
- Display key metrics in card layout:
  - Total transactions count
  - Total debits (sum of negative amounts)
  - Total credits (sum of positive amounts)
  - Net change (credits - debits)
  - Statement period (from - to dates)
- Cards use Previa design system colors

**AC4: Save Transactions to Database**
- "Complete Onboarding" button triggers transaction import
- Insert all transactions into `transactions` table
- Link transactions to bank_account.id and bank_statement.id
- Set status: `'unreconciled'` for all transactions
- Handle duplicate detection (same date, amount, description)

**AC5: Onboarding Completion**
- Mark user onboarding as complete (in database or user metadata)
- Award "Onboarding Complete" badge (onboarding category)
- Award 15 points for completing onboarding
- Display celebration modal/screen:
  - "Welcome to Previa!"
  - Summary of what user accomplished
  - Badge display
  - "Go to Dashboard" CTA button
- Redirect to main dashboard after modal dismissal

**AC6: Error Handling & Edge Cases**
- Handle no transactions extracted (show empty state message)
- Handle transaction import failures (show error, allow retry)
- Handle partial imports (some transactions succeed, some fail)
- Provide "Skip for Now" option to complete onboarding without importing

## Tasks / Subtasks

- [ ] **Task 1: Fetch and Display Transactions** (AC: 1, 2)
  - [ ] 1.1: Create `src/pages/onboarding/TransactionPreview.tsx`
  - [ ] 1.2: Fetch bank_statement by ID to get extraction data
  - [ ] 1.3: Parse transactions array from OCR extraction
  - [ ] 1.4: Display transactions in table (Tanstack Table or simple table)
  - [ ] 1.5: Format dates as DD/MM/YYYY, amounts as AUD currency
  - [ ] 1.6: Add sorting by date (default: newest first)
  - [ ] 1.7: Implement pagination or infinite scroll (if > 50 transactions)
  - [ ] 1.8: Responsive design: table on desktop, cards on mobile

- [ ] **Task 2: Display Summary Statistics** (AC: 3)
  - [ ] 2.1: Calculate total transaction count
  - [ ] 2.2: Calculate total debits (sum of negative amounts)
  - [ ] 2.3: Calculate total credits (sum of positive amounts)
  - [ ] 2.4: Calculate net change (credits - debits)
  - [ ] 2.5: Display statistics in card layout above transaction list
  - [ ] 2.6: Style cards with Previa design system colors

- [ ] **Task 3: Transaction Categorization Display** (AC: 2)
  - [ ] 3.1: Check if OCR extraction includes category hints
  - [ ] 3.2: Display category badge for each transaction (if available)
  - [ ] 3.3: Show "Uncategorized" badge if no category
  - [ ] 3.4: Add note: "Categorize transactions later in dashboard"
  - [ ] 3.5: Color-code debits (red) and credits (green)

- [ ] **Task 4: Save Transactions to Database** (AC: 4)
  - [ ] 4.1: Create `src/services/transactionService.ts`
  - [ ] 4.2: Implement `importTransactions(bankAccountId, statementId, transactions)` function
  - [ ] 4.3: Insert transactions into `transactions` table with:
    - `bank_account_id`, `bank_statement_id`, `user_id`
    - `transaction_date`, `description`, `amount`, `balance`
    - `status: 'unreconciled'`
  - [ ] 4.4: Handle duplicate detection (same date + amount + description)
  - [ ] 4.5: Use batch insert for performance (if many transactions)
  - [ ] 4.6: Return import results (success count, errors)

- [ ] **Task 5: Onboarding Completion Logic** (AC: 5)
  - [ ] 5.1: Create onboarding_completed flag in database (user metadata or separate table)
  - [ ] 5.2: Update flag to true on successful transaction import
  - [ ] 5.3: Award "Onboarding Complete" badge
  - [ ] 5.4: Award 15 points for completion
  - [ ] 5.5: Display celebration modal with:
    - Confetti animation (optional)
    - "Welcome to Previa!" message
    - Summary of accomplishments (account created, X transactions imported)
    - Badge display with image
    - "Go to Dashboard" button
  - [ ] 5.6: Redirect to `/dashboard` after modal dismissal

- [ ] **Task 6: Error Handling & Edge Cases** (AC: 6)
  - [ ] 6.1: Handle empty transactions (no transactions extracted)
  - [ ] 6.2: Display empty state message with illustration
  - [ ] 6.3: Handle transaction import failures (show error, retry button)
  - [ ] 6.4: Handle partial imports (show success count + error count)
  - [ ] 6.5: Add "Skip for Now" button to complete onboarding without importing
  - [ ] 6.6: Log errors to console for debugging

- [ ] **Task 7: Testing** (AC: 1, 2, 3, 4, 5, 6)
  - [ ] 7.1: Unit test transaction parsing
  - [ ] 7.2: Unit test summary statistics calculation
  - [ ] 7.3: Unit test duplicate transaction detection
  - [ ] 7.4: Integration test transaction import to database
  - [ ] 7.5: Integration test onboarding completion flag
  - [ ] 7.6: Integration test badge and points award
  - [ ] 7.7: E2E test: preview transactions → complete onboarding → celebration modal → redirect to dashboard

## Dev Notes

### Previous Story Insights

**From Story 2.3 (Account Confirmation):**
- bank_account.id created and available
- bank_statement.id available from context or URL params
- OCR extraction data structure defined (BankStatementExtraction)

**From Story 2.2 (Upload & OCR):**
- Extraction data includes transactions array
- Each transaction has: date, description, amount, balance

**From Story 1.6 (Build Design System):**
- Table, Card, Badge components from shadcn/ui
- Toast notifications for success/error
- Modal/Dialog component for celebration screen

### Architecture Context

**Transaction Data (from specifications/ocr-test-data-schema.md):**
- Transactions extracted from bank statements
- Each transaction: date, description, amount, running balance
- Amounts: negative for debits, positive for credits
- Australian date format: DD/MM/YYYY

**Database Schema (from architecture/database-schema.md):**
- transactions table stores all imported transactions
- Links to bank_accounts and bank_statements
- Status field: 'unreconciled', 'reconciled', 'ignored'

**Frontend Structure (from architecture/unified-project-structure.md):**
- Pages: `src/pages/onboarding/TransactionPreview.tsx`
- Services: `src/services/transactionService.ts`
- Components: Use Tanstack Table for transaction list (optional)

### Data Models

**Transaction Interface (from specifications/ocr-test-data-schema.md):**

```typescript
interface Transaction {
  date: string; // "2024-07-05" (ISO format from OCR)
  description: string; // "WOOLWORTHS 1234"
  amount: number; // -45.67 (negative for debit, positive for credit)
  balance: number; // 1234.56 (running balance after transaction)
  category?: string; // Optional, if OCR provides hints
}
```

**transactions Table (from architecture/database-schema.md):**

```sql
CREATE TABLE transactions (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  bank_account_id UUID REFERENCES bank_accounts(id) ON DELETE SET NULL,
  bank_statement_id UUID REFERENCES bank_statements(id) ON DELETE SET NULL,
  transaction_date DATE NOT NULL,
  description VARCHAR(255) NOT NULL,
  amount DECIMAL(12, 2) NOT NULL,
  balance DECIMAL(12, 2),
  category VARCHAR(50),
  status VARCHAR(20) DEFAULT 'unreconciled', -- 'unreconciled', 'reconciled', 'ignored'
  created_at TIMESTAMPTZ DEFAULT now(),
  INDEX idx_transactions_user_date (user_id, transaction_date DESC),
  INDEX idx_transactions_status (user_id, status)
);
```

**user_badges Table (from specifications/gamification-system.md):**

```sql
CREATE TABLE user_badges (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  badge_id VARCHAR(50) NOT NULL, -- 'onboarding_complete'
  earned_at TIMESTAMPTZ DEFAULT now()
);
```

### Component Specifications

**Transaction Preview Component:**

```tsx
// src/pages/onboarding/TransactionPreview.tsx
import { useState, useEffect } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import { Card, CardHeader, CardTitle, CardContent } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from '@/components/ui/table';
import { useToast } from '@/hooks/use-toast';
import { supabase } from '@/integrations/supabase/client';
import { importTransactions } from '@/services/transactionService';
import { awardBadge, awardPoints } from '@/services/gamificationService';
import { useAuth } from '@/contexts/AuthContext';
import { Dialog, DialogContent, DialogHeader, DialogTitle } from '@/components/ui/dialog';
import { PartyPopper } from 'lucide-react';

export default function TransactionPreview() {
  const { accountId } = useParams();
  const { user } = useAuth();
  const { toast } = useToast();
  const navigate = useNavigate();

  const [transactions, setTransactions] = useState([]);
  const [loading, setLoading] = useState(true);
  const [importing, setImporting] = useState(false);
  const [showCelebration, setShowCelebration] = useState(false);
  const [stats, setStats] = useState({
    count: 0,
    totalDebits: 0,
    totalCredits: 0,
    netChange: 0,
  });

  useEffect(() => {
    fetchTransactions();
  }, [accountId]);

  const fetchTransactions = async () => {
    try {
      // Fetch bank_statement extraction data
      const { data: statement, error } = await supabase
        .from('bank_statements')
        .select('id, ocr_data')
        .eq('user_id', user.id)
        .order('uploaded_at', { ascending: false })
        .limit(1)
        .single();

      if (error) throw error;

      const extractedTransactions = statement.ocr_data.transactions || [];
      setTransactions(extractedTransactions);

      // Calculate statistics
      const debits = extractedTransactions
        .filter(t => t.amount < 0)
        .reduce((sum, t) => sum + Math.abs(t.amount), 0);

      const credits = extractedTransactions
        .filter(t => t.amount > 0)
        .reduce((sum, t) => sum + t.amount, 0);

      setStats({
        count: extractedTransactions.length,
        totalDebits: debits,
        totalCredits: credits,
        netChange: credits - debits,
      });
    } catch (error) {
      toast({
        title: 'Failed to load transactions',
        description: error.message,
        variant: 'destructive',
      });
    } finally {
      setLoading(false);
    }
  };

  const handleCompleteOnboarding = async () => {
    setImporting(true);

    try {
      // 1. Import transactions
      const result = await importTransactions(accountId, user.id, transactions);

      // 2. Award badge and points
      await awardBadge(user.id, 'onboarding_complete');
      await awardPoints(user.id, 15, 'Onboarding completed');

      // 3. Mark onboarding as complete
      await supabase
        .from('user_profiles')
        .update({ onboarding_completed: true })
        .eq('user_id', user.id);

      // 4. Show celebration
      setShowCelebration(true);
    } catch (error) {
      toast({
        title: 'Import failed',
        description: error.message,
        variant: 'destructive',
      });
    } finally {
      setImporting(false);
    }
  };

  const formatCurrency = (amount) => {
    const abs = Math.abs(amount);
    return `${amount < 0 ? '-' : '+'}$${abs.toFixed(2)}`;
  };

  const formatDate = (isoDate) => {
    const date = new Date(isoDate);
    return date.toLocaleDateString('en-AU', {
      day: '2-digit',
      month: '2-digit',
      year: 'numeric',
    });
  };

  if (loading) return <div>Loading...</div>;

  return (
    <div className="min-h-screen bg-cream p-8">
      <div className="max-w-6xl mx-auto">
        <h1 className="text-3xl font-bold text-charcoal mb-2">
          Transaction Preview
        </h1>
        <p className="text-stone mb-8">
          Review {stats.count} transactions extracted from your bank statement.
        </p>

        {/* Summary Statistics */}
        <div className="grid md:grid-cols-4 gap-4 mb-8">
          <Card>
            <CardContent className="pt-6">
              <p className="text-sm text-stone mb-1">Total Transactions</p>
              <p className="text-3xl font-bold text-charcoal">{stats.count}</p>
            </CardContent>
          </Card>

          <Card>
            <CardContent className="pt-6">
              <p className="text-sm text-stone mb-1">Total Debits</p>
              <p className="text-3xl font-bold text-red-600">
                -${stats.totalDebits.toFixed(2)}
              </p>
            </CardContent>
          </Card>

          <Card>
            <CardContent className="pt-6">
              <p className="text-sm text-stone mb-1">Total Credits</p>
              <p className="text-3xl font-bold text-green-600">
                +${stats.totalCredits.toFixed(2)}
              </p>
            </CardContent>
          </Card>

          <Card>
            <CardContent className="pt-6">
              <p className="text-sm text-stone mb-1">Net Change</p>
              <p className={`text-3xl font-bold ${stats.netChange >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                {formatCurrency(stats.netChange)}
              </p>
            </CardContent>
          </Card>
        </div>

        {/* Transaction Table */}
        <Card className="mb-8">
          <CardHeader>
            <CardTitle>Transactions</CardTitle>
          </CardHeader>
          <CardContent>
            <Table>
              <TableHeader>
                <TableRow>
                  <TableHead>Date</TableHead>
                  <TableHead>Description</TableHead>
                  <TableHead>Category</TableHead>
                  <TableHead className="text-right">Amount</TableHead>
                  <TableHead className="text-right">Balance</TableHead>
                </TableRow>
              </TableHeader>
              <TableBody>
                {transactions.map((txn, index) => (
                  <TableRow key={index}>
                    <TableCell>{formatDate(txn.date)}</TableCell>
                    <TableCell className="font-medium">{txn.description}</TableCell>
                    <TableCell>
                      <Badge variant="outline">Uncategorized</Badge>
                    </TableCell>
                    <TableCell className={`text-right font-mono ${txn.amount < 0 ? 'text-red-600' : 'text-green-600'}`}>
                      {formatCurrency(txn.amount)}
                    </TableCell>
                    <TableCell className="text-right font-mono">
                      ${txn.balance.toFixed(2)}
                    </TableCell>
                  </TableRow>
                ))}
              </TableBody>
            </Table>
            <p className="text-sm text-stone mt-4">
              💡 You can categorize and manage transactions later in the dashboard.
            </p>
          </CardContent>
        </Card>

        {/* Actions */}
        <div className="flex gap-4">
          <Button
            size="lg"
            onClick={handleCompleteOnboarding}
            disabled={importing}
            className="flex-1"
          >
            {importing ? 'Importing...' : 'Complete Onboarding'}
          </Button>
          <Button
            size="lg"
            variant="outline"
            onClick={() => navigate('/dashboard')}
          >
            Skip for Now
          </Button>
        </div>
      </div>

      {/* Celebration Modal */}
      <Dialog open={showCelebration} onOpenChange={setShowCelebration}>
        <DialogContent className="sm:max-w-md">
          <DialogHeader>
            <DialogTitle className="text-center text-2xl">
              🎉 Welcome to Previa!
            </DialogTitle>
          </DialogHeader>
          <div className="text-center py-6">
            <PartyPopper className="w-16 h-16 mx-auto mb-4 text-charcoal" />
            <p className="text-lg text-stone mb-4">
              You've successfully completed onboarding!
            </p>
            <div className="bg-cream rounded-lg p-4 mb-4">
              <p className="text-sm text-stone mb-2">You've earned:</p>
              <div className="flex items-center justify-center gap-2">
                <Badge className="text-lg py-1 px-3">🏆 Onboarding Complete</Badge>
              </div>
              <p className="text-sm text-stone mt-2">+15 points</p>
            </div>
            <p className="text-stone mb-6">
              ✓ Account created<br />
              ✓ {stats.count} transactions imported<br />
              ✓ Ready to reconcile!
            </p>
            <Button
              size="lg"
              className="w-full"
              onClick={() => navigate('/dashboard')}
            >
              Go to Dashboard
            </Button>
          </div>
        </DialogContent>
      </Dialog>
    </div>
  );
}
```

**Transaction Service:**

```typescript
// src/services/transactionService.ts
import { supabase } from '@/integrations/supabase/client';

export async function importTransactions(
  bankAccountId: string,
  userId: string,
  transactions: Array<{
    date: string;
    description: string;
    amount: number;
    balance: number;
  }>
): Promise<{ success: number; failed: number }> {
  let success = 0;
  let failed = 0;

  // Batch insert for better performance
  const transactionInserts = transactions.map((txn) => ({
    user_id: userId,
    bank_account_id: bankAccountId,
    transaction_date: txn.date,
    description: txn.description,
    amount: txn.amount,
    balance: txn.balance,
    status: 'unreconciled',
  }));

  try {
    const { data, error } = await supabase
      .from('transactions')
      .insert(transactionInserts)
      .select('id');

    if (error) throw error;

    success = data.length;
  } catch (error) {
    console.error('Transaction import error:', error);
    failed = transactions.length - success;
  }

  return { success, failed };
}
```

### File Locations

**New Files to Create:**
- `src/pages/onboarding/TransactionPreview.tsx` - Transaction preview UI
- `src/services/transactionService.ts` - Transaction import logic
- `src/components/CelebrationModal.tsx` - Celebration screen (optional separate component)

**Existing Files to Modify:**
- `src/services/gamificationService.ts` - Ensure `awardBadge()` function exists
- Database migration: Add `onboarding_completed` column to user_profiles (if not exists)

**Existing Files to Reference:**
- `src/contexts/AuthContext.tsx` - User session
- `src/integrations/supabase/client.ts` - Database client

### Technical Constraints

**Transaction Import:**
- Use batch insert for performance (all transactions in one query)
- Handle duplicate detection (check existing transactions with same date + amount + description)
- Set all transactions to `status: 'unreconciled'` initially

**Date Formatting:**
- Display dates in Australian format: DD/MM/YYYY
- Store dates in ISO format in database: YYYY-MM-DD

**Currency Formatting:**
- Display amounts as AUD currency: $1,234.56
- Use red for debits (negative), green for credits (positive)
- Format with 2 decimal places

**Performance:**
- Implement pagination if > 50 transactions
- Use Tanstack Table for efficient rendering (virtualization)
- Optimize database queries (batch insert)

### Testing Requirements

**Unit Tests:**
- Calculate summary statistics correctly
- Format dates as DD/MM/YYYY
- Format currency amounts
- Detect duplicate transactions

**Integration Tests:**
- Fetch transactions from bank statement
- Import transactions to database (batch insert)
- Award onboarding badge and points
- Mark onboarding as complete in user profile

**E2E Tests:**
- Preview transactions → complete onboarding → celebration modal displays
- Skip for now → navigate to dashboard without importing
- Import fails → error message displays → retry succeeds

### Security Considerations

- RLS policies ensure user can only import their own transactions
- JWT token required for all database operations
- Validate user owns bank_account before importing
- Prevent duplicate imports (check existing transactions)

## Change Log

| Date       | Version | Description                    | Author |
|------------|---------|--------------------------------|--------|
| 2025-10-10 | 1.0     | Initial story draft (from PO) | Sarah  |

## Dev Agent Record

### Agent Model Used
<!-- Dev agent will update this section -->

### Debug Log References
<!-- Dev agent will log commands, test results, lint fixes here -->

### Completion Notes
<!-- Dev agent will document what was implemented, challenges, deviations -->

### File List
<!-- Dev agent will list all files created/modified/deleted -->

## QA Results
<!-- QA agent will append review results here -->
