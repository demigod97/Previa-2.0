# Story 3.1: Universal Upload Hub

## Status: Draft

## Story

As a **Previa user after completing onboarding**,  
I want **a centralized upload hub where I can drag-and-drop bank statements and receipts**,  
So that **I can easily manage all my financial documents in one place**.

## Acceptance Criteria

**AC1: Upload Hub UI**
- Dedicated page at `/upload` route
- Two upload zones side-by-side (desktop) or stacked (mobile):
  - "Bank Statements" zone (left/top)
  - "Receipts" zone (right/bottom)
- Each zone supports drag-and-drop
- Click-to-browse file picker as alternative
- Visual distinction between zones (icons, colors, labels)
- Recent uploads section shows last 5 documents per type

**AC2: File Type Validation**
- Bank statements: accept PDF, CSV
- Receipts: accept PDF, JPG, PNG
- File size validation: max 50MB per file
- Display clear error messages for invalid files
- Prevent upload of unsupported formats

**AC3: Multi-File Upload**
- Support uploading multiple files simultaneously (batch upload)
- Each file uploaded independently with individual progress tracking
- Display upload queue with file names and progress bars
- Allow removing files from queue before upload completes
- Show success/error status for each file

**AC4: Upload to Supabase Storage**
- Bank statements → `bank-statements` bucket
- Receipts → `receipts` bucket
- File path format: `{user_id}/{timestamp}_{filename}`
- Generate thumbnails for image receipts (optional, nice-to-have)

**AC5: Database Record Creation**
- Create record in `bank_statements` or `receipts` table per file
- Fields: `user_id`, `file_path`, `processing_status: 'pending'`, `uploaded_at`
- Return document IDs for status tracking

**AC6: Processing Status Navigation**
- After upload, navigate to processing status page
- Display processing status for each uploaded file
- Link to view document details when processing completes
- "Upload More" button to return to upload hub

## Tasks / Subtasks

- [ ] **Task 1: Create Upload Hub Page** (AC: 1)
  - [ ] 1.1: Create `src/pages/Upload.tsx` with two-zone layout
  - [ ] 1.2: Add "Bank Statements" zone with document icon
  - [ ] 1.3: Add "Receipts" zone with receipt icon
  - [ ] 1.4: Implement responsive design (side-by-side on desktop, stacked on mobile)
  - [ ] 1.5: Add navigation link to upload hub in main navbar
  - [ ] 1.6: Style with Previa design system colors

- [ ] **Task 2: Implement Drag-and-Drop** (AC: 1, 2)
  - [ ] 2.1: Use react-dropzone for each upload zone
  - [ ] 2.2: Configure accepted file types per zone:
    - Bank statements: `.pdf`, `.csv`
    - Receipts: `.pdf`, `.jpg`, `.jpeg`, `.png`
  - [ ] 2.3: Add file size validation (max 50MB)
  - [ ] 2.4: Display error messages for invalid files
  - [ ] 2.5: Show drag-active state (highlighted border/background)

- [ ] **Task 3: Multi-File Upload Queue** (AC: 3)
  - [ ] 3.1: Create upload queue component
  - [ ] 3.2: Display selected files with names, sizes, types
  - [ ] 3.3: Show individual progress bars for each file
  - [ ] 3.4: Add "Remove" button for each queued file
  - [ ] 3.5: Display upload status: pending → uploading → success/error
  - [ ] 3.6: Allow concurrent uploads (max 3 simultaneous)

- [ ] **Task 4: File Upload Implementation** (AC: 4)
  - [ ] 4.1: Extend `src/services/storageService.ts`
  - [ ] 4.2: Add `uploadReceipt(file, userId)` function
  - [ ] 4.3: Upload files to appropriate bucket based on type
  - [ ] 4.4: Use file path format: `{userId}/{timestamp}_{filename}`
  - [ ] 4.5: Track upload progress per file
  - [ ] 4.6: Handle upload errors individually (don't fail entire batch)

- [ ] **Task 5: Database Record Creation** (AC: 5)
  - [ ] 5.1: After each successful upload, create database record
  - [ ] 5.2: For bank statements: insert into `bank_statements` table
  - [ ] 5.3: For receipts: insert into `receipts` table
  - [ ] 5.4: Set `processing_status: 'pending'` initially
  - [ ] 5.5: Capture document IDs for status tracking

- [ ] **Task 6: Recent Uploads Display** (AC: 1)
  - [ ] 6.1: Fetch last 5 bank statements for current user
  - [ ] 6.2: Fetch last 5 receipts for current user
  - [ ] 6.3: Display in "Recent Uploads" section below upload zones
  - [ ] 6.4: Show: filename, upload date, processing status
  - [ ] 6.5: Add "View" link to navigate to document details

- [ ] **Task 7: Processing Status Navigation** (AC: 6)
  - [ ] 7.1: Create `src/pages/ProcessingStatus.tsx` page
  - [ ] 7.2: Accept array of document IDs as route params or state
  - [ ] 7.3: Poll processing status for each document
  - [ ] 7.4: Display status indicators (processing/completed/failed)
  - [ ] 7.5: Add "Upload More" button → navigate back to upload hub
  - [ ] 7.6: Add "View Details" links for completed documents

- [ ] **Task 8: Testing** (AC: 1, 2, 3, 4, 5, 6)
  - [ ] 8.1: Unit test file type validation
  - [ ] 8.2: Unit test file size validation
  - [ ] 8.3: Unit test upload queue management
  - [ ] 8.4: Integration test upload to Supabase Storage
  - [ ] 8.5: Integration test database record creation
  - [ ] 8.6: Integration test multi-file concurrent upload
  - [ ] 8.7: E2E test: drag-drop files → upload → navigate to status page

## Dev Notes

### Previous Story Insights

**From Story 2.2 (Bank Statement Upload):**
- storageService.ts has `uploadBankStatement()` function
- Upload progress tracking implemented
- File validation patterns established

**From Story 1.6 (Build Design System):**
- Card, Button, Progress components from shadcn/ui
- Drag-and-drop styling patterns
- Responsive layout utilities (Tailwind)

### Architecture Context

**File Storage (from architecture/backend-architecture.md):**
- Supabase Storage buckets: `bank-statements`, `receipts`
- Max file size: 50MB per file
- RLS policies: users can only access their own files

**Upload Hub Pattern (from frontend-spec-new.md):**
- Centralized upload interface for all document types
- Multi-file batch upload support
- Real-time progress tracking per file

**Frontend Structure (from architecture/unified-project-structure.md):**
- Pages: `src/pages/Upload.tsx`, `src/pages/ProcessingStatus.tsx`
- Services: `src/services/storageService.ts` (extend)
- Components: Upload zones, file queue, progress indicators

### Data Models

**bank_statements Table:**

```sql
CREATE TABLE bank_statements (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  file_path VARCHAR(500) NOT NULL,
  processing_status VARCHAR(20) DEFAULT 'pending',
  uploaded_at TIMESTAMPTZ DEFAULT now(),
  extracted_at TIMESTAMPTZ,
  error_message TEXT
);
```

**receipts Table:**

```sql
CREATE TABLE receipts (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  file_path VARCHAR(500) NOT NULL,
  processing_status VARCHAR(20) DEFAULT 'pending',
  merchant VARCHAR(255),
  receipt_date DATE,
  amount DECIMAL(10, 2),
  tax DECIMAL(10, 2),
  confidence_score DECIMAL(3, 2),
  ocr_data JSONB,
  uploaded_at TIMESTAMPTZ DEFAULT now(),
  extracted_at TIMESTAMPTZ,
  error_message TEXT
);
```

### Component Specifications

**Upload Hub Component:**

```tsx
// src/pages/Upload.tsx
import { useState } from 'react';
import { useDropzone } from 'react-dropzone';
import { Card, CardHeader, CardTitle, CardContent } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Progress } from '@/components/ui/progress';
import { FileText, Receipt, Upload as UploadIcon, X } from 'lucide-react';
import { useToast } from '@/hooks/use-toast';
import { uploadBankStatement, uploadReceipt } from '@/services/storageService';
import { useAuth } from '@/contexts/AuthContext';
import { useNavigate } from 'react-router-dom';

interface UploadFile {
  id: string;
  file: File;
  type: 'bank_statement' | 'receipt';
  progress: number;
  status: 'pending' | 'uploading' | 'success' | 'error';
  error?: string;
  documentId?: string;
}

export default function Upload() {
  const [uploadQueue, setUploadQueue] = useState<UploadFile[]>([]);
  const { user } = useAuth();
  const { toast } = useToast();
  const navigate = useNavigate();

  // Bank statement dropzone
  const bankStatementDropzone = useDropzone({
    accept: {
      'application/pdf': ['.pdf'],
      'text/csv': ['.csv'],
    },
    maxSize: 50 * 1024 * 1024,
    multiple: true,
    onDrop: (acceptedFiles) => {
      const newFiles = acceptedFiles.map(file => ({
        id: `${Date.now()}-${file.name}`,
        file,
        type: 'bank_statement' as const,
        progress: 0,
        status: 'pending' as const,
      }));
      setUploadQueue(prev => [...prev, ...newFiles]);
    },
    onDropRejected: (rejections) => {
      toast({
        title: 'Invalid file',
        description: rejections[0].errors[0].message,
        variant: 'destructive',
      });
    },
  });

  // Receipt dropzone
  const receiptDropzone = useDropzone({
    accept: {
      'application/pdf': ['.pdf'],
      'image/jpeg': ['.jpg', '.jpeg'],
      'image/png': ['.png'],
    },
    maxSize: 50 * 1024 * 1024,
    multiple: true,
    onDrop: (acceptedFiles) => {
      const newFiles = acceptedFiles.map(file => ({
        id: `${Date.now()}-${file.name}`,
        file,
        type: 'receipt' as const,
        progress: 0,
        status: 'pending' as const,
      }));
      setUploadQueue(prev => [...prev, ...newFiles]);
    },
    onDropRejected: (rejections) => {
      toast({
        title: 'Invalid file',
        description: rejections[0].errors[0].message,
        variant: 'destructive',
      });
    },
  });

  const handleUpload = async () => {
    const pendingFiles = uploadQueue.filter(f => f.status === 'pending');
    
    // Upload max 3 files concurrently
    const concurrentLimit = 3;
    for (let i = 0; i < pendingFiles.length; i += concurrentLimit) {
      const batch = pendingFiles.slice(i, i + concurrentLimit);
      await Promise.allSettled(batch.map(uploadFile));
    }

    // Navigate to processing status page
    const successfulIds = uploadQueue
      .filter(f => f.status === 'success' && f.documentId)
      .map(f => f.documentId);

    if (successfulIds.length > 0) {
      navigate('/processing-status', { state: { documentIds: successfulIds } });
    }
  };

  const uploadFile = async (uploadItem: UploadFile) => {
    try {
      // Update status to uploading
      setUploadQueue(prev => prev.map(item =>
        item.id === uploadItem.id ? { ...item, status: 'uploading' } : item
      ));

      let filePath: string;
      let documentId: string;

      if (uploadItem.type === 'bank_statement') {
        filePath = await uploadBankStatement(uploadItem.file, user.id, (progress) => {
          setUploadQueue(prev => prev.map(item =>
            item.id === uploadItem.id ? { ...item, progress } : item
          ));
        });

        // Create database record
        const { data, error } = await supabase
          .from('bank_statements')
          .insert({ user_id: user.id, file_path: filePath, processing_status: 'pending' })
          .select('id')
          .single();

        if (error) throw error;
        documentId = data.id;
      } else {
        filePath = await uploadReceipt(uploadItem.file, user.id, (progress) => {
          setUploadQueue(prev => prev.map(item =>
            item.id === uploadItem.id ? { ...item, progress } : item
          ));
        });

        // Create database record
        const { data, error } = await supabase
          .from('receipts')
          .insert({ user_id: user.id, file_path: filePath, processing_status: 'pending' })
          .select('id')
          .single();

        if (error) throw error;
        documentId = data.id;
      }

      // Update status to success
      setUploadQueue(prev => prev.map(item =>
        item.id === uploadItem.id 
          ? { ...item, status: 'success', progress: 100, documentId } 
          : item
      ));
    } catch (error) {
      setUploadQueue(prev => prev.map(item =>
        item.id === uploadItem.id 
          ? { ...item, status: 'error', error: error.message } 
          : item
      ));
    }
  };

  const removeFromQueue = (id: string) => {
    setUploadQueue(prev => prev.filter(item => item.id !== id));
  };

  return (
    <div className="min-h-screen bg-cream p-8">
      <div className="max-w-6xl mx-auto">
        <h1 className="text-3xl font-bold text-charcoal mb-2">Upload Documents</h1>
        <p className="text-stone mb-8">
          Upload bank statements and receipts for AI processing and reconciliation.
        </p>

        {/* Upload Zones */}
        <div className="grid md:grid-cols-2 gap-6 mb-8">
          {/* Bank Statements Zone */}
          <Card>
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <FileText className="w-5 h-5" />
                Bank Statements
              </CardTitle>
            </CardHeader>
            <CardContent>
              <div
                {...bankStatementDropzone.getRootProps()}
                className={`border-2 border-dashed rounded-lg p-8 text-center cursor-pointer transition-colors ${
                  bankStatementDropzone.isDragActive 
                    ? 'border-charcoal bg-sand' 
                    : 'border-stone bg-white'
                }`}
              >
                <input {...bankStatementDropzone.getInputProps()} />
                <UploadIcon className="w-12 h-12 mx-auto mb-4 text-stone" />
                <p className="text-charcoal font-medium mb-1">
                  Drop bank statements here
                </p>
                <p className="text-stone text-sm">
                  PDF or CSV, max 50MB
                </p>
              </div>
            </CardContent>
          </Card>

          {/* Receipts Zone */}
          <Card>
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <Receipt className="w-5 h-5" />
                Receipts
              </CardTitle>
            </CardHeader>
            <CardContent>
              <div
                {...receiptDropzone.getRootProps()}
                className={`border-2 border-dashed rounded-lg p-8 text-center cursor-pointer transition-colors ${
                  receiptDropzone.isDragActive 
                    ? 'border-charcoal bg-sand' 
                    : 'border-stone bg-white'
                }`}
              >
                <input {...receiptDropzone.getInputProps()} />
                <UploadIcon className="w-12 h-12 mx-auto mb-4 text-stone" />
                <p className="text-charcoal font-medium mb-1">
                  Drop receipts here
                </p>
                <p className="text-stone text-sm">
                  PDF, JPG, or PNG, max 50MB
                </p>
              </div>
            </CardContent>
          </Card>
        </div>

        {/* Upload Queue */}
        {uploadQueue.length > 0 && (
          <Card className="mb-8">
            <CardHeader>
              <CardTitle>Upload Queue ({uploadQueue.length})</CardTitle>
            </CardHeader>
            <CardContent className="space-y-3">
              {uploadQueue.map(item => (
                <div key={item.id} className="flex items-center gap-3 p-3 bg-cream rounded-lg">
                  <div className="flex-1">
                    <p className="text-sm font-medium text-charcoal">{item.file.name}</p>
                    <p className="text-xs text-stone">
                      {(item.file.size / 1024 / 1024).toFixed(2)} MB · {item.type === 'bank_statement' ? 'Bank Statement' : 'Receipt'}
                    </p>
                    {item.status === 'uploading' && (
                      <Progress value={item.progress} className="mt-2" />
                    )}
                    {item.status === 'error' && (
                      <p className="text-xs text-red-600 mt-1">{item.error}</p>
                    )}
                  </div>
                  <div className="text-right">
                    {item.status === 'pending' && (
                      <Button
                        variant="ghost"
                        size="sm"
                        onClick={() => removeFromQueue(item.id)}
                      >
                        <X className="w-4 h-4" />
                      </Button>
                    )}
                    {item.status === 'success' && <span className="text-green-600">✓</span>}
                    {item.status === 'error' && <span className="text-red-600">✗</span>}
                  </div>
                </div>
              ))}
            </CardContent>
          </Card>
        )}

        {/* Upload Button */}
        {uploadQueue.some(f => f.status === 'pending') && (
          <Button size="lg" className="w-full" onClick={handleUpload}>
            Upload {uploadQueue.filter(f => f.status === 'pending').length} Files
          </Button>
        )}
      </div>
    </div>
  );
}
```

**Extended Storage Service:**

```typescript
// src/services/storageService.ts (add to existing)
export async function uploadReceipt(
  file: File,
  userId: string,
  onProgress?: (progress: number) => void
): Promise<string> {
  const timestamp = Date.now();
  const filename = `${timestamp}_${file.name}`;
  const filePath = `${userId}/${filename}`;

  const { data, error } = await supabase.storage
    .from('receipts')
    .upload(filePath, file, {
      cacheControl: '3600',
      upsert: false,
      onUploadProgress: (progressEvent) => {
        if (onProgress && progressEvent.total) {
          const progress = Math.round((progressEvent.loaded / progressEvent.total) * 100);
          onProgress(progress);
        }
      },
    });

  if (error) {
    throw new Error(`Upload failed: ${error.message}`);
  }

  return data.path;
}
```

### File Locations

**New Files to Create:**
- `src/pages/Upload.tsx` - Universal upload hub
- `src/pages/ProcessingStatus.tsx` - Multi-document processing status

**Existing Files to Modify:**
- `src/services/storageService.ts` - Add `uploadReceipt()` function

**Existing Files to Reference:**
- `src/contexts/AuthContext.tsx` - User session
- `src/integrations/supabase/client.ts` - Storage and database client

### Technical Constraints

**File Upload:**
- Max 3 concurrent uploads to prevent overwhelming browser/network
- Individual progress tracking per file
- Independent error handling (one failure doesn't stop others)

**File Type Validation:**
- Client-side validation using react-dropzone accept prop
- Server-side validation via Supabase Storage MIME type checking

**Storage Organization:**
- Separate buckets for bank statements and receipts
- Consistent file path format: `{userId}/{timestamp}_{filename}`

**Performance:**
- Batch uploads processed in groups of 3
- Progress tracking uses callbacks (not state updates in loop)
- Database inserts per file (not batch) for immediate ID capture

### Testing Requirements

**Unit Tests:**
- File type validation (accept/reject)
- File size validation (under/over limit)
- Upload queue management (add/remove)
- Progress calculation

**Integration Tests:**
- Upload bank statement to storage
- Upload receipt to storage
- Create database records after upload
- Concurrent upload handling (3 simultaneous)
- Error handling (one file fails, others succeed)

**E2E Tests:**
- Drag-drop multiple files → upload → navigate to processing status
- Invalid file rejected → error message displays
- Remove file from queue before upload

### Security Considerations

- RLS policies prevent users from accessing other users' files
- File paths include user_id to enforce isolation
- JWT token required for storage and database operations
- File size limit enforced client and server-side

## Change Log

| Date       | Version | Description                    | Author |
|------------|---------|--------------------------------|--------|
| 2025-10-11 | 1.0     | Initial story draft (from PO) | Sarah  |

## Dev Agent Record

### Agent Model Used
<!-- Dev agent will update this section -->

### Debug Log References
<!-- Dev agent will log commands, test results, lint fixes here -->

### Completion Notes
<!-- Dev agent will document what was implemented, challenges, deviations -->

### File List
<!-- Dev agent will list all files created/modified/deleted -->

## QA Results
<!-- QA agent will append review results here -->
