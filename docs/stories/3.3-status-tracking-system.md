# Story 3.3: Processing Status Tracking System

## Status: Draft

## Story

As a **Previa user waiting for document processing**,  
I want **a real-time status page showing processing progress for all my uploaded documents**,  
So that **I know when my documents are ready and can take action if processing fails**.

## Acceptance Criteria

**AC1: Processing Status Page**
- Dedicated page at `/processing-status` route
- Accept array of document IDs (from navigation state or query params)
- Display status for multiple documents simultaneously
- Auto-refresh status every 2 seconds while any document is processing
- Stop polling when all documents reach terminal state (completed/failed)

**AC2: Status Badge UI**
- Visual status indicators with color coding:
  - **Pending**: Gray badge with clock icon
  - **Processing**: Blue badge with spinner icon (animated)
  - **Completed**: Green badge with checkmark icon
  - **Failed**: Red badge with X icon
- Display status text clearly for each document

**AC3: Document Information Display**
- Show document filename extracted from file_path
- Display document type (Bank Statement / Receipt)
- Show upload timestamp
- Show processing started timestamp (if available)
- Show estimated time remaining (if processing)

**AC4: Error Handling & Retry**
- Display error message for failed documents
- "Retry Processing" button for failed documents
- Retry button triggers Edge Function again with same document
- Display user-friendly error messages (not raw error text)

**AC5: Completion Actions**
- "View Details" button for completed bank statements → navigate to account confirmation
- "View Details" button for completed receipts → navigate to receipt details page
- "Upload More" button → navigate back to upload hub
- "Go to Dashboard" button → navigate to main dashboard

**AC6: Batch Status Summary**
- Summary header showing: X of Y documents completed
- Progress bar showing overall completion percentage
- Estimated time remaining for batch (based on average processing time)
- Alert if any documents failed

## Tasks / Subtasks

- [ ] **Task 1: Create Processing Status Page** (AC: 1, 3)
  - [ ] 1.1: Create `src/pages/ProcessingStatus.tsx`
  - [ ] 1.2: Accept document IDs from route state or query params
  - [ ] 1.3: Fetch initial status for all documents
  - [ ] 1.4: Display documents in list/grid layout
  - [ ] 1.5: Show document information (filename, type, timestamps)

- [ ] **Task 2: Implement Status Polling** (AC: 1)
  - [ ] 2.1: Create `src/hooks/useProcessingStatus.ts` React Query hook
  - [ ] 2.2: Poll database every 2 seconds with `refetchInterval`
  - [ ] 2.3: Check status for all tracked documents
  - [ ] 2.4: Stop polling when all documents reach terminal state
  - [ ] 2.5: Handle polling errors gracefully

- [ ] **Task 3: Status Badge Component** (AC: 2)
  - [ ] 3.1: Create `src/components/StatusBadge.tsx`
  - [ ] 3.2: Map status to color: pending=gray, processing=blue, completed=green, failed=red
  - [ ] 3.3: Add icons: Clock, Loader (animated), CheckCircle, XCircle from lucide-react
  - [ ] 3.4: Style with Tailwind CSS and Previa colors
  - [ ] 3.5: Make responsive for mobile

- [ ] **Task 4: Error Display & Retry** (AC: 4)
  - [ ] 4.1: Display error_message for failed documents
  - [ ] 4.2: Add "Retry Processing" button
  - [ ] 4.3: On retry, call Edge Function with same document_id
  - [ ] 4.4: Reset status to 'pending' before retry
  - [ ] 4.5: Show toast notification on retry success/failure

- [ ] **Task 5: Completion Actions** (AC: 5)
  - [ ] 5.1: "View Details" for bank statements → `/onboarding/confirm-account?statement_id={id}`
  - [ ] 5.2: "View Details" for receipts → `/receipts/{id}`
  - [ ] 5.3: "Upload More" → `/upload`
  - [ ] 5.4: "Go to Dashboard" → `/dashboard`
  - [ ] 5.5: Disable "View Details" until processing completes

- [ ] **Task 6: Batch Summary** (AC: 6)
  - [ ] 6.1: Calculate completed count vs total count
  - [ ] 6.2: Display progress bar (completed / total * 100)
  - [ ] 6.3: Estimate time remaining based on average processing time
  - [ ] 6.4: Show alert banner if any documents failed
  - [ ] 6.5: Display summary at top of page

- [ ] **Task 7: Supabase Realtime (Optional Enhancement)** (AC: 1)
  - [ ] 7.1: Subscribe to database changes on bank_statements and receipts tables
  - [ ] 7.2: Update UI immediately when status changes (no 2s delay)
  - [ ] 7.3: Use Realtime as primary, polling as fallback
  - [ ] 7.4: Unsubscribe on component unmount

- [ ] **Task 8: Testing** (AC: 1, 2, 3, 4, 5, 6)
  - [ ] 8.1: Unit test status badge color/icon mapping
  - [ ] 8.2: Unit test polling logic (start/stop conditions)
  - [ ] 8.3: Unit test batch summary calculations
  - [ ] 8.4: Integration test status fetch from database
  - [ ] 8.5: Integration test retry functionality
  - [ ] 8.6: E2E test: upload documents → processing status updates → view details

## Dev Notes

### Previous Story Insights

**From Story 3.1 (Universal Upload Hub):**
- After upload, navigate to processing status with document IDs
- Upload returns array of document IDs

**From Story 3.2 (Edge Function for Processing):**
- Edge Function updates status to 'processing'
- Status field: 'pending' | 'processing' | 'completed' | 'failed'
- error_message field contains failure details

**From Story 2.2 (Bank Statement Upload):**
- useProcessingStatus hook pattern established
- React Query polling with refetchInterval

### Architecture Context

**Real-time Updates (from architecture/backend-architecture.md):**
- Supabase Realtime for instant database change notifications
- Polling as fallback if Realtime not available
- RLS policies apply to Realtime subscriptions

**Status Tracking (from docs/specifications/n8n-integration-patterns.md):**
- Status polling every 2 seconds while processing
- Stop polling on completed/failed
- Timeout after 60 seconds (optional)

**Frontend Structure (from architecture/unified-project-structure.md):**
- Pages: `src/pages/ProcessingStatus.tsx`
- Hooks: `src/hooks/useProcessingStatus.ts`
- Components: `src/components/StatusBadge.tsx`

### Data Models

**Status Enum:**

```typescript
type ProcessingStatus = 'pending' | 'processing' | 'completed' | 'failed';
```

**Document Status Interface:**

```typescript
interface DocumentStatus {
  id: string;
  document_type: 'bank_statement' | 'receipt';
  file_path: string;
  processing_status: ProcessingStatus;
  uploaded_at: string;          // ISO timestamp
  processing_started_at?: string;
  extracted_at?: string;
  error_message?: string;
}
```

**Batch Summary:**

```typescript
interface BatchSummary {
  total: number;
  pending: number;
  processing: number;
  completed: number;
  failed: number;
  progress: number;             // Percentage (0-100)
  estimatedTimeRemaining?: number; // Seconds
}
```

### Component Specifications

**Processing Status Page:**

```tsx
// src/pages/ProcessingStatus.tsx
import { useEffect, useState } from 'react';
import { useLocation, useNavigate, useSearchParams } from 'react-router-dom';
import { Card, CardHeader, CardTitle, CardContent } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Progress } from '@/components/ui/progress';
import { Alert, AlertTitle, AlertDescription } from '@/components/ui/alert';
import { AlertCircle, Upload, Home } from 'lucide-react';
import StatusBadge from '@/components/StatusBadge';
import { useProcessingStatus } from '@/hooks/useProcessingStatus';
import { triggerDocumentProcessing } from '@/services/ocrService';
import { useToast } from '@/hooks/use-toast';
import { useAuth } from '@/contexts/AuthContext';

export default function ProcessingStatus() {
  const location = useLocation();
  const [searchParams] = useSearchParams();
  const navigate = useNavigate();
  const { toast } = useToast();
  const { user } = useAuth();

  // Get document IDs from route state or query params
  const documentIds = location.state?.documentIds || 
    searchParams.get('ids')?.split(',') || 
    [];

  const { documents, isPolling, refetch } = useProcessingStatus(documentIds);

  // Calculate batch summary
  const summary = {
    total: documents.length,
    pending: documents.filter(d => d.processing_status === 'pending').length,
    processing: documents.filter(d => d.processing_status === 'processing').length,
    completed: documents.filter(d => d.processing_status === 'completed').length,
    failed: documents.filter(d => d.processing_status === 'failed').length,
    progress: documents.length > 0 
      ? Math.round((documents.filter(d => d.processing_status === 'completed').length / documents.length) * 100)
      : 0,
  };

  const handleRetry = async (document: DocumentStatus) => {
    try {
      const bucket = document.document_type === 'bank_statement' ? 'bank-statements' : 'receipts';
      
      await triggerDocumentProcessing(
        document.id,
        user.id,
        document.document_type,
        document.file_path,
        bucket
      );

      toast({
        title: 'Processing restarted',
        description: 'Your document is being processed again.',
      });

      refetch();
    } catch (error) {
      toast({
        title: 'Retry failed',
        description: error.message,
        variant: 'destructive',
      });
    }
  };

  const handleViewDetails = (document: DocumentStatus) => {
    if (document.document_type === 'bank_statement') {
      navigate(`/onboarding/confirm-account?statement_id=${document.id}`);
    } else {
      navigate(`/receipts/${document.id}`);
    }
  };

  const getFilename = (filePath: string) => {
    return filePath.split('/').pop()?.replace(/^\d+_/, '') || 'Unknown';
  };

  return (
    <div className="min-h-screen bg-cream p-8">
      <div className="max-w-4xl mx-auto">
        <h1 className="text-3xl font-bold text-charcoal mb-2">Processing Documents</h1>
        <p className="text-stone mb-8">
          Your documents are being processed. This may take a few moments.
        </p>

        {/* Batch Summary */}
        <Card className="mb-6">
          <CardContent className="pt-6">
            <div className="mb-4">
              <div className="flex justify-between text-sm mb-2">
                <span className="text-charcoal font-medium">
                  {summary.completed} of {summary.total} documents completed
                </span>
                <span className="text-stone">{summary.progress}%</span>
              </div>
              <Progress value={summary.progress} className="h-3" />
            </div>

            {summary.failed > 0 && (
              <Alert variant="destructive">
                <AlertCircle className="h-4 w-4" />
                <AlertTitle>Processing Errors</AlertTitle>
                <AlertDescription>
                  {summary.failed} document{summary.failed > 1 ? 's' : ''} failed to process. 
                  Please review and retry below.
                </AlertDescription>
              </Alert>
            )}
          </CardContent>
        </Card>

        {/* Document List */}
        <div className="space-y-4 mb-6">
          {documents.map(doc => (
            <Card key={doc.id}>
              <CardContent className="pt-6">
                <div className="flex items-start justify-between">
                  <div className="flex-1">
                    <div className="flex items-center gap-3 mb-2">
                      <StatusBadge status={doc.processing_status} />
                      <h3 className="font-medium text-charcoal">
                        {getFilename(doc.file_path)}
                      </h3>
                    </div>
                    
                    <div className="text-sm text-stone space-y-1">
                      <p>Type: {doc.document_type === 'bank_statement' ? 'Bank Statement' : 'Receipt'}</p>
                      <p>Uploaded: {new Date(doc.uploaded_at).toLocaleString()}</p>
                      {doc.processing_started_at && (
                        <p>Processing started: {new Date(doc.processing_started_at).toLocaleString()}</p>
                      )}
                    </div>

                    {doc.error_message && (
                      <Alert variant="destructive" className="mt-3">
                        <AlertCircle className="h-4 w-4" />
                        <AlertDescription>{doc.error_message}</AlertDescription>
                      </Alert>
                    )}
                  </div>

                  <div className="flex flex-col gap-2 ml-4">
                    {doc.processing_status === 'completed' && (
                      <Button
                        size="sm"
                        onClick={() => handleViewDetails(doc)}
                      >
                        View Details
                      </Button>
                    )}
                    {doc.processing_status === 'failed' && (
                      <Button
                        size="sm"
                        variant="outline"
                        onClick={() => handleRetry(doc)}
                      >
                        Retry
                      </Button>
                    )}
                  </div>
                </div>
              </CardContent>
            </Card>
          ))}
        </div>

        {/* Action Buttons */}
        <div className="flex gap-4">
          <Button
            variant="outline"
            onClick={() => navigate('/upload')}
            className="flex items-center gap-2"
          >
            <Upload className="w-4 h-4" />
            Upload More
          </Button>

          {summary.completed === summary.total && summary.total > 0 && (
            <Button
              onClick={() => navigate('/dashboard')}
              className="flex items-center gap-2"
            >
              <Home className="w-4 h-4" />
              Go to Dashboard
            </Button>
          )}
        </div>
      </div>
    </div>
  );
}
```

**Status Badge Component:**

```tsx
// src/components/StatusBadge.tsx
import { Clock, Loader, CheckCircle, XCircle } from 'lucide-react';
import { Badge } from '@/components/ui/badge';

type ProcessingStatus = 'pending' | 'processing' | 'completed' | 'failed';

interface StatusBadgeProps {
  status: ProcessingStatus;
}

export default function StatusBadge({ status }: StatusBadgeProps) {
  const config = {
    pending: {
      label: 'Pending',
      icon: Clock,
      className: 'bg-gray-100 text-gray-700 border-gray-300',
    },
    processing: {
      label: 'Processing',
      icon: Loader,
      className: 'bg-blue-100 text-blue-700 border-blue-300',
      animated: true,
    },
    completed: {
      label: 'Completed',
      icon: CheckCircle,
      className: 'bg-green-100 text-green-700 border-green-300',
    },
    failed: {
      label: 'Failed',
      icon: XCircle,
      className: 'bg-red-100 text-red-700 border-red-300',
    },
  };

  const { label, icon: Icon, className, animated } = config[status];

  return (
    <Badge variant="outline" className={className}>
      <Icon className={`w-3 h-3 mr-1 ${animated ? 'animate-spin' : ''}`} />
      {label}
    </Badge>
  );
}
```

**Processing Status Hook:**

```typescript
// src/hooks/useProcessingStatus.ts
import { useQuery } from '@tanstack/react-query';
import { supabase } from '@/integrations/supabase/client';

interface DocumentStatus {
  id: string;
  document_type: 'bank_statement' | 'receipt';
  file_path: string;
  processing_status: 'pending' | 'processing' | 'completed' | 'failed';
  uploaded_at: string;
  processing_started_at?: string;
  extracted_at?: string;
  error_message?: string;
}

export function useProcessingStatus(documentIds: string[]) {
  const query = useQuery({
    queryKey: ['processing-status', documentIds],
    queryFn: async () => {
      if (documentIds.length === 0) return [];

      // Fetch bank statements
      const { data: statements, error: statementsError } = await supabase
        .from('bank_statements')
        .select('id, file_path, processing_status, uploaded_at, processing_started_at, extracted_at, error_message')
        .in('id', documentIds);

      if (statementsError) throw statementsError;

      // Fetch receipts
      const { data: receipts, error: receiptsError } = await supabase
        .from('receipts')
        .select('id, file_path, processing_status, uploaded_at, processing_started_at, extracted_at, error_message')
        .in('id', documentIds);

      if (receiptsError) throw receiptsError;

      // Combine and add document_type
      const documents: DocumentStatus[] = [
        ...statements.map(s => ({ ...s, document_type: 'bank_statement' as const })),
        ...receipts.map(r => ({ ...r, document_type: 'receipt' as const })),
      ];

      return documents;
    },
    refetchInterval: (data) => {
      // Stop polling if all documents are completed or failed
      const allDone = data?.every(d => 
        d.processing_status === 'completed' || d.processing_status === 'failed'
      );
      return allDone ? false : 2000; // 2 seconds
    },
    enabled: documentIds.length > 0,
  });

  return {
    documents: query.data || [],
    isPolling: query.isFetching,
    refetch: query.refetch,
  };
}
```

### File Locations

**New Files to Create:**
- `src/pages/ProcessingStatus.tsx` - Processing status page
- `src/components/StatusBadge.tsx` - Status badge component
- `src/hooks/useProcessingStatus.ts` - React Query polling hook

**Existing Files to Reference:**
- `src/integrations/supabase/client.ts` - Database client
- `src/services/ocrService.ts` - Retry processing function
- `src/contexts/AuthContext.tsx` - User session

### Technical Constraints

**Polling vs Realtime:**
- Polling is simpler and works everywhere (no WebSocket requirements)
- Realtime is more efficient but requires Realtime enabled on Supabase project
- Use polling as primary, Realtime as optional enhancement

**Polling Frequency:**
- 2 seconds balances responsiveness and server load
- Stop polling when all documents reach terminal state
- Don't poll indefinitely (60-second timeout optional)

**Batch Processing:**
- Support tracking multiple documents simultaneously
- Display overall progress (batch summary)
- Individual retry per document (not batch retry)

**Error Messages:**
- Display user-friendly messages (not raw database errors)
- Map technical errors to human-readable text
- Example: "OCR extraction failed" instead of "n8n webhook timeout"

### Testing Requirements

**Unit Tests:**
- StatusBadge renders correct icon and color for each status
- Batch summary calculations (completed/total, progress percentage)
- Polling hook stops when all documents done
- Filename extraction from file path

**Integration Tests:**
- Fetch document status from database
- Retry processing triggers Edge Function
- Navigate to correct detail page based on document type
- Polling refetches data every 2 seconds

**E2E Tests:**
- Upload documents → navigate to processing status → statuses update
- Failed document → click retry → status resets to processing
- Completed bank statement → click view details → navigate to confirm account
- All documents complete → "Go to Dashboard" button appears

### Security Considerations

- RLS policies ensure users only see their own documents
- JWT token required for all database queries
- Retry function validates user owns document before triggering Edge Function

## Change Log

| Date       | Version | Description                    | Author |
|------------|---------|--------------------------------|--------|
| 2025-10-11 | 1.0     | Initial story draft (from PO) | Sarah  |

## Dev Agent Record

### Agent Model Used
<!-- Dev agent will update this section -->

### Debug Log References
<!-- Dev agent will log commands, test results, lint fixes here -->

### Completion Notes
<!-- Dev agent will document what was implemented, challenges, deviations -->

### File List
<!-- Dev agent will list all files created/modified/deleted -->

## QA Results
<!-- QA agent will append review results here -->
