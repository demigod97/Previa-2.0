# Story 4.1: Transaction & Receipt Library Views

## Status: Draft

## Story

As a **Previa user preparing to reconcile transactions**,  
I want **dedicated library views to browse all my transactions and receipts with filtering and search**,  
So that **I can easily find and select items for reconciliation**.

## Acceptance Criteria

**AC1: Transaction Library View**
- Dedicated page at `/transactions` route
- Display all transactions for current user
- Table layout with columns: Date, Description, Amount, Balance, Category, Status, Actions
- Default view shows unreconciled transactions first
- Support pagination (25 items per page)

**AC2: Transaction Filtering**
- Filter by date range (date picker with presets: Today, Last 7 days, Last 30 days, Custom)
- Filter by amount range (slider with min/max)
- Filter by category (multi-select dropdown)
- Filter by status: Unreconciled / Reconciled / Ignored
- Filter by bank account (dropdown of user's accounts)
- "Clear All Filters" button

**AC3: Transaction Search & Sort**
- Search bar for description text (fuzzy search)
- Sort by: Date (newest/oldest), Amount (high/low), Description (A-Z)
- Maintain sort and filter state in URL query params

**AC4: Receipt Library View**
- Dedicated page at `/receipts` route (created in Story 3.4, extend here)
- Grid view (default): 3-4 columns, receipt cards with thumbnail
- List view toggle: Table-like rows with merchant, date, amount
- Empty state: "No receipts uploaded" with "Upload Receipt" CTA

**AC5: Receipt Filtering & Search**
- Filter by date range (same presets as transactions)
- Filter by merchant (multi-select from existing merchants)
- Filter by amount range (slider)
- Filter by reconciliation status: Unreconciled / Reconciled / Ignored
- Search by merchant name or line item description
- Sort by: Date (newest/oldest), Amount (high/low), Merchant (A-Z)

**AC6: Bulk Selection**
- Checkbox selection for multiple transactions/receipts
- "Select All" checkbox in table header
- Selected count displayed: "X items selected"
- Bulk actions available when items selected:
  - Mark as Reconciled
  - Mark as Ignored
  - Categorize (for transactions)
  - Export CSV (optional)

## Tasks / Subtasks

- [ ] **Task 1: Transaction Library Page** (AC: 1)
  - [ ] 1.1: Create `src/pages/Transactions.tsx`
  - [ ] 1.2: Fetch all transactions for current user
  - [ ] 1.3: Display in table using shadcn Table components
  - [ ] 1.4: Columns: checkbox, date, description, amount, balance, category, status badge, actions menu
  - [ ] 1.5: Implement pagination (25 per page)
  - [ ] 1.6: Default sort: date descending (newest first)
  - [ ] 1.7: Default filter: status = 'unreconciled'

- [ ] **Task 2: Transaction Filtering UI** (AC: 2, 3)
  - [ ] 2.1: Add date range picker with presets (Today, Last 7 days, Last 30 days, Custom)
  - [ ] 2.2: Add amount range slider (min/max from data)
  - [ ] 2.3: Add category multi-select dropdown
  - [ ] 2.4: Add status filter (checkboxes: unreconciled/reconciled/ignored)
  - [ ] 2.5: Add bank account dropdown filter
  - [ ] 2.6: Add search input for description
  - [ ] 2.7: "Clear Filters" button resets all filters

- [ ] **Task 3: Transaction Sorting** (AC: 3)
  - [ ] 3.1: Add sort dropdown in table header
  - [ ] 3.2: Sort by date (ascending/descending)
  - [ ] 3.3: Sort by amount (ascending/descending)
  - [ ] 3.4: Sort by description (A-Z / Z-A)
  - [ ] 3.5: Update URL query params on sort change

- [ ] **Task 4: Receipt Library Enhancements** (AC: 4, 5)
  - [ ] 4.1: Extend existing `src/pages/Receipts.tsx` (from Story 3.4)
  - [ ] 4.2: Add grid/list view toggle button
  - [ ] 4.3: Grid view: receipt cards with thumbnail, merchant, date, amount
  - [ ] 4.4: List view: table with columns similar to transactions
  - [ ] 4.5: Empty state component with illustration and "Upload Receipt" button

- [ ] **Task 5: Receipt Filtering UI** (AC: 5)
  - [ ] 5.1: Add date range picker (same component as transactions)
  - [ ] 5.2: Add merchant multi-select (fetch unique merchants from data)
  - [ ] 5.3: Add amount range slider
  - [ ] 5.4: Add reconciliation status filter
  - [ ] 5.5: Add search input for merchant/description
  - [ ] 5.6: Add sort dropdown
  - [ ] 5.7: Update URL query params on filter/sort changes

- [ ] **Task 6: Bulk Selection** (AC: 6)
  - [ ] 6.1: Add checkbox column to transaction/receipt tables
  - [ ] 6.2: Implement "Select All" checkbox in header
  - [ ] 6.3: Track selected items in component state
  - [ ] 6.4: Display "X items selected" when items selected
  - [ ] 6.5: Show bulk action toolbar when items selected
  - [ ] 6.6: Implement "Mark as Reconciled" bulk action
  - [ ] 6.7: Implement "Mark as Ignored" bulk action
  - [ ] 6.8: Implement "Categorize" bulk action (transactions only)

- [ ] **Task 7: URL Query Params Integration** (AC: 3, 5)
  - [ ] 7.1: Use useSearchParams from react-router-dom
  - [ ] 7.2: Serialize filters/sort to URL query string
  - [ ] 7.3: Parse URL query params on page load
  - [ ] 7.4: Apply filters/sort from URL on mount
  - [ ] 7.5: Support shareable URLs (send filtered view link)

- [ ] **Task 8: Testing** (AC: 1, 2, 3, 4, 5, 6)
  - [ ] 8.1: Unit test filter logic (date range, amount range, status)
  - [ ] 8.2: Unit test sort logic (date, amount, description)
  - [ ] 8.3: Unit test bulk selection (select all, select individual)
  - [ ] 8.4: Integration test fetch transactions/receipts
  - [ ] 8.5: Integration test bulk status update
  - [ ] 8.6: E2E test: apply filters → results update
  - [ ] 8.7: E2E test: select items → bulk action → verify updated

## Dev Notes

### Previous Story Insights

**From Story 2.4 (Transaction Preview):**
- Transaction table display with Tanstack Table
- Transaction status: 'unreconciled' | 'reconciled' | 'ignored'

**From Story 3.4 (Receipt OCR):**
- Receipt library view with grid/list toggle
- Receipt filtering and search patterns

**From Specification: dashboard-widgets-table.md:**
- Transaction Table with Tanstack Table v8
- Column definitions, filtering, sorting, pagination
- Bulk actions pattern

### Architecture Context

**Transaction Data (from architecture/data-models.md):**
- transactions table with fields: date, description, amount, balance, category, status
- Linked to bank_accounts via bank_account_id
- Linked to reconciliation_matches for reconciled transactions

**Receipt Data (from docs/specifications/ocr-test-data-schema.md):**
- receipts table with fields: merchant, receipt_date, amount, tax, category, status
- File path for image/PDF display

**Frontend Structure (from architecture/unified-project-structure.md):**
- Pages: `src/pages/Transactions.tsx`, extend `src/pages/Receipts.tsx`
- Components: Filter components, bulk action toolbar
- Hooks: useFilters, useBulkSelection (custom hooks)

### Data Models

**Transaction Interface:**

```typescript
interface Transaction {
  id: string;
  user_id: string;
  bank_account_id: string;
  bank_statement_id: string;
  transaction_date: string;        // ISO format
  description: string;
  amount: number;                  // Negative for debit, positive for credit
  balance: number;
  category?: string;
  status: 'unreconciled' | 'reconciled' | 'ignored';
  reconciliation_match_id?: string;
  created_at: string;
}
```

**Receipt Interface:**

```typescript
interface Receipt {
  id: string;
  user_id: string;
  file_path: string;
  merchant: string;
  receipt_date: string;            // ISO format
  amount: number;
  tax: number;
  category?: string;
  status: 'unreconciled' | 'reconciled' | 'ignored';
  confidence_score: number;
  reconciliation_match_id?: string;
  ocr_data: any;
  uploaded_at: string;
}
```

**Filter State:**

```typescript
interface TransactionFilters {
  dateFrom?: string;               // ISO format
  dateTo?: string;
  amountMin?: number;
  amountMax?: number;
  categories?: string[];
  statuses?: ('unreconciled' | 'reconciled' | 'ignored')[];
  bankAccountIds?: string[];
  searchQuery?: string;
}

interface ReceiptFilters {
  dateFrom?: string;
  dateTo?: string;
  amountMin?: number;
  amountMax?: number;
  merchants?: string[];
  statuses?: ('unreconciled' | 'reconciled' | 'ignored')[];
  searchQuery?: string;
}
```

### Component Specifications

**Transaction Library Page:**

```tsx
// src/pages/Transactions.tsx
import { useState, useEffect } from 'react';
import { useSearchParams } from 'react-router-dom';
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from '@/components/ui/table';
import { Checkbox } from '@/components/ui/checkbox';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { Input } from '@/components/ui/input';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import { Calendar, Filter, X } from 'lucide-react';
import { supabase } from '@/integrations/supabase/client';
import { useAuth } from '@/contexts/AuthContext';
import { formatCurrency, formatDate } from '@/lib/utils';

export default function Transactions() {
  const { user } = useAuth();
  const [searchParams, setSearchParams] = useSearchParams();
  
  const [transactions, setTransactions] = useState<Transaction[]>([]);
  const [selectedIds, setSelectedIds] = useState<Set<string>>(new Set());
  const [isLoading, setIsLoading] = useState(true);

  // Filters from URL or defaults
  const [filters, setFilters] = useState({
    dateFrom: searchParams.get('dateFrom') || '',
    dateTo: searchParams.get('dateTo') || '',
    amountMin: searchParams.get('amountMin') || '',
    amountMax: searchParams.get('amountMax') || '',
    status: searchParams.get('status') || 'unreconciled',
    searchQuery: searchParams.get('q') || '',
  });

  useEffect(() => {
    fetchTransactions();
  }, [filters]);

  const fetchTransactions = async () => {
    setIsLoading(true);

    let query = supabase
      .from('transactions')
      .select('*')
      .eq('user_id', user.id)
      .order('transaction_date', { ascending: false });

    // Apply filters
    if (filters.status) {
      query = query.eq('status', filters.status);
    }
    if (filters.dateFrom) {
      query = query.gte('transaction_date', filters.dateFrom);
    }
    if (filters.dateTo) {
      query = query.lte('transaction_date', filters.dateTo);
    }
    if (filters.amountMin) {
      query = query.gte('amount', parseFloat(filters.amountMin));
    }
    if (filters.amountMax) {
      query = query.lte('amount', parseFloat(filters.amountMax));
    }
    if (filters.searchQuery) {
      query = query.ilike('description', `%${filters.searchQuery}%`);
    }

    const { data, error } = await query;

    if (error) {
      console.error('Error fetching transactions:', error);
    } else {
      setTransactions(data || []);
    }

    setIsLoading(false);
  };

  const handleFilterChange = (key: string, value: any) => {
    const newFilters = { ...filters, [key]: value };
    setFilters(newFilters);

    // Update URL query params
    const params = new URLSearchParams();
    Object.entries(newFilters).forEach(([k, v]) => {
      if (v) params.set(k, v.toString());
    });
    setSearchParams(params);
  };

  const handleClearFilters = () => {
    setFilters({
      dateFrom: '',
      dateTo: '',
      amountMin: '',
      amountMax: '',
      status: 'unreconciled',
      searchQuery: '',
    });
    setSearchParams(new URLSearchParams({ status: 'unreconciled' }));
  };

  const handleSelectAll = () => {
    if (selectedIds.size === transactions.length) {
      setSelectedIds(new Set());
    } else {
      setSelectedIds(new Set(transactions.map(t => t.id)));
    }
  };

  const handleSelectOne = (id: string) => {
    const newSelected = new Set(selectedIds);
    if (newSelected.has(id)) {
      newSelected.delete(id);
    } else {
      newSelected.add(id);
    }
    setSelectedIds(newSelected);
  };

  const handleBulkStatusUpdate = async (newStatus: string) => {
    const ids = Array.from(selectedIds);

    const { error } = await supabase
      .from('transactions')
      .update({ status: newStatus })
      .in('id', ids);

    if (error) {
      console.error('Error updating transactions:', error);
    } else {
      fetchTransactions();
      setSelectedIds(new Set());
    }
  };

  const getStatusBadge = (status: string) => {
    const config = {
      unreconciled: 'bg-yellow-100 text-yellow-700',
      reconciled: 'bg-green-100 text-green-700',
      ignored: 'bg-gray-100 text-gray-700',
    };
    return <Badge className={config[status]}>{status}</Badge>;
  };

  return (
    <div className="min-h-screen bg-cream p-8">
      <div className="max-w-7xl mx-auto">
        <div className="flex items-center justify-between mb-6">
          <div>
            <h1 className="text-3xl font-bold text-charcoal">Transactions</h1>
            <p className="text-stone">
              {transactions.length} transactions found
            </p>
          </div>
          <Button onClick={() => window.location.href = '/upload'}>
            Import Transactions
          </Button>
        </div>

        {/* Filters */}
        <div className="bg-white rounded-lg p-4 mb-6 space-y-4">
          <div className="flex items-center gap-2">
            <Filter className="w-4 h-4 text-stone" />
            <h3 className="font-medium text-charcoal">Filters</h3>
          </div>

          <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
            {/* Search */}
            <Input
              placeholder="Search description..."
              value={filters.searchQuery}
              onChange={(e) => handleFilterChange('searchQuery', e.target.value)}
            />

            {/* Status Filter */}
            <Select
              value={filters.status}
              onValueChange={(value) => handleFilterChange('status', value)}
            >
              <SelectTrigger>
                <SelectValue placeholder="Status" />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="unreconciled">Unreconciled</SelectItem>
                <SelectItem value="reconciled">Reconciled</SelectItem>
                <SelectItem value="ignored">Ignored</SelectItem>
                <SelectItem value="">All</SelectItem>
              </SelectContent>
            </Select>

            {/* Date From */}
            <Input
              type="date"
              placeholder="From date"
              value={filters.dateFrom}
              onChange={(e) => handleFilterChange('dateFrom', e.target.value)}
            />

            {/* Date To */}
            <Input
              type="date"
              placeholder="To date"
              value={filters.dateTo}
              onChange={(e) => handleFilterChange('dateTo', e.target.value)}
            />
          </div>

          <Button variant="outline" size="sm" onClick={handleClearFilters}>
            <X className="w-4 h-4 mr-2" />
            Clear Filters
          </Button>
        </div>

        {/* Bulk Actions Toolbar */}
        {selectedIds.size > 0 && (
          <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4 flex items-center justify-between">
            <p className="text-sm text-blue-900">
              {selectedIds.size} transaction{selectedIds.size > 1 ? 's' : ''} selected
            </p>
            <div className="flex gap-2">
              <Button size="sm" onClick={() => handleBulkStatusUpdate('reconciled')}>
                Mark as Reconciled
              </Button>
              <Button size="sm" variant="outline" onClick={() => handleBulkStatusUpdate('ignored')}>
                Mark as Ignored
              </Button>
            </div>
          </div>
        )}

        {/* Transaction Table */}
        <div className="bg-white rounded-lg overflow-hidden">
          <Table>
            <TableHeader>
              <TableRow>
                <TableHead className="w-12">
                  <Checkbox
                    checked={selectedIds.size === transactions.length && transactions.length > 0}
                    onCheckedChange={handleSelectAll}
                  />
                </TableHead>
                <TableHead>Date</TableHead>
                <TableHead>Description</TableHead>
                <TableHead className="text-right">Amount</TableHead>
                <TableHead className="text-right">Balance</TableHead>
                <TableHead>Category</TableHead>
                <TableHead>Status</TableHead>
              </TableRow>
            </TableHeader>
            <TableBody>
              {transactions.map((transaction) => (
                <TableRow key={transaction.id}>
                  <TableCell>
                    <Checkbox
                      checked={selectedIds.has(transaction.id)}
                      onCheckedChange={() => handleSelectOne(transaction.id)}
                    />
                  </TableCell>
                  <TableCell>{formatDate(transaction.transaction_date)}</TableCell>
                  <TableCell className="font-medium">{transaction.description}</TableCell>
                  <TableCell className="text-right font-mono">
                    <span className={transaction.amount < 0 ? 'text-red-600' : 'text-green-600'}>
                      {transaction.amount < 0 ? '-' : '+'}{formatCurrency(Math.abs(transaction.amount))}
                    </span>
                  </TableCell>
                  <TableCell className="text-right font-mono">
                    {formatCurrency(transaction.balance)}
                  </TableCell>
                  <TableCell>
                    {transaction.category ? (
                      <Badge variant="outline">{transaction.category}</Badge>
                    ) : (
                      <span className="text-stone text-sm">Uncategorized</span>
                    )}
                  </TableCell>
                  <TableCell>{getStatusBadge(transaction.status)}</TableCell>
                </TableRow>
              ))}
            </TableBody>
          </Table>

          {transactions.length === 0 && (
            <div className="text-center py-12">
              <p className="text-stone">No transactions found</p>
            </div>
          )}
        </div>
      </div>
    </div>
  );
}
```

### File Locations

**New Files to Create:**
- `src/pages/Transactions.tsx` - Transaction library view

**Existing Files to Extend:**
- `src/pages/Receipts.tsx` - Add grid/list toggle, bulk selection

**Existing Files to Reference:**
- `src/components/ui/table.tsx` - shadcn Table components
- `src/lib/utils.ts` - formatCurrency, formatDate utilities

### Technical Constraints

**Filtering Performance:**
- Client-side filtering for small datasets (<1000 items)
- Server-side filtering via Supabase query for large datasets
- Debounce search input (300ms delay)

**Pagination:**
- 25 items per page default
- Options: 10, 25, 50, 100
- Use Supabase range() for server-side pagination

**URL Query Params:**
- All filters persisted in URL for shareable links
- Format: `/transactions?status=unreconciled&dateFrom=2025-01-01&q=coffee`
- Parse on mount, update on filter changes

**Bulk Actions:**
- Max 100 items per bulk action (prevent timeout)
- Show progress indicator for large batches
- Optimistic UI updates (update local state before server response)

### Testing Requirements

**Unit Tests:**
- Filter logic (date range, amount range, status, search)
- Sort logic (date, amount, description)
- Bulk selection (select all, select individual, deselect)
- URL query param serialization/deserialization

**Integration Tests:**
- Fetch transactions from database with filters
- Bulk status update (mark as reconciled/ignored)
- Filter persistence in URL query params

**E2E Tests:**
- Apply date filter → results update
- Search description → filtered results
- Select transactions → bulk mark as reconciled → status updates
- Clear filters → all filters reset

### Security Considerations

- RLS policies ensure users only see their own transactions/receipts
- Bulk actions validate user owns all selected items
- SQL injection prevented by Supabase parameterized queries

## Change Log

| Date       | Version | Description                    | Author |
|------------|---------|--------------------------------|--------|
| 2025-10-11 | 1.0     | Initial story draft (from PO) | Sarah  |

## Dev Agent Record

### Agent Model Used
<!-- Dev agent will update this section -->

### Debug Log References
<!-- Dev agent will log commands, test results, lint fixes here -->

### Completion Notes
<!-- Dev agent will document what was implemented, challenges, deviations -->

### File List
<!-- Dev agent will list all files created/modified/deleted -->

## QA Results
<!-- QA agent will append review results here -->
