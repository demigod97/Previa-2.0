# Story 4.3: Interactive Matching Interface

## Status: üîÑ In Progress

**Current State** (2025-10-28):
- ‚úÖ Backend complete: AI matching algorithm (match-receipt-transactions Edge Function)
- ‚úÖ Database: reconciliation_matches table with suggestions
- ‚úÖ Basic reconciliation view exists at /reconciliation (3-panel drag-and-drop layout)
- ‚ùå Side-by-side comparison view not yet implemented per acceptance criteria
- ‚ùå Confidence indicators per field not yet implemented
- ‚ùå Approve/reject workflow not yet implemented
- ‚ùå Manual matching dialog not yet implemented

**What's Working**:
- Receipts page at /receipts with library view (Story 3.4 ‚úÖ)
- Receipt details page at /receipts/:receiptId with AI match suggestions
- AI match suggestions viewable on individual receipt pages
- Users can see suggested matches but can't approve/reject in bulk yet

**What's Needed** (Per This Story):
- Enhance /reconciliation page with:
  - Statistics panel (match counts, reconciliation rate %, avg confidence)
  - Quick actions toolbar (Approve All High Confidence, Manual Match, Refresh)
  - Match cards sorted by confidence (High ‚â•0.80, Medium 0.50-0.79, Low <0.50)
  - Side-by-side comparison with field-level indicators (green/yellow/red)
  - Approve/reject buttons with keyboard shortcuts (A/R/N)
  - Recent approvals section with Undo capability

**See Also**:
- docs/USER-FLOW-RECONCILIATION.md - User journey and navigation guide
- docs/stories/5.3-reconciliation-engine-view.md - Dashboard integration

## Story

As a **Previa user reviewing suggested matches**,
I want **a side-by-side interface showing transaction and receipt details with confidence indicators**,
So that **I can quickly approve accurate matches or reject incorrect ones**.

## Acceptance Criteria

**AC1: Match Review Page**
- Dedicated page at `/reconciliation` route
- Display suggested matches sorted by confidence score (high to low)
- Side-by-side comparison: transaction (left) vs receipt (right)
- Show match count: "X matches found"
- Empty state: "No suggested matches. Upload receipts to find matches."

**NOTE**: The `/reconciliation` page already exists but uses a 3-panel drag-and-drop layout. This story requires enhancing it to match the side-by-side specification above.

**AC2: Match Card UI**
- Each match displayed as a card with:
  - Confidence score badge (High/Medium/Low with color coding)
  - Transaction details: date, description, amount
  - Receipt details: merchant, date, amount
  - Matched fields highlighted in green
  - Mismatched fields highlighted in yellow/red
- Expand/collapse for line item details (receipts)

**AC3: Field Comparison Indicators**
- Date comparison:
  - Exact match: green background, checkmark icon
  - Close match (¬±3 days): yellow background, info icon, show difference
  - Poor match (>3 days): red background, warning icon
- Amount comparison:
  - Exact match: green background, checkmark
  - Close match (within $5): yellow background, show difference
  - Mismatch (>$5): red background
- Description/Merchant similarity:
  - Display similarity percentage
  - High (‚â•60%): green indicator
  - Medium (30-59%): yellow indicator
  - Low (<30%): red indicator

**AC4: Approve/Reject Actions**
- "Approve Match" button: marks match as 'approved', updates transaction/receipt status to 'reconciled'
- "Reject Match" button: marks match as 'rejected', removes from suggested list
- "Not Sure" button: skip to next match (keeps as 'suggested')
- Keyboard shortcuts: A (approve), R (reject), N (next)
- Bulk approve: "Approve All High Confidence" button (confidence ‚â•0.80)

**AC5: Manual Matching**
- "Manual Match" button on unmatched transactions
- Opens dialog with receipt search
- Search receipts by merchant, date, amount
- Select receipt from results
- Create manual match with confidence=1.0, status='approved'

**AC6: Match History & Undo**
- Show recently approved matches in collapsible section
- "Undo" button for last 5 approved matches
- Undo reverts match to 'suggested', resets transaction/receipt status to 'unreconciled'
- Confirmation dialog before undo

## Tasks / Subtasks

- [ ] **Task 1: Match Review Page** (AC: 1)
  - [ ] 1.1: Create `src/pages/Reconciliation.tsx`
  - [ ] 1.2: Fetch suggested matches from reconciliation_matches table
  - [ ] 1.3: Include related transaction and receipt data
  - [ ] 1.4: Sort by confidence_score DESC
  - [ ] 1.5: Display match count
  - [ ] 1.6: Empty state component

- [ ] **Task 2: Match Card Component** (AC: 2, 3)
  - [ ] 2.1: Create `src/components/MatchCard.tsx`
  - [ ] 2.2: Display confidence badge (High ‚â•0.80, Medium 0.50-0.79, Low <0.50)
  - [ ] 2.3: Side-by-side layout (transaction left, receipt right)
  - [ ] 2.4: Display transaction: date, description, amount, balance
  - [ ] 2.5: Display receipt: merchant, date, amount, tax
  - [ ] 2.6: Highlight matched fields with green background
  - [ ] 2.7: Highlight mismatched fields with yellow/red
  - [ ] 2.8: Show field difference text (e.g., "2 days apart", "$3.50 difference")

- [ ] **Task 3: Field Comparison Logic** (AC: 3)
  - [ ] 3.1: Create utility function `compareFields(transaction, receipt, matchCriteria)`
  - [ ] 3.2: Compare dates: calculate day difference, determine color
  - [ ] 3.3: Compare amounts: calculate dollar difference, determine color
  - [ ] 3.4: Compare descriptions: use similarity score from matchCriteria
  - [ ] 3.5: Return comparison results with colors and difference text

- [ ] **Task 4: Approve/Reject Actions** (AC: 4)
  - [ ] 4.1: Implement approveMatch(matchId) function
  - [ ] 4.2: Update reconciliation_matches.status = 'approved'
  - [ ] 4.3: Update transaction.status = 'reconciled'
  - [ ] 4.4: Update receipt.status = 'reconciled'
  - [ ] 4.5: Set reconciliation_match_id on transaction and receipt
  - [ ] 4.6: Implement rejectMatch(matchId) function
  - [ ] 4.7: Update reconciliation_matches.status = 'rejected'
  - [ ] 4.8: Remove from UI (don't show rejected matches)
  - [ ] 4.9: Add keyboard shortcuts (useEffect with event listeners)

- [ ] **Task 5: Bulk Approve** (AC: 4)
  - [ ] 5.1: "Approve All High Confidence" button
  - [ ] 5.2: Filter matches with confidence_score ‚â• 0.80
  - [ ] 5.3: Confirm bulk action with dialog
  - [ ] 5.4: Approve matches in batch (Promise.all)
  - [ ] 5.5: Show progress indicator
  - [ ] 5.6: Toast notification with count

- [ ] **Task 6: Manual Matching** (AC: 5)
  - [ ] 6.1: "Manual Match" button on transaction cards
  - [ ] 6.2: Create `src/components/ManualMatchDialog.tsx`
  - [ ] 6.3: Search receipts by merchant, date range, amount range
  - [ ] 6.4: Display receipt search results
  - [ ] 6.5: Select receipt and create match
  - [ ] 6.6: Insert into reconciliation_matches with confidence=1.0, status='approved'

- [ ] **Task 7: Match History & Undo** (AC: 6)
  - [ ] 7.1: Fetch recently approved matches (last 24 hours)
  - [ ] 7.2: Display in collapsible "Recent Approvals" section
  - [ ] 7.3: "Undo" button per match
  - [ ] 7.4: Confirmation dialog with match details
  - [ ] 7.5: Revert match status to 'suggested'
  - [ ] 7.6: Revert transaction/receipt status to 'unreconciled'
  - [ ] 7.7: Clear reconciliation_match_id

- [ ] **Task 8: Testing** (AC: 1, 2, 3, 4, 5, 6)
  - [ ] 8.1: Unit test field comparison logic
  - [ ] 8.2: Unit test confidence badge mapping
  - [ ] 8.3: Integration test approve match
  - [ ] 8.4: Integration test reject match
  - [ ] 8.5: Integration test undo match
  - [ ] 8.6: Integration test manual match creation
  - [ ] 8.7: E2E test: view suggested match ‚Üí approve ‚Üí verify reconciled
  - [ ] 8.8: E2E test: approve match ‚Üí undo ‚Üí verify back to suggested

## Dev Notes

### Previous Story Insights

**From Story 4.1 (Library Views):**
- Transaction and receipt display patterns
- Status badge components
- Filter and search UI

**From Story 4.2 (Matching Algorithm):**
- reconciliation_matches table structure
- Confidence score calculation
- Match criteria JSONB field

### Architecture Context

**Reconciliation Flow (from docs/prd.md):**
- AI suggests matches ‚Üí User reviews ‚Üí Approve/reject ‚Üí Status updates
- Manual matching for edge cases
- Undo functionality for mistakes

**Frontend Patterns (from frontend-spec-new.md):**
- Side-by-side comparison layout
- Confidence indicators with color coding
- Keyboard shortcuts for power users

**Database Updates (from architecture/backend-architecture.md):**
- Transaction updates (status, reconciliation_match_id)
- Use database transactions for atomic updates

### Data Models

**Match with Relations:**

```typescript
interface MatchWithRelations {
  id: string;
  user_id: string;
  transaction_id: string;
  receipt_id: string;
  confidence_score: number;
  status: 'suggested' | 'approved' | 'rejected';
  match_criteria: MatchCriteria;
  created_at: string;
  updated_at: string;
  transaction: Transaction;
  receipt: Receipt;
}
```

**Field Comparison Result:**

```typescript
interface FieldComparison {
  field: 'date' | 'amount' | 'description';
  match: 'exact' | 'close' | 'poor';
  color: 'green' | 'yellow' | 'red';
  icon: 'checkmark' | 'info' | 'warning';
  difference?: string;  // "2 days apart", "$3.50 more", "45% similar"
}
```

### Component Specifications

**Reconciliation Page:**

```tsx
// src/pages/Reconciliation.tsx
import { useState, useEffect } from 'react';
import { Card } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { AlertCircle } from 'lucide-react';
import MatchCard from '@/components/MatchCard';
import { getSuggestedMatches, approveMatch, rejectMatch } from '@/services/reconciliationService';
import { useToast } from '@/hooks/use-toast';

export default function Reconciliation() {
  const [matches, setMatches] = useState<MatchWithRelations[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const { toast } = useToast();

  useEffect(() => {
    fetchMatches();
  }, []);

  const fetchMatches = async () => {
    setIsLoading(true);
    try {
      const data = await getSuggestedMatches();
      setMatches(data);
    } catch (error) {
      toast({
        title: 'Error loading matches',
        description: error.message,
        variant: 'destructive',
      });
    }
    setIsLoading(false);
  };

  const handleApprove = async (matchId: string) => {
    try {
      await approveMatch(matchId);
      toast({
        title: 'Match approved',
        description: 'Transaction and receipt reconciled.',
      });
      fetchMatches();
    } catch (error) {
      toast({
        title: 'Error approving match',
        description: error.message,
        variant: 'destructive',
      });
    }
  };

  const handleReject = async (matchId: string) => {
    try {
      await rejectMatch(matchId);
      toast({
        title: 'Match rejected',
        description: 'This suggestion has been dismissed.',
      });
      fetchMatches();
    } catch (error) {
      toast({
        title: 'Error rejecting match',
        description: error.message,
        variant: 'destructive',
      });
    }
  };

  const handleBulkApprove = async () => {
    const highConfidenceMatches = matches.filter(m => m.confidence_score >= 0.80);
    
    if (highConfidenceMatches.length === 0) {
      toast({
        title: 'No high confidence matches',
        description: 'There are no matches with confidence ‚â•80%.',
      });
      return;
    }

    try {
      await Promise.all(highConfidenceMatches.map(m => approveMatch(m.id)));
      toast({
        title: `Approved ${highConfidenceMatches.length} matches`,
        description: 'All high confidence matches have been reconciled.',
      });
      fetchMatches();
    } catch (error) {
      toast({
        title: 'Error approving matches',
        description: error.message,
        variant: 'destructive',
      });
    }
  };

  if (isLoading) {
    return <div>Loading matches...</div>;
  }

  if (matches.length === 0) {
    return (
      <div className="min-h-screen bg-cream p-8">
        <div className="max-w-4xl mx-auto text-center py-12">
          <AlertCircle className="w-16 h-16 mx-auto text-stone mb-4" />
          <h2 className="text-2xl font-bold text-charcoal mb-2">
            No suggested matches
          </h2>
          <p className="text-stone mb-6">
            Upload receipts and import transactions to find matches.
          </p>
          <Button onClick={() => window.location.href = '/upload'}>
            Upload Receipts
          </Button>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-cream p-8">
      <div className="max-w-6xl mx-auto">
        <div className="flex items-center justify-between mb-6">
          <div>
            <h1 className="text-3xl font-bold text-charcoal">Reconciliation</h1>
            <p className="text-stone">{matches.length} suggested matches</p>
          </div>
          <Button onClick={handleBulkApprove}>
            Approve All High Confidence
          </Button>
        </div>

        <div className="space-y-4">
          {matches.map((match) => (
            <MatchCard
              key={match.id}
              match={match}
              onApprove={() => handleApprove(match.id)}
              onReject={() => handleReject(match.id)}
            />
          ))}
        </div>
      </div>
    </div>
  );
}
```

**Match Card Component:**

```tsx
// src/components/MatchCard.tsx
import { Card, CardContent } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { CheckCircle, AlertTriangle, XCircle, Check, X } from 'lucide-react';
import { formatCurrency, formatDate } from '@/lib/utils';

interface MatchCardProps {
  match: MatchWithRelations;
  onApprove: () => void;
  onReject: () => void;
}

export default function MatchCard({ match, onApprove, onReject }: MatchCardProps) {
  const { transaction, receipt, confidence_score, match_criteria } = match;

  const getConfidenceBadge = () => {
    if (confidence_score >= 0.80) {
      return <Badge className="bg-green-100 text-green-700">High Confidence ({Math.round(confidence_score * 100)}%)</Badge>;
    } else if (confidence_score >= 0.50) {
      return <Badge className="bg-yellow-100 text-yellow-700">Medium Confidence ({Math.round(confidence_score * 100)}%)</Badge>;
    } else {
      return <Badge className="bg-red-100 text-red-700">Low Confidence ({Math.round(confidence_score * 100)}%)</Badge>;
    }
  };

  const getFieldComparison = (field: 'date' | 'amount' | 'description') => {
    const criteria = match_criteria as MatchCriteria;

    if (field === 'date') {
      const diff = criteria.date_diff_days;
      if (diff === 0) {
        return { color: 'bg-green-100', icon: CheckCircle, text: 'Exact match', textColor: 'text-green-700' };
      } else if (diff <= 3) {
        return { color: 'bg-yellow-100', icon: AlertTriangle, text: `${diff} day${diff > 1 ? 's' : ''} apart`, textColor: 'text-yellow-700' };
      } else {
        return { color: 'bg-red-100', icon: XCircle, text: `${diff} days apart`, textColor: 'text-red-700' };
      }
    }

    if (field === 'amount') {
      const diff = criteria.amount_diff;
      if (diff === 0) {
        return { color: 'bg-green-100', icon: CheckCircle, text: 'Exact match', textColor: 'text-green-700' };
      } else if (diff <= 5) {
        return { color: 'bg-yellow-100', icon: AlertTriangle, text: `${formatCurrency(diff)} difference`, textColor: 'text-yellow-700' };
      } else {
        return { color: 'bg-red-100', icon: XCircle, text: `${formatCurrency(diff)} difference`, textColor: 'text-red-700' };
      }
    }

    if (field === 'description') {
      const similarity = criteria.description_similarity;
      const percent = Math.round(similarity * 100);
      if (similarity >= 0.6) {
        return { color: 'bg-green-100', icon: CheckCircle, text: `${percent}% similar`, textColor: 'text-green-700' };
      } else if (similarity >= 0.3) {
        return { color: 'bg-yellow-100', icon: AlertTriangle, text: `${percent}% similar`, textColor: 'text-yellow-700' };
      } else {
        return { color: 'bg-red-100', icon: XCircle, text: `${percent}% similar`, textColor: 'text-red-700' };
      }
    }
  };

  const dateComp = getFieldComparison('date');
  const amountComp = getFieldComparison('amount');
  const descComp = getFieldComparison('description');

  return (
    <Card>
      <CardContent className="pt-6">
        <div className="flex items-center justify-between mb-4">
          {getConfidenceBadge()}
          <div className="flex gap-2">
            <Button size="sm" onClick={onApprove}>
              <Check className="w-4 h-4 mr-1" />
              Approve
            </Button>
            <Button size="sm" variant="outline" onClick={onReject}>
              <X className="w-4 h-4 mr-1" />
              Reject
            </Button>
          </div>
        </div>

        <div className="grid md:grid-cols-2 gap-6">
          {/* Transaction */}
          <div>
            <h3 className="font-medium text-charcoal mb-3">Transaction</h3>
            <div className="space-y-2">
              <div className={`p-2 rounded ${dateComp.color}`}>
                <p className="text-xs text-stone mb-1">Date</p>
                <div className="flex items-center justify-between">
                  <p className={`font-medium ${dateComp.textColor}`}>
                    {formatDate(transaction.transaction_date)}
                  </p>
                  <dateComp.icon className={`w-4 h-4 ${dateComp.textColor}`} />
                </div>
                <p className={`text-xs ${dateComp.textColor} mt-1`}>{dateComp.text}</p>
              </div>

              <div className={`p-2 rounded ${descComp.color}`}>
                <p className="text-xs text-stone mb-1">Description</p>
                <div className="flex items-center justify-between">
                  <p className={`font-medium ${descComp.textColor}`}>
                    {transaction.description}
                  </p>
                  <descComp.icon className={`w-4 h-4 ${descComp.textColor}`} />
                </div>
                <p className={`text-xs ${descComp.textColor} mt-1`}>{descComp.text}</p>
              </div>

              <div className={`p-2 rounded ${amountComp.color}`}>
                <p className="text-xs text-stone mb-1">Amount</p>
                <div className="flex items-center justify-between">
                  <p className={`font-medium font-mono ${amountComp.textColor}`}>
                    {formatCurrency(Math.abs(transaction.amount))}
                  </p>
                  <amountComp.icon className={`w-4 h-4 ${amountComp.textColor}`} />
                </div>
                <p className={`text-xs ${amountComp.textColor} mt-1`}>{amountComp.text}</p>
              </div>
            </div>
          </div>

          {/* Receipt */}
          <div>
            <h3 className="font-medium text-charcoal mb-3">Receipt</h3>
            <div className="space-y-2">
              <div className={`p-2 rounded ${dateComp.color}`}>
                <p className="text-xs text-stone mb-1">Date</p>
                <p className={`font-medium ${dateComp.textColor}`}>
                  {formatDate(receipt.receipt_date)}
                </p>
              </div>

              <div className={`p-2 rounded ${descComp.color}`}>
                <p className="text-xs text-stone mb-1">Merchant</p>
                <p className={`font-medium ${descComp.textColor}`}>
                  {receipt.merchant}
                </p>
              </div>

              <div className={`p-2 rounded ${amountComp.color}`}>
                <p className="text-xs text-stone mb-1">Amount</p>
                <p className={`font-medium font-mono ${amountComp.textColor}`}>
                  {formatCurrency(receipt.amount)}
                </p>
              </div>
            </div>
          </div>
        </div>
      </CardContent>
    </Card>
  );
}
```

### File Locations

**New Files to Create:**
- `src/pages/Reconciliation.tsx` - Match review page
- `src/components/MatchCard.tsx` - Match comparison card
- `src/components/ManualMatchDialog.tsx` - Manual matching dialog

**Existing Files to Extend:**
- `src/services/reconciliationService.ts` - Add approve/reject/undo functions

### Technical Constraints

**Keyboard Shortcuts:**
- A key: Approve current match
- R key: Reject current match
- N key: Next match (skip)
- Escape: Close dialogs

**Bulk Operations:**
- Max 50 matches per bulk action
- Show progress indicator
- Handle partial failures gracefully

**Undo Functionality:**
- Only last 5 actions undoable
- 24-hour time limit for undo
- Confirmation required

### Testing Requirements

**Unit Tests:**
- Field comparison logic (date/amount/description)
- Confidence badge mapping
- Keyboard shortcut handlers

**Integration Tests:**
- Approve match ‚Üí verify statuses updated
- Reject match ‚Üí verify removed from list
- Undo match ‚Üí verify reverted to suggested
- Manual match ‚Üí verify created with confidence=1.0

**E2E Tests:**
- View suggested matches ‚Üí approve ‚Üí verify in transaction library as reconciled
- Approve match ‚Üí undo ‚Üí verify back in suggested matches
- Bulk approve high confidence ‚Üí verify all reconciled

### Security Considerations

- User can only approve their own matches
- Validate match ownership before approve/reject
- Atomic database updates (transaction status + match status)

## Change Log

| Date       | Version | Description                    | Author |
|------------|---------|--------------------------------|--------|
| 2025-10-11 | 1.0     | Initial story draft (from PO) | Sarah  |

## Dev Agent Record

### Agent Model Used
<!-- Dev agent will update this section -->

### Debug Log References
<!-- Dev agent will log commands, test results, lint fixes here -->

### Completion Notes
<!-- Dev agent will document what was implemented, challenges, deviations -->

### File List
<!-- Dev agent will list all files created/modified/deleted -->

## QA Results
<!-- QA agent will append review results here -->
