# Story 4.4: Match Status Management

## Status: Draft

## Story

As a **Previa user managing reconciliation**,  
I want **to track match status, view reconciliation history, and generate match quality metrics**,  
So that **I can monitor my progress and ensure accuracy**.

## Acceptance Criteria

**AC1: Match Status Workflow**
- Match lifecycle: suggested → approved/rejected
- Approved matches: update transaction.reconciliation_match_id, receipt.reconciliation_match_id
- Approved matches: change transaction.status and receipt.status to 'reconciled'
- Rejected matches: remain in database but hidden from suggested list
- Manual matches: created directly with status='approved', confidence=1.0

**AC2: Reconciliation Dashboard Widget**
- Widget shows:
  - Total transactions (count)
  - Reconciled transactions (count and percentage)
  - Unreconciled transactions (count)
  - Total receipts (count)
  - Matched receipts (count and percentage)
  - Suggested matches pending review (count)
- Progress bar: reconciled / total transactions
- "View Matches" CTA button

**AC3: Match History View**
- Dedicated page at `/reconciliation/history` route
- Display all approved matches for current user
- Table columns: Date Matched, Transaction Description, Receipt Merchant, Amount, Confidence Score
- Filter by: date range, confidence level, manual/auto match
- Sort by: date matched (newest/oldest), confidence (high/low)
- Pagination: 50 items per page

**AC4: Match Quality Metrics**
- Calculate and display:
  - Average confidence score of approved matches
  - Count of high/medium/low confidence matches
  - Manual match count vs auto match count
  - Reconciliation rate: (reconciled / total) * 100%
  - Rejection rate: (rejected / suggested) * 100%
- Display metrics in dashboard widget or dedicated stats page

**AC5: Bulk Match Management**
- "Mark as Reviewed" bulk action: for user to track which matches they've looked at
- "Undo Bulk Approve" action: revert last bulk approval (within 24 hours)
- "Clear Rejected Matches" action: permanently delete rejected matches (confirmation required)
- Export matches to CSV: all approved matches with transaction and receipt details

**AC6: Gamification Integration**
- Award 3 points per match approved
- Challenge: "Reconcile 10 transactions" → 20 bonus points
- Challenge: "Reconcile 50 transactions" → 100 bonus points
- Badge: "Reconciliation Expert" (100 matches approved)
- Display points earned from reconciliation in dashboard

## Tasks / Subtasks

- [ ] **Task 1: Match Status Update Logic** (AC: 1)
  - [ ] 1.1: Implement `approveMatch(matchId)` in reconciliationService
  - [ ] 1.2: Update reconciliation_matches.status = 'approved'
  - [ ] 1.3: Update transactions.status = 'reconciled', set reconciliation_match_id
  - [ ] 1.4: Update receipts.status = 'reconciled', set reconciliation_match_id
  - [ ] 1.5: Set approved_at timestamp, approved_by user_id
  - [ ] 1.6: Use database transaction for atomic update
  - [ ] 1.7: Implement `rejectMatch(matchId)` → set status='rejected'

- [ ] **Task 2: Reconciliation Dashboard Widget** (AC: 2, 4)
  - [ ] 2.1: Create `src/components/ReconciliationWidget.tsx`
  - [ ] 2.2: Fetch transaction counts (total, reconciled, unreconciled)
  - [ ] 2.3: Fetch receipt counts (total, matched)
  - [ ] 2.4: Fetch suggested match count (status='suggested')
  - [ ] 2.5: Calculate reconciliation rate percentage
  - [ ] 2.6: Display progress bar with percentage
  - [ ] 2.7: Add "View Matches" button → navigate to /reconciliation

- [ ] **Task 3: Match History Page** (AC: 3)
  - [ ] 3.1: Create `src/pages/ReconciliationHistory.tsx`
  - [ ] 3.2: Fetch approved matches with related transaction/receipt data
  - [ ] 3.3: Display in table with columns: date, transaction, receipt, amount, confidence
  - [ ] 3.4: Add filter controls (date range, confidence level)
  - [ ] 3.5: Add sort controls (date, confidence)
  - [ ] 3.6: Implement pagination (50 per page)

- [ ] **Task 4: Match Quality Metrics** (AC: 4)
  - [ ] 4.1: Create `src/services/metricsService.ts`
  - [ ] 4.2: Function: `getReconciliationMetrics(userId)`
  - [ ] 4.3: Query: average confidence score of approved matches
  - [ ] 4.4: Query: count matches by confidence level (high/med/low)
  - [ ] 4.5: Query: count manual vs auto matches
  - [ ] 4.6: Calculate reconciliation rate
  - [ ] 4.7: Calculate rejection rate
  - [ ] 4.8: Display metrics in widget or stats page

- [ ] **Task 5: Bulk Match Management** (AC: 5)
  - [ ] 5.1: "Clear Rejected Matches" button
  - [ ] 5.2: Confirmation dialog with count of rejected matches
  - [ ] 5.3: DELETE rejected matches from database
  - [ ] 5.4: "Export to CSV" function
  - [ ] 5.5: Generate CSV with columns: date, transaction, receipt, amount, confidence
  - [ ] 5.6: Trigger browser download

- [ ] **Task 6: Gamification Integration** (AC: 6)
  - [ ] 6.1: On match approval, award 3 points
  - [ ] 6.2: Call gamificationService.awardPoints(userId, 3, 'Match approved')
  - [ ] 6.3: Check reconciliation count, trigger challenges
  - [ ] 6.4: Challenge: 10 reconciliations → 20 points
  - [ ] 6.5: Challenge: 50 reconciliations → 100 points
  - [ ] 6.6: Badge: "Reconciliation Expert" at 100 matches
  - [ ] 6.7: Display points earned in widget

- [ ] **Task 7: Match Undo Functionality** (AC: 1)
  - [ ] 7.1: Implement `undoMatch(matchId)` function
  - [ ] 7.2: Revert reconciliation_matches.status to 'suggested'
  - [ ] 7.3: Revert transaction.status to 'unreconciled', clear reconciliation_match_id
  - [ ] 7.4: Revert receipt.status to 'unreconciled', clear reconciliation_match_id
  - [ ] 7.5: Deduct gamification points (reverse award)
  - [ ] 7.6: Time limit: only allow undo within 24 hours
  - [ ] 7.7: Confirmation dialog before undo

- [ ] **Task 8: Testing** (AC: 1, 2, 3, 4, 5, 6)
  - [ ] 8.1: Unit test match status workflow
  - [ ] 8.2: Unit test metrics calculations
  - [ ] 8.3: Integration test approve match → verify statuses updated
  - [ ] 8.4: Integration test undo match → verify reverted
  - [ ] 8.5: Integration test gamification points awarded
  - [ ] 8.6: Integration test CSV export
  - [ ] 8.7: E2E test: approve match → view in history → undo
  - [ ] 8.8: E2E test: approve 10 matches → challenge completed → points awarded

## Dev Notes

### Previous Story Insights

**From Story 4.2 (Matching Algorithm):**
- reconciliation_matches table with status field
- Confidence score calculation

**From Story 4.3 (Matching Interface):**
- Approve/reject match functions
- Undo functionality pattern

**From docs/specifications/gamification-system.md:**
- Points system: 3 points per reconciliation
- Challenges for reconciliation milestones
- Badge system for achievements

### Architecture Context

**Status Management (from architecture/data-models.md):**
- Match status: suggested → approved/rejected
- Transaction/receipt status: unreconciled → reconciled
- Use database transactions for atomic updates

**Metrics & Reporting (from docs/prd.md):**
- Dashboard widgets show key metrics
- Reconciliation rate as primary KPI
- Match quality metrics guide user behavior

**Gamification (from docs/specifications/gamification-system.md):**
- Points per action (3 points per match)
- Challenges for milestones (10, 50 reconciliations)
- Badges for achievements (100 matches)

### Data Models

**Reconciliation Metrics:**

```typescript
interface ReconciliationMetrics {
  total_transactions: number;
  reconciled_transactions: number;
  unreconciled_transactions: number;
  reconciliation_rate: number;        // Percentage 0-100
  
  total_receipts: number;
  matched_receipts: number;
  unmatched_receipts: number;
  
  suggested_matches: number;
  approved_matches: number;
  rejected_matches: number;
  rejection_rate: number;             // Percentage 0-100
  
  avg_confidence_score: number;       // 0.0-1.0
  high_confidence_count: number;      // ≥0.80
  medium_confidence_count: number;    // 0.50-0.79
  low_confidence_count: number;       // <0.50
  
  manual_match_count: number;
  auto_match_count: number;
}
```

**CSV Export Row:**

```typescript
interface MatchExportRow {
  match_date: string;                 // ISO format
  transaction_date: string;
  transaction_description: string;
  transaction_amount: number;
  receipt_date: string;
  receipt_merchant: string;
  receipt_amount: number;
  confidence_score: number;
  match_type: 'auto' | 'manual';
}
```

### Component Specifications

**Reconciliation Widget:**

```tsx
// src/components/ReconciliationWidget.tsx
import { useEffect, useState } from 'react';
import { Card, CardHeader, CardTitle, CardContent } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Progress } from '@/components/ui/progress';
import { getReconciliationMetrics } from '@/services/metricsService';
import { useNavigate } from 'react-router-dom';

export default function ReconciliationWidget() {
  const [metrics, setMetrics] = useState<ReconciliationMetrics | null>(null);
  const navigate = useNavigate();

  useEffect(() => {
    fetchMetrics();
  }, []);

  const fetchMetrics = async () => {
    const data = await getReconciliationMetrics();
    setMetrics(data);
  };

  if (!metrics) return <div>Loading...</div>;

  return (
    <Card>
      <CardHeader>
        <CardTitle>Reconciliation Progress</CardTitle>
      </CardHeader>
      <CardContent className="space-y-4">
        {/* Progress Bar */}
        <div>
          <div className="flex justify-between text-sm mb-2">
            <span className="text-stone">Transactions Reconciled</span>
            <span className="text-charcoal font-medium">
              {metrics.reconciled_transactions} / {metrics.total_transactions}
            </span>
          </div>
          <Progress value={metrics.reconciliation_rate} className="h-3" />
          <p className="text-xs text-stone mt-1">{Math.round(metrics.reconciliation_rate)}% complete</p>
        </div>

        {/* Stats Grid */}
        <div className="grid grid-cols-2 gap-4">
          <div className="text-center p-3 bg-cream rounded">
            <p className="text-2xl font-bold text-charcoal">{metrics.unreconciled_transactions}</p>
            <p className="text-xs text-stone">Unreconciled</p>
          </div>
          <div className="text-center p-3 bg-cream rounded">
            <p className="text-2xl font-bold text-blue-600">{metrics.suggested_matches}</p>
            <p className="text-xs text-stone">Pending Review</p>
          </div>
        </div>

        {/* Receipts */}
        <div>
          <p className="text-sm text-stone mb-1">Receipts</p>
          <p className="text-charcoal font-medium">
            {metrics.matched_receipts} / {metrics.total_receipts} matched
          </p>
        </div>

        {/* CTA */}
        <Button 
          className="w-full" 
          onClick={() => navigate('/reconciliation')}
          disabled={metrics.suggested_matches === 0}
        >
          {metrics.suggested_matches > 0 
            ? `Review ${metrics.suggested_matches} Match${metrics.suggested_matches > 1 ? 'es' : ''}`
            : 'No Matches to Review'
          }
        </Button>
      </CardContent>
    </Card>
  );
}
```

**Metrics Service:**

```typescript
// src/services/metricsService.ts
import { supabase } from '@/integrations/supabase/client';

export async function getReconciliationMetrics(): Promise<ReconciliationMetrics> {
  const { data: { user } } = await supabase.auth.getUser();
  
  // Transactions
  const { count: totalTransactions } = await supabase
    .from('transactions')
    .select('*', { count: 'exact', head: true })
    .eq('user_id', user.id);

  const { count: reconciledTransactions } = await supabase
    .from('transactions')
    .select('*', { count: 'exact', head: true })
    .eq('user_id', user.id)
    .eq('status', 'reconciled');

  // Receipts
  const { count: totalReceipts } = await supabase
    .from('receipts')
    .select('*', { count: 'exact', head: true })
    .eq('user_id', user.id);

  const { count: matchedReceipts } = await supabase
    .from('receipts')
    .select('*', { count: 'exact', head: true })
    .eq('user_id', user.id)
    .eq('status', 'reconciled');

  // Matches
  const { count: suggestedMatches } = await supabase
    .from('reconciliation_matches')
    .select('*', { count: 'exact', head: true })
    .eq('user_id', user.id)
    .eq('status', 'suggested');

  const { count: approvedMatches } = await supabase
    .from('reconciliation_matches')
    .select('*', { count: 'exact', head: true })
    .eq('user_id', user.id)
    .eq('status', 'approved');

  const { count: rejectedMatches } = await supabase
    .from('reconciliation_matches')
    .select('*', { count: 'exact', head: true })
    .eq('user_id', user.id)
    .eq('status', 'rejected');

  // Confidence breakdown
  const { data: approvedMatchesData } = await supabase
    .from('reconciliation_matches')
    .select('confidence_score')
    .eq('user_id', user.id)
    .eq('status', 'approved');

  const avgConfidence = approvedMatchesData?.length > 0
    ? approvedMatchesData.reduce((sum, m) => sum + m.confidence_score, 0) / approvedMatchesData.length
    : 0;

  const highConfidence = approvedMatchesData?.filter(m => m.confidence_score >= 0.80).length || 0;
  const mediumConfidence = approvedMatchesData?.filter(m => m.confidence_score >= 0.50 && m.confidence_score < 0.80).length || 0;
  const lowConfidence = approvedMatchesData?.filter(m => m.confidence_score < 0.50).length || 0;

  return {
    total_transactions: totalTransactions || 0,
    reconciled_transactions: reconciledTransactions || 0,
    unreconciled_transactions: (totalTransactions || 0) - (reconciledTransactions || 0),
    reconciliation_rate: totalTransactions > 0 ? (reconciledTransactions / totalTransactions) * 100 : 0,
    
    total_receipts: totalReceipts || 0,
    matched_receipts: matchedReceipts || 0,
    unmatched_receipts: (totalReceipts || 0) - (matchedReceipts || 0),
    
    suggested_matches: suggestedMatches || 0,
    approved_matches: approvedMatches || 0,
    rejected_matches: rejectedMatches || 0,
    rejection_rate: (suggestedMatches + rejectedMatches) > 0 ? (rejectedMatches / (suggestedMatches + rejectedMatches)) * 100 : 0,
    
    avg_confidence_score: avgConfidence,
    high_confidence_count: highConfidence,
    medium_confidence_count: mediumConfidence,
    low_confidence_count: lowConfidence,
    
    manual_match_count: 0, // TODO: Track manual vs auto
    auto_match_count: approvedMatches || 0,
  };
}
```

**Gamification Integration:**

```typescript
// src/services/reconciliationService.ts (extend)
import { awardPoints, checkChallengeProgress, awardBadge } from '@/services/gamificationService';

export async function approveMatch(matchId: string): Promise<void> {
  const { data: match } = await supabase
    .from('reconciliation_matches')
    .select('*, transaction:transactions(*), receipt:receipts(*)')
    .eq('id', matchId)
    .single();

  // Update match status
  await supabase
    .from('reconciliation_matches')
    .update({ 
      status: 'approved',
      approved_at: new Date().toISOString(),
      approved_by: user.id,
    })
    .eq('id', matchId);

  // Update transaction
  await supabase
    .from('transactions')
    .update({ 
      status: 'reconciled',
      reconciliation_match_id: matchId,
    })
    .eq('id', match.transaction_id);

  // Update receipt
  await supabase
    .from('receipts')
    .update({ 
      status: 'reconciled',
      reconciliation_match_id: matchId,
    })
    .eq('id', match.receipt_id);

  // Award gamification points
  await awardPoints(user.id, 3, 'Match approved');

  // Check challenges
  const reconciledCount = await getReconciledCount(user.id);
  if (reconciledCount === 10) {
    await awardPoints(user.id, 20, 'Challenge: Reconcile 10 transactions');
  } else if (reconciledCount === 50) {
    await awardPoints(user.id, 100, 'Challenge: Reconcile 50 transactions');
  } else if (reconciledCount === 100) {
    await awardBadge(user.id, 'reconciliation_expert');
  }
}
```

### File Locations

**New Files to Create:**
- `src/components/ReconciliationWidget.tsx` - Dashboard widget
- `src/pages/ReconciliationHistory.tsx` - Match history page
- `src/services/metricsService.ts` - Metrics calculations

**Existing Files to Extend:**
- `src/services/reconciliationService.ts` - Add undo, export functions
- `src/services/gamificationService.ts` - Integrate with reconciliation

### Technical Constraints

**Atomic Updates:**
- Use database transactions for match approval
- All status updates must succeed or all fail
- Prevent partial updates

**Performance:**
- Metrics calculations cached for 5 minutes
- Use COUNT queries instead of fetching all records
- Paginate history view (50 items per page)

**Gamification:**
- Points awarded only on successful approval
- Undo reverses points award
- Challenge progress tracked in user_challenges table

### Testing Requirements

**Unit Tests:**
- Metrics calculation logic
- CSV export data formatting
- Gamification point calculation

**Integration Tests:**
- Approve match → verify all status updates
- Undo match → verify all reversals
- Award points → verify gamification_profiles updated
- Challenge completion → verify bonus points

**E2E Tests:**
- Approve 10 matches → challenge completed → points awarded
- View reconciliation widget → metrics displayed correctly
- Export matches to CSV → file downloads with correct data

### Security Considerations

- User can only approve their own matches
- Undo only allowed within 24 hours
- CSV export only includes user's own data
- Points awarded only once per match

## Change Log

| Date       | Version | Description                    | Author |
|------------|---------|--------------------------------|--------|
| 2025-10-11 | 1.0     | Initial story draft (from PO) | Sarah  |

## Dev Agent Record

### Agent Model Used
<!-- Dev agent will update this section -->

### Debug Log References
<!-- Dev agent will log commands, test results, lint fixes here -->

### Completion Notes
<!-- Dev agent will document what was implemented, challenges, deviations -->

### File List
<!-- Dev agent will list all files created/modified/deleted -->

## QA Results
<!-- QA agent will append review results here -->
