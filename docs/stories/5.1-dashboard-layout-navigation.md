# Story 5.1: Dashboard Layout & Navigation

## Status: Draft

## Story

As a **Previa user accessing the application**,  
I want **a main dashboard layout with sidebar navigation to access all major features**,  
So that **I can easily navigate between Home, Reconciliation, Transactions, and Chat views**.

## Acceptance Criteria

**AC1: Dashboard Layout Component**
- Main layout at `/dashboard` route
- Sidebar navigation (left, collapsible on mobile)
- Main content area (right, responsive)
- Persistent across all dashboard views
- Header with user profile dropdown and notifications icon

**AC2: Sidebar Navigation**
- Four main navigation items:
  - Home (icon: Home) → `/dashboard`
  - Reconciliation (icon: GitMerge) → `/dashboard/reconciliation`
  - Transactions (icon: Receipt) → `/dashboard/transactions`
  - AI Chat (icon: MessageSquare) → `/dashboard/chat`
- Active route highlighted with Previa charcoal background
- Hover states with sand background
- Icons with text labels (hide text on mobile, show icons only)

**AC3: Mobile Responsive Navigation**
- Hamburger menu button (top-left) on mobile (< 768px)
- Sidebar slides in from left as overlay
- Close button or backdrop click closes sidebar
- Navigation items stack vertically
- Touch-friendly tap targets (min 44px height)

**AC4: User Profile Dropdown**
- Display user name and email in header
- Avatar with initials or profile picture
- Dropdown menu with:
  - Settings
  - Billing (placeholder)
  - Help & Support
  - Log Out
- Log out confirms and redirects to landing page

**AC5: Notifications Icon**
- Bell icon with badge count (unread notifications)
- Dropdown panel with recent notifications:
  - "New match found" (reconciliation)
  - "Receipt processed" (OCR completed)
  - "Challenge completed" (gamification)
- Mark as read functionality
- "View All" link to notifications page (future)

**AC6: Breadcrumbs Navigation**
- Display breadcrumbs below header for sub-pages
- Format: Dashboard > Reconciliation > History
- Clickable links to navigate back
- Hide on top-level routes

## Tasks / Subtasks

- [ ] **Task 1: Create Dashboard Layout** (AC: 1)
  - [ ] 1.1: Create `src/layouts/DashboardLayout.tsx`
  - [ ] 1.2: Implement two-column layout (sidebar + main content)
  - [ ] 1.3: Add header with logo, user profile, notifications
  - [ ] 1.4: Use Outlet from react-router-dom for nested routes
  - [ ] 1.5: Style with Tailwind CSS and Previa colors

- [ ] **Task 2: Sidebar Navigation** (AC: 2)
  - [ ] 2.1: Create `src/components/Sidebar.tsx`
  - [ ] 2.2: Add navigation items with react-router-dom NavLink
  - [ ] 2.3: Import icons from lucide-react (Home, GitMerge, Receipt, MessageSquare)
  - [ ] 2.4: Highlight active route with charcoal background
  - [ ] 2.5: Add hover states with sand background
  - [ ] 2.6: Responsive: show icons only on mobile, icons + text on desktop

- [ ] **Task 3: Mobile Navigation** (AC: 3)
  - [ ] 3.1: Add hamburger menu button (Menu icon)
  - [ ] 3.2: Implement sidebar state (open/closed) with useState
  - [ ] 3.3: Sidebar slides in as overlay on mobile
  - [ ] 3.4: Add backdrop click to close sidebar
  - [ ] 3.5: Add close button (X icon) in mobile sidebar
  - [ ] 3.6: Use Tailwind responsive utilities (md:hidden, md:block)

- [ ] **Task 4: User Profile Dropdown** (AC: 4)
  - [ ] 4.1: Create `src/components/UserProfileDropdown.tsx`
  - [ ] 4.2: Display user name and email from AuthContext
  - [ ] 4.3: Generate avatar with initials (first letter of name)
  - [ ] 4.4: Use shadcn DropdownMenu component
  - [ ] 4.5: Add menu items: Settings, Billing, Help, Log Out
  - [ ] 4.6: Implement logout: call supabase.auth.signOut(), redirect to '/'

- [ ] **Task 5: Notifications Dropdown** (AC: 5)
  - [ ] 5.1: Create `src/components/NotificationsDropdown.tsx`
  - [ ] 5.2: Bell icon with badge count (unread notifications)
  - [ ] 5.3: Fetch notifications from database (future table)
  - [ ] 5.4: Display in dropdown panel (recent 5 notifications)
  - [ ] 5.5: "Mark as Read" button per notification
  - [ ] 5.6: "View All" link to /dashboard/notifications (future)
  - [ ] 5.7: For MVP: Show placeholder notifications

- [ ] **Task 6: Breadcrumbs Component** (AC: 6)
  - [ ] 6.1: Create `src/components/Breadcrumbs.tsx`
  - [ ] 6.2: Use useLocation from react-router-dom to get current path
  - [ ] 6.3: Parse path segments into breadcrumb items
  - [ ] 6.4: Render as clickable links (ChevronRight separator)
  - [ ] 6.5: Hide on top-level /dashboard route
  - [ ] 6.6: Style with Previa colors

- [ ] **Task 7: Route Configuration** (AC: 1)
  - [ ] 7.1: Update `src/App.tsx` routing
  - [ ] 7.2: Wrap dashboard routes with DashboardLayout
  - [ ] 7.3: Nested routes: /dashboard, /dashboard/reconciliation, etc.
  - [ ] 7.4: Protect dashboard routes with auth check
  - [ ] 7.5: Redirect to /login if not authenticated

- [ ] **Task 8: Testing** (AC: 1, 2, 3, 4, 5, 6)
  - [ ] 8.1: Unit test active route highlighting
  - [ ] 8.2: Unit test mobile sidebar open/close
  - [ ] 8.3: Unit test logout functionality
  - [ ] 8.4: Integration test navigation between views
  - [ ] 8.5: E2E test: login → navigate to dashboard → click sidebar items
  - [ ] 8.6: E2E test: mobile → open menu → navigate → menu closes

## Dev Notes

### Previous Story Insights

**From Story 1.1 (Supabase Setup):**
- Authentication with Supabase Auth
- Protected routes pattern

**From Story 1.6 (Design System):**
- Previa colors, Inter font, component library
- Responsive design patterns

**From docs/frontend-spec-new.md:**
- Dashboard layout with sidebar navigation
- Multi-view structure (Home, Reconciliation, Transactions, Chat)

### Architecture Context

**Layout Pattern (from architecture/unified-project-structure.md):**
- DashboardLayout wraps all authenticated views
- Outlet for nested route rendering
- Sidebar persists across views

**Navigation (from docs/frontend-spec-new.md):**
- 4 main views accessible from sidebar
- Active route highlighting
- Mobile hamburger menu

**Authentication (from architecture/backend-architecture.md):**
- Supabase Auth session management
- Redirect to /login if unauthenticated
- AuthContext for user data

### Data Models

**Navigation Item:**

```typescript
interface NavItem {
  label: string;
  path: string;
  icon: LucideIcon;
  badge?: number;  // For notification counts
}
```

**User Profile:**

```typescript
interface UserProfile {
  id: string;
  email: string;
  full_name?: string;
  avatar_url?: string;
}
```

**Notification (Placeholder for MVP):**

```typescript
interface Notification {
  id: string;
  user_id: string;
  type: 'match_found' | 'receipt_processed' | 'challenge_completed';
  title: string;
  message: string;
  read: boolean;
  created_at: string;
}
```

### Component Specifications

**Dashboard Layout:**

```tsx
// src/layouts/DashboardLayout.tsx
import { useState } from 'react';
import { Outlet } from 'react-router-dom';
import Sidebar from '@/components/Sidebar';
import UserProfileDropdown from '@/components/UserProfileDropdown';
import NotificationsDropdown from '@/components/NotificationsDropdown';
import { Menu, X } from 'lucide-react';
import { Button } from '@/components/ui/button';

export default function DashboardLayout() {
  const [sidebarOpen, setSidebarOpen] = useState(false);

  return (
    <div className="min-h-screen bg-cream flex">
      {/* Mobile Overlay */}
      {sidebarOpen && (
        <div
          className="fixed inset-0 bg-black/50 z-40 md:hidden"
          onClick={() => setSidebarOpen(false)}
        />
      )}

      {/* Sidebar */}
      <div
        className={`
          fixed md:static inset-y-0 left-0 z-50
          w-64 bg-white border-r border-stone
          transform transition-transform duration-300
          ${sidebarOpen ? 'translate-x-0' : '-translate-x-full'}
          md:translate-x-0
        `}
      >
        {/* Close button (mobile only) */}
        <Button
          variant="ghost"
          size="sm"
          className="absolute top-4 right-4 md:hidden"
          onClick={() => setSidebarOpen(false)}
        >
          <X className="w-5 h-5" />
        </Button>

        <Sidebar onNavigate={() => setSidebarOpen(false)} />
      </div>

      {/* Main Content */}
      <div className="flex-1 flex flex-col">
        {/* Header */}
        <header className="bg-white border-b border-stone px-4 py-3 flex items-center justify-between">
          {/* Mobile Menu Button */}
          <Button
            variant="ghost"
            size="sm"
            className="md:hidden"
            onClick={() => setSidebarOpen(true)}
          >
            <Menu className="w-5 h-5" />
          </Button>

          {/* Logo (desktop) */}
          <div className="hidden md:flex items-center gap-2">
            <h1 className="text-xl font-bold text-charcoal">Previa</h1>
          </div>

          {/* Right side: Notifications + Profile */}
          <div className="flex items-center gap-3">
            <NotificationsDropdown />
            <UserProfileDropdown />
          </div>
        </header>

        {/* Page Content */}
        <main className="flex-1 overflow-auto">
          <Outlet />
        </main>
      </div>
    </div>
  );
}
```

**Sidebar Component:**

```tsx
// src/components/Sidebar.tsx
import { NavLink } from 'react-router-dom';
import { Home, GitMerge, Receipt, MessageSquare } from 'lucide-react';

interface SidebarProps {
  onNavigate?: () => void;
}

export default function Sidebar({ onNavigate }: SidebarProps) {
  const navItems = [
    { label: 'Home', path: '/dashboard', icon: Home },
    { label: 'Reconciliation', path: '/dashboard/reconciliation', icon: GitMerge },
    { label: 'Transactions', path: '/dashboard/transactions', icon: Receipt },
    { label: 'AI Chat', path: '/dashboard/chat', icon: MessageSquare },
  ];

  return (
    <nav className="p-4 space-y-2">
      <div className="mb-6 hidden md:block">
        <h2 className="text-2xl font-bold text-charcoal">Previa</h2>
        <p className="text-sm text-stone">Financial Intelligence</p>
      </div>

      {navItems.map((item) => {
        const Icon = item.icon;
        return (
          <NavLink
            key={item.path}
            to={item.path}
            end={item.path === '/dashboard'}
            onClick={onNavigate}
            className={({ isActive }) =>
              `flex items-center gap-3 px-4 py-3 rounded-lg transition-colors ${
                isActive
                  ? 'bg-charcoal text-white'
                  : 'text-charcoal hover:bg-sand'
              }`
            }
          >
            <Icon className="w-5 h-5" />
            <span className="font-medium">{item.label}</span>
          </NavLink>
        );
      })}
    </nav>
  );
}
```

**User Profile Dropdown:**

```tsx
// src/components/UserProfileDropdown.tsx
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuLabel,
  DropdownMenuSeparator,
  DropdownMenuTrigger,
} from '@/components/ui/dropdown-menu';
import { Avatar, AvatarFallback } from '@/components/ui/avatar';
import { Settings, HelpCircle, LogOut } from 'lucide-react';
import { useAuth } from '@/contexts/AuthContext';
import { useNavigate } from 'react-router-dom';
import { supabase } from '@/integrations/supabase/client';

export default function UserProfileDropdown() {
  const { user } = useAuth();
  const navigate = useNavigate();

  const handleLogout = async () => {
    await supabase.auth.signOut();
    navigate('/');
  };

  const getInitials = (email: string) => {
    return email.charAt(0).toUpperCase();
  };

  return (
    <DropdownMenu>
      <DropdownMenuTrigger className="flex items-center gap-2 hover:bg-sand px-3 py-2 rounded-lg transition-colors">
        <Avatar className="w-8 h-8">
          <AvatarFallback className="bg-charcoal text-white text-sm">
            {getInitials(user?.email || 'U')}
          </AvatarFallback>
        </Avatar>
        <div className="hidden md:block text-left">
          <p className="text-sm font-medium text-charcoal">{user?.email}</p>
        </div>
      </DropdownMenuTrigger>
      <DropdownMenuContent align="end" className="w-56">
        <DropdownMenuLabel>My Account</DropdownMenuLabel>
        <DropdownMenuSeparator />
        <DropdownMenuItem onClick={() => navigate('/dashboard/settings')}>
          <Settings className="w-4 h-4 mr-2" />
          Settings
        </DropdownMenuItem>
        <DropdownMenuItem>
          <HelpCircle className="w-4 h-4 mr-2" />
          Help & Support
        </DropdownMenuItem>
        <DropdownMenuSeparator />
        <DropdownMenuItem onClick={handleLogout}>
          <LogOut className="w-4 h-4 mr-2" />
          Log Out
        </DropdownMenuItem>
      </DropdownMenuContent>
    </DropdownMenu>
  );
}
```

**Notifications Dropdown (Placeholder):**

```tsx
// src/components/NotificationsDropdown.tsx
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuTrigger,
} from '@/components/ui/dropdown-menu';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { Bell } from 'lucide-react';

export default function NotificationsDropdown() {
  const notifications = []; // TODO: Fetch from database
  const unreadCount = 0;

  return (
    <DropdownMenu>
      <DropdownMenuTrigger asChild>
        <Button variant="ghost" size="sm" className="relative">
          <Bell className="w-5 h-5" />
          {unreadCount > 0 && (
            <Badge className="absolute -top-1 -right-1 w-5 h-5 p-0 flex items-center justify-center text-xs">
              {unreadCount}
            </Badge>
          )}
        </Button>
      </DropdownMenuTrigger>
      <DropdownMenuContent align="end" className="w-80">
        <div className="p-4">
          <h3 className="font-medium text-charcoal mb-3">Notifications</h3>
          {notifications.length === 0 ? (
            <p className="text-sm text-stone text-center py-4">
              No new notifications
            </p>
          ) : (
            <div className="space-y-2">
              {/* Notification items will go here */}
            </div>
          )}
        </div>
      </DropdownMenuContent>
    </DropdownMenu>
  );
}
```

### File Locations

**New Files to Create:**
- `src/layouts/DashboardLayout.tsx` - Main dashboard layout
- `src/components/Sidebar.tsx` - Navigation sidebar
- `src/components/UserProfileDropdown.tsx` - User profile menu
- `src/components/NotificationsDropdown.tsx` - Notifications menu
- `src/components/Breadcrumbs.tsx` - Breadcrumb navigation

**Existing Files to Modify:**
- `src/App.tsx` - Add dashboard routes with nested routing

### Technical Constraints

**Mobile Responsive:**
- Sidebar hidden by default on <768px
- Hamburger menu button visible on mobile
- Sidebar slides in as overlay (z-index 50)
- Backdrop closes sidebar on click

**Navigation:**
- Use NavLink for automatic active state
- End prop for exact matching on /dashboard route
- Previa charcoal background for active, sand for hover

**Authentication:**
- Dashboard routes protected with auth check
- Redirect to /login if not authenticated
- Logout clears session and redirects to landing

### Testing Requirements

**Unit Tests:**
- Sidebar renders all navigation items
- Active route highlighted correctly
- User initials generated from email
- Logout function called

**Integration Tests:**
- Navigate between dashboard views
- Sidebar persists across routes
- User profile dropdown displays user data

**E2E Tests:**
- Login → dashboard loads with sidebar
- Click navigation item → route changes
- Mobile → open menu → navigate → menu closes
- Logout → redirects to landing page

### Security Considerations

- Authentication required for all dashboard routes
- User profile data from AuthContext (secured by RLS)
- Logout clears JWT token from localStorage

## Change Log

| Date       | Version | Description                    | Author |
|------------|---------|--------------------------------|--------|
| 2025-10-11 | 1.0     | Initial story draft (from PO) | Sarah  |

## Dev Agent Record

### Agent Model Used
<!-- Dev agent will update this section -->

### Debug Log References
<!-- Dev agent will log commands, test results, lint fixes here -->

### Completion Notes
<!-- Dev agent will document what was implemented, challenges, deviations -->

### File List
<!-- Dev agent will list all files created/modified/deleted -->

## QA Results
<!-- QA agent will append review results here -->
