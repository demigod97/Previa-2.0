# Story 5.2: Home View with Widgets

## Status: Draft

## Story

As a **Previa user accessing the dashboard**,  
I want **a Home view with widgets showing spending trends, income vs expenses, unreconciled alerts, and recent transactions**,  
So that **I get an at-a-glance overview of my financial status**.

## Acceptance Criteria

**AC1: Home View Layout**
- Page at `/dashboard` route (default view)
- Grid layout for widgets (2x2 on desktop, 1 column on mobile)
- Responsive widget cards with consistent styling
- Loading states for all widgets

**AC2: Monthly Spending LineChart Widget**
- Display spending trend for last 6 months
- LineChart from recharts library
- X-axis: Months (e.g., "Jan", "Feb", "Mar")
- Y-axis: Amount in AUD dollars
- Tooltip shows exact amount on hover
- No data state: "No transactions yet"

**AC3: Income vs Expenses BarChart Widget**
- Display current month comparison
- BarChart from recharts with two bars per month
- Green bar for income (positive transactions)
- Red bar for expenses (negative transactions)
- Show net difference at top (income - expenses)
- Tooltip shows breakdown

**AC4: Unreconciled Alert Widget**
- Display count of unreconciled transactions
- Visual alert styling (yellow/orange background)
- "Reconcile Now" CTA button → navigate to `/dashboard/reconciliation`
- Display count of unmatched receipts
- Show estimated tax savings if reconciled

**AC5: Recent Transactions Widget**
- Display last 10 transactions
- Mini table with columns: Date, Description, Amount
- Click row to view transaction details
- "View All" button → navigate to `/dashboard/transactions`
- Empty state: "No transactions imported"

**AC6: Date Range Selector**
- Dropdown to select time range for widgets
- Options: Last 7 days, Last 30 days, Last 3 months, Last 6 months, Last Year
- Update all widgets when range changes
- Default: Last 30 days

## Tasks / Subtasks

- [ ] **Task 1: Create Home View Page** (AC: 1)
  - [ ] 1.1: Create `src/pages/Dashboard.tsx`
  - [ ] 1.2: Implement grid layout for widgets (2x2 on desktop)
  - [ ] 1.3: Add responsive classes (stack on mobile)
  - [ ] 1.4: Add page title and description
  - [ ] 1.5: Add loading states while fetching data

- [ ] **Task 2: Monthly Spending Widget** (AC: 2)
  - [ ] 2.1: Create `src/components/widgets/MonthlySpendingWidget.tsx`
  - [ ] 2.2: Fetch transactions grouped by month (last 6 months)
  - [ ] 2.3: Calculate total spending per month (sum negative amounts)
  - [ ] 2.4: Implement LineChart with recharts
  - [ ] 2.5: Configure X-axis (months), Y-axis (amounts)
  - [ ] 2.6: Add tooltip with formatCurrency
  - [ ] 2.7: Style with Previa colors (charcoal line, sand fill)

- [ ] **Task 3: Income vs Expenses Widget** (AC: 3)
  - [ ] 3.1: Create `src/components/widgets/IncomeExpensesWidget.tsx`
  - [ ] 3.2: Fetch current month transactions
  - [ ] 3.3: Calculate income (sum positive amounts)
  - [ ] 3.4: Calculate expenses (sum negative amounts)
  - [ ] 3.5: Implement BarChart with recharts
  - [ ] 3.6: Two bars: income (green), expenses (red)
  - [ ] 3.7: Display net difference at top with color (positive=green, negative=red)

- [ ] **Task 4: Unreconciled Alert Widget** (AC: 4)
  - [ ] 4.1: Create `src/components/widgets/UnreconciledAlertWidget.tsx`
  - [ ] 4.2: Fetch count of unreconciled transactions
  - [ ] 4.3: Fetch count of unmatched receipts
  - [ ] 4.4: Display with alert styling (yellow background, AlertCircle icon)
  - [ ] 4.5: "Reconcile Now" button → navigate to /dashboard/reconciliation
  - [ ] 4.6: Show estimated tax savings (optional calculation)

- [ ] **Task 5: Recent Transactions Widget** (AC: 5)
  - [ ] 5.1: Create `src/components/widgets/RecentTransactionsWidget.tsx`
  - [ ] 5.2: Fetch last 10 transactions for user
  - [ ] 5.3: Display in mini table (shadcn Table component)
  - [ ] 5.4: Columns: Date (DD/MM/YYYY), Description (truncate if long), Amount (color-coded)
  - [ ] 5.5: Click row → navigate to transaction details (future)
  - [ ] 5.6: "View All" button → navigate to /dashboard/transactions
  - [ ] 5.7: Empty state component

- [ ] **Task 6: Date Range Selector** (AC: 6)
  - [ ] 6.1: Create date range selector component
  - [ ] 6.2: Use shadcn Select component
  - [ ] 6.3: Options: Last 7/30 days, 3/6 months, Last Year
  - [ ] 6.4: Store selected range in component state
  - [ ] 6.5: Pass date range to all widgets
  - [ ] 6.6: Widgets refetch data when range changes

- [ ] **Task 7: Data Fetching Services** (AC: 2, 3, 5)
  - [ ] 7.1: Create `src/services/dashboardService.ts`
  - [ ] 7.2: Function: `getMonthlySpending(userId, months)`
  - [ ] 7.3: Function: `getIncomeExpenses(userId, dateFrom, dateTo)`
  - [ ] 7.4: Function: `getRecentTransactions(userId, limit)`
  - [ ] 7.5: Function: `getUnreconciledCounts(userId)`

- [ ] **Task 8: Testing** (AC: 1, 2, 3, 4, 5, 6)
  - [ ] 8.1: Unit test monthly spending calculation
  - [ ] 8.2: Unit test income/expenses calculation
  - [ ] 8.3: Unit test unreconciled count
  - [ ] 8.4: Integration test widget data fetching
  - [ ] 8.5: E2E test: login → dashboard loads → widgets display

## Dev Notes

### Previous Story Insights

**From docs/specifications/dashboard-widgets-table.md:**
- Monthly Spending LineChart configuration
- Income vs Expenses BarChart configuration
- Unreconciled Alert card specs
- Recent Transactions mini table

**From Story 5.1 (Dashboard Layout):**
- DashboardLayout wraps all views
- Home is default route at /dashboard

### Architecture Context

**Widget Specifications (from docs/specifications/dashboard-widgets-table.md):**
- LineChart: last 6 months spending trend
- BarChart: current month income vs expenses
- Alert card: unreconciled count with CTA
- Mini table: last 10 transactions

**Data Visualization (from docs/frontend-spec-new.md):**
- recharts library for LineChart and BarChart
- Responsive charts (mobile-friendly)
- Previa color palette for data viz

### Data Models

**Monthly Spending Data:**

```typescript
interface MonthlySpendingData {
  month: string;  // "Jan", "Feb", "Mar"
  year: number;
  amount: number; // Total spending (positive number)
}
```

**Income Expenses Data:**

```typescript
interface IncomeExpensesData {
  income: number;   // Sum of positive transactions
  expenses: number; // Sum of negative transactions (absolute value)
  net: number;      // income - expenses
}
```

**Unreconciled Counts:**

```typescript
interface UnreconciledCounts {
  transactions: number;
  receipts: number;
  estimated_tax_savings?: number;
}
```

### Component Specifications

**Home View:**

```tsx
// src/pages/Dashboard.tsx
import { useState } from 'react';
import MonthlySpendingWidget from '@/components/widgets/MonthlySpendingWidget';
import IncomeExpensesWidget from '@/components/widgets/IncomeExpensesWidget';
import UnreconciledAlertWidget from '@/components/widgets/UnreconciledAlertWidget';
import RecentTransactionsWidget from '@/components/widgets/RecentTransactionsWidget';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';

export default function Dashboard() {
  const [dateRange, setDateRange] = useState('30'); // days

  return (
    <div className="p-8">
      <div className="flex items-center justify-between mb-6">
        <div>
          <h1 className="text-3xl font-bold text-charcoal">Dashboard</h1>
          <p className="text-stone">Your financial overview</p>
        </div>
        <Select value={dateRange} onValueChange={setDateRange}>
          <SelectTrigger className="w-48">
            <SelectValue />
          </SelectTrigger>
          <SelectContent>
            <SelectItem value="7">Last 7 days</SelectItem>
            <SelectItem value="30">Last 30 days</SelectItem>
            <SelectItem value="90">Last 3 months</SelectItem>
            <SelectItem value="180">Last 6 months</SelectItem>
            <SelectItem value="365">Last Year</SelectItem>
          </SelectContent>
        </Select>
      </div>

      {/* Widgets Grid */}
      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
        <MonthlySpendingWidget dateRange={parseInt(dateRange)} />
        <IncomeExpensesWidget dateRange={parseInt(dateRange)} />
        <UnreconciledAlertWidget />
        <RecentTransactionsWidget />
      </div>
    </div>
  );
}
```

**Monthly Spending Widget:**

```tsx
// src/components/widgets/MonthlySpendingWidget.tsx
import { useEffect, useState } from 'react';
import { Card, CardHeader, CardTitle, CardContent } from '@/components/ui/card';
import { LineChart, Line, XAxis, YAxis, Tooltip, ResponsiveContainer } from 'recharts';
import { getMonthlySpending } from '@/services/dashboardService';
import { formatCurrency } from '@/lib/utils';

interface MonthlySpendingWidgetProps {
  dateRange: number;
}

export default function MonthlySpendingWidget({ dateRange }: MonthlySpendingWidgetProps) {
  const [data, setData] = useState([]);
  const [isLoading, setIsLoading] = useState(true);

  useEffect(() => {
    fetchData();
  }, [dateRange]);

  const fetchData = async () => {
    setIsLoading(true);
    const months = Math.ceil(dateRange / 30);
    const spendingData = await getMonthlySpending(months);
    setData(spendingData);
    setIsLoading(false);
  };

  if (isLoading) return <Card><CardContent>Loading...</CardContent></Card>;

  return (
    <Card>
      <CardHeader>
        <CardTitle>Monthly Spending Trend</CardTitle>
      </CardHeader>
      <CardContent>
        {data.length === 0 ? (
          <p className="text-center text-stone py-8">No transaction data yet</p>
        ) : (
          <ResponsiveContainer width="100%" height={250}>
            <LineChart data={data}>
              <XAxis dataKey="month" stroke="#8C877D" />
              <YAxis stroke="#8C877D" />
              <Tooltip
                formatter={(value) => formatCurrency(value)}
                contentStyle={{ backgroundColor: '#F2E9D8', border: '1px solid #8C877D' }}
              />
              <Line
                type="monotone"
                dataKey="amount"
                stroke="#403B31"
                strokeWidth={2}
                fill="#D9C8B4"
              />
            </LineChart>
          </ResponsiveContainer>
        )}
      </CardContent>
    </Card>
  );
}
```

### File Locations

**New Files to Create:**
- `src/pages/Dashboard.tsx` - Home view
- `src/components/widgets/MonthlySpendingWidget.tsx`
- `src/components/widgets/IncomeExpensesWidget.tsx`
- `src/components/widgets/UnreconciledAlertWidget.tsx`
- `src/components/widgets/RecentTransactionsWidget.tsx`
- `src/services/dashboardService.ts` - Widget data fetching

### Technical Constraints

**Chart Performance:**
- Limit data points (max 12 months for LineChart)
- Use recharts ResponsiveContainer for mobile
- Lazy load recharts library

**Data Aggregation:**
- Group transactions by month server-side (SQL GROUP BY)
- Cache widget data for 5 minutes
- Debounce date range changes

**Mobile Responsive:**
- Stack widgets vertically on mobile
- Reduce chart height on small screens
- Touch-friendly tooltips

### Testing Requirements

**Unit Tests:**
- Monthly spending aggregation logic
- Income/expenses calculation
- Date range conversion (days → months)

**Integration Tests:**
- Fetch monthly spending data
- Fetch income/expenses data
- Fetch unreconciled counts
- Fetch recent transactions

**E2E Tests:**
- Dashboard loads with all widgets
- Change date range → widgets update
- Click "Reconcile Now" → navigate to reconciliation
- Click "View All" → navigate to transactions

### Security Considerations

- All widget data filtered by user_id (RLS policies)
- No sensitive data in chart tooltips
- Dashboard requires authentication

## Change Log

| Date       | Version | Description                    | Author |
|------------|---------|--------------------------------|--------|
| 2025-10-11 | 1.0     | Initial story draft (from PO) | Sarah  |

## Dev Agent Record

### Agent Model Used
<!-- Dev agent will update this section -->

### Debug Log References
<!-- Dev agent will log commands, test results, lint fixes here -->

### Completion Notes
<!-- Dev agent will document what was implemented, challenges, deviations -->

### File List
<!-- Dev agent will list all files created/modified/deleted -->

## QA Results
<!-- QA agent will append review results here -->
