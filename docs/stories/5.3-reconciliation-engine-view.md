# Story 5.3: Reconciliation Engine View

## Status: Draft

## Story

As a **Previa user managing transactions**,  
I want **a Reconciliation Engine view that embeds the AI matching interface from Story 4.3 in the dashboard context**,  
So that **I can review and approve suggested matches with comprehensive statistics and filtering**.

## Acceptance Criteria

**AC1: Reconciliation View Layout**
- Page at `/dashboard/reconciliation` route
- Embed MatchCard components from Story 4.3
- Display match statistics summary at top
- Filter controls sidebar (or top bar on mobile)

**AC2: AI-Suggested Matches Section**
- Display all suggested matches sorted by confidence (high to low)
- Use MatchCard component from Story 4.3
- Side-by-side comparison (transaction left, receipt right)
- Confidence badges: High ≥0.80 (green), Medium 0.50-0.79 (yellow), Low <0.50 (red)
- Show match count: "X suggested matches"

**AC3: Quick Actions Toolbar**
- "Approve All High Confidence" button (filters ≥0.80)
- Confirmation dialog showing count before bulk approve
- "Manual Match" button opens ManualMatchDialog from Story 4.3
- "Refresh Matches" button re-runs matching algorithm
- Actions disabled when no matches

**AC4: Match Statistics Summary**
- Card displaying key metrics:
  - Total suggested matches
  - Total approved matches today/this week
  - Total rejected matches
  - Reconciliation rate percentage with progress bar
  - Average confidence score
- Update in real-time after approve/reject actions

**AC5: Filter by Confidence Level**
- Tabs or radio buttons: All / High / Medium / Low
- Filter suggested matches by confidence level
- Update match count when filter changes
- Default: Show All

**AC6: Gamification Progress Display**
- Display points earned from reconciliation this week
- Show current challenge progress (e.g., "Reconcile 10 transactions: 7/10")
- Progress bar for active challenge
- "X more matches to unlock badge" text
- Link to full gamification view (Story 5.6)

## Tasks / Subtasks

- [ ] **Task 1: Create Reconciliation View Page** (AC: 1)
  - [ ] 1.1: Create `src/pages/ReconciliationEngine.tsx`
  - [ ] 1.2: Import components from Story 4.3 (MatchCard, ManualMatchDialog)
  - [ ] 1.3: Layout with statistics at top, actions toolbar, match list
  - [ ] 1.4: Responsive layout (sidebar on desktop, top bar on mobile)

- [ ] **Task 2: AI-Suggested Matches Section** (AC: 2)
  - [ ] 2.1: Fetch suggested matches with `getSuggestedMatches()`
  - [ ] 2.2: Sort by confidence_score DESC
  - [ ] 2.3: Map to MatchCard components
  - [ ] 2.4: Display match count with Badge
  - [ ] 2.5: Empty state: "No suggested matches. Upload receipts to start matching."
  - [ ] 2.6: Loading state with Skeleton cards

- [ ] **Task 3: Quick Actions Toolbar** (AC: 3)
  - [ ] 3.1: Create toolbar component with 4 action buttons
  - [ ] 3.2: "Approve All High Confidence" filters ≥0.80 → bulk approve
  - [ ] 3.3: Confirmation dialog with count and risk warning
  - [ ] 3.4: "Manual Match" opens ManualMatchDialog
  - [ ] 3.5: "Refresh Matches" calls Edge Function `run-matching`
  - [ ] 3.6: Disable actions when matches.length === 0

- [ ] **Task 4: Match Statistics Summary** (AC: 4)
  - [ ] 4.1: Create MatchStatistics component
  - [ ] 4.2: Fetch metrics with `getReconciliationMetrics()`
  - [ ] 4.3: Display suggested/approved/rejected counts
  - [ ] 4.4: Display reconciliation rate with Progress component
  - [ ] 4.5: Display average confidence score with color coding
  - [ ] 4.6: Refetch after approve/reject actions

- [ ] **Task 5: Confidence Level Filter** (AC: 5)
  - [ ] 5.1: Create filter component with Tabs or RadioGroup
  - [ ] 5.2: Options: All, High (≥0.80), Medium (0.50-0.79), Low (<0.50)
  - [ ] 5.3: Filter matches in component state
  - [ ] 5.4: Update match count when filter changes
  - [ ] 5.5: Show selected filter in UI

- [ ] **Task 6: Gamification Progress Display** (AC: 6)
  - [ ] 6.1: Create GamificationProgress component
  - [ ] 6.2: Fetch gamification data with `fetchActiveChallenges()`
  - [ ] 6.3: Display points earned this week (reconciliation category)
  - [ ] 6.4: Display active challenge with Progress bar
  - [ ] 6.5: Calculate "X more to unlock" text
  - [ ] 6.6: Link to `/dashboard/gamification`

- [ ] **Task 7: Real-Time Updates** (AC: 4, 6)
  - [ ] 7.1: After approve action → refetch statistics
  - [ ] 7.2: After approve action → check challenge completion
  - [ ] 7.3: After bulk approve → show success toast with count
  - [ ] 7.4: After reject action → update statistics
  - [ ] 7.5: Optimistic UI updates (update state immediately)

- [ ] **Task 8: Testing** (AC: 1, 2, 3, 4, 5, 6)
  - [ ] 8.1: Unit test confidence level filter logic
  - [ ] 8.2: Unit test bulk approve (filter ≥0.80)
  - [ ] 8.3: Integration test approve match → statistics update
  - [ ] 8.4: Integration test refresh matches → new matches appear
  - [ ] 8.5: E2E test: approve match → gamification progress updates

## Dev Notes

### Previous Story Insights

**From Story 4.3 (Interactive Matching Interface):**
- MatchCard component with side-by-side comparison
- Confidence badges (High/Medium/Low)
- approveMatch() and rejectMatch() functions
- ManualMatchDialog for manual matching
- Keyboard shortcuts (A/R/N)

**From Story 4.4 (Match Status Management):**
- ReconciliationWidget displaying metrics
- getReconciliationMetrics() service function
- Gamification integration (3 pts per approval)

**From Story 5.1 (Dashboard Layout):**
- DashboardLayout with navigation
- Route: `/dashboard/reconciliation`

### Architecture Context

**Matching Algorithm (from Story 4.2):**
- PostgreSQL function find_reconciliation_matches()
- Confidence score: 0.0-1.0
- Automatic triggers after transaction/receipt INSERT

**Reconciliation Flow:**
- User uploads receipts (Story 3.1)
- Matching algorithm runs (Story 4.2)
- Suggested matches appear here
- User approves/rejects matches (Story 4.3)
- Statistics update (Story 4.4)

### Data Models

**Suggested Match (from Story 4.3):**

```typescript
interface SuggestedMatch {
  id: string;
  transaction_id: string;
  receipt_id: string;
  confidence_score: number;
  status: 'suggested' | 'approved' | 'rejected';
  created_at: string;
  transaction: Transaction;
  receipt: Receipt;
}
```

**Reconciliation Metrics (from Story 4.4):**

```typescript
interface ReconciliationMetrics {
  total_transactions: number;
  reconciled_transactions: number;
  unreconciled_transactions: number;
  total_receipts: number;
  matched_receipts: number;
  suggested_matches: number;
  approved_matches_today: number;
  approved_matches_week: number;
  rejected_matches: number;
  reconciliation_rate: number; // percentage
  average_confidence: number;
  high_confidence_count: number; // ≥0.80
  medium_confidence_count: number; // 0.50-0.79
  low_confidence_count: number; // <0.50
}
```

**Active Challenge (from gamification-system.md):**

```typescript
interface ActiveChallenge {
  challenge_id: string;
  challenge_name: string;
  challenge_description: string;
  target_count: number;
  current_progress: number;
  reward_points: number;
  expires_at: string;
}
```

### Component Specifications

**Reconciliation Engine View:**

```tsx
// src/pages/ReconciliationEngine.tsx
import { useState, useEffect } from 'react';
import { useToast } from '@/components/ui/use-toast';
import MatchCard from '@/components/reconciliation/MatchCard';
import ManualMatchDialog from '@/components/reconciliation/ManualMatchDialog';
import MatchStatistics from '@/components/reconciliation/MatchStatistics';
import GamificationProgress from '@/components/gamification/GamificationProgress';
import { Button } from '@/components/ui/button';
import { Tabs, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { Badge } from '@/components/ui/badge';
import { getSuggestedMatches, approveMatch, runMatching } from '@/services/reconciliationService';
import { getReconciliationMetrics } from '@/services/metricsService';
import type { SuggestedMatch } from '@/types/reconciliation';

export default function ReconciliationEngine() {
  const [matches, setMatches] = useState<SuggestedMatch[]>([]);
  const [filteredMatches, setFilteredMatches] = useState<SuggestedMatch[]>([]);
  const [confidenceFilter, setConfidenceFilter] = useState('all');
  const [isLoading, setIsLoading] = useState(true);
  const [isManualDialogOpen, setIsManualDialogOpen] = useState(false);
  const [metrics, setMetrics] = useState(null);
  const { toast } = useToast();

  useEffect(() => {
    fetchMatches();
    fetchMetrics();
  }, []);

  useEffect(() => {
    applyConfidenceFilter();
  }, [matches, confidenceFilter]);

  const fetchMatches = async () => {
    setIsLoading(true);
    const data = await getSuggestedMatches();
    setMatches(data);
    setIsLoading(false);
  };

  const fetchMetrics = async () => {
    const data = await getReconciliationMetrics();
    setMetrics(data);
  };

  const applyConfidenceFilter = () => {
    if (confidenceFilter === 'all') {
      setFilteredMatches(matches);
    } else if (confidenceFilter === 'high') {
      setFilteredMatches(matches.filter(m => m.confidence_score >= 0.80));
    } else if (confidenceFilter === 'medium') {
      setFilteredMatches(matches.filter(m => m.confidence_score >= 0.50 && m.confidence_score < 0.80));
    } else if (confidenceFilter === 'low') {
      setFilteredMatches(matches.filter(m => m.confidence_score < 0.50));
    }
  };

  const handleApproveAll = async () => {
    const highConfidenceMatches = matches.filter(m => m.confidence_score >= 0.80);
    
    if (highConfidenceMatches.length === 0) {
      toast({ title: 'No high confidence matches to approve' });
      return;
    }

    // Confirmation dialog
    const confirmed = confirm(
      `Approve ${highConfidenceMatches.length} high confidence matches?`
    );
    if (!confirmed) return;

    // Approve all
    await Promise.all(highConfidenceMatches.map(m => approveMatch(m.id)));
    
    toast({
      title: `Approved ${highConfidenceMatches.length} matches`,
      description: `You earned ${highConfidenceMatches.length * 3} points!`,
    });

    // Refresh
    await fetchMatches();
    await fetchMetrics();
  };

  const handleRefresh = async () => {
    toast({ title: 'Running matching algorithm...' });
    await runMatching();
    await fetchMatches();
    toast({ title: 'Matches updated' });
  };

  const handleApprove = async (matchId: string) => {
    await approveMatch(matchId);
    toast({ title: 'Match approved', description: '+3 points' });
    await fetchMatches();
    await fetchMetrics();
  };

  return (
    <div className="p-8">
      <div className="mb-6">
        <h1 className="text-3xl font-bold text-charcoal mb-2">Reconciliation Engine</h1>
        <p className="text-stone">Review AI-suggested transaction matches</p>
      </div>

      {/* Statistics Summary */}
      {metrics && <MatchStatistics metrics={metrics} />}

      {/* Gamification Progress */}
      <GamificationProgress category="reconciliation" />

      {/* Actions Toolbar */}
      <div className="flex items-center gap-4 my-6">
        <Button
          onClick={handleApproveAll}
          disabled={matches.filter(m => m.confidence_score >= 0.80).length === 0}
        >
          Approve All High Confidence
        </Button>
        <Button variant="outline" onClick={() => setIsManualDialogOpen(true)}>
          Manual Match
        </Button>
        <Button variant="outline" onClick={handleRefresh}>
          Refresh Matches
        </Button>
        <Badge variant="secondary" className="ml-auto">
          {filteredMatches.length} matches
        </Badge>
      </div>

      {/* Confidence Filter Tabs */}
      <Tabs value={confidenceFilter} onValueChange={setConfidenceFilter} className="mb-6">
        <TabsList>
          <TabsTrigger value="all">All</TabsTrigger>
          <TabsTrigger value="high">High (≥80%)</TabsTrigger>
          <TabsTrigger value="medium">Medium (50-79%)</TabsTrigger>
          <TabsTrigger value="low">Low (&lt;50%)</TabsTrigger>
        </TabsList>
      </Tabs>

      {/* Matches List */}
      {isLoading ? (
        <p>Loading matches...</p>
      ) : filteredMatches.length === 0 ? (
        <div className="text-center py-12 bg-cream rounded-lg">
          <p className="text-stone text-lg">No suggested matches</p>
          <p className="text-stone text-sm mt-2">Upload receipts to start matching</p>
        </div>
      ) : (
        <div className="space-y-4">
          {filteredMatches.map(match => (
            <MatchCard
              key={match.id}
              match={match}
              onApprove={handleApprove}
              onReject={async () => {
                // Reject logic from Story 4.3
                await fetchMatches();
                await fetchMetrics();
              }}
            />
          ))}
        </div>
      )}

      <ManualMatchDialog
        open={isManualDialogOpen}
        onClose={() => setIsManualDialogOpen(false)}
        onSuccess={async () => {
          await fetchMatches();
          await fetchMetrics();
        }}
      />
    </div>
  );
}
```

**Match Statistics Component:**

```tsx
// src/components/reconciliation/MatchStatistics.tsx
import { Card, CardHeader, CardTitle, CardContent } from '@/components/ui/card';
import { Progress } from '@/components/ui/progress';
import { Badge } from '@/components/ui/badge';
import type { ReconciliationMetrics } from '@/types/reconciliation';

interface MatchStatisticsProps {
  metrics: ReconciliationMetrics;
}

export default function MatchStatistics({ metrics }: MatchStatisticsProps) {
  const getConfidenceBadgeColor = (score: number) => {
    if (score >= 0.80) return 'bg-green-100 text-green-800';
    if (score >= 0.60) return 'bg-yellow-100 text-yellow-800';
    return 'bg-red-100 text-red-800';
  };

  return (
    <Card className="mb-6">
      <CardHeader>
        <CardTitle>Match Statistics</CardTitle>
      </CardHeader>
      <CardContent>
        <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
          <div>
            <p className="text-sm text-stone">Suggested Matches</p>
            <p className="text-2xl font-bold text-charcoal">{metrics.suggested_matches}</p>
          </div>
          <div>
            <p className="text-sm text-stone">Approved This Week</p>
            <p className="text-2xl font-bold text-green-600">{metrics.approved_matches_week}</p>
          </div>
          <div>
            <p className="text-sm text-stone">Rejected</p>
            <p className="text-2xl font-bold text-red-600">{metrics.rejected_matches}</p>
          </div>
          <div>
            <p className="text-sm text-stone">Reconciliation Rate</p>
            <p className="text-2xl font-bold text-charcoal">{metrics.reconciliation_rate}%</p>
            <Progress value={metrics.reconciliation_rate} className="mt-2" />
          </div>
        </div>

        <div className="mt-4 pt-4 border-t">
          <p className="text-sm text-stone mb-2">Confidence Distribution</p>
          <div className="flex gap-4">
            <Badge className="bg-green-100 text-green-800">
              High: {metrics.high_confidence_count}
            </Badge>
            <Badge className="bg-yellow-100 text-yellow-800">
              Medium: {metrics.medium_confidence_count}
            </Badge>
            <Badge className="bg-red-100 text-red-800">
              Low: {metrics.low_confidence_count}
            </Badge>
            <Badge className={getConfidenceBadgeColor(metrics.average_confidence)}>
              Avg: {(metrics.average_confidence * 100).toFixed(0)}%
            </Badge>
          </div>
        </div>
      </CardContent>
    </Card>
  );
}
```

**Gamification Progress Component:**

```tsx
// src/components/gamification/GamificationProgress.tsx
import { useEffect, useState } from 'react';
import { Card, CardHeader, CardTitle, CardContent } from '@/components/ui/card';
import { Progress } from '@/components/ui/progress';
import { Badge } from '@/components/ui/badge';
import { Link } from 'react-router-dom';
import { fetchActiveChallenges, getPointsThisWeek } from '@/services/gamificationService';
import type { ActiveChallenge } from '@/types/gamification';

interface GamificationProgressProps {
  category: string; // 'reconciliation'
}

export default function GamificationProgress({ category }: GamificationProgressProps) {
  const [challenges, setChallenges] = useState<ActiveChallenge[]>([]);
  const [pointsThisWeek, setPointsThisWeek] = useState(0);

  useEffect(() => {
    fetchData();
  }, []);

  const fetchData = async () => {
    const challengesData = await fetchActiveChallenges(category);
    const pointsData = await getPointsThisWeek(category);
    setChallenges(challengesData);
    setPointsThisWeek(pointsData);
  };

  const activeChallenge = challenges[0]; // Show first active challenge

  if (!activeChallenge) return null;

  const progressPercent = (activeChallenge.current_progress / activeChallenge.target_count) * 100;
  const remaining = activeChallenge.target_count - activeChallenge.current_progress;

  return (
    <Card className="mb-6 bg-gradient-to-r from-purple-50 to-pink-50">
      <CardHeader>
        <CardTitle className="flex items-center justify-between">
          <span>Reconciliation Challenge</span>
          <Badge variant="secondary">{pointsThisWeek} points this week</Badge>
        </CardTitle>
      </CardHeader>
      <CardContent>
        <p className="text-sm text-stone mb-2">{activeChallenge.challenge_description}</p>
        <Progress value={progressPercent} className="mb-2" />
        <div className="flex items-center justify-between text-sm">
          <span className="text-stone">
            {activeChallenge.current_progress} / {activeChallenge.target_count}
          </span>
          <span className="text-charcoal font-medium">
            {remaining} more to earn +{activeChallenge.reward_points} points
          </span>
        </div>
        <Link
          to="/dashboard/gamification"
          className="text-xs text-blue-600 hover:underline mt-2 inline-block"
        >
          View all challenges →
        </Link>
      </CardContent>
    </Card>
  );
}
```

### File Locations

**New Files to Create:**
- `src/pages/ReconciliationEngine.tsx` - Main reconciliation view
- `src/components/reconciliation/MatchStatistics.tsx` - Statistics card
- `src/components/gamification/GamificationProgress.tsx` - Challenge progress widget

**Files to Reuse (from Story 4.3):**
- `src/components/reconciliation/MatchCard.tsx`
- `src/components/reconciliation/ManualMatchDialog.tsx`
- `src/services/reconciliationService.ts` (extend with runMatching function)

**Files to Reuse (from Story 4.4):**
- `src/services/metricsService.ts` (getReconciliationMetrics)

### Technical Constraints

**Real-Time Updates:**
- Refetch statistics after every approve/reject
- Optimistic UI updates (update state before API call)
- Show loading states during refetch

**Bulk Operations:**
- Limit bulk approve to ≥0.80 confidence
- Show confirmation dialog with count
- Handle errors gracefully (partial success)

**Performance:**
- Paginate matches if >50 (future enhancement)
- Cache metrics for 30 seconds
- Debounce filter changes

### Testing Requirements

**Unit Tests:**
- Confidence filter logic (all/high/medium/low)
- Bulk approve filter (≥0.80)
- Metrics calculation

**Integration Tests:**
- Fetch suggested matches
- Approve match → refetch statistics
- Reject match → update metrics
- Run matching → new matches appear

**E2E Tests:**
- Navigate to /dashboard/reconciliation
- View suggested matches
- Approve high confidence match
- Gamification progress updates
- Bulk approve all high confidence

### Security Considerations

- All matches filtered by user_id (RLS policies)
- Approve/reject only user's own matches
- Edge Function `run-matching` requires authentication

## Change Log

| Date       | Version | Description                    | Author |
|------------|---------|--------------------------------|--------|
| 2025-10-11 | 1.0     | Initial story draft (from PO) | Sarah  |

## Dev Agent Record

### Agent Model Used
<!-- Dev agent will update this section -->

### Debug Log References
<!-- Dev agent will log commands, test results, lint fixes here -->

### Completion Notes
<!-- Dev agent will document what was implemented, challenges, deviations -->

### File List
<!-- Dev agent will list all files created/modified/deleted -->

## QA Results
<!-- QA agent will append review results here -->
