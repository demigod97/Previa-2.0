# Story 5.4: Transaction Table View

## Status: Draft

## Story

As a **Previa user managing financial data**,  
I want **a comprehensive Transaction Table view with advanced filtering, sorting, searching, and bulk actions**,  
So that **I can efficiently find, categorize, and manage all my transactions**.

## Acceptance Criteria

**AC1: Full Transaction Table with Tanstack Table**
- Display all transactions in sortable/filterable table
- Columns: Checkbox (select), Date (sortable), Description (searchable), Category (badge), Amount (+/- formatting), Status (badge), Actions (dropdown menu)
- Server-side pagination (10/25/50/100 rows per page)
- Column visibility toggle (show/hide columns)
- Total count display

**AC2: Sortable Columns**
- Click column header to sort ascending/descending
- Sort indicator icon (up/down arrow)
- Multi-column sort (Shift+click)
- Sort by: Date, Amount, Description, Category, Status
- Default sort: Date descending (newest first)

**AC3: Advanced Filtering**
- Date range picker with presets (Today, Last 7/30 days, Custom)
- Amount range slider (min/max with two thumbs)
- Category multi-select dropdown (checkboxes)
- Status checkboxes (Unreconciled/Reconciled/Ignored, stack filters)
- Bank account dropdown (filter by account)
- Search bar for description (debounced 300ms, case-insensitive)

**AC4: Bulk Actions Toolbar**
- Appears when selectedIds.size > 0
- "Categorize Selected" dropdown (assign category to all selected)
- "Reconcile with Receipt" button (opens dialog to select receipt)
- "Mark as Reviewed" button
- "Mark as Ignored" button
- "Export CSV" action (download selected transactions)
- "X items selected" display
- Max 100 items per bulk action

**AC5: Responsive Mobile View**
- Switch from table to card layout on <768px
- Cards show key fields: Date, Description, Amount, Status
- Swipeable cards for mobile interactions
- Filter drawer opens from bottom

**AC6: Empty State and Loading**
- Empty state: "No transactions found" with "Upload Bank Statement" CTA
- Loading skeleton with shimmer effect
- Error state with retry button
- Inline loading for actions (e.g., categorize)

## Tasks / Subtasks

- [ ] **Task 1: Transaction Table Component** (AC: 1)
  - [ ] 1.1: Create `src/pages/Transactions.tsx`
  - [ ] 1.2: Set up Tanstack Table v8 with column definitions
  - [ ] 1.3: Checkbox column with "Select All" in header
  - [ ] 1.4: Date column (format DD/MM/YYYY, sortable)
  - [ ] 1.5: Description column (truncate long text, searchable)
  - [ ] 1.6: Category column (Badge component, color-coded)
  - [ ] 1.7: Amount column (+ for income, - for expenses, JetBrains Mono font)
  - [ ] 1.8: Status column (Badge: unreconciled/reconciled/ignored)
  - [ ] 1.9: Actions column (DropdownMenu: Edit, Categorize, View Receipt, Delete)

- [ ] **Task 2: Sorting Implementation** (AC: 2)
  - [ ] 2.1: Implement column sorting with Tanstack Table
  - [ ] 2.2: Add sort indicator icons (ChevronUp/ChevronDown)
  - [ ] 2.3: Toggle sort direction on click (asc → desc → none)
  - [ ] 2.4: Multi-column sort with Shift+click
  - [ ] 2.5: Default sort: transaction_date DESC

- [ ] **Task 3: Filtering UI** (AC: 3)
  - [ ] 3.1: Create filter sidebar (or top bar on mobile)
  - [ ] 3.2: Date range picker with shadcn Popover + Calendar
  - [ ] 3.3: Presets: Today, Last 7, Last 30, Custom
  - [ ] 3.4: Amount range slider with two thumbs (shadcn Slider)
  - [ ] 3.5: Category multi-select with Checkbox list
  - [ ] 3.6: Status checkboxes (Unreconciled, Reconciled, Ignored)
  - [ ] 3.7: Bank account dropdown (Select component)
  - [ ] 3.8: Search input (Input component, debounced 300ms)

- [ ] **Task 4: Filtering Logic** (AC: 3)
  - [ ] 4.1: Build Supabase query with filters
  - [ ] 4.2: .gte('transaction_date', dateFrom)
  - [ ] 4.3: .lte('transaction_date', dateTo)
  - [ ] 4.4: .gte('amount', amountMin) and .lte('amount', amountMax)
  - [ ] 4.5: .in('category', selectedCategories)
  - [ ] 4.6: .in('status', selectedStatuses)
  - [ ] 4.7: .eq('bank_account_id', selectedAccount)
  - [ ] 4.8: .ilike('description', %${searchQuery}%)

- [ ] **Task 5: Pagination** (AC: 1)
  - [ ] 5.1: Implement server-side pagination with Supabase .range()
  - [ ] 5.2: Page size selector (10/25/50/100)
  - [ ] 5.3: Page number navigation (previous/next buttons)
  - [ ] 5.4: Total count display ("Showing X-Y of Z transactions")
  - [ ] 5.5: Jump to page input (optional)

- [ ] **Task 6: Bulk Actions** (AC: 4)
  - [ ] 6.1: Bulk selection state (Set<transaction_id>)
  - [ ] 6.2: "Select All" checkbox in header (selects current page)
  - [ ] 6.3: Bulk actions toolbar (appears when selectedIds.size > 0)
  - [ ] 6.4: "Categorize Selected" dropdown → update category for all
  - [ ] 6.5: "Reconcile with Receipt" → open dialog to search receipts
  - [ ] 6.6: "Mark as Reviewed" → update status
  - [ ] 6.7: "Mark as Ignored" → update status
  - [ ] 6.8: "Export CSV" → generate CSV file and download
  - [ ] 6.9: Max 100 items per bulk action (show error if exceeded)

- [ ] **Task 7: Responsive Mobile View** (AC: 5)
  - [ ] 7.1: Detect screen size with Tailwind breakpoints
  - [ ] 7.2: Render card layout on <768px
  - [ ] 7.3: TransactionCard component with key fields
  - [ ] 7.4: Swipeable cards with react-swipeable library
  - [ ] 7.5: Filter drawer opens from bottom (Sheet component)

- [ ] **Task 8: Column Visibility Toggle** (AC: 1)
  - [ ] 8.1: "Columns" button with DropdownMenu
  - [ ] 8.2: Checkbox list for each column
  - [ ] 8.3: Toggle column visibility with Tanstack Table API
  - [ ] 8.4: Persist column visibility in localStorage

- [ ] **Task 9: Testing** (AC: 1, 2, 3, 4, 5, 6)
  - [ ] 9.1: Unit test sorting logic
  - [ ] 9.2: Unit test filter query builder
  - [ ] 9.3: Unit test bulk action validation (max 100)
  - [ ] 9.4: Integration test fetch transactions with filters
  - [ ] 9.5: E2E test: apply filters → transactions update
  - [ ] 9.6: E2E test: bulk categorize transactions

## Dev Notes

### Previous Story Insights

**From Story 4.1 (Transaction/Receipt Library):**
- Transactions.tsx page with filtering, sorting, bulk selection
- URL query params for shareable filtered views
- Bulk actions: mark reconciled/ignored, categorize

**From docs/specifications/dashboard-widgets-table.md:**
- Transaction Table with Tanstack Table v8
- Column definitions, filtering, sorting, pagination

**From Story 5.2 (Home View with Widgets):**
- Recent Transactions widget (simplified table)

### Architecture Context

**Table Library (from docs/frontend-spec-new.md):**
- Tanstack Table v8 with shadcn Data Table pattern
- Server-side pagination, sorting, filtering
- Column visibility, row selection

**Data Fetching:**
- Supabase client for transactions table
- RLS policies filter by user_id
- Pagination with .range(from, to)

### Data Models

**Transaction (from docs/prd/data-models.md):**

```typescript
interface Transaction {
  id: string;
  user_id: string;
  bank_account_id: string;
  transaction_date: string; // YYYY-MM-DD
  description: string;
  amount: number; // Negative for expenses, positive for income
  category: string | null;
  status: 'unreconciled' | 'reconciled' | 'ignored';
  reconciliation_match_id: string | null;
  created_at: string;
  bank_account?: {
    account_name: string;
    bank_name: string;
  };
}
```

**Table Filters:**

```typescript
interface TransactionFilters {
  dateFrom: string | null;
  dateTo: string | null;
  amountMin: number | null;
  amountMax: number | null;
  categories: string[];
  statuses: ('unreconciled' | 'reconciled' | 'ignored')[];
  bankAccountId: string | null;
  searchQuery: string;
}
```

**Pagination State:**

```typescript
interface PaginationState {
  pageIndex: number;
  pageSize: number;
}
```

### Component Specifications

**Transactions Page:**

```tsx
// src/pages/Transactions.tsx
import { useState, useEffect, useMemo } from 'react';
import {
  useReactTable,
  getCoreRowModel,
  getSortedRowModel,
  getFilteredRowModel,
  getPaginationRowModel,
  ColumnDef,
  flexRender,
} from '@tanstack/react-table';
import { Checkbox } from '@/components/ui/checkbox';
import { Badge } from '@/components/ui/badge';
import { Button } from '@/components/ui/button';
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
} from '@/components/ui/dropdown-menu';
import { MoreHorizontal, ChevronUp, ChevronDown } from 'lucide-react';
import { formatCurrency, formatDate } from '@/lib/utils';
import { fetchTransactions } from '@/services/transactionService';
import type { Transaction } from '@/types/transaction';

export default function Transactions() {
  const [data, setData] = useState<Transaction[]>([]);
  const [rowSelection, setRowSelection] = useState({});
  const [sorting, setSorting] = useState([{ id: 'transaction_date', desc: true }]);
  const [filters, setFilters] = useState<TransactionFilters>({
    dateFrom: null,
    dateTo: null,
    amountMin: null,
    amountMax: null,
    categories: [],
    statuses: [],
    bankAccountId: null,
    searchQuery: '',
  });
  const [pagination, setPagination] = useState({ pageIndex: 0, pageSize: 25 });
  const [totalCount, setTotalCount] = useState(0);
  const [isLoading, setIsLoading] = useState(true);

  useEffect(() => {
    fetchData();
  }, [filters, sorting, pagination]);

  const fetchData = async () => {
    setIsLoading(true);
    const { data: transactions, count } = await fetchTransactions({
      filters,
      sorting,
      pagination,
    });
    setData(transactions);
    setTotalCount(count);
    setIsLoading(false);
  };

  const columns: ColumnDef<Transaction>[] = useMemo(
    () => [
      {
        id: 'select',
        header: ({ table }) => (
          <Checkbox
            checked={table.getIsAllPageRowsSelected()}
            onCheckedChange={(value) => table.toggleAllPageRowsSelected(!!value)}
          />
        ),
        cell: ({ row }) => (
          <Checkbox
            checked={row.getIsSelected()}
            onCheckedChange={(value) => row.toggleSelected(!!value)}
          />
        ),
      },
      {
        accessorKey: 'transaction_date',
        header: 'Date',
        cell: ({ getValue }) => formatDate(getValue() as string),
      },
      {
        accessorKey: 'description',
        header: 'Description',
        cell: ({ getValue }) => {
          const desc = getValue() as string;
          return desc.length > 50 ? desc.substring(0, 50) + '...' : desc;
        },
      },
      {
        accessorKey: 'category',
        header: 'Category',
        cell: ({ getValue }) => {
          const category = getValue() as string | null;
          return category ? (
            <Badge variant="secondary">{category}</Badge>
          ) : (
            <span className="text-stone text-sm">Uncategorized</span>
          );
        },
      },
      {
        accessorKey: 'amount',
        header: 'Amount',
        cell: ({ getValue }) => {
          const amount = getValue() as number;
          return (
            <span
              className={`font-mono ${amount >= 0 ? 'text-green-600' : 'text-red-600'}`}
            >
              {amount >= 0 ? '+' : ''}
              {formatCurrency(amount)}
            </span>
          );
        },
      },
      {
        accessorKey: 'status',
        header: 'Status',
        cell: ({ getValue }) => {
          const status = getValue() as string;
          const variant =
            status === 'reconciled'
              ? 'default'
              : status === 'ignored'
              ? 'secondary'
              : 'outline';
          return <Badge variant={variant}>{status}</Badge>;
        },
      },
      {
        id: 'actions',
        header: 'Actions',
        cell: ({ row }) => (
          <DropdownMenu>
            <DropdownMenuTrigger asChild>
              <Button variant="ghost" size="sm">
                <MoreHorizontal className="h-4 w-4" />
              </Button>
            </DropdownMenuTrigger>
            <DropdownMenuContent align="end">
              <DropdownMenuItem>Edit</DropdownMenuItem>
              <DropdownMenuItem>Categorize</DropdownMenuItem>
              <DropdownMenuItem>View Receipt</DropdownMenuItem>
              <DropdownMenuItem className="text-red-600">Delete</DropdownMenuItem>
            </DropdownMenuContent>
          </DropdownMenu>
        ),
      },
    ],
    []
  );

  const table = useReactTable({
    data,
    columns,
    getCoreRowModel: getCoreRowModel(),
    getSortedRowModel: getSortedRowModel(),
    getPaginationRowModel: getPaginationRowModel(),
    onRowSelectionChange: setRowSelection,
    onSortingChange: setSorting,
    onPaginationChange: setPagination,
    state: {
      rowSelection,
      sorting,
      pagination,
    },
    pageCount: Math.ceil(totalCount / pagination.pageSize),
    manualPagination: true,
    manualSorting: true,
  });

  const selectedRows = table.getFilteredSelectedRowModel().rows;

  return (
    <div className="p-8">
      <div className="flex items-center justify-between mb-6">
        <div>
          <h1 className="text-3xl font-bold text-charcoal">Transactions</h1>
          <p className="text-stone">Manage all your transactions</p>
        </div>
      </div>

      {/* Filters (simplified for brevity - full implementation in actual code) */}
      <div className="mb-6">
        {/* Date range, amount range, category, status, bank account, search */}
      </div>

      {/* Bulk Actions Toolbar */}
      {selectedRows.length > 0 && (
        <div className="mb-4 p-4 bg-sand rounded-lg flex items-center gap-4">
          <span className="text-sm font-medium">{selectedRows.length} items selected</span>
          <Button size="sm" variant="outline">
            Categorize Selected
          </Button>
          <Button size="sm" variant="outline">
            Reconcile with Receipt
          </Button>
          <Button size="sm" variant="outline">
            Mark as Reviewed
          </Button>
          <Button size="sm" variant="outline">
            Mark as Ignored
          </Button>
          <Button size="sm" variant="outline">
            Export CSV
          </Button>
        </div>
      )}

      {/* Table */}
      <div className="rounded-lg border">
        <table className="w-full">
          <thead className="bg-cream">
            {table.getHeaderGroups().map((headerGroup) => (
              <tr key={headerGroup.id}>
                {headerGroup.headers.map((header) => (
                  <th
                    key={header.id}
                    className="px-4 py-3 text-left text-sm font-medium text-charcoal"
                  >
                    {header.isPlaceholder ? null : (
                      <div
                        className={
                          header.column.getCanSort()
                            ? 'cursor-pointer select-none flex items-center gap-2'
                            : ''
                        }
                        onClick={header.column.getToggleSortingHandler()}
                      >
                        {flexRender(header.column.columnDef.header, header.getContext())}
                        {header.column.getIsSorted() === 'asc' && <ChevronUp className="h-4 w-4" />}
                        {header.column.getIsSorted() === 'desc' && (
                          <ChevronDown className="h-4 w-4" />
                        )}
                      </div>
                    )}
                  </th>
                ))}
              </tr>
            ))}
          </thead>
          <tbody>
            {table.getRowModel().rows.map((row) => (
              <tr key={row.id} className="border-t hover:bg-cream/50">
                {row.getVisibleCells().map((cell) => (
                  <td key={cell.id} className="px-4 py-3 text-sm">
                    {flexRender(cell.column.columnDef.cell, cell.getContext())}
                  </td>
                ))}
              </tr>
            ))}
          </tbody>
        </table>
      </div>

      {/* Pagination */}
      <div className="mt-4 flex items-center justify-between">
        <p className="text-sm text-stone">
          Showing {pagination.pageIndex * pagination.pageSize + 1}-
          {Math.min((pagination.pageIndex + 1) * pagination.pageSize, totalCount)} of {totalCount}{' '}
          transactions
        </p>
        <div className="flex gap-2">
          <Button
            variant="outline"
            size="sm"
            onClick={() => table.previousPage()}
            disabled={!table.getCanPreviousPage()}
          >
            Previous
          </Button>
          <Button
            variant="outline"
            size="sm"
            onClick={() => table.nextPage()}
            disabled={!table.getCanNextPage()}
          >
            Next
          </Button>
        </div>
      </div>
    </div>
  );
}
```

**Transaction Service with Filters:**

```typescript
// src/services/transactionService.ts (extend existing)
import { supabase } from '@/lib/supabase';
import type { TransactionFilters, PaginationState, SortingState } from '@/types';

export async function fetchTransactions({
  filters,
  sorting,
  pagination,
}: {
  filters: TransactionFilters;
  sorting: SortingState;
  pagination: PaginationState;
}) {
  let query = supabase
    .from('transactions')
    .select('*, bank_account:bank_accounts(account_name, bank_name)', { count: 'exact' });

  // Apply filters
  if (filters.dateFrom) query = query.gte('transaction_date', filters.dateFrom);
  if (filters.dateTo) query = query.lte('transaction_date', filters.dateTo);
  if (filters.amountMin !== null) query = query.gte('amount', filters.amountMin);
  if (filters.amountMax !== null) query = query.lte('amount', filters.amountMax);
  if (filters.categories.length > 0) query = query.in('category', filters.categories);
  if (filters.statuses.length > 0) query = query.in('status', filters.statuses);
  if (filters.bankAccountId) query = query.eq('bank_account_id', filters.bankAccountId);
  if (filters.searchQuery) {
    query = query.ilike('description', `%${filters.searchQuery}%`);
  }

  // Apply sorting
  if (sorting.length > 0) {
    const sort = sorting[0];
    query = query.order(sort.id, { ascending: !sort.desc });
  }

  // Apply pagination
  const from = pagination.pageIndex * pagination.pageSize;
  const to = from + pagination.pageSize - 1;
  query = query.range(from, to);

  const { data, error, count } = await query;

  if (error) throw error;

  return { data: data || [], count: count || 0 };
}
```

### File Locations

**New Files to Create:**
- `src/pages/Transactions.tsx` - Full transaction table view
- `src/components/transactions/TransactionFilters.tsx` - Filter sidebar
- `src/components/transactions/TransactionCard.tsx` - Mobile card view
- `src/components/transactions/BulkActionsToolbar.tsx` - Bulk actions UI

**Files to Extend:**
- `src/services/transactionService.ts` - Add fetchTransactions with filters

### Technical Constraints

**Performance:**
- Server-side pagination (max 100 rows per page)
- Debounce search input (300ms)
- Virtualized rows for large datasets (future)

**Bulk Operations:**
- Max 100 items per bulk action
- Show confirmation dialog for destructive actions
- Handle partial failures gracefully

**Mobile Responsive:**
- Card layout on <768px
- Filter drawer from bottom
- Touch-friendly interactions

### Testing Requirements

**Unit Tests:**
- Column sorting logic
- Filter query builder
- Bulk action validation (max 100)
- CSV export generation

**Integration Tests:**
- Fetch transactions with filters
- Apply date range filter
- Apply category filter
- Bulk categorize transactions
- Export CSV

**E2E Tests:**
- Navigate to /dashboard/transactions
- Apply multiple filters → transactions update
- Sort by column → order changes
- Select transactions → bulk categorize
- Export CSV → file downloads

### Security Considerations

- All transactions filtered by user_id (RLS policies)
- Bulk actions only affect user's own transactions
- CSV export includes only selected transactions

## Change Log

| Date       | Version | Description                    | Author |
|------------|---------|--------------------------------|--------|
| 2025-10-11 | 1.0     | Initial story draft (from PO) | Sarah  |

## Dev Agent Record

### Agent Model Used
<!-- Dev agent will update this section -->

### Debug Log References
<!-- Dev agent will log commands, test results, lint fixes here -->

### Completion Notes
<!-- Dev agent will document what was implemented, challenges, deviations -->

### File List
<!-- Dev agent will list all files created/modified/deleted -->

## QA Results
<!-- QA agent will append review results here -->
