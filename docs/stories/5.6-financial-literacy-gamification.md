# Story 5.6: Financial Literacy Gamification

## Status: Draft

## Story

As a **Previa user engaged with the platform**,  
I want **a gamification dashboard that displays my badges, points, challenges, and financial literacy tips**,  
So that **I stay motivated to reconcile transactions, learn financial concepts, and earn rewards**.

## Acceptance Criteria

**AC1: Points & Level Display**
- Prominently display total points (large font, Previa charcoal color)
- Show current level (calculated: level = floor(sqrt(points/100)))
- Display level title (e.g., "Level 5 Financial Wizard")
- Next level progress bar (e.g., "380/500 points to Level 6")
- Points history log (recent point_transactions with reasons, timestamps)
- "View All" link to full points history page

**AC2: Badge Showcase**
- Display earned badges as colored cards with icons
- Badge categories:
  - First Steps (green, check icon) - Earned on signup
  - Account Creator (blue, trophy icon) - Create first bank account
  - Onboarding Complete (gold, star icon) - Complete onboarding flow
  - Reconciliation Expert (purple, medal icon) - Reconcile 100 transactions
- Locked badges greyed out with lock icon + unlock criteria text
- Badge modal on click showing details (earned date, description, rarity)

**AC3: Active Challenges Widget**
- Display daily/weekly/monthly challenges with progress tracking
- Progress bar for each challenge (e.g., "3/5 transactions reconciled")
- Countdown timer for challenge expiration
- Completion animations (confetti effect when challenge completed)
- Reward display ("+20 points" badge on completion)
- "Start Challenge" button for available challenges (optional)

**AC4: Leaderboard (Optional)**
- Compare with other users (rank, username, points, level)
- Filter by time period (This Week / This Month / All Time)
- User's rank highlighted in leaderboard
- Opt-in feature (user can hide themselves from leaderboard)

**AC5: Achievement Notifications**
- Toast notifications when badge earned (PartyPopper icon, badge name, points awarded)
- Toast when challenge completed (trophy icon, challenge name, reward)
- Toast when level up (sparkles icon, new level number)
- Notification history page (last 30 notifications)

**AC6: Financial Literacy Tips**
- Contextual tips tied to actions:
  - "Did you know? Tracking receipts can save 15% on taxes" (after receipt upload)
  - "Pro tip: Reconcile transactions weekly for better cash flow visibility" (after first reconciliation)
- Tip carousel with next/previous buttons
- "Tip of the Day" widget displaying random tip
- Link to full tips library (future enhancement)

## Tasks / Subtasks

- [ ] **Task 1: Gamification Page Layout** (AC: 1, 2, 3, 6)
  - [ ] 1.1: Create `src/pages/Gamification.tsx` at `/dashboard/gamification` route
  - [ ] 1.2: Grid layout for widgets (points, badges, challenges, tips)
  - [ ] 1.3: Responsive layout (stack on mobile)
  - [ ] 1.4: Page title and description

- [ ] **Task 2: Points & Level Display** (AC: 1)
  - [ ] 2.1: Create `src/components/gamification/PointsLevelCard.tsx`
  - [ ] 2.2: Fetch gamification_profiles with total_points, current_level
  - [ ] 2.3: Calculate next level threshold (next_level^2 * 100)
  - [ ] 2.4: Display total points (large font, JetBrains Mono)
  - [ ] 2.5: Display current level with title mapping (1: "Beginner", 5: "Financial Wizard", 10: "Master", etc.)
  - [ ] 2.6: Progress bar to next level
  - [ ] 2.7: Points history widget (last 10 point_transactions)
  - [ ] 2.8: "View All" link to `/dashboard/gamification/points-history`

- [ ] **Task 3: Badge Showcase** (AC: 2)
  - [ ] 3.1: Create `src/components/gamification/BadgeShowcase.tsx`
  - [ ] 3.2: Fetch user_badges with earned badges
  - [ ] 3.3: Display earned badges as cards (icon, name, color)
  - [ ] 3.4: Display locked badges (greyed out, lock icon, unlock criteria)
  - [ ] 3.5: Badge modal component (click badge → open modal)
  - [ ] 3.6: Modal shows: badge icon, name, description, earned date, rarity
  - [ ] 3.7: Badge categories: First Steps (green), Account Creator (blue), Onboarding Complete (gold), Reconciliation Expert (purple)

- [ ] **Task 4: Active Challenges Widget** (AC: 3)
  - [ ] 4.1: Create `src/components/gamification/ActiveChallenges.tsx`
  - [ ] 4.2: Fetch user_challenges with status='active'
  - [ ] 4.3: Display challenge name, description, progress
  - [ ] 4.4: Progress bar (current_progress / target_count)
  - [ ] 4.5: Countdown timer (expires_at - now)
  - [ ] 4.6: "Start Challenge" button (optional, marks challenge as active)
  - [ ] 4.7: Completion animation (confetti.js when progress reaches target)
  - [ ] 4.8: Reward badge (+X points)

- [ ] **Task 5: Leaderboard (Optional)** (AC: 4)
  - [ ] 5.1: Create `src/components/gamification/Leaderboard.tsx`
  - [ ] 5.2: Fetch top 100 users by total_points
  - [ ] 5.3: Display rank, username, points, level
  - [ ] 5.4: Highlight current user row
  - [ ] 5.5: Time period filter (This Week, This Month, All Time)
  - [ ] 5.6: Opt-in toggle in user settings (default: opted in)

- [ ] **Task 6: Achievement Notifications** (AC: 5)
  - [ ] 6.1: Create notification system (use shadcn Toast)
  - [ ] 6.2: Trigger toast on badge earned (listen to gamification events)
  - [ ] 6.3: Trigger toast on challenge completed
  - [ ] 6.4: Trigger toast on level up
  - [ ] 6.5: Store notifications in database (notifications table)
  - [ ] 6.6: Notifications page at `/dashboard/gamification/notifications`

- [ ] **Task 7: Financial Literacy Tips** (AC: 6)
  - [ ] 7.1: Create `src/components/gamification/TipOfTheDay.tsx`
  - [ ] 7.2: Hardcoded tips array (20+ tips)
  - [ ] 7.3: Display random tip on page load
  - [ ] 7.4: Carousel navigation (next/previous buttons)
  - [ ] 7.5: Contextual tips triggered by actions (e.g., after receipt upload)
  - [ ] 7.6: "Tip of the Day" widget on dashboard home

- [ ] **Task 8: Gamification Service Integration** (AC: 1, 2, 3)
  - [ ] 8.1: Create `src/services/gamificationService.ts`
  - [ ] 8.2: Function: fetchGamificationProfile(userId)
  - [ ] 8.3: Function: fetchUserBadges(userId)
  - [ ] 8.4: Function: fetchActiveChallenges(userId)
  - [ ] 8.5: Function: fetchPointsHistory(userId, limit)
  - [ ] 8.6: Function: awardPoints(userId, points, reason)
  - [ ] 8.7: Function: awardBadge(userId, badgeId)

- [ ] **Task 9: Testing** (AC: 1, 2, 3, 4, 5, 6)
  - [ ] 9.1: Unit test level calculation (floor(sqrt(points/100)))
  - [ ] 9.2: Unit test next level threshold calculation
  - [ ] 9.3: Integration test fetch gamification profile
  - [ ] 9.4: Integration test award points → total_points updates
  - [ ] 9.5: Integration test award badge → badge appears in showcase
  - [ ] 9.6: E2E test: reconcile transaction → points increase, challenge progress updates

## Dev Notes

### Previous Story Insights

**From docs/specifications/gamification-system.md:**
- Badge system (4 categories)
- Challenge system (daily/weekly/monthly)
- Points system (5-10 pts per action)
- Database schema (gamification_profiles, user_badges, user_challenges, point_transactions)

**From Story 4.4 (Match Status Management):**
- Gamification integration (3 pts per reconciliation)
- Challenge triggers (10/50/100 reconciliations)
- Badge award (Reconciliation Expert at 100)

**From Story 2.1 (Welcome & Authentication):**
- gamificationService.ts creates profile + First Steps badge + 10 points

### Architecture Context

**Gamification System (from docs/specifications/gamification-system.md):**
- Points awarded for actions (5-10 pts)
- Badges earned at milestones
- Challenges with time limits (daily/weekly/monthly)
- Levels calculated from total points

**Level Calculation:**
- Formula: level = floor(sqrt(total_points / 100))
- Examples: 100 pts = Level 1, 400 pts = Level 2, 900 pts = Level 3, 2500 pts = Level 5, 10000 pts = Level 10

### Data Models

**Gamification Profile (from gamification-system.md):**

```typescript
interface GamificationProfile {
  id: string;
  user_id: string;
  total_points: number;
  current_level: number;
  created_at: string;
  updated_at: string;
}
```

**User Badge:**

```typescript
interface UserBadge {
  id: string;
  user_id: string;
  badge_id: string;
  earned_at: string;
  badge: {
    badge_id: string;
    badge_name: string;
    badge_description: string;
    badge_icon: string;
    badge_color: string; // green, blue, gold, purple
    unlock_criteria: string;
    rarity: 'common' | 'rare' | 'epic' | 'legendary';
  };
}
```

**User Challenge:**

```typescript
interface UserChallenge {
  id: string;
  user_id: string;
  challenge_id: string;
  status: 'available' | 'active' | 'completed';
  current_progress: number;
  started_at: string | null;
  completed_at: string | null;
  expires_at: string | null;
  challenge: {
    challenge_id: string;
    challenge_name: string;
    challenge_description: string;
    challenge_type: 'daily' | 'weekly' | 'monthly';
    target_count: number;
    reward_points: number;
  };
}
```

**Point Transaction:**

```typescript
interface PointTransaction {
  id: string;
  user_id: string;
  points_earned: number;
  reason: string; // "Transaction reconciled", "Receipt uploaded", etc.
  created_at: string;
}
```

**Financial Literacy Tip:**

```typescript
interface FinancialTip {
  id: string;
  tip_text: string;
  category: 'tax' | 'budgeting' | 'cashflow' | 'general';
  context_trigger?: string; // 'receipt_upload', 'first_reconciliation', etc.
}
```

### Component Specifications

**Gamification Page:**

```tsx
// src/pages/Gamification.tsx
import PointsLevelCard from '@/components/gamification/PointsLevelCard';
import BadgeShowcase from '@/components/gamification/BadgeShowcase';
import ActiveChallenges from '@/components/gamification/ActiveChallenges';
import TipOfTheDay from '@/components/gamification/TipOfTheDay';
import Leaderboard from '@/components/gamification/Leaderboard';

export default function Gamification() {
  return (
    <div className="p-8">
      <div className="mb-6">
        <h1 className="text-3xl font-bold text-charcoal">Financial Gamification</h1>
        <p className="text-stone">Track your progress and earn rewards</p>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        {/* Left Column: Points & Badges */}
        <div className="lg:col-span-2 space-y-6">
          <PointsLevelCard />
          <BadgeShowcase />
        </div>

        {/* Right Column: Challenges & Tips */}
        <div className="space-y-6">
          <ActiveChallenges />
          <TipOfTheDay />
        </div>
      </div>

      {/* Leaderboard (optional) */}
      <div className="mt-6">
        <Leaderboard />
      </div>
    </div>
  );
}
```

**Points & Level Card:**

```tsx
// src/components/gamification/PointsLevelCard.tsx
import { useEffect, useState } from 'react';
import { Card, CardHeader, CardTitle, CardContent } from '@/components/ui/card';
import { Progress } from '@/components/ui/progress';
import { Badge } from '@/components/ui/badge';
import { Link } from 'react-router-dom';
import { fetchGamificationProfile, fetchPointsHistory } from '@/services/gamificationService';
import type { GamificationProfile, PointTransaction } from '@/types/gamification';

export default function PointsLevelCard() {
  const [profile, setProfile] = useState<GamificationProfile | null>(null);
  const [history, setHistory] = useState<PointTransaction[]>([]);

  useEffect(() => {
    fetchData();
  }, []);

  const fetchData = async () => {
    const profileData = await fetchGamificationProfile();
    const historyData = await fetchPointsHistory(10);
    setProfile(profileData);
    setHistory(historyData);
  };

  if (!profile) return <Card><CardContent>Loading...</CardContent></Card>;

  const nextLevel = profile.current_level + 1;
  const nextLevelThreshold = nextLevel * nextLevel * 100;
  const currentLevelThreshold = profile.current_level * profile.current_level * 100;
  const progressToNextLevel = profile.total_points - currentLevelThreshold;
  const pointsNeeded = nextLevelThreshold - currentLevelThreshold;
  const progressPercent = (progressToNextLevel / pointsNeeded) * 100;

  const levelTitles = {
    1: 'Beginner',
    2: 'Learner',
    3: 'Practitioner',
    4: 'Achiever',
    5: 'Financial Wizard',
    6: 'Expert',
    7: 'Guru',
    8: 'Sage',
    9: 'Legend',
    10: 'Master',
  };

  return (
    <Card className="bg-gradient-to-br from-purple-50 to-blue-50">
      <CardHeader>
        <CardTitle>Your Progress</CardTitle>
      </CardHeader>
      <CardContent>
        {/* Total Points */}
        <div className="text-center mb-6">
          <p className="text-6xl font-bold text-charcoal font-mono">{profile.total_points}</p>
          <p className="text-stone text-sm">Total Points</p>
        </div>

        {/* Current Level */}
        <div className="text-center mb-4">
          <Badge variant="secondary" className="text-lg px-4 py-2">
            Level {profile.current_level}: {levelTitles[profile.current_level] || 'Master'}
          </Badge>
        </div>

        {/* Next Level Progress */}
        <div className="mb-6">
          <div className="flex justify-between text-sm text-stone mb-2">
            <span>Next Level: {nextLevel}</span>
            <span>
              {profile.total_points} / {nextLevelThreshold} points
            </span>
          </div>
          <Progress value={progressPercent} className="h-3" />
        </div>

        {/* Points History */}
        <div className="border-t pt-4">
          <div className="flex items-center justify-between mb-2">
            <h3 className="font-semibold text-charcoal">Recent Activity</h3>
            <Link to="/dashboard/gamification/points-history" className="text-xs text-blue-600 hover:underline">
              View All
            </Link>
          </div>
          <div className="space-y-2">
            {history.map((tx) => (
              <div key={tx.id} className="flex justify-between text-sm">
                <span className="text-stone">{tx.reason}</span>
                <span className="font-medium text-green-600">+{tx.points_earned}</span>
              </div>
            ))}
          </div>
        </div>
      </CardContent>
    </Card>
  );
}
```

**Badge Showcase:**

```tsx
// src/components/gamification/BadgeShowcase.tsx
import { useEffect, useState } from 'react';
import { Card, CardHeader, CardTitle, CardContent } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { Lock, Check, Trophy, Star, Medal } from 'lucide-react';
import { fetchUserBadges } from '@/services/gamificationService';
import type { UserBadge } from '@/types/gamification';

const badgeIcons = {
  first_steps: Check,
  account_creator: Trophy,
  onboarding_complete: Star,
  reconciliation_expert: Medal,
};

const badgeColors = {
  first_steps: 'bg-green-100 text-green-800',
  account_creator: 'bg-blue-100 text-blue-800',
  onboarding_complete: 'bg-yellow-100 text-yellow-800',
  reconciliation_expert: 'bg-purple-100 text-purple-800',
};

export default function BadgeShowcase() {
  const [badges, setBadges] = useState<UserBadge[]>([]);
  const [allBadges, setAllBadges] = useState([]);

  useEffect(() => {
    fetchData();
  }, []);

  const fetchData = async () => {
    const earnedBadges = await fetchUserBadges();
    setBadges(earnedBadges);
    
    // Mock all badges (would fetch from badges table in real implementation)
    setAllBadges([
      { badge_id: 'first_steps', badge_name: 'First Steps', unlock_criteria: 'Sign up', earned: true },
      { badge_id: 'account_creator', badge_name: 'Account Creator', unlock_criteria: 'Create first bank account', earned: false },
      { badge_id: 'onboarding_complete', badge_name: 'Onboarding Complete', unlock_criteria: 'Complete onboarding', earned: false },
      { badge_id: 'reconciliation_expert', badge_name: 'Reconciliation Expert', unlock_criteria: 'Reconcile 100 transactions', earned: false },
    ]);
  };

  return (
    <Card>
      <CardHeader>
        <CardTitle>Badge Collection</CardTitle>
      </CardHeader>
      <CardContent>
        <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
          {allBadges.map((badge) => {
            const Icon = badgeIcons[badge.badge_id] || Check;
            const isEarned = badges.some((b) => b.badge_id === badge.badge_id);

            return (
              <div
                key={badge.badge_id}
                className={`p-4 rounded-lg text-center cursor-pointer transition ${
                  isEarned
                    ? badgeColors[badge.badge_id]
                    : 'bg-gray-100 text-gray-400 opacity-50'
                }`}
              >
                {isEarned ? (
                  <Icon className="h-12 w-12 mx-auto mb-2" />
                ) : (
                  <Lock className="h-12 w-12 mx-auto mb-2" />
                )}
                <p className="font-semibold text-sm">{badge.badge_name}</p>
                {!isEarned && (
                  <p className="text-xs mt-1">{badge.unlock_criteria}</p>
                )}
              </div>
            );
          })}
        </div>
      </CardContent>
    </Card>
  );
}
```

**Active Challenges:**

```tsx
// src/components/gamification/ActiveChallenges.tsx
import { useEffect, useState } from 'react';
import { Card, CardHeader, CardTitle, CardContent } from '@/components/ui/card';
import { Progress } from '@/components/ui/progress';
import { Badge } from '@/components/ui/badge';
import { Trophy } from 'lucide-react';
import { fetchActiveChallenges } from '@/services/gamificationService';
import type { UserChallenge } from '@/types/gamification';

export default function ActiveChallenges() {
  const [challenges, setChallenges] = useState<UserChallenge[]>([]);

  useEffect(() => {
    fetchData();
  }, []);

  const fetchData = async () => {
    const data = await fetchActiveChallenges();
    setChallenges(data);
  };

  const getTimeRemaining = (expiresAt: string) => {
    const now = new Date();
    const expiry = new Date(expiresAt);
    const diff = expiry.getTime() - now.getTime();
    const hours = Math.floor(diff / (1000 * 60 * 60));
    return `${hours}h remaining`;
  };

  return (
    <Card>
      <CardHeader>
        <CardTitle className="flex items-center gap-2">
          <Trophy className="h-5 w-5" />
          Active Challenges
        </CardTitle>
      </CardHeader>
      <CardContent>
        {challenges.length === 0 ? (
          <p className="text-center text-stone py-4">No active challenges</p>
        ) : (
          <div className="space-y-4">
            {challenges.map((challenge) => {
              const progressPercent = (challenge.current_progress / challenge.challenge.target_count) * 100;

              return (
                <div key={challenge.id} className="border rounded-lg p-4">
                  <div className="flex items-start justify-between mb-2">
                    <div>
                      <p className="font-semibold text-charcoal">{challenge.challenge.challenge_name}</p>
                      <p className="text-xs text-stone">{challenge.challenge.challenge_description}</p>
                    </div>
                    <Badge variant="secondary">+{challenge.challenge.reward_points} pts</Badge>
                  </div>
                  <Progress value={progressPercent} className="mb-2" />
                  <div className="flex justify-between text-xs text-stone">
                    <span>
                      {challenge.current_progress} / {challenge.challenge.target_count}
                    </span>
                    {challenge.expires_at && <span>{getTimeRemaining(challenge.expires_at)}</span>}
                  </div>
                </div>
              );
            })}
          </div>
        )}
      </CardContent>
    </Card>
  );
}
```

**Tip of the Day:**

```tsx
// src/components/gamification/TipOfTheDay.tsx
import { useState } from 'react';
import { Card, CardHeader, CardTitle, CardContent } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Lightbulb, ChevronLeft, ChevronRight } from 'lucide-react';

const tips = [
  'Tracking receipts can save up to 15% on taxes for freelancers.',
  'Reconcile transactions weekly for better cash flow visibility.',
  'Categorize expenses monthly to identify spending patterns.',
  'GST in Australia is 10% - keep receipts to claim GST credits.',
  'Superannuation contributions are tax-deductible for self-employed.',
  'Set aside 25-30% of income for taxes as a freelancer.',
  'Invoice promptly to maintain healthy cash flow.',
  'Track business vs personal expenses separately for tax time.',
];

export default function TipOfTheDay() {
  const [currentIndex, setCurrentIndex] = useState(Math.floor(Math.random() * tips.length));

  const nextTip = () => setCurrentIndex((prev) => (prev + 1) % tips.length);
  const prevTip = () => setCurrentIndex((prev) => (prev - 1 + tips.length) % tips.length);

  return (
    <Card className="bg-gradient-to-br from-yellow-50 to-orange-50">
      <CardHeader>
        <CardTitle className="flex items-center gap-2">
          <Lightbulb className="h-5 w-5 text-yellow-600" />
          Tip of the Day
        </CardTitle>
      </CardHeader>
      <CardContent>
        <p className="text-sm text-charcoal mb-4">{tips[currentIndex]}</p>
        <div className="flex justify-between">
          <Button variant="ghost" size="sm" onClick={prevTip}>
            <ChevronLeft className="h-4 w-4" />
          </Button>
          <span className="text-xs text-stone">
            {currentIndex + 1} / {tips.length}
          </span>
          <Button variant="ghost" size="sm" onClick={nextTip}>
            <ChevronRight className="h-4 w-4" />
          </Button>
        </div>
      </CardContent>
    </Card>
  );
}
```

### File Locations

**New Files to Create:**
- `src/pages/Gamification.tsx` - Main gamification page
- `src/components/gamification/PointsLevelCard.tsx`
- `src/components/gamification/BadgeShowcase.tsx`
- `src/components/gamification/ActiveChallenges.tsx`
- `src/components/gamification/TipOfTheDay.tsx`
- `src/components/gamification/Leaderboard.tsx` (optional)

**Files to Extend:**
- `src/services/gamificationService.ts` - Add fetch functions

### Technical Constraints

**Level Calculation:**
- Use Math.floor(Math.sqrt(total_points / 100))
- Cache calculated level in gamification_profiles table
- Update level on every point award

**Badge Awards:**
- Trigger badge awards from backend (Supabase functions or triggers)
- Prevent duplicate badge awards (unique constraint on user_badges)

**Challenge Expiry:**
- Check expires_at before displaying challenge
- Auto-mark expired challenges as failed (future)

### Testing Requirements

**Unit Tests:**
- Level calculation formula
- Next level threshold calculation
- Tip randomization

**Integration Tests:**
- Fetch gamification profile
- Fetch user badges
- Fetch active challenges
- Award points → total_points updates

**E2E Tests:**
- Navigate to /dashboard/gamification
- Points and level display correctly
- Badges showcase displays earned badges
- Active challenges with progress bars
- Tip carousel navigation

### Security Considerations

- All gamification data filtered by user_id (RLS policies)
- Points awarded via backend functions (not client-side)
- Badge awards validated server-side

## Change Log

| Date       | Version | Description                    | Author |
|------------|---------|--------------------------------|--------|
| 2025-10-11 | 1.0     | Initial story draft (from PO) | Sarah  |

## Dev Agent Record

### Agent Model Used
<!-- Dev agent will update this section -->

### Debug Log References
<!-- Dev agent will log commands, test results, lint fixes here -->

### Completion Notes
<!-- Dev agent will document what was implemented, challenges, deviations -->

### File List
<!-- Dev agent will list all files created/modified/deleted -->

## QA Results
<!-- QA agent will append review results here -->
