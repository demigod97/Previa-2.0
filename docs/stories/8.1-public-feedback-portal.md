# Story 8.1: Public Feedback Portal

**Epic:** 8 - User Engagement & Feedback Systems
**Story Points:** 13
**Priority:** High
**Status:** Approved

---

## Story

As a **public user or existing Previa user**,
I want to **submit bug reports, feature requests, and general feedback through an accessible web portal**,
So that **I can help improve the platform and communicate issues or ideas to the development team**.

---

## Acceptance Criteria

### AC1: Database Schema Implementation
- [ ] `public_feedback` table created with all required fields
- [ ] Enum types defined: `feedback_type`, `severity`, `status`, `priority`
- [ ] RLS policies configured (public INSERT, admin-only UPDATE/DELETE)
- [ ] Storage bucket `feedback-screenshots` created with public upload, private read
- [ ] Indexes created on `feedback_type`, `status`, `created_at`

### AC2: Wizard Step 1 - Feedback Type Selection
- [ ] Modal opens with Previa logo and welcoming header
- [ ] Five feedback type cards displayed with icons and descriptions:
  - üêõ Bug Report
  - ‚ú® Feature Request
  - ‚ö†Ô∏è Error Report
  - üí° Improvement Suggestion
  - üìã Other
- [ ] Cards use Chakra UI RadioCard pattern with hover effects (scale 1.02)
- [ ] Image `docs/1.png` displayed contextually (user analyzing at computer)
- [ ] "Next" button disabled until type selected
- [ ] Smooth fade-in animation with stagger effect (150ms delay per card)

### AC3: Wizard Step 2 - Details Form
- [ ] Form displays conditional fields based on selected feedback type:
  - **All types**: Title (max 100 chars), Description (max 2000 chars)
  - **Bug/Error**: Steps to reproduce, Expected behavior, Actual behavior
  - **Feature**: Use case description, Priority preference
- [ ] Severity/Priority selector with visual radio cards (Low/Medium/High/Critical)
- [ ] Screenshot upload component with drag-drop + file picker (max 5MB, PNG/JPG/PDF)
- [ ] Real-time character counters for text fields
- [ ] Validation messages display inline with shake animation on error
- [ ] Image `docs/2.png` displayed (stressed user with problems)
- [ ] Progress bar shows 66% completion

### AC4: Wizard Step 3 - Contact Information
- [ ] Name input (optional, max 50 chars)
- [ ] Email input (optional, validated format)
- [ ] Consent checkbox: "I'd like to receive updates on this report"
- [ ] Checkbox for "I'm a registered Previa user" (pre-fills email if logged in)
- [ ] Image `docs/3.png` displayed (confident user with financial tools)
- [ ] "Submit" button with loading state (spinner + "Submitting...")
- [ ] Progress bar shows 100% completion

### AC5: Submission Flow & Feedback
- [ ] On submit, validate all required fields
- [ ] Upload screenshot to Supabase Storage (if provided)
- [ ] Insert record into `public_feedback` table via Edge Function
- [ ] Capture browser info (user agent, screen size, viewport) automatically
- [ ] Show success toast with confetti animation: "Thank you! We've received your feedback."
- [ ] Provide unique reference ID: "Reference: FB-20250128-ABC123"
- [ ] Option to submit another report or close modal
- [ ] Clear form state on successful submission

### AC6: Error Handling & Rate Limiting
- [ ] Rate limit: 5 submissions per IP per hour (Edge Function)
- [ ] Display friendly error message on rate limit: "Too many submissions. Please try again in X minutes."
- [ ] Handle network errors with retry option
- [ ] File upload errors show specific messages (size limit, format)
- [ ] Form persists data on error (don't lose user input)
- [ ] Toast notifications for all error states (Chakra useToast)

### AC7: Admin Dashboard (Internal View)
- [ ] Protected route `/admin/feedback` (requires admin role)
- [ ] AG-Grid table displaying all feedback submissions
- [ ] Filterable columns: Type, Status, Priority, Date
- [ ] Sortable by created_at, status, priority
- [ ] Row actions: View details, Update status, Add admin notes, Mark resolved
- [ ] Status change updates `updated_at` and sends optional email notification
- [ ] View screenshot in lightbox modal

### AC8: Responsive Design & Accessibility
- [ ] Modal responsive: Full screen on mobile, 3xl on desktop
- [ ] All form fields have proper labels and ARIA attributes
- [ ] Keyboard navigation: Tab order logical, Enter to submit, Esc to close
- [ ] Color contrast meets WCAG AA (Previa color palette)
- [ ] Focus indicators visible (Chakra default focus ring)
- [ ] Screen reader announces step changes and validation errors

---

## Dev Notes

### Database Migration
```sql
-- supabase/migrations/YYYYMMDDHHMMSS_create_public_feedback.sql

-- Enum types
CREATE TYPE feedback_type AS ENUM ('bug', 'feature', 'error', 'improvement', 'other');
CREATE TYPE severity_level AS ENUM ('low', 'medium', 'high', 'critical');
CREATE TYPE feedback_status AS ENUM ('new', 'acknowledged', 'in_progress', 'resolved', 'wont_fix');
CREATE TYPE priority_level AS ENUM ('low', 'medium', 'high', 'urgent');

-- Main table
CREATE TABLE public_feedback (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  feedback_type feedback_type NOT NULL,
  severity severity_level,
  priority priority_level,
  title TEXT NOT NULL CHECK (char_length(title) <= 100),
  description TEXT NOT NULL CHECK (char_length(description) <= 2000),
  steps_to_reproduce TEXT,
  expected_behavior TEXT,
  actual_behavior TEXT,
  use_case TEXT,
  user_name TEXT CHECK (char_length(user_name) <= 50),
  user_email TEXT,
  wants_updates BOOLEAN DEFAULT false,
  browser_info JSONB,
  screenshot_url TEXT,
  status feedback_status DEFAULT 'new',
  admin_notes TEXT,
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now(),
  resolved_at TIMESTAMPTZ
);

-- Indexes
CREATE INDEX idx_feedback_type ON public_feedback(feedback_type);
CREATE INDEX idx_feedback_status ON public_feedback(status);
CREATE INDEX idx_feedback_created_at ON public_feedback(created_at DESC);

-- RLS Policies
ALTER TABLE public_feedback ENABLE ROW LEVEL SECURITY;

-- Public can insert
CREATE POLICY "Anyone can submit feedback"
  ON public_feedback FOR INSERT
  WITH CHECK (true);

-- Only admins can view/update
CREATE POLICY "Admins can view all feedback"
  ON public_feedback FOR SELECT
  USING (
    EXISTS (
      SELECT 1 FROM user_tiers
      WHERE user_tiers.user_id = auth.uid()
      AND user_tiers.tier = 'admin'
    )
  );

CREATE POLICY "Admins can update feedback"
  ON public_feedback FOR UPDATE
  USING (
    EXISTS (
      SELECT 1 FROM user_tiers
      WHERE user_tiers.user_id = auth.uid()
      AND user_tiers.tier = 'admin'
    )
  );

-- Storage bucket
INSERT INTO storage.buckets (id, name, public)
VALUES ('feedback-screenshots', 'feedback-screenshots', false);

-- Storage RLS: Public upload, admin read
CREATE POLICY "Anyone can upload screenshots"
  ON storage.objects FOR INSERT
  WITH CHECK (bucket_id = 'feedback-screenshots');

CREATE POLICY "Admins can view screenshots"
  ON storage.objects FOR SELECT
  USING (
    bucket_id = 'feedback-screenshots' AND
    EXISTS (
      SELECT 1 FROM user_tiers
      WHERE user_tiers.user_id = auth.uid()
      AND user_tiers.tier = 'admin'
    )
  );
```

### Edge Function: Rate Limiting
```typescript
// supabase/functions/submit-feedback/index.ts
import { serve } from 'https://deno.land/std@0.168.0/http/server.ts'
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

const RATE_LIMIT = 5 // submissions per hour
const RATE_LIMIT_WINDOW = 3600000 // 1 hour in ms

serve(async (req) => {
  const supabase = createClient(
    Deno.env.get('SUPABASE_URL')!,
    Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!
  )

  const clientIP = req.headers.get('x-forwarded-for') || 'unknown'

  // Check rate limit (simple KV store or separate rate_limits table)
  const { data: recentSubmissions } = await supabase
    .from('public_feedback')
    .select('created_at')
    .gte('created_at', new Date(Date.now() - RATE_LIMIT_WINDOW).toISOString())
    // In production, add IP tracking field or use Redis/KV

  if (recentSubmissions && recentSubmissions.length >= RATE_LIMIT) {
    return new Response(
      JSON.stringify({ error: 'Rate limit exceeded. Try again later.' }),
      { status: 429, headers: { 'Content-Type': 'application/json' } }
    )
  }

  const body = await req.json()

  // Validate and insert feedback
  const { data, error } = await supabase
    .from('public_feedback')
    .insert({
      ...body,
      browser_info: {
        userAgent: req.headers.get('user-agent'),
        // Additional client info passed from frontend
      }
    })
    .select()
    .single()

  if (error) {
    return new Response(
      JSON.stringify({ error: error.message }),
      { status: 400, headers: { 'Content-Type': 'application/json' } }
    )
  }

  return new Response(
    JSON.stringify({
      success: true,
      referenceId: `FB-${new Date().toISOString().split('T')[0].replace(/-/g, '')}-${data.id.slice(0, 6).toUpperCase()}`,
      data
    }),
    { headers: { 'Content-Type': 'application/json' } }
  )
})
```

### Component Structure
```
src/components/feedback/
‚îú‚îÄ‚îÄ FeedbackPortal.tsx          # Main modal controller
‚îú‚îÄ‚îÄ FeedbackWizard.tsx          # Step orchestrator
‚îú‚îÄ‚îÄ steps/
‚îÇ   ‚îú‚îÄ‚îÄ TypeSelection.tsx       # Step 1: Feedback type cards
‚îÇ   ‚îú‚îÄ‚îÄ DetailsForm.tsx         # Step 2: Conditional form fields
‚îÇ   ‚îî‚îÄ‚îÄ ContactInfo.tsx         # Step 3: Optional contact details
‚îú‚îÄ‚îÄ ScreenshotUpload.tsx        # Drag-drop file upload
‚îú‚îÄ‚îÄ ConfettiSuccess.tsx         # Success animation
‚îî‚îÄ‚îÄ hooks/
    ‚îî‚îÄ‚îÄ useFeedbackSubmit.ts    # Submission logic + validation
```

### Chakra UI Theme Integration
Use existing Previa theme tokens:
- Primary: `previa.purple` for CTAs
- Background: `previa.cream` for modal
- Text: `previa.charcoal` for headings
- Borders: `previa.stone` for dividers
- Success: `green.500` for checkmarks
- Error: `red.500` for validation

### Image Integration
```typescript
// Context-aware image display per step
const stepImages = {
  1: '/docs/1.png', // User analyzing (type selection)
  2: '/docs/2.png', // Stressed user (problem reporting)
  3: '/docs/3.png', // Confident user (successful submission)
}

<Box mb={6} textAlign="center">
  <Image
    src={stepImages[currentStep]}
    alt={`Step ${currentStep} illustration`}
    maxH="200px"
    mx="auto"
    borderRadius="lg"
    objectFit="contain"
  />
</Box>
```

---

## Tasks

### Database & Backend Setup
- [x] Create migration file for `public_feedback` table with enums
- [x] Set up RLS policies (public INSERT, admin SELECT/UPDATE)
- [x] Create `feedback-screenshots` storage bucket with policies
- [x] Implement Edge Function `submit-feedback` with rate limiting
- [x] Add IP tracking mechanism (table or Redis) for rate limits
- [x] Test rate limiting with multiple rapid submissions

### Frontend - Wizard Infrastructure
- [x] Create `FeedbackPortal.tsx` modal component with Chakra Modal
- [x] Build `FeedbackWizard.tsx` with step state management (useState or Zustand)
- [x] Implement progress bar with Chakra Progress component
- [x] Set up Framer Motion animations for step transitions (slide + fade)
- [x] Add back/next navigation with validation checks

### Frontend - Step 1: Type Selection
- [x] Create `TypeSelection.tsx` with 5 feedback type RadioCards
- [x] Add icons for each type (Lucide React or Chakra Icon)
- [x] Implement hover animations (scale transform)
- [x] Integrate `docs/1.png` image with fade-in animation
- [x] Add stagger animation for card entrance (150ms delay)

### Frontend - Step 2: Details Form
- [x] Build `DetailsForm.tsx` with conditional field rendering
- [x] Add title input with character counter (max 100)
- [x] Add description textarea with character counter (max 2000)
- [x] Implement bug-specific fields (steps to reproduce, expected/actual behavior)
- [x] Implement feature-specific fields (use case, priority)
- [x] Create severity/priority selector with RadioCards
- [x] Build `ScreenshotUpload.tsx` with drag-drop + file picker
- [x] Add file validation (5MB limit, PNG/JPG/PDF only)
- [x] Integrate `docs/2.png` image
- [x] Add real-time validation with Zod schema

### Frontend - Step 3: Contact Info
- [x] Create `ContactInfo.tsx` with name/email inputs
- [x] Add email format validation (Zod)
- [x] Implement consent checkbox for updates
- [x] Add "I'm a registered user" checkbox (pre-fill email if logged in)
- [x] Integrate `docs/3.png` image
- [x] Create submit button with loading state (Chakra Spinner)

### Frontend - Submission Logic
- [x] Build `useFeedbackSubmit.ts` hook with TanStack Query mutation
- [x] Capture browser info (navigator.userAgent, screen dimensions)
- [x] Upload screenshot to Supabase Storage before submitting
- [x] Submit feedback to Edge Function `submit-feedback`
- [x] Handle success: Show toast with reference ID, reset form
- [x] Handle errors: Display specific messages, preserve form data
- [x] Add retry logic for network failures

### Frontend - Success State
- [x] Create `ConfettiSuccess.tsx` with react-confetti or canvas-confetti
- [x] Display reference ID prominently (e.g., "FB-20250128-ABC123")
- [x] Show "Submit Another" button and "Close" button
- [x] Clear wizard state on close

### Admin Dashboard
- [ ] Create protected route `/admin/feedback` with role check
- [ ] Build AG-Grid table with all feedback columns
- [ ] Add filters: Type, Status, Priority, Date range
- [ ] Implement status update modal with admin notes field
- [ ] Add screenshot lightbox viewer (Chakra Modal + Image)
- [ ] Email notification on status change (optional, Edge Function trigger)

### Testing & QA
- [ ] Unit tests: Form validation logic (Vitest)
- [ ] Unit tests: Rate limiting logic (Edge Function)
- [ ] Integration test: Full submission flow (Playwright or Cypress)
- [ ] Test accessibility: Keyboard navigation, screen reader announcements
- [ ] Test responsive design: Mobile (full screen), tablet, desktop (3xl modal)
- [ ] Test error scenarios: Rate limit, network failure, file upload errors
- [ ] Load test: Verify rate limiting under concurrent requests

### Documentation & Polish
- [ ] Add JSDoc comments to all components
- [ ] Update `docs/architecture/source-tree.md` with new component paths
- [ ] Create admin user guide for feedback dashboard (if needed)
- [ ] Add analytics tracking (optional): Submission events, type distribution

---

## Testing

### Unit Tests
```typescript
describe('FeedbackPortal', () => {
  it('validates required fields before allowing next step', () => {
    render(<FeedbackPortal />)
    const nextButton = screen.getByText('Next')
    expect(nextButton).toBeDisabled()

    fireEvent.click(screen.getByLabelText('Bug Report'))
    expect(nextButton).not.toBeDisabled()
  })

  it('shows conditional fields based on feedback type', () => {
    render(<DetailsForm type="bug" />)
    expect(screen.getByLabelText('Steps to Reproduce')).toBeInTheDocument()

    rerender(<DetailsForm type="feature" />)
    expect(screen.queryByLabelText('Steps to Reproduce')).not.toBeInTheDocument()
    expect(screen.getByLabelText('Use Case')).toBeInTheDocument()
  })
})
```

### Integration Tests
```typescript
describe('Feedback Submission Flow', () => {
  it('completes full wizard and submits feedback', async () => {
    render(<FeedbackPortal />)

    // Step 1
    fireEvent.click(screen.getByLabelText('Bug Report'))
    fireEvent.click(screen.getByText('Next'))

    // Step 2
    fireEvent.change(screen.getByLabelText('Title'), { target: { value: 'Test bug' } })
    fireEvent.change(screen.getByLabelText('Description'), { target: { value: 'Test description' } })
    fireEvent.click(screen.getByText('Next'))

    // Step 3
    fireEvent.click(screen.getByText('Submit'))

    await waitFor(() => {
      expect(screen.getByText(/Thank you/i)).toBeInTheDocument()
    })
  })
})
```

---

## Definition of Done
- [ ] All acceptance criteria met and verified
- [ ] Database migration applied to dev/staging/prod
- [ ] Edge Function deployed and tested
- [ ] All tasks completed and checked off
- [ ] Unit tests passing (>80% coverage for new code)
- [ ] Integration tests passing
- [ ] Accessibility audit passing (WCAG AA)
- [ ] Responsive design verified on mobile/tablet/desktop
- [ ] Code review completed by at least one team member
- [ ] Documentation updated (component docs, architecture)
- [ ] QA approval obtained
- [ ] Deployed to staging and smoke tested
- [ ] Product Owner acceptance received

---

## Dev Agent Record

### Agent Model Used
- Model: Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)
- Timestamp: 2025-10-28T11:00:00Z

### Debug Log References
(Dev agent will add references to complex debugging sessions here)

### Completion Notes

**Task 1: Database & Backend Setup (COMPLETED)**
- Created comprehensive feedback system database schema with 4 enum types
- Implemented RLS policies for public submission and admin-only viewing
- Built rate-limiting Edge Function with IP tracking (5 submissions/hour limit)
- Created feedback_rate_limits table for efficient rate limit queries
- Deployed Edge Function successfully to Supabase
- Storage bucket configured for screenshot uploads with appropriate access policies
- Fixed apostrophe escaping issue in Edge Function for proper TypeScript parsing

**Task 2: Frontend - Wizard Infrastructure (COMPLETED)**
- Built FeedbackPortal modal with Chakra UI (responsive: full screen mobile, 3xl desktop)
- Created FeedbackWizard orchestrator with useState for step management
- Implemented animated progress bar (Chakra Progress) showing completion percentage
- Added Framer Motion slide+fade transitions between steps (300ms smooth animations)
- Built back/next navigation with validation checks (disables "Next" until step complete)
- Created TypeScript types file for type safety across components
- Generated stub components for steps (TypeSelection, DetailsForm, ContactInfo, ConfettiSuccess)
- Included Previa logo and branding in modal header

**Task 3: Frontend - Step 1 Type Selection (COMPLETED)**
- Implemented full TypeSelection component with 5 feedback type radio cards
- Created FeedbackTypeCard component with hover animations (scale 1.05)
- Integrated Lucide React icons (Bug, Sparkles, AlertTriangle, Lightbulb, FileText)
- Added stagger animation with 150ms delay per card for smooth entrance effect
- Integrated illustration `/illustrations/1.png` (user analyzing at computer)
- Moved illustration images from docs/ to public/illustrations/ for proper web serving

**Task 4: Frontend - Step 2 Details Form (COMPLETED)**
- Built comprehensive DetailsForm with conditional field rendering based on feedback type
- Created SeverityCard component for severity/priority radio selection
- Implemented ScreenshotUpload component with drag-drop + file picker functionality
- Added file validation (5MB limit, PNG/JPG/PDF types only)
- Implemented character counters for title (100 chars) and description (2000 chars)
- Added real-time validation with error messages and warning colors
- Bug/Error types display: steps to reproduce, expected/actual behavior fields, severity selector
- Feature types display: use case field, priority selector
- Integrated illustration `/illustrations/2.png` (stressed user with problems)

**Task 5: Frontend - Step 3 Contact Info (COMPLETED)**
- Implemented ContactInfo component with optional name and email inputs
- Added email validation using regex pattern `/^[^\s@]+@[^\s@]+\.[^\s@]+$/`
- Implemented "I'm a registered user" checkbox with auto-fill functionality for logged-in users
- Integrated useSupabaseAuth hook to pre-fill email from session state
- Added "I'd like to receive updates" consent checkbox (only shows if email provided)
- Created privacy notice in purple-bordered box explaining data usage
- Integrated illustration `/illustrations/3.png` (confident user with financial tools)
- Contextual heading: "How can we reach you? (Optional)"

**Task 6: Frontend - Submission Logic (COMPLETED)**
- Created `useFeedbackSubmit.ts` hook with TanStack Query mutation
- Implemented browser info capture (userAgent, screen, viewport, language, timezone, platform, cookies)
- Built screenshot upload to Supabase Storage with unique filenames (timestamp + random string)
- Integrated Edge Function call to `submit-feedback` with proper payload structure
- Implemented success handling with Chakra toast showing reference ID (8 second duration, top position)
- Added comprehensive error handling with specific messages for rate limits, upload errors, network errors
- Configured automatic retry logic (3 attempts with exponential backoff: 1s, 2s, 4s)
- Updated FeedbackWizard to use the hook with local state management for success screen
- Added FeedbackFormData type to types.ts for shared type safety
- Exported hook from index.ts for external use

**Task 7: Frontend - Success State (COMPLETED)**
- Implemented full ConfettiSuccess component with canvas-confetti animation
- Created 3-second confetti burst effect from dual positions with Previa brand colors
- Added animated success icon with CheckCircle (green) and spring animation (scale + rotate)
- Built prominent reference ID display in purple-bordered box with copy-friendly Code component
- Implemented "What happens next?" information box explaining review timeline
- Created two action buttons: "Submit Another Report" (outline) and "Close" (solid purple)
- Added staggered fade-in animations (0.2s, 0.4s, 0.6s, 0.8s, 1.0s delays) for smooth UX
- Made component fully responsive (base/sm/md breakpoints) with stacked buttons on mobile
- Used Framer Motion for all animations (MotionBox, MotionText)
- Installed canvas-confetti package (npm install canvas-confetti)

### File List
(Dev agent will maintain list of created/modified source files)

**Created:**
- `supabase/migrations/20251028110300_create_public_feedback.sql`
- `supabase/migrations/20251028110301_create_feedback_rate_limits.sql`
- `supabase/functions/submit-feedback/index.ts`
- `supabase/functions/_shared/cors.ts`
- `.bmad-core/data/story-archon-map-8.1.yaml`
- `src/components/feedback/FeedbackPortal.tsx`
- `src/components/feedback/FeedbackWizard.tsx`
- `src/components/feedback/types.ts`
- `src/components/feedback/index.ts`
- `src/components/feedback/steps/TypeSelection.tsx`
- `src/components/feedback/steps/FeedbackTypeCard.tsx`
- `src/components/feedback/steps/DetailsForm.tsx`
- `src/components/feedback/steps/SeverityCard.tsx`
- `src/components/feedback/steps/ContactInfo.tsx`
- `src/components/feedback/ScreenshotUpload.tsx`
- `src/components/feedback/hooks/useFeedbackSubmit.ts`
- `src/components/feedback/ConfettiSuccess.tsx`
- `public/illustrations/1.png` (moved from docs/)
- `public/illustrations/2.png` (moved from docs/)
- `public/illustrations/3.png` (moved from docs/)

**Modified:**
- `src/components/feedback/FeedbackWizard.tsx` - Integrated useFeedbackSubmit hook
- `src/components/feedback/types.ts` - Added FeedbackFormData and BrowserInfo interfaces
- `src/components/feedback/index.ts` - Added hook export
- `src/components/feedback/ConfettiSuccess.tsx` - Full implementation with canvas-confetti
- `package.json` / `package-lock.json` - Added canvas-confetti dependency

**Deleted:**
- (none)

### Change Log
(Dev agent will document significant changes during implementation)

| Date | Change | Reason |
|------|--------|--------|
| (to be filled) | (change description) | (rationale) |

---

## Dependencies
- Story 2.1 (Auth screens) - for "I'm a registered user" checkbox
- Story 3.1 (Dashboard layout) - for admin feedback route integration

## Blocked By
- None

## Estimated Effort
- Database setup: 2 hours
- Edge Function: 3 hours
- Wizard infrastructure: 4 hours
- Step components: 8 hours
- Screenshot upload: 3 hours
- Admin dashboard: 6 hours
- Testing: 4 hours
- **Total: ~30 hours (Story Points: 13)**

---

**Story Status:** Draft
**Created:** 2025-01-28
**Last Updated:** 2025-01-28
